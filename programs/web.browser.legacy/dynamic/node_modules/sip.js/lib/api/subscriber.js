function module(e,t,s){var i,r,o,n,a,c,u;s.export({Subscriber:function(){return h}}),s.link("../core",{C:function(e){i=e},fromBodyLegacy:function(e){r=e},SubscriptionState:function(e){o=e}},0),s.link("../core/user-agent-core/allowed-methods",{AllowedMethods:function(e){n=e}},1),s.link("./notification",{Notification:function(e){a=e}},2),s.link("./subscription",{Subscription:function(e){c=e}},3),s.link("./subscription-state",{SubscriptionState:function(e){u=e}},4);class h extends c{constructor(e,t,s,i={}){super(e,i),this.body=void 0,this.logger=e.getLogger("sip.Subscriber"),i.body&&(this.body={body:i.body,contentType:i.contentType?i.contentType:"application/sdp"}),this.targetURI=t,this.event=s,void 0===i.expires?this.expires=3600:"number"!=typeof i.expires?(this.logger.warn('Option "expires" must be a number. Using default of 3600.'),this.expires=3600):this.expires=i.expires,this.extraHeaders=(i.extraHeaders||[]).slice(),this.subscriberRequest=this.initSubscriberRequest(),this.outgoingRequestMessage=this.subscriberRequest.message,this.id=this.outgoingRequestMessage.callId+this.outgoingRequestMessage.from.parameters.tag+this.event,this._userAgent._subscriptions[this.id]=this}dispose(){return this.disposed?Promise.resolve():(this.logger.log(`Subscription ${this.id} in state ${this.state} is being disposed`),delete this._userAgent._subscriptions[this.id],this.retryAfterTimer&&(clearTimeout(this.retryAfterTimer),this.retryAfterTimer=void 0),this.subscriberRequest.dispose(),super.dispose().then(()=>{if(this.state===u.Subscribed){if(!this._dialog)throw Error("Dialog undefined.");if(this._dialog.subscriptionState===o.Pending||this._dialog.subscriptionState===o.Active){let e=this._dialog;return new Promise((t,s)=>{e.delegate={onTerminated:()=>t()},e.unsubscribe()})}}}))}subscribe(e={}){switch(this.subscriberRequest.state){case o.Initial:this.state===u.Initial&&this.stateTransition(u.NotifyWait),this.subscriberRequest.subscribe().then(e=>{e.success?(e.success.subscription&&(this._dialog=e.success.subscription,this._dialog.delegate={onNotify:e=>this.onNotify(e),onRefresh:e=>this.onRefresh(e),onTerminated:()=>{this.state!==u.Terminated&&this.stateTransition(u.Terminated)}}),this.onNotify(e.success.request)):e.failure&&this.unsubscribe()});break;case o.NotifyWait:case o.Pending:break;case o.Active:if(this._dialog){let e=this._dialog.refresh();e.delegate={onAccept:e=>this.onAccepted(e),onRedirect:e=>this.unsubscribe(),onReject:e=>this.unsubscribe()}}case o.Terminated:}return Promise.resolve()}unsubscribe(e={}){if(this.disposed)return Promise.resolve();switch(this.subscriberRequest.state){case o.Initial:case o.NotifyWait:break;case o.Pending:case o.Active:this._dialog&&this._dialog.unsubscribe();break;case o.Terminated:break;default:throw Error("Unknown state.")}return this.stateTransition(u.Terminated),Promise.resolve()}_refresh(){return this.subscriberRequest.state===o.Active?this.subscribe():Promise.resolve()}onAccepted(e){}onNotify(e){if(this.disposed){e.accept();return}if(this.state!==u.Subscribed&&this.stateTransition(u.Subscribed),this.delegate&&this.delegate.onNotify){let t=new a(e);this.delegate.onNotify(t)}else e.accept();let t=e.message.parseHeader("Subscription-State");if(t&&t.state&&"terminated"===t.state){if(t.reason)switch(this.logger.log(`Terminated subscription with reason ${t.reason}`),t.reason){case"deactivated":case"timeout":this.initSubscriberRequest(),this.subscribe();return;case"probation":case"giveup":this.initSubscriberRequest(),t.params&&t.params["retry-after"]?this.retryAfterTimer=setTimeout(()=>{this.subscribe()},t.params["retry-after"]):this.subscribe();return}this.unsubscribe()}}onRefresh(e){e.delegate={onAccept:e=>this.onAccepted(e)}}initSubscriberRequest(){let e={extraHeaders:this.extraHeaders,body:this.body?r(this.body):void 0};return this.subscriberRequest=new b(this._userAgent.userAgentCore,this.targetURI,this.event,this.expires,e),this.subscriberRequest.delegate={onAccept:e=>this.onAccepted(e)},this.subscriberRequest}}class b{constructor(e,t,s,r,o,a){this.core=e,this.target=t,this.event=s,this.expires=r,this.subscribed=!1,this.logger=e.loggerFactory.getLogger("sip.Subscriber"),this.delegate=a;let c="Allow: "+n.toString(),u=(o&&o.extraHeaders||[]).slice();u.push(c),u.push("Event: "+this.event),u.push("Expires: "+this.expires),u.push("Contact: "+this.core.configuration.contact.toString());let h=o&&o.body;this.message=e.makeOutgoingRequestMessage(i.SUBSCRIBE,this.target,this.core.configuration.aor,this.target,{},u,h)}dispose(){this.request&&(this.request.waitNotifyStop(),this.request.dispose(),this.request=void 0)}get state(){return this.subscription?this.subscription.subscriptionState:this.subscribed?o.NotifyWait:o.Initial}subscribe(){return this.subscribed?Promise.reject(Error("Not in initial state. Did you call subscribe more than once?")):(this.subscribed=!0,new Promise(e=>{if(!this.message)throw Error("Message undefined.");this.request=this.core.subscribe(this.message,{onAccept:e=>{this.delegate&&this.delegate.onAccept&&this.delegate.onAccept(e)},onNotify:t=>{this.subscription=t.subscription,this.subscription&&(this.subscription.autoRefresh=!0),e({success:t})},onNotifyTimeout:()=>{e({failure:{}})},onRedirect:t=>{e({failure:{response:t}})},onReject:t=>{e({failure:{response:t}})}})}))}}}
//# sourceMappingURL=/dynamic/node_modules/sip.js/lib/api/7fec60e044d4f52e7e404f30882121e82bd8c2a6.map

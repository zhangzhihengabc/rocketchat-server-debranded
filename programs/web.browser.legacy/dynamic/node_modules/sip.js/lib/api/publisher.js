function module(e,s,t){var i,r,o,h;t.export({Publisher:function(){return n}}),t.link("../core",{C:function(e){i=e},fromBodyLegacy:function(e){r=e}},0),t.link("./emitter",{EmitterImpl:function(e){o=e}},1),t.link("./publisher-state",{PublisherState:function(e){h=e}},2);class n{constructor(e,s,t,r={}){let n;this.disposed=!1,this._state=h.Initial,this._stateEventEmitter=new o,this.userAgent=e,r.extraHeaders=(r.extraHeaders||[]).slice(),r.contentType=r.contentType||"text/plain","number"!=typeof r.expires||r.expires%1!=0?r.expires=3600:r.expires=Number(r.expires),"boolean"!=typeof r.unpublishOnClose&&(r.unpublishOnClose=!0),this.target=s,this.event=t,this.options=r,this.pubRequestExpires=r.expires,this.logger=e.getLogger("sip.Publisher");let u=r.params||{},a=u.fromUri?u.fromUri:e.userAgentCore.configuration.aor,p=u.toUri?u.toUri:s;if(r.body&&r.contentType){let e=r.contentType,s=r.body;n={contentDisposition:"render",contentType:e,content:s}}let d=(r.extraHeaders||[]).slice();this.request=e.userAgentCore.makeOutgoingRequestMessage(i.PUBLISH,s,a,p,u,d,n),this.id=this.target.toString()+":"+this.event,this.userAgent._publishers[this.id]=this}dispose(){return this.disposed?Promise.resolve():(this.disposed=!0,this.logger.log(`Publisher ${this.id} in state ${this.state} is being disposed`),delete this.userAgent._publishers[this.id],this.options.unpublishOnClose&&this.state===h.Published)?this.unpublish():(this.publishRefreshTimer&&(clearTimeout(this.publishRefreshTimer),this.publishRefreshTimer=void 0),this.pubRequestBody=void 0,this.pubRequestExpires=0,this.pubRequestEtag=void 0,Promise.resolve())}get state(){return this._state}get stateChange(){return this._stateEventEmitter}publish(e,s={}){if(this.publishRefreshTimer&&(clearTimeout(this.publishRefreshTimer),this.publishRefreshTimer=void 0),this.options.body=e,this.pubRequestBody=this.options.body,0===this.pubRequestExpires){if(void 0===this.options.expires)throw Error("Expires undefined.");this.pubRequestExpires=this.options.expires,this.pubRequestEtag=void 0}return this.sendPublishRequest(),Promise.resolve()}unpublish(e={}){return this.publishRefreshTimer&&(clearTimeout(this.publishRefreshTimer),this.publishRefreshTimer=void 0),this.pubRequestBody=void 0,this.pubRequestExpires=0,void 0!==this.pubRequestEtag&&this.sendPublishRequest(),Promise.resolve()}receiveResponse(e){let s=e.statusCode||0;switch(!0){case/^1[0-9]{2}$/.test(s.toString()):break;case/^2[0-9]{2}$/.test(s.toString()):if(e.hasHeader("SIP-ETag")?this.pubRequestEtag=e.getHeader("SIP-ETag"):this.logger.warn("SIP-ETag header missing in a 200-class response to PUBLISH"),e.hasHeader("Expires")){let s=Number(e.getHeader("Expires"));"number"==typeof s&&s>=0&&s<=this.pubRequestExpires?this.pubRequestExpires=s:this.logger.warn("Bad Expires header in a 200-class response to PUBLISH")}else this.logger.warn("Expires header missing in a 200-class response to PUBLISH");0!==this.pubRequestExpires?(this.publishRefreshTimer=setTimeout(()=>this.refreshRequest(),900*this.pubRequestExpires),this._state!==h.Published&&this.stateTransition(h.Published)):this.stateTransition(h.Unpublished);break;case/^412$/.test(s.toString()):if(void 0!==this.pubRequestEtag&&0!==this.pubRequestExpires){if(this.logger.warn("412 response to PUBLISH, recovering"),this.pubRequestEtag=void 0,void 0===this.options.body)throw Error("Body undefined.");this.publish(this.options.body)}else this.logger.warn("412 response to PUBLISH, recovery failed"),this.pubRequestExpires=0,this.stateTransition(h.Unpublished),this.stateTransition(h.Terminated);break;case/^423$/.test(s.toString()):if(0!==this.pubRequestExpires&&e.hasHeader("Min-Expires")){let s=Number(e.getHeader("Min-Expires"));if("number"==typeof s||s>this.pubRequestExpires){if(this.logger.warn("423 code in response to PUBLISH, adjusting the Expires value and trying to recover"),this.pubRequestExpires=s,void 0===this.options.body)throw Error("Body undefined.");this.publish(this.options.body)}else this.logger.warn("Bad 423 response Min-Expires header received for PUBLISH"),this.pubRequestExpires=0,this.stateTransition(h.Unpublished),this.stateTransition(h.Terminated)}else this.logger.warn("423 response to PUBLISH, recovery failed"),this.pubRequestExpires=0,this.stateTransition(h.Unpublished),this.stateTransition(h.Terminated);break;default:this.pubRequestExpires=0,this.stateTransition(h.Unpublished),this.stateTransition(h.Terminated)}0===this.pubRequestExpires&&(this.publishRefreshTimer&&(clearTimeout(this.publishRefreshTimer),this.publishRefreshTimer=void 0),this.pubRequestBody=void 0,this.pubRequestEtag=void 0)}send(){return this.userAgent.userAgentCore.publish(this.request,{onAccept:e=>this.receiveResponse(e.message),onProgress:e=>this.receiveResponse(e.message),onRedirect:e=>this.receiveResponse(e.message),onReject:e=>this.receiveResponse(e.message),onTrying:e=>this.receiveResponse(e.message)})}refreshRequest(){if(this.publishRefreshTimer&&(clearTimeout(this.publishRefreshTimer),this.publishRefreshTimer=void 0),this.pubRequestBody=void 0,void 0===this.pubRequestEtag)throw Error("Etag undefined");if(0===this.pubRequestExpires)throw Error("Expires zero");this.sendPublishRequest()}sendPublishRequest(){let e,s;let t=Object.assign({},this.options);t.extraHeaders=(this.options.extraHeaders||[]).slice(),t.extraHeaders.push("Event: "+this.event),t.extraHeaders.push("Expires: "+this.pubRequestExpires),void 0!==this.pubRequestEtag&&t.extraHeaders.push("SIP-If-Match: "+this.pubRequestEtag);let o=this.target,h=this.options.params||{};if(void 0!==this.pubRequestBody){if(void 0===this.options.contentType)throw Error("Content type undefined.");e={body:this.pubRequestBody,contentType:this.options.contentType}}return e&&(s=r(e)),this.request=this.userAgent.userAgentCore.makeOutgoingRequestMessage(i.PUBLISH,o,h.fromUri?h.fromUri:this.userAgent.userAgentCore.configuration.aor,h.toUri?h.toUri:this.target,h,t.extraHeaders,s),this.send()}stateTransition(e){let s=()=>{throw Error(`Invalid state transition from ${this._state} to ${e}`)};switch(this._state){case h.Initial:e!==h.Published&&e!==h.Unpublished&&e!==h.Terminated&&s();break;case h.Published:e!==h.Unpublished&&e!==h.Terminated&&s();break;case h.Unpublished:e!==h.Published&&e!==h.Terminated&&s();break;case h.Terminated:s();break;default:throw Error("Unrecognized state.")}this._state=e,this.logger.log(`Publication transitioned to state ${this._state}`),this._stateEventEmitter.emit(this._state),e===h.Terminated&&this.dispose()}}}
//# sourceMappingURL=/dynamic/node_modules/sip.js/lib/api/e6fee9c3bd33e6819f9ca69a1d707941e79224f4.map

function module(e,t,s){var i,r,n,o,a,l,d,h,g,c,f,p,u,m,v,D,H,E;s.export({Session:function(){return R}}),s.link("../core",{fromBodyLegacy:function(e){i=e},getBody:function(e){r=e},Grammar:function(e){n=e},SessionState:function(e){o=e},SignalingState:function(e){a=e},URI:function(e){l=e}},0),s.link("../core/messages/utils",{getReasonPhrase:function(e){d=e}},1),s.link("../core/user-agent-core/allowed-methods",{AllowedMethods:function(e){h=e}},2),s.link("./ack",{Ack:function(e){g=e}},3),s.link("./bye",{Bye:function(e){c=e}},4),s.link("./emitter",{EmitterImpl:function(e){f=e}},5),s.link("./exceptions",{ContentTypeUnsupportedError:function(e){p=e},RequestPendingError:function(e){u=e}},6),s.link("./info",{Info:function(e){m=e}},7),s.link("./message",{Message:function(e){v=e}},8),s.link("./notification",{Notification:function(e){D=e}},9),s.link("./referral",{Referral:function(e){H=e}},10),s.link("./session-state",{SessionState:function(e){E=e}},11);class R{constructor(e,t={}){this.pendingReinvite=!1,this.pendingReinviteAck=!1,this._state=E.Initial,this.delegate=t.delegate,this._stateEventEmitter=new f,this._userAgent=e}dispose(){switch(this.logger.log(`Session ${this.id} in state ${this._state} is being disposed`),delete this.userAgent._sessions[this.id],this._sessionDescriptionHandler&&this._sessionDescriptionHandler.close(),this.state){case E.Initial:case E.Establishing:break;case E.Established:return new Promise(e=>{this._bye({onAccept:()=>e(),onRedirect:()=>e(),onReject:()=>e()})});case E.Terminating:case E.Terminated:break;default:throw Error("Unknown state.")}return Promise.resolve()}get assertedIdentity(){return this._assertedIdentity}get dialog(){return this._dialog}get id(){return this._id}get replacee(){return this._replacee}get sessionDescriptionHandler(){return this._sessionDescriptionHandler}get sessionDescriptionHandlerFactory(){return this.userAgent.configuration.sessionDescriptionHandlerFactory}get sessionDescriptionHandlerModifiers(){return this._sessionDescriptionHandlerModifiers||[]}set sessionDescriptionHandlerModifiers(e){this._sessionDescriptionHandlerModifiers=e.slice()}get sessionDescriptionHandlerOptions(){return this._sessionDescriptionHandlerOptions||{}}set sessionDescriptionHandlerOptions(e){this._sessionDescriptionHandlerOptions=Object.assign({},e)}get sessionDescriptionHandlerModifiersReInvite(){return this._sessionDescriptionHandlerModifiersReInvite||[]}set sessionDescriptionHandlerModifiersReInvite(e){this._sessionDescriptionHandlerModifiersReInvite=e.slice()}get sessionDescriptionHandlerOptionsReInvite(){return this._sessionDescriptionHandlerOptionsReInvite||{}}set sessionDescriptionHandlerOptionsReInvite(e){this._sessionDescriptionHandlerOptionsReInvite=Object.assign({},e)}get state(){return this._state}get stateChange(){return this._stateEventEmitter}get userAgent(){return this._userAgent}bye(e={}){let t="Session.bye() may only be called if established session.";switch(this.state){case E.Initial:"function"==typeof this.cancel?t+=" However Inviter.invite() has not yet been called. Perhaps you should have called Inviter.cancel()?":"function"==typeof this.reject&&(t+=" However Invitation.accept() has not yet been called. Perhaps you should have called Invitation.reject()?");break;case E.Establishing:"function"==typeof this.cancel?t+=" However a dialog does not yet exist. Perhaps you should have called Inviter.cancel()?":"function"==typeof this.reject&&(t+=" However Invitation.accept() has not yet been called (or not yet resolved). Perhaps you should have called Invitation.reject()?");break;case E.Established:{let t=e.requestDelegate,s=this.copyRequestOptions(e.requestOptions);return this._bye(t,s)}case E.Terminating:t+=" However this session is already terminating.","function"==typeof this.cancel?t+=" Perhaps you have already called Inviter.cancel()?":"function"==typeof this.reject&&(t+=" Perhaps you have already called Session.bye()?");break;case E.Terminated:t+=" However this session is already terminated.";break;default:throw Error("Unknown state")}return this.logger.error(t),Promise.reject(Error(`Invalid session state ${this.state}`))}info(e={}){if(this.state!==E.Established)return this.logger.error("Session.info() may only be called if established session."),Promise.reject(Error(`Invalid session state ${this.state}`));let t=e.requestDelegate,s=this.copyRequestOptions(e.requestOptions);return this._info(t,s)}invite(e={}){if(this.logger.log("Session.invite"),this.state!==E.Established)return Promise.reject(Error(`Invalid session state ${this.state}`));if(this.pendingReinvite)return Promise.reject(new u("Reinvite in progress. Please wait until complete, then try again."));this.pendingReinvite=!0,e.sessionDescriptionHandlerModifiers&&(this.sessionDescriptionHandlerModifiersReInvite=e.sessionDescriptionHandlerModifiers),e.sessionDescriptionHandlerOptions&&(this.sessionDescriptionHandlerOptionsReInvite=e.sessionDescriptionHandlerOptions);let t={onAccept:t=>{let s=r(t.message);if(!s){this.logger.error("Received 2xx response to re-INVITE without a session description"),this.ackAndBye(t,400,"Missing session description"),this.stateTransition(E.Terminated),this.pendingReinvite=!1;return}if(e.withoutSdp){let i={sessionDescriptionHandlerOptions:this.sessionDescriptionHandlerOptionsReInvite,sessionDescriptionHandlerModifiers:this.sessionDescriptionHandlerModifiersReInvite};this.setOfferAndGetAnswer(s,i).then(e=>{t.ack({body:e})}).catch(e=>{this.logger.error("Failed to handle offer in 2xx response to re-INVITE"),this.logger.error(e.message),this.state===E.Terminated?t.ack():(this.ackAndBye(t,488,"Bad Media Description"),this.stateTransition(E.Terminated))}).then(()=>{this.pendingReinvite=!1,e.requestDelegate&&e.requestDelegate.onAccept&&e.requestDelegate.onAccept(t)})}else{let i={sessionDescriptionHandlerOptions:this.sessionDescriptionHandlerOptionsReInvite,sessionDescriptionHandlerModifiers:this.sessionDescriptionHandlerModifiersReInvite};this.setAnswer(s,i).then(()=>{t.ack()}).catch(e=>{this.logger.error("Failed to handle answer in 2xx response to re-INVITE"),this.logger.error(e.message),this.state!==E.Terminated?(this.ackAndBye(t,488,"Bad Media Description"),this.stateTransition(E.Terminated)):t.ack()}).then(()=>{this.pendingReinvite=!1,e.requestDelegate&&e.requestDelegate.onAccept&&e.requestDelegate.onAccept(t)})}},onProgress:e=>{},onRedirect:e=>{},onReject:t=>{this.logger.warn("Received a non-2xx response to re-INVITE"),this.pendingReinvite=!1,e.withoutSdp?e.requestDelegate&&e.requestDelegate.onReject&&e.requestDelegate.onReject(t):this.rollbackOffer().catch(e=>{if(this.logger.error("Failed to rollback offer on non-2xx response to re-INVITE"),this.logger.error(e.message),this.state!==E.Terminated){if(!this.dialog)throw Error("Dialog undefined.");let e=[];e.push("Reason: "+this.getReasonHeaderValue(500,"Internal Server Error")),this.dialog.bye(void 0,{extraHeaders:e}),this.stateTransition(E.Terminated)}}).then(()=>{e.requestDelegate&&e.requestDelegate.onReject&&e.requestDelegate.onReject(t)})},onTrying:e=>{}},s=e.requestOptions||{};if(s.extraHeaders=(s.extraHeaders||[]).slice(),s.extraHeaders.push("Allow: "+h.toString()),s.extraHeaders.push("Contact: "+this._contact),e.withoutSdp){if(!this.dialog)throw this.pendingReinvite=!1,Error("Dialog undefined.");return Promise.resolve(this.dialog.invite(t,s))}let i={sessionDescriptionHandlerOptions:this.sessionDescriptionHandlerOptionsReInvite,sessionDescriptionHandlerModifiers:this.sessionDescriptionHandlerModifiersReInvite};return this.getOffer(i).then(e=>{if(!this.dialog)throw this.pendingReinvite=!1,Error("Dialog undefined.");return s.body=e,this.dialog.invite(t,s)}).catch(e=>{throw this.logger.error(e.message),this.logger.error("Failed to send re-INVITE"),this.pendingReinvite=!1,e})}message(e={}){if(this.state!==E.Established)return this.logger.error("Session.message() may only be called if established session."),Promise.reject(Error(`Invalid session state ${this.state}`));let t=e.requestDelegate,s=this.copyRequestOptions(e.requestOptions);return this._message(t,s)}refer(e,t={}){if(this.state!==E.Established)return this.logger.error("Session.refer() may only be called if established session."),Promise.reject(Error(`Invalid session state ${this.state}`));let s=t.requestDelegate,i=this.copyRequestOptions(t.requestOptions);return i.extraHeaders=i.extraHeaders?i.extraHeaders.concat(this.referExtraHeaders(this.referToString(e))):this.referExtraHeaders(this.referToString(e)),this._refer(t.onNotify,s,i)}_bye(e,t){if(!this.dialog)return Promise.reject(Error("Session dialog undefined."));let s=this.dialog;switch(s.sessionState){case o.Initial:case o.Early:throw Error(`Invalid dialog state ${s.sessionState}`);case o.AckWait:return this.stateTransition(E.Terminating),new Promise(i=>{s.delegate={onAck:()=>{let r=s.bye(e,t);return this.stateTransition(E.Terminated),i(r),Promise.resolve()},onAckTimeout:()=>{let r=s.bye(e,t);this.stateTransition(E.Terminated),i(r)}}});case o.Confirmed:{let i=s.bye(e,t);return this.stateTransition(E.Terminated),Promise.resolve(i)}case o.Terminated:throw Error(`Invalid dialog state ${s.sessionState}`);default:throw Error("Unrecognized state.")}}_info(e,t){return this.dialog?Promise.resolve(this.dialog.info(e,t)):Promise.reject(Error("Session dialog undefined."))}_message(e,t){return this.dialog?Promise.resolve(this.dialog.message(e,t)):Promise.reject(Error("Session dialog undefined."))}_refer(e,t,s){return this.dialog?(this.onNotify=e,Promise.resolve(this.dialog.refer(t,s))):Promise.reject(Error("Session dialog undefined."))}ackAndBye(e,t,s){e.ack();let i=[];t&&i.push("Reason: "+this.getReasonHeaderValue(t,s)),e.session.bye(void 0,{extraHeaders:i})}onAckRequest(e){if(this.logger.log("Session.onAckRequest"),this.state!==E.Established&&this.state!==E.Terminating)return this.logger.error(`ACK received while in state ${this.state}, dropping request`),Promise.resolve();let t=this.dialog;if(!t)throw Error("Dialog undefined.");let s={sessionDescriptionHandlerOptions:this.pendingReinviteAck?this.sessionDescriptionHandlerOptionsReInvite:this.sessionDescriptionHandlerOptions,sessionDescriptionHandlerModifiers:this.pendingReinviteAck?this._sessionDescriptionHandlerModifiersReInvite:this._sessionDescriptionHandlerModifiers};if(this.delegate&&this.delegate.onAck){let t=new g(e);this.delegate.onAck(t)}switch(this.pendingReinviteAck=!1,t.signalingState){case a.Initial:{this.logger.error(`Invalid signaling state ${t.signalingState}.`);let e=["Reason: "+this.getReasonHeaderValue(488,"Bad Media Description")];return t.bye(void 0,{extraHeaders:e}),this.stateTransition(E.Terminated),Promise.resolve()}case a.Stable:{let i=r(e.message);if(!i)return Promise.resolve();if("render"===i.contentDisposition)return this._renderbody=i.content,this._rendertype=i.contentType,Promise.resolve();if("session"!==i.contentDisposition)return Promise.resolve();return this.setAnswer(i,s).catch(e=>{this.logger.error(e.message);let s=["Reason: "+this.getReasonHeaderValue(488,"Bad Media Description")];t.bye(void 0,{extraHeaders:s}),this.stateTransition(E.Terminated)})}case a.HaveLocalOffer:{this.logger.error(`Invalid signaling state ${t.signalingState}.`);let e=["Reason: "+this.getReasonHeaderValue(488,"Bad Media Description")];return t.bye(void 0,{extraHeaders:e}),this.stateTransition(E.Terminated),Promise.resolve()}case a.HaveRemoteOffer:{this.logger.error(`Invalid signaling state ${t.signalingState}.`);let e=["Reason: "+this.getReasonHeaderValue(488,"Bad Media Description")];return t.bye(void 0,{extraHeaders:e}),this.stateTransition(E.Terminated),Promise.resolve()}case a.Closed:default:throw Error(`Invalid signaling state ${t.signalingState}.`)}}onByeRequest(e){if(this.logger.log("Session.onByeRequest"),this.state!==E.Established){this.logger.error(`BYE received while in state ${this.state}, dropping request`);return}if(this.delegate&&this.delegate.onBye){let t=new c(e);this.delegate.onBye(t)}else e.accept();this.stateTransition(E.Terminated)}onInfoRequest(e){if(this.logger.log("Session.onInfoRequest"),this.state!==E.Established){this.logger.error(`INFO received while in state ${this.state}, dropping request`);return}if(this.delegate&&this.delegate.onInfo){let t=new m(e);this.delegate.onInfo(t)}else e.accept()}onInviteRequest(e){if(this.logger.log("Session.onInviteRequest"),this.state!==E.Established){this.logger.error(`INVITE received while in state ${this.state}, dropping request`);return}this.pendingReinviteAck=!0;let t=["Contact: "+this._contact];if(e.message.hasHeader("P-Asserted-Identity")){let t=e.message.getHeader("P-Asserted-Identity");if(!t)throw Error("Header undefined.");this._assertedIdentity=n.nameAddrHeaderParse(t)}let s={sessionDescriptionHandlerOptions:this.sessionDescriptionHandlerOptionsReInvite,sessionDescriptionHandlerModifiers:this.sessionDescriptionHandlerModifiersReInvite};this.generateResponseOfferAnswerInDialog(s).then(s=>{let i=e.accept({statusCode:200,extraHeaders:t,body:s});this.delegate&&this.delegate.onInvite&&this.delegate.onInvite(e.message,i.message,200)}).catch(s=>{if(this.logger.error(s.message),this.logger.error("Failed to handle to re-INVITE request"),!this.dialog)throw Error("Dialog undefined.");if(this.logger.error(this.dialog.signalingState),this.dialog.signalingState===a.Stable){let t=e.reject({statusCode:488});this.delegate&&this.delegate.onInvite&&this.delegate.onInvite(e.message,t.message,488);return}this.rollbackOffer().then(()=>{let t=e.reject({statusCode:488});this.delegate&&this.delegate.onInvite&&this.delegate.onInvite(e.message,t.message,488)}).catch(s=>{this.logger.error(s.message),this.logger.error("Failed to rollback offer on re-INVITE request");let i=e.reject({statusCode:488});if(this.state!==E.Terminated){if(!this.dialog)throw Error("Dialog undefined.");[].push("Reason: "+this.getReasonHeaderValue(500,"Internal Server Error")),this.dialog.bye(void 0,{extraHeaders:t}),this.stateTransition(E.Terminated)}this.delegate&&this.delegate.onInvite&&this.delegate.onInvite(e.message,i.message,488)})})}onMessageRequest(e){if(this.logger.log("Session.onMessageRequest"),this.state!==E.Established){this.logger.error(`MESSAGE received while in state ${this.state}, dropping request`);return}if(this.delegate&&this.delegate.onMessage){let t=new v(e);this.delegate.onMessage(t)}else e.accept()}onNotifyRequest(e){if(this.logger.log("Session.onNotifyRequest"),this.state!==E.Established){this.logger.error(`NOTIFY received while in state ${this.state}, dropping request`);return}if(this.onNotify){let t=new D(e);this.onNotify(t);return}if(this.delegate&&this.delegate.onNotify){let t=new D(e);this.delegate.onNotify(t)}else e.accept()}onPrackRequest(e){if(this.logger.log("Session.onPrackRequest"),this.state!==E.Established){this.logger.error(`PRACK received while in state ${this.state}, dropping request`);return}throw Error("Unimplemented.")}onReferRequest(e){if(this.logger.log("Session.onReferRequest"),this.state!==E.Established){this.logger.error(`REFER received while in state ${this.state}, dropping request`);return}if(!e.message.hasHeader("refer-to")){this.logger.warn("Invalid REFER packet. A refer-to header is required. Rejecting."),e.reject();return}let t=new H(e,this);this.delegate&&this.delegate.onRefer?this.delegate.onRefer(t):(this.logger.log("No delegate available to handle REFER, automatically accepting and following."),t.accept().then(()=>t.makeInviter(this._referralInviterOptions).invite()).catch(e=>{this.logger.error(e.message)}))}generateResponseOfferAnswer(e,t){if(this.dialog)return this.generateResponseOfferAnswerInDialog(t);let s=r(e.message);return s&&"session"===s.contentDisposition?this.setOfferAndGetAnswer(s,t):this.getOffer(t)}generateResponseOfferAnswerInDialog(e){if(!this.dialog)throw Error("Dialog undefined.");switch(this.dialog.signalingState){case a.Initial:return this.getOffer(e);case a.HaveLocalOffer:return Promise.resolve(void 0);case a.HaveRemoteOffer:if(!this.dialog.offer)throw Error(`Session offer undefined in signaling state ${this.dialog.signalingState}.`);return this.setOfferAndGetAnswer(this.dialog.offer,e);case a.Stable:if(this.state!==E.Established)return Promise.resolve(void 0);return this.getOffer(e);case a.Closed:default:throw Error(`Invalid signaling state ${this.dialog.signalingState}.`)}}getOffer(e){let t=this.setupSessionDescriptionHandler(),s=e.sessionDescriptionHandlerOptions,r=e.sessionDescriptionHandlerModifiers;try{return t.getDescription(s,r).then(e=>i(e)).catch(e=>{this.logger.error("Session.getOffer: SDH getDescription rejected...");let t=e instanceof Error?e:Error("Session.getOffer unknown error.");throw this.logger.error(t.message),t})}catch(t){this.logger.error("Session.getOffer: SDH getDescription threw...");let e=t instanceof Error?t:Error(t);return this.logger.error(e.message),Promise.reject(e)}}rollbackOffer(){let e=this.setupSessionDescriptionHandler();if(void 0===e.rollbackDescription)return Promise.resolve();try{return e.rollbackDescription().catch(e=>{this.logger.error("Session.rollbackOffer: SDH rollbackDescription rejected...");let t=e instanceof Error?e:Error("Session.rollbackOffer unknown error.");throw this.logger.error(t.message),t})}catch(t){this.logger.error("Session.rollbackOffer: SDH rollbackDescription threw...");let e=t instanceof Error?t:Error(t);return this.logger.error(e.message),Promise.reject(e)}}setAnswer(e,t){let s=this.setupSessionDescriptionHandler(),i=t.sessionDescriptionHandlerOptions,r=t.sessionDescriptionHandlerModifiers;try{if(!s.hasDescription(e.contentType))return Promise.reject(new p)}catch(t){this.logger.error("Session.setAnswer: SDH hasDescription threw...");let e=t instanceof Error?t:Error(t);return this.logger.error(e.message),Promise.reject(e)}try{return s.setDescription(e.content,i,r).catch(e=>{this.logger.error("Session.setAnswer: SDH setDescription rejected...");let t=e instanceof Error?e:Error("Session.setAnswer unknown error.");throw this.logger.error(t.message),t})}catch(t){this.logger.error("Session.setAnswer: SDH setDescription threw...");let e=t instanceof Error?t:Error(t);return this.logger.error(e.message),Promise.reject(e)}}setOfferAndGetAnswer(e,t){let s=this.setupSessionDescriptionHandler(),r=t.sessionDescriptionHandlerOptions,n=t.sessionDescriptionHandlerModifiers;try{if(!s.hasDescription(e.contentType))return Promise.reject(new p)}catch(t){this.logger.error("Session.setOfferAndGetAnswer: SDH hasDescription threw...");let e=t instanceof Error?t:Error(t);return this.logger.error(e.message),Promise.reject(e)}try{return s.setDescription(e.content,r,n).then(()=>s.getDescription(r,n)).then(e=>i(e)).catch(e=>{this.logger.error("Session.setOfferAndGetAnswer: SDH setDescription or getDescription rejected...");let t=e instanceof Error?e:Error("Session.setOfferAndGetAnswer unknown error.");throw this.logger.error(t.message),t})}catch(t){this.logger.error("Session.setOfferAndGetAnswer: SDH setDescription or getDescription threw...");let e=t instanceof Error?t:Error(t);return this.logger.error(e.message),Promise.reject(e)}}setSessionDescriptionHandler(e){if(this._sessionDescriptionHandler)throw Error("Session description handler defined.");this._sessionDescriptionHandler=e}setupSessionDescriptionHandler(){var e;return this._sessionDescriptionHandler||(this._sessionDescriptionHandler=this.sessionDescriptionHandlerFactory(this,this.userAgent.configuration.sessionDescriptionHandlerFactoryOptions),(null===(e=this.delegate)||void 0===e?void 0:e.onSessionDescriptionHandler)&&this.delegate.onSessionDescriptionHandler(this._sessionDescriptionHandler,!1)),this._sessionDescriptionHandler}stateTransition(e){let t=()=>{throw Error(`Invalid state transition from ${this._state} to ${e}`)};switch(this._state){case E.Initial:e!==E.Establishing&&e!==E.Established&&e!==E.Terminating&&e!==E.Terminated&&t();break;case E.Establishing:e!==E.Established&&e!==E.Terminating&&e!==E.Terminated&&t();break;case E.Established:e!==E.Terminating&&e!==E.Terminated&&t();break;case E.Terminating:e!==E.Terminated&&t();break;case E.Terminated:t();break;default:throw Error("Unrecognized state.")}this._state=e,this.logger.log(`Session ${this.id} transitioned to state ${this._state}`),this._stateEventEmitter.emit(this._state),e===E.Terminated&&this.dispose()}copyRequestOptions(e={}){let t=e.extraHeaders?e.extraHeaders.slice():void 0,s=e.body?{contentDisposition:e.body.contentDisposition||"render",contentType:e.body.contentType||"text/plain",content:e.body.content||""}:void 0;return{extraHeaders:t,body:s}}getReasonHeaderValue(e,t){let s=d(e);return!s&&t&&(s=t),"SIP;cause="+e+';text="'+s+'"'}referExtraHeaders(e){let t=[];return t.push("Referred-By: <"+this.userAgent.configuration.uri+">"),t.push("Contact: "+this._contact),t.push("Allow: "+["ACK","CANCEL","INVITE","MESSAGE","BYE","OPTIONS","INFO","NOTIFY","REFER"].toString()),t.push("Refer-To: "+e),t}referToString(e){let t;if(e instanceof l)t=e.toString();else{if(!e.dialog)throw Error("Dialog undefined.");let s=e.remoteIdentity.friendlyName,i=e.dialog.remoteTarget.toString(),r=e.dialog.callId,n=e.dialog.remoteTag,o=e.dialog.localTag,a=encodeURIComponent(`${r};to-tag=${n};from-tag=${o}`);t=`"${s}" <${i}?Replaces=${a}>`}return t}}}
//# sourceMappingURL=/dynamic/node_modules/sip.js/lib/api/9e27e61d1676b10d201dadd8759bcc83713e85c5.map

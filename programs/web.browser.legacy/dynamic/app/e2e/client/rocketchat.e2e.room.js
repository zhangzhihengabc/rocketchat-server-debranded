function module(e,t,r){var n,s,i,o,a,c,u,p,h,f,l,d,y,E,m,g,S,b,x,k,v,R,A,D,I,w,K,T,P,O,_,C,N,Y,G,U,M,B=["_id"];r.link("@babel/runtime/helpers/objectSpread2",{default:function(e){s=e}},0),r.link("@babel/runtime/helpers/typeof",{default:function(e){i=e}},1),r.link("@babel/runtime/helpers/slicedToArray",{default:function(e){o=e}},2),r.link("@babel/runtime/helpers/objectWithoutProperties",{default:function(e){a=e}},3),r.link("@babel/runtime/regenerator",{default:function(e){c=e}},4),r.link("@babel/runtime/helpers/createClass",{default:function(e){u=e}},5),r.link("@babel/runtime/helpers/inheritsLoose",{default:function(e){p=e}},6),r.export({E2ERoom:function(){return W}}),r.link("@rocket.chat/base64",{Base64:function(e){h=e}},0),r.link("@rocket.chat/emitter",{Emitter:function(e){f=e}},1),r.link("@rocket.chat/random",{Random:function(e){l=e}},2),r.link("ejson",{default:function(e){d=e}},3),r.link("../../../client/lib/RoomManager",{RoomManager:function(e){y=e}},4),r.link("../../../client/lib/rooms/roomCoordinator",{roomCoordinator:function(e){E=e}},5),r.link("../../../definition/IRoomTypeConfig",{RoomSettingsEnum:function(e){m=e}},6),r.link("../../models/client",{ChatRoom:function(e){g=e},Subscriptions:function(e){S=e},Messages:function(e){b=e}},7),r.link("../../notifications/client",{Notifications:function(e){x=e}},8),r.link("../../utils/client/lib/SDKClient",{sdk:function(e){k=e}},9),r.link("./E2ERoomState",{E2ERoomState:function(e){v=e}},10),r.link("./helper",{toString:function(e){R=e},toArrayBuffer:function(e){A=e},joinVectorAndEcryptedData:function(e){D=e},splitVectorAndEcryptedData:function(e){I=e},encryptRSA:function(e){w=e},encryptAES:function(e){K=e},decryptRSA:function(e){T=e},decryptAES:function(e){P=e},generateAESKey:function(e){O=e},exportJWKKey:function(e){_=e},importAESKey:function(e){C=e},importRSAKey:function(e){N=e},readFileAsArrayBuffer:function(e){Y=e}},11),r.link("./logger",{log:function(e){G=e},logError:function(e){U=e}},12),r.link("./rocketchat.e2e",{e2e:function(e){M=e}},13);var F=Symbol("keyID"),V=Symbol("PAUSED"),L=((n={})[v.NOT_STARTED]=[v.ESTABLISHING,v.DISABLED,v.KEYS_RECEIVED],n[v.READY]=[v.DISABLED],n[v.ERROR]=[v.KEYS_RECEIVED,v.NOT_STARTED],n[v.WAITING_KEYS]=[v.KEYS_RECEIVED,v.ERROR,v.DISABLED],n[v.ESTABLISHING]=[v.READY,v.KEYS_RECEIVED,v.ERROR,v.DISABLED,v.WAITING_KEYS],n),W=function(e){function t(t,r,n){var s;return(s=e.call(this)||this).state=void 0,s[V]=void 0,s.userId=t,s.roomId=r,s.typeOfRoom=n,s.once(v.READY,function(){return s.decryptPendingMessages()}),s.once(v.READY,function(){return s.decryptSubscription()}),s.on("STATE_CHANGED",function(e){s.roomId===y.opened&&s.log("[PREV: "+e+"]","State CHANGED")}),s.on("STATE_CHANGED",function(){return s.handshake()}),s.setState(v.NOT_STARTED),s}p(t,e);var r=t.prototype;return r.log=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];G.apply(void 0,["E2E ROOM { state: "+this.state+", rid: "+this.roomId+" }"].concat(t))},r.error=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];U.apply(void 0,["E2E ROOM { state: "+this.state+", rid: "+this.roomId+" }"].concat(t))},r.setState=function(e){var t=this.state,r=t===e?e===v.ERROR:!!(!(t in L)||L[t].includes(e))&&e;if(!r){this.error("invalid state "+t+" -> "+e);return}this.state=r,this.log(t,"->",r),this.emit("STATE_CHANGED",t,r,this),this.emit(r,this)},r.isReady=function(){return this.state===v.READY},r.isDisabled=function(){return this.state===v.DISABLED},r.enable=function(){this.state!==v.READY&&this.setState(v.READY)},r.disable=function(){this.setState(v.DISABLED)},r.pause=function(){this.log("PAUSED",this[V],"->",!0),this[V]=!0,this.emit("PAUSED",!0)},r.resume=function(){this.log("PAUSED",this[V],"->",!1),this[V]=!1,this.emit("PAUSED",!1)},r.keyReceived=function(){this.setState(v.KEYS_RECEIVED)},r.shouldConvertSentMessages=function(e){var t=this;return c.async(function(r){for(;;)switch(r.prev=r.next){case 0:if(!(!this.isReady()||this[V])){r.next=2;break}return r.abrupt("return",!1);case 2:if(void 0!==this[V]){r.next=4;break}return r.abrupt("return",new Promise(function(e){t.once("PAUSED",e)}));case 4:if("/"!==e.msg[0]){r.next=6;break}return r.abrupt("return",!1);case 6:return r.abrupt("return",!0);case 7:case"end":return r.stop()}},null,this,null,Promise)},r.shouldConvertReceivedMessages=function(){return this.isReady()},r.isWaitingKeys=function(){return this.state===v.WAITING_KEYS},r.decryptSubscription=function(){var e,t,r;return c.async(function(n){for(;;)switch(n.prev=n.next){case 0:return t=S.findOne({rid:this.roomId}),n.next=3,c.awrap((null===(e=t.lastMessage)||void 0===e?void 0:e.msg)&&this.decrypt(t.lastMessage.msg));case 3:if(null!=(r=n.sent)&&r.text){n.next=7;break}return this.log("decryptSubscriptions nothing to do"),n.abrupt("return");case 7:S.update({_id:t._id},{$set:{"lastMessage.msg":r.text,"lastMessage.e2e":"done"}}),this.log("decryptSubscriptions Done");case 9:case"end":return n.stop()}},null,this,null,Promise)},r.decryptPendingMessages=function(){var e=this;return c.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",b.find({rid:this.roomId,t:"e2e",e2e:"pending"}).forEach(function t(t){var r,n;return c.async(function s(s){for(;;)switch(s.prev=s.next){case 0:return r=t._id,n=a(t,B),s.t0=b,s.t1={_id:r},s.next=5,c.awrap(e.decryptMessage(n));case 5:s.t2=s.sent,s.t0.update.call(s.t0,s.t1,s.t2);case 7:case"end":return s.stop()}},null,null,null,Promise)}));case 1:case"end":return t.stop()}},null,this,null,Promise)},r.handshake=function(){var e,t;return c.async(function(r){for(;;)switch(r.prev=r.next){case 0:if(!(this.state!==v.KEYS_RECEIVED&&this.state!==v.NOT_STARTED)){r.next=2;break}return r.abrupt("return");case 2:if(this.setState(v.ESTABLISHING),r.prev=3,!(e=S.findOne({rid:this.roomId}).E2EKey)){r.next=10;break}return r.next=8,c.awrap(this.importGroupKey(e));case 8:case 23:return this.setState(v.READY),r.abrupt("return");case 10:r.next=17;break;case 12:return r.prev=12,r.t0=r.catch(3),this.setState(v.ERROR),this.error("Error fetching group key: ",r.t0),r.abrupt("return");case 17:if(r.prev=17,(t=g.findOne({_id:this.roomId})).e2eKeyId){r.next=25;break}return this.setState(v.CREATING_KEYS),r.next=23,c.awrap(this.createGroupKey());case 25:this.setState(v.WAITING_KEYS),this.log("Requesting room key"),x.notifyUsersOfRoom(this.roomId,"e2ekeyRequest",this.roomId,t.e2eKeyId),r.next=33;break;case 30:r.prev=30,r.t1=r.catch(17),this.setState(v.ERROR);case 33:case"end":return r.stop()}},null,this,[[3,12],[17,30]],Promise)},r.isSupportedRoomType=function(e){return E.getRoomDirectives(e).allowRoomSettingChange({},m.E2E)},r.importGroupKey=function(e){var t,r;return c.async(function(n){for(;;)switch(n.prev=n.next){case 0:return this.log("Importing room key ->",this.roomId),e=e.slice(12),e=h.decode(e),n.prev=3,n.next=6,c.awrap(T(M.privateKey,e));case 6:t=n.sent,this.sessionKeyExportedString=R(t),n.next=14;break;case 10:return n.prev=10,n.t0=n.catch(3),this.error("Error decrypting group key: ",n.t0),n.abrupt("return",!1);case 14:return this.keyID=h.encode(this.sessionKeyExportedString).slice(0,12),n.prev=15,n.next=18,c.awrap(C(JSON.parse(this.sessionKeyExportedString)));case 18:r=n.sent,this.groupSessionKey=r,n.next=26;break;case 22:return n.prev=22,n.t1=n.catch(15),this.error("Error importing group key: ",n.t1),n.abrupt("return",!1);case 26:return n.abrupt("return",!0);case 27:case"end":return n.stop()}},null,this,[[3,10],[15,22]],Promise)},r.createGroupKey=function(){var e;return c.async(function(t){for(;;)switch(t.prev=t.next){case 0:return this.log("Creating room key"),t.prev=1,t.next=4,c.awrap(O());case 4:this.groupSessionKey=t.sent,t.next=11;break;case 7:throw t.prev=7,t.t0=t.catch(1),console.error("Error generating group key: ",t.t0),t.t0;case 11:return t.prev=11,t.next=14,c.awrap(_(this.groupSessionKey));case 14:return e=t.sent,this.sessionKeyExportedString=JSON.stringify(e),this.keyID=h.encode(this.sessionKeyExportedString).slice(0,12),t.next=19,c.awrap(k.call("e2e.setRoomKeyID",this.roomId,this.keyID));case 19:return t.next=21,c.awrap(this.encryptKeyForOtherParticipants());case 21:t.next=27;break;case 23:throw t.prev=23,t.t1=t.catch(11),this.error("Error exporting group key: ",t.t1),t.t1;case 27:case"end":return t.stop()}},null,this,[[1,7],[11,23]],Promise)},r.encryptKeyForOtherParticipants=function(){var e=this;return c.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,c.awrap(k.call("e2e.getUsersOfRoomWithoutKey",this.roomId));case 3:t.sent.users.forEach(function(t){return e.encryptForParticipant(t)}),t.next=11;break;case 8:return t.prev=8,t.t0=t.catch(0),t.abrupt("return",this.error("Error getting room users: ",t.t0));case 11:case"end":return t.stop()}},null,this,[[0,8]],Promise)},r.encryptForParticipant=function(e){var t,r;return c.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,c.awrap(N(JSON.parse(e.e2e.public_key),["encrypt"]));case 3:t=n.sent,n.next=9;break;case 6:return n.prev=6,n.t0=n.catch(0),n.abrupt("return",this.error("Error importing user key: ",n.t0));case 9:return n.prev=9,n.next=12,c.awrap(w(t,A(this.sessionKeyExportedString)));case 12:return r=n.sent,n.next=15,c.awrap(k.call("e2e.updateGroupKey",this.roomId,e._id,this.keyID+h.encode(new Uint8Array(r))));case 15:n.next=20;break;case 17:return n.prev=17,n.t1=n.catch(9),n.abrupt("return",this.error("Error encrypting user key: ",n.t1));case 20:case"end":return n.stop()}},null,this,[[0,6],[9,17]],Promise)},r.encryptFile=function(e){var t,r,n,s,i;return c.async(function(o){for(;;)switch(o.prev=o.next){case 0:if(this.isSupportedRoomType(this.typeOfRoom)){o.next=2;break}return o.abrupt("return");case 2:return o.next=4,c.awrap(Y(e));case 4:return t=o.sent,r=crypto.getRandomValues(new Uint8Array(16)),o.prev=6,o.next=9,c.awrap(K(r,this.groupSessionKey,t));case 9:n=o.sent,o.next=15;break;case 12:return o.prev=12,o.t0=o.catch(6),o.abrupt("return",this.error("Error encrypting group key: ",o.t0));case 15:return s=D(r,n),i=new File([A(d.stringify(s))],e.name),o.abrupt("return",i);case 18:case"end":return o.stop()}},null,this,[[6,12]],Promise)},r.decryptFile=function(e){var t,r,n;return c.async(function(s){for(;;)switch(s.prev=s.next){case 0:if(!("{"!==e[0])){s.next=2;break}return s.abrupt("return");case 2:return r=(t=o(I(d.parse(e)),2))[0],n=t[1],s.prev=3,s.next=6,c.awrap(P(r,this.groupSessionKey,n));case 6:return s.abrupt("return",s.sent);case 9:return s.prev=9,s.t0=s.catch(3),this.error("Error decrypting file: ",s.t0),s.abrupt("return",!1);case 13:case"end":return s.stop()}},null,this,[[3,9]],Promise)},r.encryptText=function(e){var t,r;return c.async(function(n){for(;;)switch(n.prev=n.next){case 0:if("function"==typeof e||"object"===i(e)&&e||(e=new TextEncoder("UTF-8").encode(d.stringify({text:e,ack:l.id((l.fraction()+1)*20)}))),this.isSupportedRoomType(this.typeOfRoom)){n.next=3;break}return n.abrupt("return",e);case 3:return t=crypto.getRandomValues(new Uint8Array(16)),n.prev=4,n.next=7,c.awrap(K(t,this.groupSessionKey,e));case 7:r=n.sent,n.next=13;break;case 10:return n.prev=10,n.t0=n.catch(4),n.abrupt("return",this.error("Error encrypting message: ",n.t0));case 13:return n.abrupt("return",this.keyID+h.encode(D(t,r)));case 14:case"end":return n.stop()}},null,this,[[4,10]],Promise)},r.encrypt=function(e){var t=new Date,r=new TextEncoder("UTF-8").encode(d.stringify({_id:e._id,text:e.msg,userId:this.userId,ts:t}));return this.encryptText(r)},r.decryptMessage=function(e){var t;return c.async(function(r){for(;;)switch(r.prev=r.next){case 0:if(!("e2e"!==e.t||"done"===e.e2e)){r.next=2;break}return r.abrupt("return",e);case 2:return r.next=4,c.awrap(this.decrypt(e.msg));case 4:if(null!=(t=r.sent)&&t.text){r.next=7;break}return r.abrupt("return",e);case 7:return r.abrupt("return",s(s({},e),{},{msg:t.text,e2e:"done"}));case 8:case"end":return r.stop()}},null,this,null,Promise)},r.decrypt=function(e){var t,r,n,s;return c.async(function(i){for(;;)switch(i.prev=i.next){case 0:if(this.isSupportedRoomType(this.typeOfRoom)){i.next=2;break}return i.abrupt("return",e);case 2:if(!(e.slice(0,12)!==this.keyID)){i.next=5;break}return i.abrupt("return",e);case 5:return e=e.slice(12),r=(t=o(I(h.decode(e)),2))[0],n=t[1],i.prev=7,i.next=10,c.awrap(P(r,this.groupSessionKey,n));case 10:return s=i.sent,i.abrupt("return",d.parse(new TextDecoder("UTF-8").decode(new Uint8Array(s))));case 14:return i.prev=14,i.t0=i.catch(7),i.abrupt("return",this.error("Error decrypting message: ",i.t0,e));case 17:case"end":return i.stop()}},null,this,[[7,14]],Promise)},r.provideKeyToUser=function(e){this.keyID===e&&this.encryptKeyForOtherParticipants()},u(t,[{key:"keyID",get:function(){return this[F]},set:function(e){this[F]=e}}]),t}(f)}
//# sourceMappingURL=/dynamic/app/e2e/client/da5ef5288f027fd7448bdbeb145a063797e30df1.map

function module(e,t,r){var n,s,a,i,o,c,u,l,p,d,f,y,h,v,b,m,g,k,w,x,_,P,S,K,E,A,I,R,M,C,B,F,U,q,D,L,j,Q,V,J,N,O,T=["_id"];r.link("@babel/runtime/helpers/objectWithoutProperties",{default:function(e){n=e}},0),r.link("@babel/runtime/regenerator",{default:function(e){s=e}},1),r.link("@babel/runtime/helpers/objectSpread2",{default:function(e){a=e}},2),r.link("@babel/runtime/helpers/slicedToArray",{default:function(e){i=e}},3),r.link("@babel/runtime/helpers/inheritsLoose",{default:function(e){o=e}},4),r.export({e2e:function(){return G}}),r.link("querystring",{default:function(e){c=e}},0),r.link("url",{default:function(e){u=e}},1),r.link("@rocket.chat/core-typings",{isE2EEMessage:function(e){l=e}},2),r.link("@rocket.chat/emitter",{Emitter:function(e){p=e}},3),r.link("ejson",{default:function(e){d=e}},4),r.link("meteor/meteor",{Meteor:function(e){f=e}},5),r.link("meteor/reactive-var",{ReactiveVar:function(e){y=e}},6),r.link("../../../client/lib/banners",{"*":function(e){h=e}},7),r.link("../../../client/lib/imperativeModal",{imperativeModal:function(e){v=e}},8),r.link("../../../client/lib/utils/mapMessageFromApi",{mapMessageFromApi:function(e){b=e}},9),r.link("../../../client/lib/utils/waitUntilFind",{waitUntilFind:function(e){m=e}},10),r.link("../../../client/views/e2e/EnterE2EPasswordModal",{default:function(e){g=e}},11),r.link("../../../client/views/e2e/SaveE2EPasswordModal",{default:function(e){k=e}},12),r.link("../../../lib/createQuoteAttachment",{createQuoteAttachment:function(e){w=e}},13),r.link("../../../lib/getMessageUrlRegex",{getMessageUrlRegex:function(e){x=e}},14),r.link("../../models/client",{ChatRoom:function(e){_=e},Subscriptions:function(e){P=e},Messages:function(e){S=e}},15),r.link("../../settings/client",{settings:function(e){K=e}},16),r.link("../../utils/client",{getUserAvatarURL:function(e){E=e}},17),r.link("../../utils/client/lib/SDKClient",{sdk:function(e){A=e}},18),r.link("../../utils/lib/i18n",{t:function(e){I=e}},19),r.link("./helper",{toString:function(e){R=e},toArrayBuffer:function(e){M=e},joinVectorAndEcryptedData:function(e){C=e},splitVectorAndEcryptedData:function(e){B=e},encryptAES:function(e){F=e},decryptAES:function(e){U=e},generateRSAKey:function(e){q=e},exportJWKKey:function(e){D=e},importRSAKey:function(e){L=e},importRawKey:function(e){j=e},deriveKey:function(e){Q=e},generateMnemonicPhrase:function(e){V=e}},20),r.link("./logger",{log:function(e){J=e},logError:function(e){N=e}},21),r.link("./rocketchat.e2e.room",{E2ERoom:function(e){O=e}},22),r.link("./events.js");var W=!1,G=new(function(e){function t(){var t;return(t=e.call(this)||this).started=void 0,t.enabled=void 0,t._ready=void 0,t.instancesByRoomId=void 0,t.db_public_key=void 0,t.db_private_key=void 0,t.privateKey=void 0,t.started=!1,t.enabled=new y(!1),t._ready=new y(!1),t.instancesByRoomId={},t.on("ready",function(){return s.async(function(e){for(;;)switch(e.prev=e.next){case 0:return t._ready.set(!0),t.log("startClient -> Done"),t.log("decryptSubscriptions"),e.next=5,s.awrap(t.decryptSubscriptions());case 5:t.log("decryptSubscriptions -> Done");case 6:case"end":return e.stop()}},null,null,null,Promise)}),t}o(t,e);var r=t.prototype;return r.log=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];J.apply(void 0,["E2E"].concat(t))},r.error=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];N.apply(void 0,["E2E"].concat(t))},r.isEnabled=function(){return this.enabled.get()},r.isReady=function(){return this.enabled.get()&&this._ready.get()},r.getInstanceByRoomId=function(e){var t;return s.async(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,s.awrap(m(function(){return _.findOne({_id:e})}));case 2:if(!("d"!==(t=r.sent).t&&"p"!==t.t)){r.next=5;break}return r.abrupt("return",null);case 5:if(!(!0!==t.encrypted&&!t.e2eKeyId)){r.next=7;break}return r.abrupt("return",null);case 7:return this.instancesByRoomId[e]||(this.instancesByRoomId[e]=new O(f.userId(),e,t.t)),r.abrupt("return",this.instancesByRoomId[e]);case 9:case"end":return r.stop()}},null,this,null,Promise)},r.removeInstanceByRoomId=function(e){delete this.instancesByRoomId[e]},r.persistKeys=function(e,t){var r,n,a;return s.async(function(i){for(;;)switch(i.prev=i.next){case 0:if(r=e.public_key,n=e.private_key,!("string"!=typeof r||"string"!=typeof n)){i.next=3;break}throw Error("Failed to persist keys as they are not strings.");case 3:return i.next=5,s.awrap(this.encodePrivateKey(n,t));case 5:if(a=i.sent){i.next=8;break}throw Error("Failed to encode private key with provided password.");case 8:return i.next=10,s.awrap(A.rest.post("/v1/e2e.setUserPublicAndPrivateKeys",{public_key:r,private_key:a}));case 10:case"end":return i.stop()}},null,this,null,Promise)},r.acceptSuggestedKey=function(e){return s.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,s.awrap(A.rest.post("/v1/e2e.acceptSuggestedGroupKey",{rid:e}));case 2:case"end":return t.stop()}},null,null,null,Promise)},r.rejectSuggestedKey=function(e){return s.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,s.awrap(A.rest.post("/v1/e2e.rejectSuggestedGroupKey",{rid:e}));case 2:case"end":return t.stop()}},null,null,null,Promise)},r.getKeysFromLocalStorage=function(){return{public_key:f._localStorage.getItem("public_key"),private_key:f._localStorage.getItem("private_key")}},r.startClient=function(){var e,t,r,n,a=this;return s.async(function(i){for(;;)switch(i.prev=i.next){case 0:if(!this.started){i.next=2;break}return i.abrupt("return");case 2:return this.log("startClient -> STARTED"),this.started=!0,t=(e=this.getKeysFromLocalStorage()).public_key,r=e.private_key,i.next=7,s.awrap(this.loadKeysFromDB());case 7:if(!t&&this.db_public_key&&(t=this.db_public_key),!(!r&&this.db_private_key)){i.next=21;break}return i.prev=9,i.next=12,s.awrap(this.decodePrivateKey(this.db_private_key));case 12:r=i.sent,i.next=21;break;case 15:return i.prev=15,i.t0=i.catch(9),this.started=!1,W=!0,this.openAlert({title:"Wasn't possible to decode your encryption key to be imported.",html:"<div>Your encryption password seems wrong. Click here to try again.</div>",modifiers:["large","danger"],closable:!0,icon:"key",action:function e(){return s.async(function e(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s.awrap(a.startClient());case 2:a.closeAlert();case 3:case"end":return e.stop()}},null,null,null,Promise)}}),i.abrupt("return");case 21:if(!(t&&r)){i.next=26;break}return i.next=24,s.awrap(this.loadKeys({public_key:t,private_key:r}));case 24:i.next=28;break;case 26:return i.next=28,s.awrap(this.createAndLoadKeys());case 28:if(!(!this.db_public_key||!this.db_private_key)){i.next=38;break}return i.t1=s,i.t2=this,i.t3=this.getKeysFromLocalStorage(),i.next=34,s.awrap(this.createRandomPassword());case 34:return i.t4=i.sent,i.t5=i.t2.persistKeys.call(i.t2,i.t3,i.t4),i.next=38,i.t1.awrap.call(i.t1,i.t5);case 38:(n=f._localStorage.getItem("e2e.randomPassword"))&&this.openAlert({title:function(){return I("Save_your_encryption_password")},html:function(){return I("Click_here_to_view_and_copy_your_password")},modifiers:["large"],closable:!1,icon:"key",action:function(){v.open({component:k,props:{randomPassword:n,onClose:v.close,onCancel:function(){a.closeAlert(),v.close()},onConfirm:function(){f._localStorage.removeItem("e2e.randomPassword"),a.closeAlert(),v.close()}}})}}),this.emit("ready");case 41:case"end":return i.stop()}},null,this,[[9,15]],Promise)},r.stopClient=function(){return s.async(function(e){for(;;)switch(e.prev=e.next){case 0:this.log("-> Stop Client"),this.closeAlert(),f._localStorage.removeItem("public_key"),f._localStorage.removeItem("private_key"),this.instancesByRoomId={},this.privateKey=void 0,this.enabled.set(!1),this._ready.set(!1),this.started=!1;case 9:case"end":return e.stop()}},null,this,null,Promise)},r.changePassword=function(e){return s.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,s.awrap(this.persistKeys(this.getKeysFromLocalStorage(),e));case 2:f._localStorage.getItem("e2e.randomPassword")&&f._localStorage.setItem("e2e.randomPassword",e);case 3:case"end":return t.stop()}},null,this,null,Promise)},r.loadKeysFromDB=function(){var e,t,r;return s.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,s.awrap(A.rest.get("/v1/e2e.fetchMyKeys"));case 3:t=(e=n.sent).public_key,r=e.private_key,this.db_public_key=t,this.db_private_key=r,n.next=13;break;case 10:return n.prev=10,n.t0=n.catch(0),n.abrupt("return",this.error("Error fetching RSA keys: ",n.t0));case 13:case"end":return n.stop()}},null,this,[[0,10]],Promise)},r.loadKeys=function(e){var t,r;return s.async(function(n){for(;;)switch(n.prev=n.next){case 0:return t=e.public_key,r=e.private_key,f._localStorage.setItem("public_key",t),n.prev=2,n.next=5,s.awrap(L(d.parse(r),["decrypt"]));case 5:this.privateKey=n.sent,f._localStorage.setItem("private_key",r),n.next=12;break;case 9:return n.prev=9,n.t0=n.catch(2),n.abrupt("return",this.error("Error importing private key: ",n.t0));case 12:case"end":return n.stop()}},null,this,[[2,9]],Promise)},r.createAndLoadKeys=function(){var e,t,r;return s.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,s.awrap(q());case 3:e=n.sent,this.privateKey=e.privateKey,n.next=10;break;case 7:return n.prev=7,n.t0=n.catch(0),n.abrupt("return",this.error("Error generating key: ",n.t0));case 10:return n.prev=10,n.next=13,s.awrap(D(e.publicKey));case 13:t=n.sent,f._localStorage.setItem("public_key",JSON.stringify(t)),n.next=20;break;case 17:return n.prev=17,n.t1=n.catch(10),n.abrupt("return",this.error("Error exporting public key: ",n.t1));case 20:return n.prev=20,n.next=23,s.awrap(D(e.privateKey));case 23:r=n.sent,f._localStorage.setItem("private_key",JSON.stringify(r)),n.next=30;break;case 27:return n.prev=27,n.t2=n.catch(20),n.abrupt("return",this.error("Error exporting private key: ",n.t2));case 30:return n.next=32,s.awrap(this.requestSubscriptionKeys());case 32:case"end":return n.stop()}},null,this,[[0,7],[10,17],[20,27]],Promise)},r.requestSubscriptionKeys=function(){return s.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s.awrap(A.call("e2e.requestSubscriptionKeys"));case 2:case"end":return e.stop()}},null,null,null,Promise)},r.createRandomPassword=function(){var e;return s.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,s.awrap(V(5));case 2:return e=t.sent,f._localStorage.setItem("e2e.randomPassword",e),t.abrupt("return",e);case 5:case"end":return t.stop()}},null,null,null,Promise)},r.encodePrivateKey=function(e,t){var r,n,a;return s.async(function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,s.awrap(this.getMasterKey(t));case 2:return r=i.sent,n=crypto.getRandomValues(new Uint8Array(16)),i.prev=4,i.next=7,s.awrap(F(n,r,M(e)));case 7:return a=i.sent,i.abrupt("return",d.stringify(C(n,a)));case 11:return i.prev=11,i.t0=i.catch(4),i.abrupt("return",this.error("Error encrypting encodedPrivateKey: ",i.t0));case 14:case"end":return i.stop()}},null,this,[[4,11]],Promise)},r.getMasterKey=function(e){var t;return s.async(function(r){for(;;)switch(r.prev=r.next){case 0:return null==e&&alert("You should provide a password"),r.prev=1,r.next=4,s.awrap(j(M(e)));case 4:t=r.sent,r.next=10;break;case 7:return r.prev=7,r.t0=r.catch(1),r.abrupt("return",this.error("Error creating a key based on user password: ",r.t0));case 10:return r.prev=10,r.next=13,s.awrap(Q(M(f.userId()),t));case 13:return r.abrupt("return",r.sent);case 16:return r.prev=16,r.t1=r.catch(10),r.abrupt("return",this.error("Error deriving baseKey: ",r.t1));case 19:case"end":return r.stop()}},null,this,[[1,7],[10,16]],Promise)},r.requestPassword=function(){var e=this;return s.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise(function(t){var r=function(){v.open({component:g,props:{onClose:v.close,onCancel:function(){W=!1,e.closeAlert(),v.close()},onConfirm:function(r){t(r),e.closeAlert(),v.close()}}})};W?r():e.openAlert({title:function(){return I("Enter_your_E2E_password")},html:function(){return I("Click_here_to_enter_your_encryption_password")},modifiers:["large"],closable:!1,icon:"key",action:function(){r()}})}));case 1:case"end":return t.stop()}},null,null,null,Promise)},r.decodePrivateKey=function(e){var t,r,n,a,o,c;return s.async(function(u){for(;;)switch(u.prev=u.next){case 0:return u.next=2,s.awrap(this.requestPassword());case 2:return t=u.sent,u.next=5,s.awrap(this.getMasterKey(t));case 5:return r=u.sent,a=(n=i(B(d.parse(e)),2))[0],o=n[1],u.prev=7,u.next=10,s.awrap(U(a,r,o));case 10:return c=u.sent,u.abrupt("return",R(c));case 14:throw u.prev=14,u.t0=u.catch(7),Error("E2E -> Error decrypting private key");case 17:case"end":return u.stop()}},null,this,[[7,14]],Promise)},r.decryptMessage=function(e){var t,r,n,i;return s.async(function(o){for(;;)switch(o.prev=o.next){case 0:if(!(!l(e)||"done"===e.e2e)){o.next=2;break}return o.abrupt("return",e);case 2:return o.next=4,s.awrap(this.getInstanceByRoomId(e.rid));case 4:if(t=o.sent){o.next=7;break}return o.abrupt("return",e);case 7:return o.next=9,s.awrap(t.decrypt(e.msg));case 9:if(r=o.sent){o.next=12;break}return o.abrupt("return",e);case 12:return n=a(a({},e),{},{msg:r.text,e2e:"done"}),o.next=15,s.awrap(this.parseQuoteAttachment(n));case 15:return i=o.sent,o.abrupt("return",i);case 17:case"end":return o.stop()}},null,this,null,Promise)},r.decryptPendingMessages=function(){var e=this;return s.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",S.find({t:"e2e",e2e:"pending"}).forEach(function t(t){var r,a;return s.async(function i(i){for(;;)switch(i.prev=i.next){case 0:return r=t._id,a=n(t,T),i.t0=S,i.t1={_id:r},i.next=5,s.awrap(e.decryptMessage(a));case 5:i.t2=i.sent,i.t0.update.call(i.t0,i.t1,i.t2);case 7:case"end":return i.stop()}},null,null,null,Promise)}));case 1:case"end":return t.stop()}},null,null,null,Promise)},r.decryptSubscription=function(e){var t;return s.async(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,s.awrap(this.getInstanceByRoomId(e));case 2:return t=r.sent,this.log("decryptSubscription ->",e),r.next=6,s.awrap(null==t?void 0:t.decryptSubscription());case 6:case"end":return r.stop()}},null,this,null,Promise)},r.decryptSubscriptions=function(){var e=this;return s.async(function(t){for(;;)switch(t.prev=t.next){case 0:P.find({encrypted:!0}).forEach(function(t){return e.decryptSubscription(t._id)});case 1:case"end":return t.stop()}},null,null,null,Promise)},r.openAlert=function(e){h.open(a({id:"e2e"},e))},r.closeAlert=function(){h.closeById("e2e")},r.parseQuoteAttachment=function(e){var t,r=this;return s.async(function(n){for(;;)switch(n.prev=n.next){case 0:return t=e.msg.match(x())||[],n.next=3,s.awrap(Promise.all(t.map(function t(t){var n,a,i,o,l,p;return s.async(function d(d){for(;;)switch(d.prev=d.next){case 0:if(t.includes(K.get("Site_Url"))){d.next=2;break}return d.abrupt("return");case 2:if((n=u.parse(t)).query){d.next=5;break}return d.abrupt("return");case 5:if(!(!(a=c.parse(n.query).msg)||Array.isArray(a))){d.next=8;break}return d.abrupt("return");case 8:return d.next=10,s.awrap(A.rest.get("/v1/chat.getMessage",{msgId:a}));case 10:if(o=null==(i=d.sent)?void 0:i.message){d.next=14;break}return d.abrupt("return");case 14:return d.next=16,s.awrap(r.decryptMessage(b(o)));case 16:l=d.sent,e.attachments=e.attachments||[],p=w(l,t,K.get("UI_Use_Real_Name"),E(l.u.username||"")),e.attachments.push(p);case 21:case"end":return d.stop()}},null,null,null,Promise)})));case 3:return n.abrupt("return",e);case 4:case"end":return n.stop()}},null,null,null,Promise)},t}(p))}
//# sourceMappingURL=/dynamic/app/e2e/client/8c8dd41827973bff61c7e049d023b55f76ca312c.map

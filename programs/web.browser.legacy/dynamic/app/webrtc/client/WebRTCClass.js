function module(e,t,n){n.link("@babel/runtime/helpers/toConsumableArray",{default:function(e){o=e}},0),n.link("@babel/runtime/helpers/slicedToArray",{default:function(e){i=e}},1),n.link("@babel/runtime/helpers/inheritsLoose",{default:function(e){r=e}},2),n.export({WebRTC:function(){return R}}),n.link("@rocket.chat/emitter",{Emitter:function(e){a=e}},0),n.link("meteor/meteor",{Meteor:function(e){s=e}},1),n.link("meteor/reactive-var",{ReactiveVar:function(e){c=e}},2),n.link("meteor/tracker",{Tracker:function(e){l=e}},3),n.link("../../../client/components/GenericModal",{default:function(e){d=e}},4),n.link("../../../client/lib/imperativeModal",{imperativeModal:function(e){h=e}},5),n.link("../../../client/lib/utils/goToRoomById",{goToRoomById:function(e){m=e}},6),n.link("../../models/client",{ChatSubscription:function(e){u=e}},7),n.link("../../notifications/client",{Notifications:function(e){f=e}},8),n.link("../../settings/client",{settings:function(e){p=e}},9),n.link("../../utils/lib/i18n",{t:function(e){g=e}},10),n.link("../lib/constants",{WEB_RTC_EVENTS:function(e){v=e}},11),n.link("./screenShare",{ChromeScreenShare:function(e){C=e}},12);var o,i,r,a,s,c,l,d,h,m,u,f,p,g,v,C,b=function(e){function t(t){var n;return(n=e.call(this)||this).debug=!1,n.webrtcInstance=t,f.onRoom(n.webrtcInstance.room,v.WEB_RTC,function(e,t){n.log("WebRTCTransportClass - onRoom",e,t),n.emit(e,t)}),n}r(t,e);var n=t.prototype;return n.log=function(){if(!0===this.debug){var e;(e=console).log.apply(e,arguments)}},n.onUserStream=function(e,t){t.room===this.webrtcInstance.room&&(this.log("WebRTCTransportClass - onUser",e,t),this.emit(e,t))},n.startCall=function(e){this.log("WebRTCTransportClass - startCall",this.webrtcInstance.room,this.webrtcInstance.selfId),f.notifyUsersOfRoom(this.webrtcInstance.room,v.WEB_RTC,v.CALL,{from:this.webrtcInstance.selfId,room:this.webrtcInstance.room,media:e.media,monitor:e.monitor})},n.joinCall=function(e){this.log("WebRTCTransportClass - joinCall",this.webrtcInstance.room,this.webrtcInstance.selfId),!0===e.monitor?f.notifyUser(e.to,v.WEB_RTC,v.JOIN,{from:this.webrtcInstance.selfId,room:this.webrtcInstance.room,media:e.media,monitor:e.monitor}):f.notifyUsersOfRoom(this.webrtcInstance.room,v.WEB_RTC,v.JOIN,{from:this.webrtcInstance.selfId,room:this.webrtcInstance.room,media:e.media,monitor:e.monitor})},n.sendCandidate=function(e){e.from=this.webrtcInstance.selfId,e.room=this.webrtcInstance.room,this.log("WebRTCTransportClass - sendCandidate",e),f.notifyUser(e.to,v.WEB_RTC,v.CANDIDATE,e)},n.sendDescription=function(e){e.from=this.webrtcInstance.selfId,e.room=this.webrtcInstance.room,this.log("WebRTCTransportClass - sendDescription",e),f.notifyUser(e.to,v.WEB_RTC,v.DESCRIPTION,e)},n.sendStatus=function(e){this.log("WebRTCTransportClass - sendStatus",e,this.webrtcInstance.room),e.from=this.webrtcInstance.selfId,f.notifyRoom(this.webrtcInstance.room,v.WEB_RTC,v.STATUS,e)},n.onRemoteCall=function(e){return this.on(v.CALL,e)},n.onRemoteJoin=function(e){return this.on(v.JOIN,e)},n.onRemoteCandidate=function(e){return this.on(v.CANDIDATE,e)},n.onRemoteDescription=function(e){return this.on(v.DESCRIPTION,e)},n.onRemoteStatus=function(e){return this.on(v.STATUS,e)},t}(a),S=function(){function e(e,t){var n=this,o=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.resetCallInProgress=function(){n.callInProgress.set(!1)},this.stopPeerConnection=function(e){var t=n.peerConnections[e];null!=t&&(delete n.peerConnections[e],t.close(),n.updateRemoteItems())},this.config={iceServers:[]},this.debug=!1,this.TransportClass=b,this.selfId=e,this.room=t;var i=p.get("WebRTC_Servers");i&&""!==i.trim()&&(i=(i=i.replace(/\s/g,"")).split(",")).forEach(function(e){var t={urls:(e=e.split("@")).pop()};1===e.length&&(e=e[0].split(":"),t.username=decodeURIComponent(e[0]),t.credential=decodeURIComponent(e[1])),n.config.iceServers.push(t)}),this.peerConnections={},this.remoteItems=new c([]),this.remoteItemsById=new c({}),this.callInProgress=new c(!1),this.audioEnabled=new c(!1),this.videoEnabled=new c(!1),this.overlayEnabled=new c(!1),this.screenShareEnabled=new c(!1),this.localUrl=new c,this.active=!1,this.remoteMonitoring=!1,this.monitor=!1,this.autoAccept=o,this.navigator=void 0;var r=navigator.userAgent.toLocaleLowerCase();-1!==r.indexOf("electron")?this.navigator="electron":-1!==r.indexOf("chrome")?this.navigator="chrome":-1!==r.indexOf("firefox")?this.navigator="firefox":-1!==r.indexOf("safari")&&(this.navigator="safari"),this.screenShareAvailable=["chrome","firefox","electron"].includes(this.navigator),this.media={video:!0,audio:!0},this.transport=new this.TransportClass(this),this.transport.onRemoteCall(this.onRemoteCall.bind(this)),this.transport.onRemoteJoin(this.onRemoteJoin.bind(this)),this.transport.onRemoteCandidate(this.onRemoteCandidate.bind(this)),this.transport.onRemoteDescription(this.onRemoteDescription.bind(this)),this.transport.onRemoteStatus(this.onRemoteStatus.bind(this)),setInterval(this.checkPeerConnections.bind(this),1e3)}var t=e.prototype;return t.onUserStream=function(){var e;return(e=this.transport).onUserStream.apply(e,arguments)},t.log=function(){if(!0===this.debug){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];console.log.apply(console,t)}},t.onError=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];console.error.apply(console,t)},t.checkPeerConnections=function(){var e=this,t=this.peerConnections,n=Date.now();Object.entries(t).some(function(t){var o=i(t,2),r=o[0],a=o[1];return!["connected","completed"].includes(a.iceConnectionState)&&a.createdAt+5e3<n&&(e.stopPeerConnection(r),!0)})},t.updateRemoteItems=function(){var e=[],t={};Object.entries(this.peerConnections).forEach(function(n){var o=i(n,2),r=o[0],a=o[1];a.getRemoteStreams().forEach(function(n){var o={id:r,url:n,state:a.iceConnectionState};switch(a.iceConnectionState){case"checking":o.stateText="Connecting...";break;case"connected":case"completed":o.stateText="Connected",o.connected=!0;break;case"disconnected":o.stateText="Disconnected";break;case"failed":o.stateText="Failed";break;case"closed":o.stateText="Closed"}e.push(o),t[r]=o})}),this.remoteItems.set(e),this.remoteItemsById.set(t)},t.broadcastStatus=function(){if(!0===this.active&&!0!==this.monitor&&!0!==this.remoteMonitoring){var e=[];Object.keys(this.peerConnections).entries(function(t){var n=i(t,2),o=n[0],r=n[1].remoteMedia;e.push({id:o,media:r})}),this.transport.sendStatus({media:this.media,remoteConnections:e})}},t.onRemoteStatus=function(e){var t=this;this.callInProgress.set(!0),clearTimeout(this.callInProgressTimeout),this.callInProgressTimeout=setTimeout(this.resetCallInProgress,2e3),!0===this.active&&[{id:e.from,media:e.media}].concat(o(e.remoteConnections)).forEach(function(e){e.id!==t.selfId&&null==t.peerConnections[e.id]&&(t.log("reconnecting with",e.id),t.onRemoteJoin({from:e.id,media:e.media}))})},t.getPeerConnection=function(e){var t=this;if(null!=this.peerConnections[e])return this.peerConnections[e];var n=new RTCPeerConnection(this.config);return n.createdAt=Date.now(),n.remoteMedia={},this.peerConnections[e]=n,["icecandidate","addstream","removestream","iceconnectionstatechange","datachannel","identityresult","idpassertionerror","idpvalidationerror","negotiationneeded","peeridentity","signalingstatechange"].forEach(function(o){n.addEventListener(o,function(n){t.log(e,n.type,n)})}),n.addEventListener("icecandidate",function(n){null!=n.candidate&&t.transport.sendCandidate({to:e,candidate:{candidate:n.candidate.candidate,sdpMLineIndex:n.candidate.sdpMLineIndex,sdpMid:n.candidate.sdpMid}})}),n.addEventListener("addstream",function(){t.updateRemoteItems()}),n.addEventListener("removestream",function(){t.updateRemoteItems()}),n.addEventListener("iceconnectionstatechange",function(){("disconnected"===n.iceConnectionState||"closed"===n.iceConnectionState)&&n===t.peerConnections[e]&&(t.stopPeerConnection(e),setTimeout(function(){0===Object.keys(t.peerConnections).length&&t.stop()},3e3)),t.updateRemoteItems()}),n},t._getUserMedia=function(e,t,n){var o=this,i=function(e){if(AudioContext&&e.getAudioTracks().length>0){var n=new AudioContext,i=n.createMediaStreamSource(e),r=n.createGain();i.connect(r);var a=n.createMediaStreamDestination();r.connect(a),r.gain.value=.6,e.removeTrack(e.getAudioTracks()[0]),e.addTrack(a.stream.getAudioTracks()[0]),e.volume=r,o.audioContext=n}t(e)};if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)return navigator.mediaDevices.getUserMedia(e).then(i).catch(n);navigator.getUserMedia(e,i,n)},t.getUserMedia=function(e,t){var n=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.onError;if(!0!==e.desktop){this._getUserMedia(e,t,o);return}if(!0!==this.screenShareAvailable){console.log("Screen share is not avaliable");return}var i=function(i){var r=function(){h.open({component:d,props:{variant:"warning",title:g("Refresh_your_page_after_install_to_enable_screen_sharing")}})},a="chrome"===n.navigator&&C.installed,s="firefox"===n.navigator&&null!=window.rocketchatscreenshare;if(!a&&!s)return h.open({component:d,props:{title:g("Screen_Share"),variant:"warning",confirmText:g("Install_Extension"),cancelText:g("Cancel"),children:g("You_need_install_an_extension_to_allow_screen_sharing"),onConfirm:function(){if("chrome"===n.navigator){var e="https://chrome.google.com/webstore/detail/rocketchat-screen-share/nocfbnnmjnndkbipkabodnheejiegccf";try{chrome.webstore.install(e,r,function(){window.open(e),r()})}catch(t){console.log(t),window.open(e),r()}}else"firefox"===n.navigator&&(window.open("https://addons.mozilla.org/en-GB/firefox/addon/rocketchat-screen-share/"),r())}}}),o(!1);var c=function(e){null!=i&&e.addTrack(i.getAudioTracks()[0]),t(e)};"firefox"===n.navigator?(e={audio:e.audio,video:{mozMediaSource:"window",mediaSource:"window"}},n._getUserMedia(e,c,o)):C.getSourceId(n.navigator,function(t){e={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxWidth:1280,maxHeight:720}}},n._getUserMedia(e,c,o)})};"firefox"===this.navigator||null==e.audio||!1===e.audio?i():this._getUserMedia({audio:e.audio},function(e){i(e)},function(){i()})},t.getLocalUserMedia=function(e){for(var t=this,n=arguments.length,o=Array(n>1?n-1:0),r=1;r<n;r++)o[r-1]=arguments[r];if(this.log("getLocalUserMedia",[e].concat(o)),null!=this.localStream)return e(null,this.localStream);this.getUserMedia(this.media,function(n){t.localStream=n,t.audioEnabled.get()||t.disableAudio(),t.videoEnabled.get()||t.disableVideo(),t.localUrl.set(n),Object.entries(t.peerConnections).forEach(function(e){return i(e,2)[1].addStream(n)}),document.querySelector("video#localVideo").srcObject=n,e(null,t.localStream)},function(n){e(!1),t.onError(n)})},t.stopAllPeerConnections=function(){Object.keys(this.peerConnections).forEach(this.stopPeerConnection),window.audioContext&&window.audioContext.close()},t.setAudioEnabled=function(){var e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];null!=this.localStream&&(this.localStream.getAudioTracks().forEach(function(t){t.enabled=e}),this.audioEnabled.set(e))},t.disableAudio=function(){this.setAudioEnabled(!1)},t.enableAudio=function(){this.setAudioEnabled(!0)},t.toggleAudio=function(){return this.audioEnabled.get()?this.disableAudio():this.enableAudio()},t.setVideoEnabled=function(){var e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];null!=this.localStream&&(this.localStream.getVideoTracks().forEach(function(t){t.enabled=e}),this.videoEnabled.set(e))},t.disableScreenShare=function(){this.setScreenShareEnabled(!1)},t.enableScreenShare=function(){this.setScreenShareEnabled(!0)},t.setScreenShareEnabled=function(){var e=this,t=!(arguments.length>0)||void 0===arguments[0]||arguments[0];null!=this.localStream&&(this.media.desktop=t,delete this.localStream,this.getLocalUserMedia(function(n){null==n&&(e.screenShareEnabled.set(t),e.stopAllPeerConnections(),e.joinCall())}))},t.disableVideo=function(){this.setVideoEnabled(!1)},t.enableVideo=function(){this.setVideoEnabled(!0)},t.toggleVideo=function(){return this.videoEnabled.get()?this.disableVideo():this.enableVideo()},t.stop=function(){this.active=!1,this.monitor=!1,this.remoteMonitoring=!1,null!=this.localStream&&void 0!==this.localStream&&this.localStream.getTracks().forEach(function(e){return e.stop()}),this.localUrl.set(void 0),delete this.localStream,this.stopAllPeerConnections()},t.startCall=function(){for(var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length,o=Array(n>1?n-1:0),i=1;i<n;i++)o[i-1]=arguments[i];this.log("startCall",[t].concat(o)),this.media=t,this.getLocalUserMedia(function(){e.active=!0,e.transport.startCall({media:e.media})})},t.startCallAsMonitor=function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length,n=Array(t>1?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];this.log("startCallAsMonitor",[e].concat(n)),this.media=e,this.active=!0,this.monitor=!0,this.transport.startCall({media:this.media,monitor:!0})},t.onRemoteCall=function(e){var t,n,o=this;if(!0===this.autoAccept){setTimeout(function(){o.joinCall({to:e.from,monitor:e.monitor,media:e.media})},0);return}var i=s.users.findOne(e.from),r=void 0;i&&i.username&&(r=i.username);var a=u.findOne({rid:e.room});!0===e.monitor?(t="eye",n=g("WebRTC_monitor_call_from_%s",r)):a&&"d"===a.t?e.media&&e.media.video?(t="videocam",n=g("WebRTC_direct_video_call_from_%s",r)):(t="phone",n=g("WebRTC_direct_audio_call_from_%s",r)):e.media&&e.media.video?(t="videocam",n=g("WebRTC_group_video_call_from_%s",a.name)):(t="phone",n=g("WebRTC_group_audio_call_from_%s",a.name)),h.open({component:d,props:{title:n,icon:t,confirmText:g("Yes"),cancelText:g("No"),children:g("Do_you_want_to_accept"),onConfirm:function(){return m(e.room),o.joinCall({to:e.from,monitor:e.monitor,media:e.media})},onCancel:function(){return o.stop()},onClose:function(){return o.stop()}}})},t.joinCall=function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t.media=this.media;for(var n=arguments.length,o=Array(n>1?n-1:0),i=1;i<n;i++)o[i-1]=arguments[i];this.log("joinCall",[t].concat(o)),this.getLocalUserMedia(function(){e.remoteMonitoring=t.monitor,e.active=!0,e.transport.joinCall(t)})},t.onRemoteJoin=function(e){var t=this;if(!0===this.active){for(var n=arguments.length,o=Array(n>1?n-1:0),i=1;i<n;i++)o[i-1]=arguments[i];this.log("onRemoteJoin",[e].concat(o));var r=this.getPeerConnection(e.from);if("checking"!==r.signalingState&&(this.stopPeerConnection(e.from),r=this.getPeerConnection(e.from)),"new"===r.iceConnectionState){r.remoteMedia=e.media,this.localStream&&r.addStream(this.localStream);var a=function(n){r.setLocalDescription(new RTCSessionDescription(n),function(){t.transport.sendDescription({to:e.from,type:"offer",ts:r.createdAt,media:t.media,description:{sdp:n.sdp,type:n.type}})},t.onError)};!0===e.monitor?r.createOffer(a,this.onError,{mandatory:{OfferToReceiveAudio:e.media.audio,OfferToReceiveVideo:e.media.video}}):r.createOffer(a,this.onError)}}},t.onRemoteOffer=function(e){var t=this;if(!0===this.active){for(var n=arguments.length,o=Array(n>1?n-1:0),i=1;i<n;i++)o[i-1]=arguments[i];this.log("onRemoteOffer",[e].concat(o));var r=this.getPeerConnection(e.from);if(["have-local-offer","stable"].includes(r.signalingState)&&r.createdAt<e.ts&&(this.stopPeerConnection(e.from),r=this.getPeerConnection(e.from)),"new"===r.iceConnectionState){r.setRemoteDescription(new RTCSessionDescription(e.description));try{this.localStream&&r.addStream(this.localStream)}catch(e){console.log(e)}r.createAnswer(function(n){r.setLocalDescription(new RTCSessionDescription(n),function(){t.transport.sendDescription({to:e.from,type:"answer",ts:r.createdAt,description:{sdp:n.sdp,type:n.type}})},t.onError)},this.onError)}}},t.onRemoteCandidate=function(e){if(!0===this.active&&e.to===this.selfId){for(var t,n=arguments.length,o=Array(n>1?n-1:0),i=1;i<n;i++)o[i-1]=arguments[i];this.log("onRemoteCandidate",[e].concat(o));var r=this.getPeerConnection(e.from);"closed"!==r.iceConnectionState&&"failed"!==r.iceConnectionState&&"disconnected"!==r.iceConnectionState&&"completed"!==r.iceConnectionState&&r.addIceCandidate(new RTCIceCandidate(e.candidate)),document.querySelector("video#remoteVideo").srcObject=null===(t=this.remoteItems.get()[0])||void 0===t?void 0:t.url}},t.onRemoteDescription=function(e){if(!0===this.active&&e.to===this.selfId){for(var t=arguments.length,n=Array(t>1?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];this.log("onRemoteDescription",[e].concat(n));var i=this.getPeerConnection(e.from);"offer"===e.type?(i.remoteMedia=e.media,this.onRemoteOffer({from:e.from,ts:e.ts,description:e.description})):i.setRemoteDescription(new RTCSessionDescription(e.description))}},e}(),R=new(function(){function e(){this.instancesByRoomId={}}return e.prototype.getInstanceByRoomId=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=!1;if(t)n="WebRTC"===p.get("Omnichannel_call_provider");else{var o=u.findOne({rid:e});if(!o)return;switch(o.t){case"d":n=p.get("WebRTC_Enable_Direct");break;case"p":n=p.get("WebRTC_Enable_Private");break;case"c":n=p.get("WebRTC_Enable_Channel");break;case"l":n="WebRTC"===p.get("Omnichannel_call_provider")}}if(!1!==(n=n&&p.get("WebRTC_Enabled"))){if(null==this.instancesByRoomId[e]){var i=s.userId(),r=!1;t&&(i=t,r=!0),this.instancesByRoomId[e]=new S(i,e,r)}return this.instancesByRoomId[e]}},e}());s.startup(function(){l.autorun(function(){s.userId()&&f.onUser(v.WEB_RTC,function(e,t){null!=t.room&&R.getInstanceByRoomId(t.room).onUserStream(e,t)})})})}
//# sourceMappingURL=/dynamic/app/webrtc/client/17b591406af4e5b23a5ec6bfbf42c4c6ebd1db02.map

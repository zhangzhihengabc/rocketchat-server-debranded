)]}'
{"version":3,"sources":["meteor://ðŸ’»app/app/reactions/client/methods/setReaction.ts","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { IMessage, IRoom } from '@rocket.chat/core-typings';\nimport type { ServerMethods } from '@rocket.chat/ui-contexts';\nimport { Meteor } from 'meteor/meteor';\n\nimport { roomCoordinator } from '../../../../client/lib/rooms/roomCoordinator';\nimport { callbacks } from '../../../../lib/callbacks';\nimport { emoji } from '../../../emoji/client';\nimport { Messages, ChatRoom, Subscriptions } from '../../../models/client';\n\nMeteor.methods<ServerMethods>({\n\tasync setReaction(reaction, messageId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error(203, 'User_logged_out');\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif (!user?.username) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst message: IMessage | undefined = Messages.findOne({ _id: messageId });\n\t\tif (!message) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst room: IRoom | undefined = ChatRoom.findOne({ _id: message.rid });\n\t\tif (!room) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (message.private) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!emoji.list[reaction]) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (roomCoordinator.readOnly(room._id, user)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!Subscriptions.findOne({ rid: message.rid })) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (message.reactions?.[reaction] && message.reactions[reaction].usernames.indexOf(user.username) !== -1) {\n\t\t\tmessage.reactions[reaction].usernames.splice(message.reactions[reaction].usernames.indexOf(user.username), 1);\n\n\t\t\tif (message.reactions[reaction].usernames.length === 0) {\n\t\t\t\tdelete message.reactions[reaction];\n\t\t\t}\n\n\t\t\tif (!message.reactions || typeof message.reactions !== 'object' || Object.keys(message.reactions).length === 0) {\n\t\t\t\tdelete message.reactions;\n\t\t\t\tMessages.update({ _id: messageId }, { $unset: { reactions: 1 } });\n\t\t\t\tawait callbacks.run('unsetReaction', messageId, reaction);\n\t\t\t} else {\n\t\t\t\tMessages.update({ _id: messageId }, { $set: { reactions: message.reactions } });\n\t\t\t\tawait callbacks.run('setReaction', messageId, reaction);\n\t\t\t}\n\t\t} else {\n\t\t\tif (!message.reactions) {\n\t\t\t\tmessage.reactions = {};\n\t\t\t}\n\t\t\tif (!message.reactions[reaction]) {\n\t\t\t\tmessage.reactions[reaction] = {\n\t\t\t\t\tusernames: [],\n\t\t\t\t};\n\t\t\t}\n\t\t\tmessage.reactions[reaction].usernames.push(user.username);\n\n\t\t\tMessages.update({ _id: messageId }, { $set: { reactions: message.reactions } });\n\t\t\tawait callbacks.run('setReaction', messageId, reaction);\n\t\t}\n\t},\n});\n",null],"names":["_regeneratorRuntime","_typeof","Meteor","roomCoordinator","callbacks","emoji","Messages","ChatRoom","Subscriptions","module","default","link","methods","setReaction","reaction","messageId","_message$reactions","user","message","room","async","_context","prev","next","userId","Error","username","abrupt","findOne","_id","rid","private","list","readOnly","reactions","usernames","indexOf","splice","length","Object","keys","update","$unset","awrap","run","$set","push","stop","Promise"],"mappings":"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"}
)]}'
{"version":3,"sources":["meteor://ðŸ’»app/app/analytics/client/loadScript.ts","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { useEffect } from 'react';\n\nimport { useReactiveValue } from '../../../client/hooks/useReactiveValue';\nimport { settings } from '../../settings/client';\n\ndeclare global {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface Window {\n\t\t_paq?: [string, ...unknown[]][];\n\t\tGoogleAnalyticsObject: unknown;\n\t\tga?: qa;\n\t}\n\n\ttype qa = {\n\t\t(...args: unknown[]): void;\n\t\tl?: number;\n\t\tq?: unknown[];\n\t};\n}\n\nexport const useAnalytics = (): void => {\n\tconst uid = useReactiveValue(() => Meteor.userId());\n\n\tconst googleId = useReactiveValue(() => settings.get('GoogleAnalytics_enabled') && settings.get('GoogleAnalytics_ID'));\n\tconst piwikUrl = useReactiveValue(() => settings.get('PiwikAnalytics_enabled') && settings.get('PiwikAnalytics_url'));\n\n\tuseEffect(() => {\n\t\tif (uid) {\n\t\t\twindow._paq = window._paq || [];\n\t\t\twindow._paq.push(['setUserId', uid]);\n\t\t}\n\t});\n\n\tuseEffect(() => {\n\t\tif (!googleId) {\n\t\t\treturn;\n\t\t}\n\t\tif (googleId.startsWith('G-')) {\n\t\t\t// Google Analytics 4\n\t\t\tconst f = document.getElementsByTagName('script')[0];\n\t\t\tconst j = document.createElement('script');\n\t\t\tj.async = true;\n\t\t\tj.src = `//www.googletagmanager.com/gtag/js?id=${googleId}`;\n\t\t\tf.parentNode?.insertBefore(j, f);\n\n\t\t\t// injecting the dataLayer into the windows global object\n\t\t\tconst w: Window & { dataLayer?: any } = window;\n\t\t\tconst dataLayer = w.dataLayer || [];\n\t\t\tconst gtag = (key: string, value: any) => {\n\t\t\t\tdataLayer.push(key, value);\n\t\t\t};\n\t\t\tgtag('js', new Date());\n\t\t\tgtag('config', googleId);\n\t\t} else {\n\t\t\t// Google Analytics 3\n\t\t\t(function (i, s, o, g, r: 'ga', a?: any, m?: any) {\n\t\t\t\ti.GoogleAnalyticsObject = r;\n\t\t\t\t(i[r] =\n\t\t\t\t\ti[r] ||\n\t\t\t\t\tfunction (...args) {\n\t\t\t\t\t\t((i[r] as any).q = (i[r] as any).q || []).push(args);\n\t\t\t\t\t\t// eslint-disable-next-line no-sequences\n\t\t\t\t\t}),\n\t\t\t\t\t((i[r] as any).l = new Date().getTime());\n\t\t\t\t// eslint-disable-next-line no-sequences\n\t\t\t\t(a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);\n\t\t\t\ta.async = 1;\n\t\t\t\ta.src = g;\n\t\t\t\tm.parentNode.insertBefore(a, m);\n\t\t\t})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');\n\n\t\t\twindow.ga?.('create', googleId, 'auto');\n\t\t\twindow.ga?.('send', 'pageview');\n\t\t}\n\t}, [googleId, uid]);\n\n\tuseEffect(() => {\n\t\tif (!piwikUrl) {\n\t\t\tdocument.getElementById('piwik-analytics')?.remove();\n\t\t\twindow._paq = [];\n\t\t\treturn;\n\t\t}\n\n\t\tconst piwikSiteId = piwikUrl && settings.get('PiwikAnalytics_siteId');\n\t\tconst piwikPrependDomain = piwikUrl && settings.get('PiwikAnalytics_prependDomain');\n\t\tconst piwikCookieDomain = piwikUrl && settings.get('PiwikAnalytics_cookieDomain');\n\t\tconst piwikDomains = piwikUrl && settings.get('PiwikAnalytics_domains');\n\t\tconst piwikAdditionalTracker = piwikUrl && settings.get('PiwikAdditionalTrackers');\n\t\twindow._paq = window._paq || [];\n\n\t\twindow._paq.push(['trackPageView']);\n\t\twindow._paq.push(['enableLinkTracking']);\n\t\tif (piwikPrependDomain) {\n\t\t\twindow._paq.push(['setDocumentTitle', `${window.location.hostname}/${document.title}`]);\n\t\t}\n\t\tconst upperLevelDomain = `*.${window.location.hostname.split('.').slice(1).join('.')}`;\n\t\tif (piwikCookieDomain) {\n\t\t\twindow._paq.push(['setCookieDomain', upperLevelDomain]);\n\t\t}\n\t\tif (piwikDomains) {\n\t\t\t// array\n\t\t\tconst domainsArray = piwikDomains.split(/\\n/);\n\t\t\tconst domains = [];\n\t\t\tfor (let i = 0; i < domainsArray.length; i++) {\n\t\t\t\t// only push domain if it contains a non whitespace character.\n\t\t\t\tif (/\\S/.test(domainsArray[i])) {\n\t\t\t\t\tdomains.push(`*.${domainsArray[i].trim()}`);\n\t\t\t\t}\n\t\t\t}\n\t\t\twindow._paq.push(['setDomains', domains]);\n\t\t}\n\t\t(() => {\n\t\t\ttry {\n\t\t\t\tif (/\\S/.test(piwikAdditionalTracker)) {\n\t\t\t\t\t// piwikAdditionalTracker is not empty or whitespace only\n\t\t\t\t\tconst addTrackers = JSON.parse(piwikAdditionalTracker);\n\t\t\t\t\tfor (let i = 0; i < addTrackers.length; i++) {\n\t\t\t\t\t\tconst tracker = addTrackers[i];\n\t\t\t\t\t\twindow._paq.push(['addTracker', `${tracker.trackerURL}js/`, tracker.siteId]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\t// parsing JSON faild\n\t\t\t\tconsole.log('Error while parsing JSON value of \"piwikAdditionalTracker\": ', e);\n\t\t\t}\n\t\t\twindow._paq.push(['setTrackerUrl', `${piwikUrl}js/`]);\n\t\t\twindow._paq.push(['setSiteId', Number.parseInt(piwikSiteId)]);\n\t\t\tconst d = document;\n\t\t\tconst g = d.createElement('script');\n\t\t\tg.setAttribute('id', 'piwik-analytics');\n\t\t\tconst s = d.getElementsByTagName('script')[0];\n\t\t\tg.type = 'text/javascript';\n\t\t\tg.async = true;\n\t\t\tg.defer = true;\n\t\t\tg.src = `${piwikUrl}js/`;\n\t\t\ts.parentNode?.insertBefore(g, s);\n\t\t})();\n\t}, [piwikUrl]);\n};\n",null],"names":["module","export","useAnalytics","Meteor","useEffect","useReactiveValue","settings","uid","userId","googleId","get","piwikUrl","window","_paq","push","startsWith","i","s","o","a","m","_window$ga","_window","_window$ga2","_window2","_f$parentNode","f","document","getElementsByTagName","j","createElement","async","src","parentNode","insertBefore","dataLayer","w","gtag","key","value","Date","GoogleAnalyticsObject","_len","arguments","length","args","Array","_key","q","l","getTime","ga","call","_document$getElementB","getElementById","remove","piwikSiteId","piwikPrependDomain","piwikCookieDomain","piwikDomains","piwikAdditionalTracker","location","hostname","title","upperLevelDomain","split","slice","join","domainsArray","domains","test","trim","_s$parentNode","addTrackers","JSON","parse","tracker","trackerURL","siteId","e","console","log","Number","parseInt","d","g","setAttribute","type","defer"],"mappings":"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"}
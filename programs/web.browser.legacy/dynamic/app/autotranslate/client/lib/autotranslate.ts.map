)]}'
{"version":3,"sources":["meteor://ðŸ’»app/app/autotranslate/client/lib/autotranslate.ts","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type {\n\tIRoom,\n\tISubscription,\n\tISupportedLanguage,\n\tITranslatedMessage,\n\tIUser,\n\tMessageAttachmentDefault,\n} from '@rocket.chat/core-typings';\nimport { isTranslatedMessageAttachment } from '@rocket.chat/core-typings';\nimport mem from 'mem';\nimport { Meteor } from 'meteor/meteor';\nimport { Tracker } from 'meteor/tracker';\n\nimport {\n\thasTranslationLanguageInAttachments,\n\thasTranslationLanguageInMessage,\n} from '../../../../client/views/room/MessageList/lib/autoTranslate';\nimport { hasPermission } from '../../../authorization/client';\nimport { Subscriptions, Messages } from '../../../models/client';\nimport { sdk } from '../../../utils/client/lib/SDKClient';\n\nlet userLanguage = 'en';\nlet username = '';\n\nMeteor.startup(() => {\n\tTracker.autorun(() => {\n\t\tconst user: Pick<IUser, 'language' | 'username'> | null = Meteor.user();\n\t\tif (!user) {\n\t\t\treturn;\n\t\t}\n\t\tuserLanguage = user.language || 'en';\n\t\tusername = user.username || '';\n\t});\n});\n\nexport const AutoTranslate = {\n\tinitialized: false,\n\tprovidersMetadata: {} as { [providerNamer: string]: { name: string; displayName: string } },\n\tmessageIdsToWait: {} as { [messageId: string]: string },\n\tsupportedLanguages: [] as ISupportedLanguage[] | undefined,\n\n\tfindSubscriptionByRid: mem((rid) => Subscriptions.findOne({ rid })),\n\n\tgetLanguage(rid: IRoom['_id']): string {\n\t\tlet subscription: ISubscription | undefined;\n\t\tif (rid) {\n\t\t\tsubscription = this.findSubscriptionByRid(rid);\n\t\t}\n\t\tconst language = (subscription?.autoTranslateLanguage || userLanguage || window.defaultUserLanguage?.()) as string;\n\t\tif (language.indexOf('-') !== -1) {\n\t\t\tif (!(this.supportedLanguages || []).some((supportedLanguage) => supportedLanguage.language === language)) {\n\t\t\t\treturn language.slice(0, 2);\n\t\t\t}\n\t\t}\n\t\treturn language;\n\t},\n\n\ttranslateAttachments(\n\t\tattachments: MessageAttachmentDefault[],\n\t\tlanguage: string,\n\t\tautoTranslateShowInverse: boolean,\n\t): MessageAttachmentDefault[] {\n\t\tif (!isTranslatedMessageAttachment(attachments)) {\n\t\t\treturn attachments;\n\t\t}\n\t\tfor (const attachment of attachments) {\n\t\t\tif (attachment.author_name !== username) {\n\t\t\t\tif (attachment.text && attachment.translations && attachment.translations[language]) {\n\t\t\t\t\tattachment.translations.original = attachment.text;\n\n\t\t\t\t\tif (autoTranslateShowInverse) {\n\t\t\t\t\t\tattachment.text = attachment.translations.original;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tattachment.text = attachment.translations[language];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (attachment.description && attachment.translations && attachment.translations[language]) {\n\t\t\t\t\tattachment.translations.original = attachment.description;\n\n\t\t\t\t\tif (autoTranslateShowInverse) {\n\t\t\t\t\t\tattachment.description = attachment.translations.original;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tattachment.description = attachment.translations[language];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// @ts-expect-error - not sure what to do with this\n\t\t\t\tif (attachment.attachments && attachment.attachments.length > 0) {\n\t\t\t\t\t// @ts-expect-error - not sure what to do with this\n\t\t\t\t\tattachment.attachments = this.translateAttachments(attachment.attachments, language);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn attachments;\n\t},\n\n\tinit(): void {\n\t\tif (this.initialized) {\n\t\t\treturn;\n\t\t}\n\n\t\tTracker.autorun(async (c) => {\n\t\t\tconst uid = Meteor.userId();\n\t\t\tif (!uid || !hasPermission('auto-translate')) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tc.stop();\n\n\t\t\ttry {\n\t\t\t\t[this.providersMetadata, this.supportedLanguages] = await Promise.all([\n\t\t\t\t\tsdk.call('autoTranslate.getProviderUiMetadata'),\n\t\t\t\t\tsdk.call('autoTranslate.getSupportedLanguages', 'en'),\n\t\t\t\t]);\n\t\t\t} catch (e: unknown) {\n\t\t\t\t// Avoid unwanted error message on UI when autotranslate is disabled while fetching data\n\t\t\t\tconsole.error((e as Error).message);\n\t\t\t}\n\t\t});\n\n\t\tSubscriptions.find().observeChanges({\n\t\t\tchanged: (_id: string, fields: ISubscription) => {\n\t\t\t\tif (fields.hasOwnProperty('autoTranslate') || fields.hasOwnProperty('autoTranslateLanguage')) {\n\t\t\t\t\tmem.clear(this.findSubscriptionByRid);\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\n\t\tthis.initialized = true;\n\t},\n};\n\nexport const createAutoTranslateMessageStreamHandler = (): ((message: ITranslatedMessage) => void) => {\n\tAutoTranslate.init();\n\n\treturn (message: ITranslatedMessage): void => {\n\t\tif (message.u && message.u._id !== Meteor.userId()) {\n\t\t\tconst subscription = AutoTranslate.findSubscriptionByRid(message.rid);\n\t\t\tconst language = AutoTranslate.getLanguage(message.rid);\n\t\t\tif (\n\t\t\t\tsubscription &&\n\t\t\t\tsubscription.autoTranslate === true &&\n\t\t\t\tmessage.msg &&\n\t\t\t\t(!message.translations ||\n\t\t\t\t\t(!hasTranslationLanguageInMessage(message, language) && !hasTranslationLanguageInAttachments(message.attachments, language)))\n\t\t\t) {\n\t\t\t\t// || (message.attachments && !_.find(message.attachments, attachment => { return attachment.translations && attachment.translations[language]; }))\n\t\t\t\tMessages.update({ _id: message._id }, { $set: { autoTranslateFetching: true } });\n\t\t\t} else if (AutoTranslate.messageIdsToWait[message._id] !== undefined && subscription && subscription.autoTranslate !== true) {\n\t\t\t\tMessages.update({ _id: message._id }, { $set: { autoTranslateShowInverse: true }, $unset: { autoTranslateFetching: true } });\n\t\t\t\tdelete AutoTranslate.messageIdsToWait[message._id];\n\t\t\t} else if (message.autoTranslateFetching === true) {\n\t\t\t\tMessages.update({ _id: message._id }, { $unset: { autoTranslateFetching: true } });\n\t\t\t}\n\t\t}\n\t};\n};\n",null],"names":["module","default","v","_regeneratorRuntime","_slicedToArray","_createForOfIteratorHelperLoose","export","AutoTranslate","createAutoTranslateMessageStreamHandler","isTranslatedMessageAttachment","mem","Meteor","Tracker","hasTranslationLanguageInAttachments","hasTranslationLanguageInMessage","hasPermission","Subscriptions","Messages","sdk","userLanguage","username","startup","autorun","user","language","initialized","providersMetadata","messageIdsToWait","supportedLanguages","findSubscriptionByRid","rid","findOne","getLanguage","subscription","_subscription","_window$defaultUserLa","_window","autoTranslateLanguage","window","defaultUserLanguage","call","indexOf","some","supportedLanguage","slice","translateAttachments","attachments","autoTranslateShowInverse","_step","_iterator","done","attachment","value","author_name","text","translations","original","description","length","init","_this","c","_await$Promise$all2","async","_context","prev","next","userId","abrupt","stop","awrap","Promise","all","sent","t0","console","error","message","find","observeChanges","changed","_id","fields","hasOwnProperty","clear","u","autoTranslate","msg","undefined","update","$set","$unset","autoTranslateFetching"],"mappings":"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"}
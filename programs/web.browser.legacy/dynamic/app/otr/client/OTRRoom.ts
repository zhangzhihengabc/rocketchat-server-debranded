function module(e,t,r){r.link("@babel/runtime/helpers/typeof",{default:function(e){n=e}},0),r.link("@babel/runtime/regenerator",{default:function(e){s=e}},1),r.export({OTRRoom:function(){return K}}),r.link("@rocket.chat/random",{Random:function(e){i=e}},0),r.link("ejson",{default:function(e){a=e}},1),r.link("meteor/meteor",{Meteor:function(e){o=e}},2),r.link("meteor/reactive-var",{ReactiveVar:function(e){c=e}},3),r.link("meteor/tracker",{Tracker:function(e){u=e}},4),r.link("../../../client/components/GenericModal",{default:function(e){l=e}},5),r.link("../../../client/lib/imperativeModal",{imperativeModal:function(e){p=e}},6),r.link("../../../client/lib/presence",{Presence:function(e){h=e}},7),r.link("../../../client/lib/toast",{dispatchToastMessage:function(e){d=e}},8),r.link("../../../client/lib/utils/getUidDirectMessage",{getUidDirectMessage:function(e){f=e}},9),r.link("../../../client/lib/utils/goToRoomById",{goToRoomById:function(e){y=e}},10),r.link("../../utils/client/lib/SDKClient",{sdk:function(e){m=e}},11),r.link("../../utils/lib/i18n",{t:function(e){b=e}},12),r.link("../lib/OtrRoomState",{OtrRoomState:function(e){_=e}},13),r.link("../lib/constants",{otrSystemMessages:function(e){k=e}},14),r.link("../lib/functions",{decryptAES:function(e){x=e},deriveBits:function(e){w=e},digest:function(e){S=e},encryptAES:function(e){E=e},exportKey:function(e){v=e},generateKeyPair:function(e){I=e},importKey:function(e){T=e},importKeyRaw:function(e){g=e},joinEncryptedData:function(e){R=e}},15);var n,s,i,a,o,c,u,l,p,h,d,f,y,m,b,_,k,x,w,S,E,v,I,T,g,R,K=function(){function e(e,t,r){this._userId=void 0,this._roomId=void 0,this._keyPair=void 0,this._exportedPublicKey=void 0,this._sessionKey=void 0,this._userOnlineComputation=void 0,this.peerId=void 0,this.state=new c(_.NOT_STARTED),this.isFirstOTR=void 0,this._userId=e,this._roomId=t,this._keyPair=null,this._sessionKey=null,this.peerId=r,this.isFirstOTR=!0}e.create=function(t,r){var n=f(r);if(n)return new e(t,r,n)};var t=e.prototype;return t.getPeerId=function(){return this.peerId},t.getState=function(){return this.state.get()},t.setState=function(e){this.getState()!==e&&this.state.set(e)},t.handshake=function(e){var t;return s.async(function(r){for(;;)switch(r.prev=r.next){case 0:return this.setState(_.ESTABLISHING),r.next=3,s.awrap(this.generateKeyPair());case 3:if(m.publish("notify-user",[this.peerId+"/otr","handshake",{roomId:this._roomId,userId:this._userId,publicKey:a.stringify(this._exportedPublicKey),refresh:e}]),!e){r.next=11;break}if(t=o.user()){r.next=8;break}return r.abrupt("return");case 8:return r.next=10,s.awrap(m.call("sendSystemMessages",this._roomId,t.username,k.USER_REQUESTED_OTR_KEY_REFRESH));case 10:this.isFirstOTR=!1;case 11:case"end":return r.stop()}},null,this,null,Promise)},t.acknowledge=function(){m.rest.post("/v1/statistics.telemetry",{params:[{eventName:"otrStats",timestamp:Date.now(),rid:this._roomId}]}),m.publish("notify-user",[this.peerId+"/otr","acknowledge",{roomId:this._roomId,userId:this._userId,publicKey:a.stringify(this._exportedPublicKey)}])},t.deny=function(){this.reset(),this.setState(_.DECLINED),m.publish("notify-user",[this.peerId+"/otr","deny",{roomId:this._roomId,userId:this._userId}])},t.end=function(){this.isFirstOTR=!0,this.reset(),this.setState(_.NOT_STARTED),m.publish("notify-user",[this.peerId+"/otr","end",{roomId:this._roomId,userId:this._userId}])},t.reset=function(){this._keyPair=null,this._exportedPublicKey={},this._sessionKey=null,m.call("deleteOldOTRMessages",this._roomId)},t.generateKeyPair=function(){var e=this;return s.async(function(t){for(;;)switch(t.prev=t.next){case 0:return this._userOnlineComputation&&this._userOnlineComputation.stop(),this._userOnlineComputation=u.autorun(function(){var t,r=document.querySelector("#chat-window-"+e._roomId),n=null==r?void 0:r.querySelector(".rc-header__title");e.getState()===_.ESTABLISHED?r&&n&&!n.querySelector(".otr-icon")&&n.prepend("<i class='otr-icon icon-key'></i>"):n&&(null===(t=n.querySelector(".otr-icon"))||void 0===t||t.remove())}),t.prev=2,t.next=5,s.awrap(I());case 5:if(this._keyPair=t.sent,this._keyPair.publicKey){t.next=8;break}throw Error("Public key is not generated");case 8:return t.next=10,s.awrap(v(this._keyPair.publicKey));case 10:this._exportedPublicKey=t.sent,m.call("deleteOldOTRMessages",this._roomId),t.next=18;break;case 14:throw t.prev=14,t.t0=t.catch(2),this.setState(_.ERROR),t.t0;case 18:case"end":return t.stop()}},null,this,[[2,14]],Promise)},t.importPublicKey=function(e){var t,r,n,i,o;return s.async(function(c){for(;;)switch(c.prev=c.next){case 0:if(c.prev=0,this._keyPair){c.next=3;break}throw Error("No key pair");case 3:return t=a.parse(e),c.next=6,s.awrap(T(t));case 6:return r={name:"ECDH",namedCurve:"P-256",public:c.sent},c.next=10,s.awrap(w({ecdhObj:r,_keyPair:this._keyPair}));case 10:return n=c.sent,c.next=13,s.awrap(S(n));case 13:return i=c.sent,o=new Uint8Array(i).slice(0,16),c.next=17,s.awrap(g(o));case 17:this._sessionKey=c.sent,c.next=24;break;case 20:throw c.prev=20,c.t0=c.catch(0),this.setState(_.ERROR),c.t0;case 24:case"end":return c.stop()}},null,this,[[0,20]],Promise)},t.encryptText=function(e){var t,r;return s.async(function(n){for(;;)switch(n.prev=n.next){case 0:if("string"==typeof e&&(e=new TextEncoder().encode(a.stringify({text:e,ack:i.id((i.fraction()+1)*20)}))),n.prev=1,this._sessionKey){n.next=4;break}throw Error("Session Key not available");case 4:return t=crypto.getRandomValues(new Uint8Array(12)),n.next=7,s.awrap(E({iv:t,_sessionKey:this._sessionKey,data:e}));case 7:return r=R({encryptedData:n.sent,iv:t}),n.abrupt("return",a.stringify(r));case 12:throw n.prev=12,n.t0=n.catch(1),this.setState(_.ERROR),new o.Error("encryption-error","Encryption error.");case 16:case"end":return n.stop()}},null,this,[[1,12]],Promise)},t.encrypt=function(e){var t,r;return s.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,t=new TextEncoder().encode(a.stringify({_id:e._id,text:e.msg,userId:this._userId,ack:i.id((i.fraction()+1)*20),ts:new Date})),n.next=4,s.awrap(this.encryptText(t));case 4:return r=n.sent,n.abrupt("return",r);case 8:throw n.prev=8,n.t0=n.catch(0),new o.Error("encryption-error","Encryption error.");case 11:case"end":return n.stop()}},null,this,[[0,8]],Promise)},t.decrypt=function(e){var t,r,i;return s.async(function(o){for(;;)switch(o.prev=o.next){case 0:if(o.prev=0,this._sessionKey){o.next=3;break}throw Error("Session Key not available.");case 3:return t=a.parse(e),o.next=6,s.awrap(x(t,this._sessionKey));case 6:if(r=o.sent,!((i=a.parse(new TextDecoder("UTF-8").decode(new Uint8Array(r))))&&"object"===n(i))){o.next=10;break}return o.abrupt("return",i);case 10:return o.abrupt("return",e);case 13:return o.prev=13,o.t0=o.catch(0),d({type:"error",message:o.t0}),this.setState(_.ERROR),o.abrupt("return",e);case 18:case"end":return o.stop()}},null,this,[[0,13]],Promise)},t.onUserStream=function(e,t){var r,n,i,a,c,u=this;return s.async(function(f){for(;;)switch(f.prev=f.next){case 0:f.t0=e,f.next="handshake"===f.t0?3:"acknowledge"===f.t0?29:"deny"===f.t0?45:"end"===f.t0?47:60;break;case 3:return n=function e(){return s.async(function e(e){for(;;)switch(e.prev=e.next){case 0:if(u.setState(_.ESTABLISHING),clearTimeout(r),e.prev=2,t.publicKey){e.next=5;break}throw Error("Public key is not generated");case 5:return e.next=7,s.awrap(u.generateKeyPair());case 7:return e.next=9,s.awrap(u.importPublicKey(t.publicKey));case 9:return e.next=11,s.awrap(y(t.roomId));case 11:setTimeout(function e(){return s.async(function e(e){for(;;)switch(e.prev=e.next){case 0:if(u.setState(_.ESTABLISHED),u.acknowledge(),!t.refresh){e.next=5;break}return e.next=5,s.awrap(m.rest.post("/v1/chat.otr",{roomId:u._roomId,type:k.USER_KEY_REFRESHED_SUCCESSFULLY}));case 5:case"end":return e.stop()}},null,null,null,Promise)},0),e.next=18;break;case 14:throw e.prev=14,e.t0=e.catch(2),d({type:"error",message:e.t0}),new o.Error("establish-connection-error","Establish connection error.");case 18:case"end":return e.stop()}},null,null,[[2,14]],Promise)},i=function(){clearTimeout(r),u.deny(),p.close()},f.prev=5,f.next=8,s.awrap(h.get(t.userId));case 8:if(null!=(a=f.sent)&&a.username){f.next=11;break}throw new o.Error("user-not-defined","User not defined.");case 11:if(!(t.refresh&&this.getState()===_.ESTABLISHED)){f.next=17;break}return this.reset(),f.next=15,s.awrap(n());case 15:f.next=23;break;case 17:if(this.getState()!==_.REQUESTED){f.next=19;break}return f.abrupt("return");case 19:this.getState()===_.ESTABLISHED&&this.reset(),this.setState(_.REQUESTED),p.open({component:l,props:{variant:"warning",title:b("OTR"),children:b("Username_wants_to_start_otr_Do_you_want_to_accept",{username:a.username}),confirmText:b("Yes"),cancelText:b("No"),onClose:function(){return i()},onCancel:function(){return i()},onConfirm:function e(){return s.async(function e(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s.awrap(n());case 2:p.close();case 3:case"end":return e.stop()}},null,null,null,Promise)}}}),r=setTimeout(function(){u.setState(_.TIMEOUT),p.close()},1e4);case 23:f.next=28;break;case 25:f.prev=25,f.t1=f.catch(5),d({type:"error",message:f.t1});case 28:return f.abrupt("break",60);case 29:if(f.prev=29,t.publicKey){f.next=32;break}throw Error("Public key is not generated");case 32:return f.next=34,s.awrap(this.importPublicKey(t.publicKey));case 34:if(this.setState(_.ESTABLISHED),!this.isFirstOTR){f.next=38;break}return f.next=38,s.awrap(m.rest.post("/v1/chat.otr",{roomId:this._roomId,type:k.USER_JOINED_OTR}));case 38:this.isFirstOTR=!1,f.next=44;break;case 41:f.prev=41,f.t2=f.catch(29),d({type:"error",message:f.t2});case 44:return f.abrupt("break",60);case 45:return this.getState()===_.ESTABLISHING&&(this.reset(),this.setState(_.DECLINED)),f.abrupt("break",60);case 47:return f.prev=47,f.next=50,s.awrap(h.get(this.peerId));case 50:if(null!=(c=f.sent)&&c.username){f.next=53;break}throw new o.Error("user-not-defined","User not defined.");case 53:this.getState()===_.ESTABLISHED&&(this.reset(),this.setState(_.NOT_STARTED),p.open({component:l,props:{variant:"warning",title:b("OTR"),children:b("Username_ended_the_OTR_session",{username:c.username}),confirmText:b("Ok"),onClose:p.close,onConfirm:p.close}})),f.next=59;break;case 56:f.prev=56,f.t3=f.catch(47),d({type:"error",message:f.t3});case 59:return f.abrupt("break",60);case 60:case"end":return f.stop()}},null,this,[[5,25],[29,41],[47,56]],Promise)},e}()}
//# sourceMappingURL=/dynamic/app/otr/client/3c2c0e57f771c21760617254aad3ce9e83f5be9a.map

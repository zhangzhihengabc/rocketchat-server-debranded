)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/methods/updateMessage.ts","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { IEditedMessage } from '@rocket.chat/core-typings';\nimport type { ServerMethods } from '@rocket.chat/ui-contexts';\nimport { Meteor } from 'meteor/meteor';\nimport { Tracker } from 'meteor/tracker';\nimport moment from 'moment';\n\nimport { hasAtLeastOnePermission, hasPermission } from '../../app/authorization/client';\nimport { ChatMessage } from '../../app/models/client';\nimport { settings } from '../../app/settings/client';\nimport { t } from '../../app/utils/lib/i18n';\nimport { callbacks } from '../../lib/callbacks';\nimport { dispatchToastMessage } from '../lib/toast';\n\nMeteor.methods<ServerMethods>({\n\tupdateMessage(message) {\n\t\tconst uid = Meteor.userId();\n\t\tif (!uid) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst originalMessage = ChatMessage.findOne(message._id);\n\n\t\tif (!originalMessage) {\n\t\t\treturn;\n\t\t}\n\t\tconst canEditMessage = hasAtLeastOnePermission('edit-message', message.rid);\n\t\tconst editAllowed = settings.get('Message_AllowEditing');\n\t\tlet editOwn = false;\n\n\t\tconst msgText = originalMessage?.attachments?.[0]?.description ?? originalMessage.msg;\n\n\t\tif (msgText === message.msg) {\n\t\t\treturn;\n\t\t}\n\t\tif (originalMessage?.u?._id) {\n\t\t\teditOwn = originalMessage.u._id === uid;\n\t\t}\n\n\t\tconst me = Meteor.users.findOne(uid);\n\n\t\tif (!me) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!(canEditMessage || (editAllowed && editOwn))) {\n\t\t\tdispatchToastMessage({\n\t\t\t\ttype: 'error',\n\t\t\t\tmessage: t('error-action-not-allowed', { action: t('Message_editing') }),\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\n\t\tconst blockEditInMinutes = Number(settings.get('Message_AllowEditing_BlockEditInMinutes') as number | undefined);\n\t\tconst bypassBlockTimeLimit = hasPermission('bypass-time-limit-edit-and-delete');\n\n\t\tif (!bypassBlockTimeLimit && blockEditInMinutes !== 0) {\n\t\t\tif (originalMessage.ts) {\n\t\t\t\tconst msgTs = moment(originalMessage.ts);\n\t\t\t\tif (msgTs) {\n\t\t\t\t\tconst currentTsDiff = moment().diff(msgTs, 'minutes');\n\t\t\t\t\tif (currentTsDiff > blockEditInMinutes) {\n\t\t\t\t\t\tdispatchToastMessage({ type: 'error', message: t('error-message-editing-blocked') });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tTracker.nonreactive(async () => {\n\t\t\tmessage.editedAt = new Date(Date.now());\n\n\t\t\tmessage.editedBy = {\n\t\t\t\t_id: uid,\n\t\t\t\tusername: me.username,\n\t\t\t};\n\n\t\t\tmessage = (await callbacks.run('beforeSaveMessage', message)) as IEditedMessage;\n\t\t\tconst messageObject: Partial<IEditedMessage> = {\n\t\t\t\teditedAt: message.editedAt,\n\t\t\t\teditedBy: message.editedBy,\n\t\t\t\tmsg: message.msg,\n\t\t\t};\n\n\t\t\tif (originalMessage.attachments?.length) {\n\t\t\t\tif (originalMessage.attachments[0].description !== undefined) {\n\t\t\t\t\tdelete messageObject.msg;\n\t\t\t\t\toriginalMessage.attachments[0].description = message.msg;\n\t\t\t\t}\n\t\t\t}\n\t\t\tChatMessage.update(\n\t\t\t\t{\n\t\t\t\t\t'_id': message._id,\n\t\t\t\t\t'u._id': uid,\n\t\t\t\t},\n\t\t\t\t{ $set: messageObject },\n\t\t\t);\n\t\t});\n\t},\n});\n",null],"names":["_regeneratorRuntime","Meteor","Tracker","moment","hasAtLeastOnePermission","hasPermission","ChatMessage","settings","t","callbacks","dispatchToastMessage","module","default","link","v","methods","updateMessage","message","_originalMessage$atta","_originalMessage$atta2","_originalMessage$atta3","_originalMessage$u","uid","userId","originalMessage","findOne","_id","canEditMessage","rid","editAllowed","get","editOwn","msgText","attachments","description","msg","u","me","users","type","action","blockEditInMinutes","Number","ts","msgTs","currentTsDiff","diff","nonreactive","_originalMessage$atta4","messageObject","async","_context","prev","next","editedAt","Date","now","editedBy","username","awrap","run","sent","length","undefined","update","$set","stop","Promise"],"mappings":"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"}
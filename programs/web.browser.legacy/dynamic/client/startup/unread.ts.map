)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/startup/unread.ts","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { ISubscription } from '@rocket.chat/core-typings';\nimport { manageFavicon } from '@rocket.chat/favicon';\nimport { Meteor } from 'meteor/meteor';\nimport { Session } from 'meteor/session';\nimport { Tracker } from 'meteor/tracker';\n\nimport { ChatSubscription, ChatRoom } from '../../app/models/client';\nimport { settings } from '../../app/settings/client';\nimport { getUserPreference } from '../../app/utils/client';\nimport { fireGlobalEvent } from '../lib/utils/fireGlobalEvent';\n\nconst fetchSubscriptions = (): ISubscription[] =>\n\tChatSubscription.find(\n\t\t{\n\t\t\topen: true,\n\t\t\thideUnreadStatus: { $ne: true },\n\t\t\tarchived: { $ne: true },\n\t\t},\n\t\t{\n\t\t\tfields: {\n\t\t\t\tunread: 1,\n\t\t\t\talert: 1,\n\t\t\t\trid: 1,\n\t\t\t\tt: 1,\n\t\t\t\tname: 1,\n\t\t\t\tls: 1,\n\t\t\t\tunreadAlert: 1,\n\t\t\t\tfname: 1,\n\t\t\t\tprid: 1,\n\t\t\t},\n\t\t},\n\t).fetch();\n\nMeteor.startup(() => {\n\tTracker.autorun(() => {\n\t\tconst userUnreadAlert = getUserPreference(Meteor.userId(), 'unreadAlert');\n\n\t\tlet unreadAlert: false | 'â€¢' = false;\n\n\t\tconst unreadCount = fetchSubscriptions().reduce(\n\t\t\t(ret, subscription) =>\n\t\t\t\tTracker.nonreactive(() => {\n\t\t\t\t\tconst room = ChatRoom.findOne({ _id: subscription.rid }, { fields: { usersCount: 1 } });\n\t\t\t\t\tfireGlobalEvent('unread-changed-by-subscription', {\n\t\t\t\t\t\t...subscription,\n\t\t\t\t\t\tusersCount: room?.usersCount,\n\t\t\t\t\t});\n\n\t\t\t\t\tif (subscription.alert || subscription.unread > 0) {\n\t\t\t\t\t\t// Increment the total unread count.\n\t\t\t\t\t\tif (subscription.alert === true && subscription.unreadAlert !== 'nothing') {\n\t\t\t\t\t\t\tif (subscription.unreadAlert === 'all' || userUnreadAlert !== false) {\n\t\t\t\t\t\t\t\tunreadAlert = 'â€¢';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn ret + subscription.unread;\n\t\t\t\t\t}\n\t\t\t\t\treturn ret;\n\t\t\t\t}),\n\t\t\t0,\n\t\t);\n\n\t\tif (unreadCount > 0) {\n\t\t\tif (unreadCount > 999) {\n\t\t\t\tSession.set('unread', '999+');\n\t\t\t} else {\n\t\t\t\tSession.set('unread', unreadCount);\n\t\t\t}\n\t\t} else if (unreadAlert !== false) {\n\t\t\tSession.set('unread', unreadAlert);\n\t\t} else {\n\t\t\tSession.set('unread', '');\n\t\t}\n\t});\n});\n\nMeteor.startup(() => {\n\tconst updateFavicon = manageFavicon();\n\n\tTracker.autorun(() => {\n\t\tconst siteName = settings.get('Site_Name') ?? '';\n\n\t\tconst unread = Session.get('unread');\n\t\tfireGlobalEvent('unread-changed', unread);\n\n\t\tupdateFavicon(unread);\n\n\t\tdocument.title = unread === '' ? siteName : `(${unread}) ${siteName}`;\n\t});\n});\n",null],"names":["_objectSpread","manageFavicon","Meteor","Session","Tracker","ChatSubscription","ChatRoom","settings","getUserPreference","fireGlobalEvent","module","link","default","startup","autorun","userUnreadAlert","userId","unreadAlert","unreadCount","fetchSubscriptions","find","open","hideUnreadStatus","$ne","archived","fields","unread","alert","rid","t","name","ls","fname","prid","fetch","reduce","ret","subscription","nonreactive","room","findOne","_id","usersCount","set","updateFavicon","_settings$get","siteName","get","document","title"],"mappings":"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"}
)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/startup/notifications/konchatNotifications.ts","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { AtLeast, ISubscription, IUser, ICalendarNotification } from '@rocket.chat/core-typings';\nimport { Meteor } from 'meteor/meteor';\nimport { Tracker } from 'meteor/tracker';\nimport { lazy } from 'react';\n\nimport { CachedChatSubscription } from '../../../app/models/client';\nimport { Notifications } from '../../../app/notifications/client';\nimport { settings } from '../../../app/settings/client';\nimport { KonchatNotification } from '../../../app/ui/client/lib/KonchatNotification';\nimport { getUserPreference } from '../../../app/utils/client';\nimport { RoomManager } from '../../lib/RoomManager';\nimport { imperativeModal } from '../../lib/imperativeModal';\nimport { fireGlobalEvent } from '../../lib/utils/fireGlobalEvent';\nimport { isLayoutEmbedded } from '../../lib/utils/isLayoutEmbedded';\nimport { router } from '../../providers/RouterProvider';\n\nconst OutlookCalendarEventModal = lazy(() => import('../../views/outlookCalendar/OutlookCalendarEventModal'));\n\nconst notifyNewRoom = async (sub: AtLeast<ISubscription, 'rid'>): Promise<void> => {\n\tconst user = Meteor.user() as IUser | null;\n\tif (!user || user.status === 'busy') {\n\t\treturn;\n\t}\n\n\tif ((!router.getRouteParameters().name || router.getRouteParameters().name !== sub.name) && !sub.ls && sub.alert === true) {\n\t\tKonchatNotification.newRoom(sub.rid);\n\t}\n};\n\nfunction notifyNewMessageAudio(rid?: string): void {\n\t// This logic is duplicated in /client/startup/unread.coffee.\n\tconst hasFocus = document.hasFocus();\n\tconst messageIsInOpenedRoom = RoomManager.opened === rid;\n\tconst muteFocusedConversations = getUserPreference(Meteor.userId(), 'muteFocusedConversations');\n\n\tif (isLayoutEmbedded()) {\n\t\tif (!hasFocus && messageIsInOpenedRoom) {\n\t\t\t// Play a notification sound\n\t\t\tvoid KonchatNotification.newMessage(rid);\n\t\t}\n\t} else if (!hasFocus || !messageIsInOpenedRoom || !muteFocusedConversations) {\n\t\t// Play a notification sound\n\t\tvoid KonchatNotification.newMessage(rid);\n\t}\n}\n\nMeteor.startup(() => {\n\tconst notifyUserCalendar = async function (notification: ICalendarNotification): Promise<void> {\n\t\tconst user = Meteor.user() as IUser | null;\n\t\tif (!user || user.status === 'busy') {\n\t\t\treturn;\n\t\t}\n\n\t\tconst requireInteraction = getUserPreference<boolean>(Meteor.userId(), 'desktopNotificationRequireInteraction');\n\n\t\tconst n = new Notification(notification.title, {\n\t\t\tbody: notification.text,\n\t\t\ttag: notification.payload._id,\n\t\t\tsilent: true,\n\t\t\trequireInteraction,\n\t\t} as NotificationOptions);\n\n\t\tn.onclick = function () {\n\t\t\tthis.close();\n\t\t\twindow.focus();\n\t\t\timperativeModal.open({\n\t\t\t\tcomponent: OutlookCalendarEventModal,\n\t\t\t\tprops: { id: notification.payload._id, onClose: imperativeModal.close, onCancel: imperativeModal.close },\n\t\t\t});\n\t\t};\n\t};\n\tTracker.autorun(() => {\n\t\tif (!Meteor.userId() || !settings.get('Outlook_Calendar_Enabled')) {\n\t\t\treturn Notifications.unUser('calendar');\n\t\t}\n\n\t\tNotifications.onUser('calendar', notifyUserCalendar);\n\t});\n\n\tTracker.autorun(() => {\n\t\tif (!Meteor.userId()) {\n\t\t\treturn;\n\t\t}\n\t\tNotifications.onUser('notification', (notification) => {\n\t\t\tconst openedRoomId = ['channel', 'group', 'direct'].includes(router.getRouteName()!) ? RoomManager.opened : undefined;\n\n\t\t\t// This logic is duplicated in /client/startup/unread.coffee.\n\t\t\tconst hasFocus = document.hasFocus();\n\t\t\tconst messageIsInOpenedRoom = openedRoomId === notification.payload.rid;\n\n\t\t\tfireGlobalEvent('notification', {\n\t\t\t\tnotification,\n\t\t\t\tfromOpenedRoom: messageIsInOpenedRoom,\n\t\t\t\thasFocus,\n\t\t\t});\n\n\t\t\tif (isLayoutEmbedded()) {\n\t\t\t\tif (!hasFocus && messageIsInOpenedRoom) {\n\t\t\t\t\t// Show a notification.\n\t\t\t\t\tKonchatNotification.showDesktop(notification);\n\t\t\t\t}\n\t\t\t} else if (!hasFocus || !messageIsInOpenedRoom) {\n\t\t\t\t// Show a notification.\n\t\t\t\tKonchatNotification.showDesktop(notification);\n\t\t\t}\n\n\t\t\tnotifyNewMessageAudio(notification.payload.rid);\n\t\t});\n\n\t\tCachedChatSubscription.on('changed', (sub): void => {\n\t\t\tvoid notifyNewRoom(sub);\n\t\t});\n\n\t\tNotifications.onUser('subscriptions-changed', (action, sub) => {\n\t\t\tif (action === 'removed') {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvoid notifyNewRoom(sub);\n\t\t});\n\t});\n});\n",null],"names":["module","default","_regeneratorRuntime","link","Meteor","Tracker","lazy","CachedChatSubscription","Notifications","settings","KonchatNotification","getUserPreference","RoomManager","imperativeModal","fireGlobalEvent","isLayoutEmbedded","router","OutlookCalendarEventModal","dynamicImport","notifyNewRoom","sub","user","async","_context","prev","next","status","abrupt","getRouteParameters","name","ls","alert","newRoom","rid","stop","Promise","startup","notifyUserCalendar","notification","requireInteraction","_context2","userId","n","Notification","title","body","text","tag","payload","_id","silent","onclick","close","window","focus","open","component","props","id","onClose","onCancel","autorun","get","unUser","onUser","hasFocus","messageIsInOpenedRoom","muteFocusedConversations","openedRoomId","includes","getRouteName","opened","undefined","document","fromOpenedRoom","showDesktop","newMessage","on","action"],"mappings":"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"}
)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/startup/loadMissedMessages.ts","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { IRoom } from '@rocket.chat/core-typings';\nimport { Meteor } from 'meteor/meteor';\nimport { Tracker } from 'meteor/tracker';\n\nimport { ChatMessage, ChatSubscription } from '../../app/models/client';\nimport { LegacyRoomManager, upsertMessage } from '../../app/ui-utils/client';\nimport { callWithErrorHandling } from '../lib/utils/callWithErrorHandling';\n\nconst loadMissedMessages = async function (rid: IRoom['_id']): Promise<void> {\n\tconst lastMessage = ChatMessage.findOne({ rid, _hidden: { $ne: true }, temp: { $exists: false } }, { sort: { ts: -1 }, limit: 1 });\n\n\tif (!lastMessage) {\n\t\treturn;\n\t}\n\n\ttry {\n\t\tconst result = await callWithErrorHandling('loadMissedMessages', rid, lastMessage.ts);\n\t\tif (result) {\n\t\t\tconst subscription = ChatSubscription.findOne({ rid });\n\t\t\tawait Promise.all(Array.from(result).map((msg) => upsertMessage({ msg, subscription })));\n\t\t}\n\t} catch (error) {\n\t\tconsole.error(error);\n\t}\n};\n\nMeteor.startup(() => {\n\tlet connectionWasOnline = true;\n\tTracker.autorun(() => {\n\t\tconst { connected } = Meteor.connection.status();\n\n\t\tif (connected === true && connectionWasOnline === false && LegacyRoomManager.openedRooms) {\n\t\t\tObject.keys(LegacyRoomManager.openedRooms).forEach((key) => {\n\t\t\t\tconst value = LegacyRoomManager.openedRooms[key];\n\t\t\t\tif (value.rid) {\n\t\t\t\t\tloadMissedMessages(value.rid);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tconnectionWasOnline = connected;\n\t});\n});\n",null],"names":["module","default","_regeneratorRuntime","link","Meteor","Tracker","ChatMessage","ChatSubscription","LegacyRoomManager","upsertMessage","callWithErrorHandling","loadMissedMessages","rid","lastMessage","result","subscription","async","_context","prev","next","findOne","_hidden","$ne","temp","$exists","sort","ts","limit","abrupt","awrap","sent","Promise","all","Array","from","map","msg","t0","console","error","stop","startup","connectionWasOnline","autorun","connected","_Meteor$connection$st","connection","status","openedRooms","Object","keys","forEach","key","value"],"mappings":"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"}
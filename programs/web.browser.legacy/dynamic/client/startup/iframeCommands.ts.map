)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/startup/iframeCommands.ts","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { UserStatus, IUser } from '@rocket.chat/core-typings';\nimport { escapeRegExp } from '@rocket.chat/string-helpers';\nimport type { LocationPathname } from '@rocket.chat/ui-contexts';\nimport { Meteor } from 'meteor/meteor';\nimport { ServiceConfiguration } from 'meteor/service-configuration';\n\nimport { settings } from '../../app/settings/client';\nimport { AccountBox } from '../../app/ui-utils/client/lib/AccountBox';\nimport { sdk } from '../../app/utils/client/lib/SDKClient';\nimport { afterLogoutCleanUpCallback } from '../../lib/callbacks/afterLogoutCleanUpCallback';\nimport { capitalize, ltrim, rtrim } from '../../lib/utils/stringUtils';\nimport { baseURI } from '../lib/baseURI';\nimport { router } from '../providers/RouterProvider';\n\nconst commands = {\n\t'go'(data: { path: string }) {\n\t\tif (typeof data.path !== 'string' || data.path.trim().length === 0) {\n\t\t\treturn console.error('`path` not defined');\n\t\t}\n\t\tconst newUrl = new URL(`${rtrim(baseURI, '/')}/${ltrim(data.path, '/')}`);\n\n\t\tconst newParams = Array.from(newUrl.searchParams.entries()).reduce((ret, [key, value]) => {\n\t\t\tret[key] = value;\n\t\t\treturn ret;\n\t\t}, {} as Record<string, string>);\n\n\t\tconst newPath = newUrl.pathname.replace(\n\t\t\tnew RegExp(`^${escapeRegExp(__meteor_runtime_config__.ROOT_URL_PATH_PREFIX)}`),\n\t\t\t'',\n\t\t) as LocationPathname;\n\t\trouter.navigate({\n\t\t\tpathname: newPath,\n\t\t\tsearch: { ...router.getSearchParameters(), ...newParams },\n\t\t});\n\t},\n\n\t'set-user-status'(data: { status: UserStatus }) {\n\t\tAccountBox.setStatus(data.status);\n\t},\n\n\t'call-custom-oauth-login'(data: { service: string; redirectUrl?: string | null }, event: MessageEvent) {\n\t\tconst customOAuthCallback = (response: unknown) => {\n\t\t\tevent.source?.postMessage(\n\t\t\t\t{\n\t\t\t\t\tevent: 'custom-oauth-callback',\n\t\t\t\t\tresponse,\n\t\t\t\t},\n\t\t\t\t{ targetOrigin: event.origin },\n\t\t\t);\n\t\t};\n\n\t\tconst siteUrl = `${Meteor.settings.Site_Url}/`;\n\t\tif (typeof data.redirectUrl !== 'string' || !data.redirectUrl.startsWith(siteUrl)) {\n\t\t\tdata.redirectUrl = null;\n\t\t}\n\n\t\tif (typeof data.service === 'string' && window.ServiceConfiguration) {\n\t\t\tconst customOauth = ServiceConfiguration.configurations.findOne({ service: data.service });\n\n\t\t\tif (customOauth) {\n\t\t\t\tconst customLoginWith = (Meteor as any)[`loginWith${capitalize(customOauth.service, true)}`];\n\t\t\t\tconst customRedirectUri = data.redirectUrl || siteUrl;\n\t\t\t\tcustomLoginWith.call(Meteor, { redirectUrl: customRedirectUri }, customOAuthCallback);\n\t\t\t}\n\t\t}\n\t},\n\n\t'login-with-token'(data: { token: string }) {\n\t\tif (typeof data.token === 'string') {\n\t\t\tMeteor.loginWithToken(data.token, () => {\n\t\t\t\tconsole.log('Iframe command [login-with-token]: result', data);\n\t\t\t});\n\t\t}\n\t},\n\n\tasync 'logout'() {\n\t\tconst user = Meteor.user();\n\t\tMeteor.logout(() => {\n\t\t\tif (!user) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvoid afterLogoutCleanUpCallback.run(user);\n\t\t\tsdk.call('logoutCleanUp', user as unknown as IUser);\n\t\t\treturn router.navigate('/home');\n\t\t});\n\t},\n} as const;\n\ntype CommandMessage<TCommandName extends keyof typeof commands = keyof typeof commands> = {\n\texternalCommand: TCommandName;\n} & Parameters<(typeof commands)[TCommandName]>[0];\n\nwindow.addEventListener('message', <TCommandMessage extends CommandMessage>(e: MessageEvent<TCommandMessage>) => {\n\tif (!settings.get<boolean>('Iframe_Integration_receive_enable')) {\n\t\treturn;\n\t}\n\n\tif (typeof e.data !== 'object' || typeof e.data.externalCommand !== 'string') {\n\t\treturn;\n\t}\n\n\tconst origins = settings.get<string>('Iframe_Integration_receive_origin');\n\n\tif (origins !== '*' && origins.split(',').indexOf(e.origin) === -1) {\n\t\tconsole.error('Origin not allowed', e.origin);\n\t\treturn;\n\t}\n\n\tif (!(e.data.externalCommand in commands)) {\n\t\tconsole.error('Command not allowed', e.data.externalCommand);\n\t\treturn;\n\t}\n\n\tconst command: (data: any, event: MessageEvent) => void = commands[e.data.externalCommand];\n\tcommand(e.data, e);\n});\n",null],"names":["module","link","default","_regeneratorRuntime","_typeof","_objectSpread","_slicedToArray","escapeRegExp","Meteor","ServiceConfiguration","settings","AccountBox","sdk","afterLogoutCleanUpCallback","capitalize","ltrim","rtrim","baseURI","router","commands","data","path","trim","length","console","error","newUrl","URL","newParams","Array","from","searchParams","entries","reduce","ret","_ref","_ref2","key","value","newPath","pathname","replace","RegExp","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","navigate","search","getSearchParameters","setStatus","status","event","siteUrl","Site_Url","redirectUrl","startsWith","service","window","customOauth","configurations","findOne","customLoginWith","customRedirectUri","call","response","_event$source","source","postMessage","targetOrigin","origin","token","loginWithToken","log","user","async","_context","prev","next","logout","run","stop","Promise","addEventListener","e","get","externalCommand","origins","split","indexOf","command"],"mappings":"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"}
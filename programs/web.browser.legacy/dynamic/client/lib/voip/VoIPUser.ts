function module(e,t,n){n.link("@babel/runtime/regenerator",{default:function(e){r=e}},0),n.link("@babel/runtime/helpers/createClass",{default:function(e){i=e}},1),n.link("@babel/runtime/helpers/assertThisInitialized",{default:function(e){s=e}},2),n.link("@babel/runtime/helpers/inheritsLoose",{default:function(e){o=e}},3),n.export({VoIPUser:function(){return I}}),n.link("@rocket.chat/core-typings",{Operation:function(e){a=e},UserState:function(e){c=e},WorkflowTypes:function(e){l=e}},0),n.link("@rocket.chat/emitter",{Emitter:function(e){u=e}},1),n.link("sip.js",{UserAgent:function(e){h=e},Invitation:function(e){d=e},SessionState:function(e){f=e},Registerer:function(e){p=e},RequestPendingError:function(e){m=e},Inviter:function(e){g=e}},2),n.link("sip.js/lib/core",{URI:function(e){v=e}},3),n.link("sip.js/lib/platform/web",{SessionDescriptionHandler:function(e){E=e}},4),n.link("./Helper",{toggleMediaStreamTracks:function(e){R=e}},5),n.link("./LocalStream",{default:function(e){S=e}},6),n.link("./QueueAggregator",{QueueAggregator:function(e){w=e}},7),n.link("./RemoteStream",{default:function(e){_=e}},8);var r,i,s,o,a,c,l,u,h,d,f,p,m,g,v,E,R,S,w,_,I=function(e){function t(t,n){var r;return(r=e.call(this)||this).config=void 0,r.state={isReady:!1,enableVideo:!1},r.remoteStream=void 0,r.userAgentOptions={},r.userAgent=void 0,r.registerer=void 0,r.mediaStreamRendered=void 0,r._connectionState="INITIAL",r._held=!1,r.mode=void 0,r.queueInfo=void 0,r.connectionRetryCount=void 0,r.stop=void 0,r.networkEmitter=void 0,r.offlineNetworkHandler=void 0,r.onlineNetworkHandler=void 0,r.optionsKeepaliveInterval=5,r.optionsKeepAliveDebounceTimeInSec=5,r.attemptRegistration=!1,r.session=void 0,r._callState="INITIAL",r._callerInfo=void 0,r._userState=c.IDLE,r._opInProgress=a.OP_NONE,r.config=t,r.mediaStreamRendered=n,r.networkEmitter=new u,r.connectionRetryCount=r.config.connectionRetryCount,r.stop=!1,r.onlineNetworkHandler=r.onNetworkRestored.bind(s(r)),r.offlineNetworkHandler=r.onNetworkLost.bind(s(r)),r}o(t,e);var n=t.prototype;return n.init=function(){var e,t,n,i=this;return r.async(function(s){for(;;)switch(s.prev=s.next){case 0:return e="sip:"+this.config.authUserName+"@"+this.config.sipRegistrarHostnameOrIP,t={server:this.config.webSocketURI,connectionTimeout:100,keepAliveInterval:20},n={iceGatheringTimeout:10,peerConnectionConfiguration:{iceServers:this.config.iceServers}},this.userAgentOptions={delegate:{onInvite:function e(e){return r.async(function t(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,r.awrap(i.handleIncomingCall(e));case 2:case"end":return t.stop()}},null,null,null,Promise)}},authorizationPassword:this.config.authPassword,authorizationUsername:this.config.authUserName,uri:h.makeURI(e),transportOptions:t,sessionDescriptionHandlerFactoryOptions:n,logConfiguration:!1,logLevel:"error"},this.userAgent=new h(this.userAgentOptions),this.userAgent.transport.isConnected(),this._opInProgress=a.OP_CONNECT,s.prev=7,this.registerer=new p(this.userAgent),this.userAgent.transport.onConnect=this.onConnected.bind(this),this.userAgent.transport.onDisconnect=this.onDisconnected.bind(this),window.addEventListener("online",this.onlineNetworkHandler),window.addEventListener("offline",this.offlineNetworkHandler),s.next=15,r.awrap(this.userAgent.start());case 15:this.config.enableKeepAliveUsingOptionsForUnstableNetworks&&this.startOptionsPingForUnstableNetworks(),s.next=22;break;case 18:throw s.prev=18,s.t0=s.catch(7),this._connectionState="ERROR",s.t0;case 22:case"end":return s.stop()}},null,this,[[7,18]],Promise)},n.onConnected=function(){return r.async(function(e){for(;;)switch(e.prev=e.next){case 0:this._connectionState="SERVER_CONNECTED",this.state.isReady=!0,this.sendOptions(),this.networkEmitter.emit("connected"),this.registerer&&"INITIAL"!==this.callState&&(this.attemptRegistration=!0);case 5:case"end":return e.stop()}},null,this,null,Promise)},n.onDisconnected=function(e){this._connectionState="SERVER_DISCONNECTED",this._opInProgress=a.OP_NONE,this.networkEmitter.emit("disconnected"),e&&(this.networkEmitter.emit("connectionerror",e),this.state.isReady=!1,this.attemptReconnection(0,!1))},n.onNetworkRestored=function(){this.networkEmitter.emit("localnetworkonline"),"WAITING_FOR_NETWORK"===this._connectionState&&(this.attemptReconnection(),this.registerer&&"INITIAL"!==this.callState&&(this.attemptRegistration=!0))},n.onNetworkLost=function(){this.networkEmitter.emit("localnetworkoffline"),this._connectionState="WAITING_FOR_NETWORK"},n.onRegistrationRequestAccept=function(){this._opInProgress===a.OP_REGISTER&&(this._callState="REGISTERED",this.emit("registered"),this.emit("stateChanged")),this._opInProgress===a.OP_UNREGISTER&&(this._callState="UNREGISTERED",this.emit("unregistered"),this.emit("stateChanged"))},n.onRegistrationRequestReject=function(e){this._opInProgress===a.OP_REGISTER&&this.emit("registrationerror",e),this._opInProgress===a.OP_UNREGISTER&&this.emit("unregistrationerror",e)},n.handleIncomingCall=function(e){var t;return r.async(function(n){for(;;)switch(n.prev=n.next){case 0:if("REGISTERED"!==this.callState){n.next=11;break}return this._opInProgress=a.OP_PROCESS_INVITE,this._callState="OFFER_RECEIVED",this._userState=c.UAS,this.session=e,this.setupSessionEventHandlers(e),t={callerId:e.remoteIdentity.uri.user?e.remoteIdentity.uri.user:"",callerName:e.remoteIdentity.displayName,host:e.remoteIdentity.uri.host},this._callerInfo=t,this.emit("incomingcall",t),this.emit("stateChanged"),n.abrupt("return");case 11:return n.next=13,r.awrap(e.reject());case 13:case"end":return n.stop()}},null,this,null,Promise)},n.setupSessionEventHandlers=function(e){var t,n=this;null===(t=this.session)||void 0===t||t.stateChange.addListener(function(t){var r;if(n.session===e)switch(t){case f.Initial:break;case f.Establishing:n.emit("ringing",{userState:n._userState,callInfo:n._callerInfo});break;case f.Established:n._userState===c.UAC&&(n._callState="ANSWER_RECEIVED"),n._opInProgress=a.OP_NONE,n.setupRemoteMedia(),n._callState="IN_CALL",n.emit("callestablished",{userState:n._userState,callInfo:n._callerInfo}),n.emit("stateChanged");break;case f.Terminating:case f.Terminated:n.session=void 0,n._callState="REGISTERED",n._opInProgress=a.OP_NONE,n._userState=c.IDLE,n.emit("callterminated"),null===(r=n.remoteStream)||void 0===r||r.clear(),n.emit("stateChanged");break;default:throw Error("Unknown session state.")}})},n.onTrackAdded=function(e){console.log("onTrackAdded")},n.onTrackRemoved=function(e){console.log("onTrackRemoved")},n.setupRemoteMedia=function(){if(!this.session)throw Error("Session does not exist.");var e,t,n=null===(e=this.session)||void 0===e?void 0:e.sessionDescriptionHandler;if(n){if(!(n instanceof E))throw Error("Session description handler not instance of web SessionDescriptionHandler");var r=n.remoteMediaStream;if(!r)throw Error("Remote media stream is undefined.");this.remoteStream=new _(r);var i=null===(t=this.mediaStreamRendered)||void 0===t?void 0:t.remoteMediaElement;i&&(this.remoteStream.init(i),this.remoteStream.onTrackAdded(this.onTrackAdded.bind(this)),this.remoteStream.onTrackRemoved(this.onTrackRemoved.bind(this)),this.remoteStream.play())}},n.handleMuteUnmute=function(e){var t,n,i,s,o,a=this;return r.async(function(r){for(;;)switch(r.prev=r.next){case 0:if(t=this.session,this._held!==e){r.next=3;break}return r.abrupt("return",Promise.resolve());case 3:if(t){r.next=5;break}throw Error("Session not found");case 5:if((n=null===(s=this.session)||void 0===s?void 0:s.sessionDescriptionHandler)instanceof E){r.next=8;break}throw Error("Session's session description handler not instance of SessionDescriptionHandler.");case 8:if(i={requestDelegate:{onAccept:function(){a._held=e,R(!a._held,t,"receiver"),R(!a._held,t,"sender")},onReject:function(){a.emit("muteerror")}}},n.peerConnection){r.next=12;break}throw Error("Peer connection closed.");case 12:return r.abrupt("return",null===(o=this.session)||void 0===o?void 0:o.invite(i).then(function(){R(!a._held,t,"receiver"),R(!a._held,t,"sender")}).catch(function(e){if(e instanceof m){var t;console.error("["+(null===(t=a.session)||void 0===t?void 0:t.id)+"] A mute request is already in progress.")}throw a.emit("muteerror"),e}));case 13:case"end":return r.stop()}},null,this,null,Promise)},n.handleHoldUnhold=function(e){var t,n,i,s,o,a,c=this;return r.async(function(r){for(;;)switch(r.prev=r.next){case 0:if(t=this.session,this._held!==e){r.next=3;break}return r.abrupt("return",Promise.resolve());case 3:if(t){r.next=5;break}throw Error("Session not found");case 5:if((n=null===(o=this.session)||void 0===o?void 0:o.sessionDescriptionHandler)instanceof E){r.next=8;break}throw Error("Session's session description handler not instance of SessionDescriptionHandler.");case 8:if(i={requestDelegate:{onAccept:function(){c._held=e,c._callState=e?"ON_HOLD":"IN_CALL",R(!c._held,t,"receiver"),R(!c._held,t,"sender"),"ON_HOLD"===c._callState?c.emit("hold"):c.emit("unhold"),c.emit("stateChanged")},onReject:function(){R(!c._held,t,"receiver"),R(!c._held,t,"sender"),c.emit("holderror")}}},(s=t.sessionDescriptionHandlerOptionsReInvite).hold=e,t.sessionDescriptionHandlerOptionsReInvite=s,n.peerConnection){r.next=15;break}throw Error("Peer connection closed.");case 15:return r.abrupt("return",null===(a=this.session)||void 0===a?void 0:a.invite(i).then(function(){R(!c._held,t,"receiver"),R(!c._held,t,"sender")}).catch(function(e){if(e instanceof m){var t;console.error("["+(null===(t=c.session)||void 0===t?void 0:t.id)+"] A hold request is already in progress.")}throw c.emit("holderror"),e}));case 16:case"end":return r.stop()}},null,this,null,Promise)},t.create=function(e,n){var i;return r.async(function(s){for(;;)switch(s.prev=s.next){case 0:return i=new t(e,n),s.next=3,r.awrap(i.init());case 3:return s.abrupt("return",i);case 4:case"end":return s.stop()}},null,null,null,Promise)},n.sendOptions=function(e){var t,n,r=new v("sip",this.config.authUserName,this.config.sipRegistrarHostnameOrIP),i=null===(t=this.userAgent)||void 0===t?void 0:t.userAgentCore.makeOutgoingRequestMessage("OPTIONS",r,r,r,{});i&&(null===(n=this.userAgent)||void 0===n||n.userAgentCore.request(i,e))},n.register=function(){var e;this._opInProgress=a.OP_REGISTER,null===(e=this.registerer)||void 0===e||e.register({requestDelegate:{onAccept:this.onRegistrationRequestAccept.bind(this),onReject:this.onRegistrationRequestReject.bind(this)}})},n.unregister=function(){var e;this._opInProgress=a.OP_UNREGISTER,null===(e=this.registerer)||void 0===e||e.unregister({all:!0,requestDelegate:{onAccept:this.onRegistrationRequestAccept.bind(this),onReject:this.onRegistrationRequestReject.bind(this)}})},n.acceptCall=function(e){var t,n,i;return r.async(function(r){for(;;)switch(r.prev=r.next){case 0:if(e&&(this.mediaStreamRendered=e),!("OFFER_RECEIVED"===this._callState&&this._opInProgress===a.OP_PROCESS_INVITE)){r.next=10;break}if(this._callState="ANSWER_SENT",this.session instanceof d){r.next=5;break}throw Error("Session not instance of Invitation.");case 5:return t=!!this.config.enableVideo,(n=this.session.body)&&-1===n.indexOf("m=video")&&(t=!1),i={sessionDescriptionHandlerOptions:{constraints:{audio:!0,video:!!this.config.enableVideo&&t}}},r.abrupt("return",this.session.accept(i));case 10:throw Error("Something went wrong");case 11:case"end":return r.stop()}},null,this,null,Promise)},n.canRejectCall=function(){return["OFFER_RECEIVED","OFFER_SENT"].includes(this._callState)},n.canEndOrHoldCall=function(){return["ANSWER_SENT","ANSWER_RECEIVED","IN_CALL","ON_HOLD","OFFER_SENT"].includes(this._callState)},n.rejectCall=function(){if(!this.session)throw Error("Session does not exist.");if(!this.canRejectCall())throw Error("Incorrect call State = "+this.callState);if(!(this.session instanceof d))throw Error("Session not instance of Invitation.");return this.session.reject()},n.endCall=function(){return r.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.session){e.next=2;break}throw Error("Session does not exist.");case 2:if(this.canEndOrHoldCall()){e.next=4;break}throw Error("Incorrect call State = "+this.callState);case 4:this.emit("stateChanged"),e.t0=this.session.state,e.next=e.t0===f.Initial?8:e.t0===f.Establishing?11:e.t0===f.Established?16:e.t0===f.Terminating?17:e.t0===f.Terminated?18:19;break;case 8:if(!(this.session instanceof d)){e.next=10;break}return e.abrupt("return",this.session.reject());case 10:case 15:throw Error("Session not instance of Invitation.");case 11:if(!(this.session instanceof d)){e.next=13;break}return e.abrupt("return",this.session.reject());case 13:if(!(this.session instanceof g)){e.next=15;break}return e.abrupt("return",this.session.cancel());case 16:return e.abrupt("return",this.session.bye());case 17:case 18:return e.abrupt("break",20);case 19:throw Error("Unknown state");case 20:case"end":return e.stop()}},null,this,null,Promise)},n.muteCall=function(e){return r.async(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.session){t.next=2;break}throw Error("Session does not exist.");case 2:if(!("IN_CALL"!==this._callState)){t.next=4;break}throw Error("Incorrect call State = "+this.callState);case 4:this.handleMuteUnmute(e);case 5:case"end":return t.stop()}},null,this,null,Promise)},n.holdCall=function(e){return r.async(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.session){t.next=2;break}throw Error("Session does not exist.");case 2:if(this.canEndOrHoldCall()){t.next=4;break}throw Error("Incorrect call State = "+this.callState);case 4:this.handleHoldUnhold(e);case 5:case"end":return t.stop()}},null,this,null,Promise)},n.isReady=function(){return this.state.isReady},n.switchMediaRenderer=function(e){this.remoteStream&&(this.mediaStreamRendered=e,this.remoteStream.init(e.remoteMediaElement),this.remoteStream.onTrackAdded(this.onTrackAdded.bind(this)),this.remoteStream.onTrackRemoved(this.onTrackRemoved.bind(this)),this.remoteStream.play())},n.setWorkflowMode=function(e){this.mode=e,e===l.CONTACT_CENTER_USER&&(this.queueInfo=new w)},n.setMembershipSubscription=function(e){var t;this.mode===l.CONTACT_CENTER_USER&&(null===(t=this.queueInfo)||void 0===t||t.setMembership(e))},n.getAggregator=function(){return this.queueInfo},n.getRegistrarState=function(){var e;return null===(e=this.registerer)||void 0===e?void 0:e.state.toString().toLocaleLowerCase()},n.clear=function(){var e,t;this._opInProgress=a.OP_CLEANUP,this.stop=!0,null===(e=this.userAgent)||void 0===e||e.stop(),null===(t=this.registerer)||void 0===t||t.dispose(),this._connectionState="STOP",this.userAgent&&(this.userAgent.transport.onConnect=void 0,this.userAgent.transport.onDisconnect=void 0,window.removeEventListener("online",this.onlineNetworkHandler),window.removeEventListener("offline",this.offlineNetworkHandler))},n.onNetworkEvent=function(e,t){this.networkEmitter.on(e,t)},n.offNetworkEvent=function(e,t){this.networkEmitter.off(e,t)},n.attemptReconnection=function(){var e,t,n,i,s=this,o=arguments;return r.async(function(r){for(;;)switch(r.prev=r.next){case 0:if(e=o.length>0&&void 0!==o[0]?o[0]:0,t=o.length>1&&void 0!==o[1]&&o[1],n=this.connectionRetryCount,this._connectionState="SERVER_RECONNECTING",this.userAgent){r.next=6;break}return r.abrupt("return");case 6:if(!this.stop){r.next=8;break}return r.abrupt("return");case 8:if(!(-1!==n&&e>n)){r.next=11;break}return this._connectionState="ERROR",r.abrupt("return");case 11:console.error("Attempting to reconnect with backoff due to network loss. Backoff time ["+(i=Math.pow(2,e%4))+"]"),setTimeout(function(){var n;s.stop||"SERVER_CONNECTED"===s._connectionState||null===(n=s.userAgent)||void 0===n||n.reconnect().then(function(){s._connectionState="SERVER_CONNECTED"}).catch(function(){s.attemptReconnection(++e,t)})},1e3*i);case 14:case"end":return r.stop()}},null,this,null,Promise)},n.attemptPostRecoveryRoutine=function(){var e=this;return r.async(function(t){for(;;)switch(t.prev=t.next){case 0:this.sendOptions({onAccept:function(){e.attemptPostRecoveryRegistrationRoutine()},onReject:function(e){console.error("["+e+"] Failed to do options in attemptPostRecoveryRoutine()")}});case 1:case"end":return t.stop()}},null,this,null,Promise)},n.sendKeepAliveAndWaitForResponse=function(){var e,t,n=this,i=arguments;return r.async(function(s){for(;;)switch(s.prev=s.next){case 0:return e=i.length>0&&void 0!==i[0]&&i[0],t=new Promise(function(t,i){var s=!1,o=n.optionsKeepaliveInterval/2;e&&(o+=n.optionsKeepAliveDebounceTimeInSec),n.sendOptions({onAccept:function(){s=!0},onReject:function(e){console.error("Failed to do options.")}}),setTimeout(function e(){return r.async(function e(e){for(;;)switch(e.prev=e.next){case 0:s?(n.attemptRegistration&&(n.attemptPostRecoveryRoutine(),n.attemptRegistration=!1),t(!0)):i(!1);case 1:case"end":return e.stop()}},null,null,null,Promise)},1e3*o)}),s.abrupt("return",t);case 3:case"end":return s.stop()}},null,null,null,Promise)},n.startOptionsPingForUnstableNetworks=function(){var e=this;return r.async(function(t){for(;;)switch(t.prev=t.next){case 0:setTimeout(function t(){var t;return r.async(function n(n){for(;;)switch(n.prev=n.next){case 0:if(!(!e.userAgent||e.stop)){n.next=2;break}return n.abrupt("return");case 2:if(!("SERVER_RECONNECTING"!==e._connectionState)){n.next=17;break}return t=!1,n.prev=4,n.next=7,r.awrap(e.sendKeepAliveAndWaitForResponse());case 7:t=!0,n.next=13;break;case 10:n.prev=10,n.t0=n.catch(4),console.error("["+n.t0+"] Failed to do options ping.");case 13:return n.prev=13,t||e.networkEmitter.emit("disconnected"),t&&e.networkEmitter.emit("connected"),n.finish(13);case 17:e.startOptionsPingForUnstableNetworks();case 18:case"end":return n.stop()}},null,null,[[4,10,13,17]],Promise)},1e3*this.optionsKeepaliveInterval);case 1:case"end":return t.stop()}},null,this,null,Promise)},n.attemptPostRecoveryRegistrationRoutine=function(){var e,t,n=this;return r.async(function(i){for(;;)switch(i.prev=i.next){case 0:return e=new Promise(function(e,t){var r;null===(r=n.registerer)||void 0===r||r.unregister({all:!0,requestDelegate:{onAccept:function(){e()},onReject:function(e){console.error("["+e+"] While unregistering after recovery"),n.emit("unregistrationerror",e),t("Error in Unregistering")}}})}),i.prev=1,i.next=4,r.awrap(e);case 4:i.next=9;break;case 6:i.prev=6,i.t0=i.catch(1),console.error("["+i.t0+"] While waiting for unregister promise");case 9:null===(t=this.registerer)||void 0===t||t.register({requestDelegate:{onReject:function(e){n._callState="UNREGISTERED",n.emit("registrationerror",e),n.emit("stateChanged")}}});case 10:case"end":return i.stop()}},null,this,[[1,6]],Promise)},n.changeAudioInputDevice=function(e){var t,n,i;return r.async(function(s){for(;;)switch(s.prev=s.next){case 0:if(this.session){s.next=3;break}return console.warn("changeAudioInputDevice() : No session. Returning"),s.abrupt("return",!1);case 3:return s.next=5,r.awrap(S.requestNewStream(e,this.session));case 5:if(n=s.sent){s.next=9;break}return console.warn("changeAudioInputDevice() : Unable to get local stream. Returning"),s.abrupt("return",!1);case 9:if(i=(null===(t=this.session)||void 0===t?void 0:t.sessionDescriptionHandler).peerConnection){s.next=13;break}return console.warn("changeAudioInputDevice() : No peer connection. Returning"),s.abrupt("return",!1);case 13:return S.replaceTrack(i,n,"audio"),s.abrupt("return",!0);case 15:case"end":return s.stop()}},null,this,null,Promise)},n.makeCallURI=function(e,t){return r.async(function(e){for(;;)switch(e.prev=e.next){case 0:throw Error("Not implemented");case 1:case"end":return e.stop()}},null,null,null,Promise)},n.makeCall=function(e){return r.async(function(e){for(;;)switch(e.prev=e.next){case 0:throw Error("Not implemented");case 1:case"end":return e.stop()}},null,null,null,Promise)},i(t,[{key:"operationInProgress",get:function(){return this._opInProgress}},{key:"userState",get:function(){return this._userState}},{key:"userConfig",get:function(){return this.config}},{key:"callState",get:function(){return this._callState}},{key:"connectionState",get:function(){return this._connectionState}},{key:"callerInfo",get:function(){if("IN_CALL"===this.callState||"OFFER_RECEIVED"===this.callState||"ON_HOLD"===this.callState||"OFFER_SENT"===this.callState){if(!this._callerInfo)throw Error("[VoIPUser callerInfo] invalid state");return{state:this.callState,caller:this._callerInfo,userState:this._userState}}return{state:this.callState,userState:this._userState}}},{key:"localMediaStream",get:function(){var e,t=null===(e=this.session)||void 0===e?void 0:e.sessionDescriptionHandler;if(t){if(!(t instanceof E))throw Error("Session description handler not instance of web SessionDescriptionHandler");return t.localMediaStream}}}]),t}(u)}
//# sourceMappingURL=/dynamic/client/lib/voip/ded5f513652ccf1f7a12e280370e34da5758fd4b.map

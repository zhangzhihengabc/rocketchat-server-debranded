)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/lib/chats/uploads.ts","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { IMessage, IRoom } from '@rocket.chat/core-typings';\nimport { Emitter } from '@rocket.chat/emitter';\nimport { Random } from '@rocket.chat/random';\n\nimport { UserAction, USER_ACTIVITIES } from '../../../app/ui/client/lib/UserAction';\nimport { sdk } from '../../../app/utils/client/lib/SDKClient';\nimport { getErrorMessage } from '../errorHandling';\nimport type { UploadsAPI } from './ChatAPI';\nimport type { Upload } from './Upload';\n\nlet uploads: readonly Upload[] = [];\n\nconst emitter = new Emitter<{ update: void; [x: `cancelling-${Upload['id']}`]: void }>();\n\nconst updateUploads = (update: (uploads: readonly Upload[]) => readonly Upload[]): void => {\n\tuploads = update(uploads);\n\temitter.emit('update');\n};\n\nconst get = (): readonly Upload[] => uploads;\n\nconst subscribe = (callback: () => void): (() => void) => emitter.on('update', callback);\n\nconst cancel = (id: Upload['id']): void => {\n\temitter.emit(`cancelling-${id}`);\n};\n\nconst wipeFailedOnes = (): void => {\n\tupdateUploads((uploads) => uploads.filter((upload) => !upload.error));\n};\n\nconst send = async (\n\tfile: File,\n\t{\n\t\tdescription,\n\t\tmsg,\n\t\trid,\n\t\ttmid,\n\t}: {\n\t\tdescription?: string;\n\t\tmsg?: string;\n\t\trid: string;\n\t\ttmid?: string;\n\t},\n): Promise<void> => {\n\tconst id = Random.id();\n\n\tupdateUploads((uploads) => [\n\t\t...uploads,\n\t\t{\n\t\t\tid,\n\t\t\tname: file.name,\n\t\t\tpercentage: 0,\n\t\t},\n\t]);\n\n\ttry {\n\t\tawait new Promise((resolve, reject) => {\n\t\t\tconst xhr = sdk.rest.upload(\n\t\t\t\t`/v1/rooms.upload/${rid}`,\n\t\t\t\t{\n\t\t\t\t\tmsg,\n\t\t\t\t\ttmid,\n\t\t\t\t\tfile,\n\t\t\t\t\tdescription,\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tload: (event) => {\n\t\t\t\t\t\tresolve(event);\n\t\t\t\t\t},\n\t\t\t\t\tprogress: (event) => {\n\t\t\t\t\t\tif (!event.lengthComputable) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst progress = (event.loaded / event.total) * 100;\n\t\t\t\t\t\tif (progress === 100) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tupdateUploads((uploads) =>\n\t\t\t\t\t\t\tuploads.map((upload) => {\n\t\t\t\t\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\t\t\t\t\treturn upload;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t...upload,\n\t\t\t\t\t\t\t\t\tpercentage: Math.round(progress) || 0,\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\terror: (event) => {\n\t\t\t\t\t\tupdateUploads((uploads) =>\n\t\t\t\t\t\t\tuploads.map((upload) => {\n\t\t\t\t\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\t\t\t\t\treturn upload;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t...upload,\n\t\t\t\t\t\t\t\t\tpercentage: 0,\n\t\t\t\t\t\t\t\t\terror: new Error(xhr.responseText),\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t);\n\t\t\t\t\t\treject(event);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t);\n\n\t\t\tif (uploads.length) {\n\t\t\t\tUserAction.performContinuously(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t\t\t}\n\n\t\t\temitter.once(`cancelling-${id}`, () => {\n\t\t\t\txhr.abort();\n\t\t\t\tupdateUploads((uploads) => uploads.filter((upload) => upload.id !== id));\n\t\t\t});\n\t\t});\n\n\t\tupdateUploads((uploads) => uploads.filter((upload) => upload.id !== id));\n\t} catch (error: unknown) {\n\t\tupdateUploads((uploads) =>\n\t\t\tuploads.map((upload) => {\n\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\treturn upload;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\t...upload,\n\t\t\t\t\tpercentage: 0,\n\t\t\t\t\terror: new Error(getErrorMessage(error)),\n\t\t\t\t};\n\t\t\t}),\n\t\t);\n\t} finally {\n\t\tif (!uploads.length) {\n\t\t\tUserAction.stop(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t\t}\n\t}\n};\n\nexport const createUploadsAPI = ({ rid, tmid }: { rid: IRoom['_id']; tmid?: IMessage['_id'] }): UploadsAPI => ({\n\tget,\n\tsubscribe,\n\twipeFailedOnes,\n\tcancel,\n\tsend: (file: File, { description, msg }: { description?: string; msg?: string }): Promise<void> =>\n\t\tsend(file, { description, msg, rid, tmid }),\n});\n",null],"names":["module","default","_regeneratorRuntime","_objectSpread","_toConsumableArray","export","createUploadsAPI","Emitter","Random","UserAction","USER_ACTIVITIES","sdk","getErrorMessage","uploads","emitter","updateUploads","update","emit","get","subscribe","callback","on","cancel","id","wipeFailedOnes","filter","upload","error","send","file","_ref","description","msg","rid","tmid","async","_context","prev","next","concat","name","percentage","awrap","Promise","resolve","reject","xhr","rest","load","event","progress","lengthComputable","loaded","total","map","Math","round","Error","responseText","length","performContinuously","USER_UPLOADING","once","abort","t0","stop","finish","_ref2","_ref3"],"mappings":"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"}
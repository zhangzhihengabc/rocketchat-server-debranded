)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/views/composer/VideoMessageRecorder/VideoMessageRecorder.tsx","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { IMessage, IRoom } from '@rocket.chat/core-typings';\nimport { css } from '@rocket.chat/css-in-js';\nimport { Box, ButtonGroup, Button, Icon, PositionAnimated } from '@rocket.chat/fuselage';\nimport { useMutableCallback } from '@rocket.chat/fuselage-hooks';\nimport { useTranslation, useToastMessageDispatch } from '@rocket.chat/ui-contexts';\nimport type { AllHTMLAttributes, RefObject } from 'react';\nimport React, { useRef, useEffect, useState } from 'react';\n\nimport { UserAction, USER_ACTIVITIES } from '../../../../app/ui/client/lib/UserAction';\nimport { VideoRecorder } from '../../../../app/ui/client/lib/recorderjs/videoRecorder';\nimport type { ChatAPI } from '../../../lib/chats/ChatAPI';\nimport { useChat } from '../../room/contexts/ChatContext';\n\ntype VideoMessageRecorderProps = {\n\trid: IRoom['_id'];\n\ttmid?: IMessage['_id'];\n\tchatContext?: ChatAPI; // TODO: remove this when the composer is migrated to React\n\treference: RefObject<HTMLElement>;\n} & Omit<AllHTMLAttributes<HTMLDivElement>, 'is'>;\n\nconst videoContainerClass = css`\n\ttransform: scaleX(-1);\n\tfilter: FlipH;\n\n\t@media (max-width: 500px) {\n\t\t& > video {\n\t\t\twidth: 100%;\n\t\t\theight: 100%;\n\t\t}\n\t}\n`;\n\nconst getVideoRecordingExtension = () => {\n\tconst supported = VideoRecorder.getSupportedMimeTypes();\n\tif (supported.match(/video\\/webm/)) {\n\t\treturn 'webm';\n\t}\n\treturn 'mp4';\n};\n\nconst VideoMessageRecorder = ({ rid, tmid, chatContext, reference }: VideoMessageRecorderProps) => {\n\tconst t = useTranslation();\n\tconst videoRef = useRef<HTMLVideoElement>(null);\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\n\tconst [time, setTime] = useState<string | undefined>();\n\tconst [recordingState, setRecordingState] = useState<'idle' | 'loading' | 'recording'>('idle');\n\tconst [recordingInterval, setRecordingInterval] = useState<ReturnType<typeof setInterval> | null>(null);\n\tconst isRecording = recordingState === 'recording';\n\tconst sendButtonDisabled = !(VideoRecorder.cameraStarted.get() && !(recordingState === 'recording'));\n\n\tconst chat = useChat() ?? chatContext;\n\n\tconst stopVideoRecording = async (rid: IRoom['_id'], tmid?: IMessage['_id']) => {\n\t\tif (recordingInterval) {\n\t\t\tclearInterval(recordingInterval);\n\t\t}\n\t\tsetRecordingInterval(null);\n\t\tVideoRecorder.stopRecording();\n\t\tUserAction.stop(rid, USER_ACTIVITIES.USER_RECORDING, { tmid });\n\t\tsetRecordingState('idle');\n\t};\n\n\tconst handleRecord = async () => {\n\t\tif (recordingState === 'recording') {\n\t\t\tstopVideoRecording(rid, tmid);\n\t\t} else {\n\t\t\tVideoRecorder.record();\n\t\t\tsetRecordingState('recording');\n\t\t\tUserAction.performContinuously(rid, USER_ACTIVITIES.USER_RECORDING, { tmid });\n\t\t\tsetTime('00:00');\n\t\t\tconst startTime = new Date();\n\t\t\tsetRecordingInterval(\n\t\t\t\tsetInterval(() => {\n\t\t\t\t\tconst now = new Date();\n\t\t\t\t\tconst distance = (now.getTime() - startTime.getTime()) / 1000;\n\t\t\t\t\tconst minutes = Math.floor(distance / 60);\n\t\t\t\t\tconst seconds = Math.floor(distance % 60);\n\t\t\t\t\tsetTime(`${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);\n\t\t\t\t}, 1000),\n\t\t\t);\n\t\t}\n\t};\n\n\tconst handleSendRecord = async () => {\n\t\tconst cb = async (blob: Blob) => {\n\t\t\tconst fileName = `${t('Video_record')}.${getVideoRecordingExtension()}`;\n\t\t\tconst file = new File([blob], fileName, { type: VideoRecorder.getSupportedMimeTypes().split(';')[0] });\n\t\t\tawait chat?.flows.uploadFiles([file]);\n\t\t\tchat?.composer?.setRecordingVideo(false);\n\t\t};\n\n\t\tVideoRecorder.stop(cb);\n\t\tsetTime(undefined);\n\t\tstopVideoRecording(rid, tmid);\n\t};\n\n\tconst handleCancel = useMutableCallback(() => {\n\t\tVideoRecorder.stop();\n\t\tchat?.composer?.setRecordingVideo(false);\n\t\tsetTime(undefined);\n\t\tstopVideoRecording(rid, tmid);\n\t});\n\n\tuseEffect(() => {\n\t\tif (!VideoRecorder.getSupportedMimeTypes()) {\n\t\t\treturn dispatchToastMessage({ type: 'error', message: t('Browser_does_not_support_recording_video') });\n\t\t}\n\n\t\tVideoRecorder.start(videoRef.current ?? undefined, (success) => (!success ? handleCancel() : undefined));\n\n\t\treturn () => {\n\t\t\tVideoRecorder.stop();\n\t\t};\n\t}, [dispatchToastMessage, handleCancel, t]);\n\n\treturn (\n\t\t<PositionAnimated visible='visible' anchor={reference} placement='top-end'>\n\t\t\t<Box bg='light' padding={4} borderRadius={4} elevation='2'>\n\t\t\t\t<Box className={videoContainerClass} overflow='hidden' height={240} borderRadius={4}>\n\t\t\t\t\t<video muted autoPlay playsInline ref={videoRef} width={320} height={240} />\n\t\t\t\t</Box>\n\t\t\t\t<Box mbs={4} display='flex' justifyContent='space-between'>\n\t\t\t\t\t<Button small onClick={handleRecord}>\n\t\t\t\t\t\t<Box is='span' display='flex' alignItems='center'>\n\t\t\t\t\t\t\t<Icon size='x16' mie={time ? 4 : undefined} name={isRecording ? 'stop-unfilled' : 'rec'} />\n\t\t\t\t\t\t\t{time && <span>{time}</span>}\n\t\t\t\t\t\t</Box>\n\t\t\t\t\t</Button>\n\t\t\t\t\t<ButtonGroup>\n\t\t\t\t\t\t<Button small onClick={handleCancel}>\n\t\t\t\t\t\t\t{t('Cancel')}\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t<Button primary small disabled={sendButtonDisabled} onClick={handleSendRecord}>\n\t\t\t\t\t\t\t{t('Send')}\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</ButtonGroup>\n\t\t\t\t</Box>\n\t\t\t</Box>\n\t\t</PositionAnimated>\n\t);\n};\n\nexport default VideoMessageRecorder;\n",null],"names":["module","default","_regeneratorRuntime","_slicedToArray","_taggedTemplateLiteralLoose","link","css","Box","ButtonGroup","Button","Icon","PositionAnimated","useMutableCallback","useTranslation","useToastMessageDispatch","v","React","useRef","useEffect","useState","UserAction","USER_ACTIVITIES","VideoRecorder","useChat","videoContainerClass","_templateObject","exportDefault","_ref","_useChat","rid","tmid","chatContext","reference","t","videoRef","dispatchToastMessage","_useState2","time","setTime","_useState4","recordingState","setRecordingState","_useState6","recordingInterval","setRecordingInterval","sendButtonDisabled","cameraStarted","get","chat","stopVideoRecording","async","_context","prev","next","clearInterval","stopRecording","stop","USER_RECORDING","Promise","handleCancel","_chat$composer2","composer","setRecordingVideo","undefined","_videoRef$current","getSupportedMimeTypes","start","current","success","type","message","createElement","visible","anchor","placement","bg","padding","borderRadius","elevation","className","overflow","height","muted","autoPlay","playsInline","ref","width","mbs","display","justifyContent","small","onClick","startTime","_context2","record","performContinuously","Date","setInterval","distance","now","getTime","minutes","Math","floor","seconds","String","padStart","is","alignItems","size","mie","name","isRecording","primary","disabled","cb","_context4","_callee3","blob","_chat$composer","fileName","file","_callee3$","_context3","supported","match","File","split","awrap","flows","uploadFiles"],"mappings":"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"}
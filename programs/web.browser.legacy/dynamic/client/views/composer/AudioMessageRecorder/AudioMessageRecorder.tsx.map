)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/views/composer/AudioMessageRecorder/AudioMessageRecorder.tsx","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { IRoom } from '@rocket.chat/core-typings';\nimport { Box, Throbber } from '@rocket.chat/fuselage';\nimport { useMutableCallback } from '@rocket.chat/fuselage-hooks';\nimport { MessageComposerAction } from '@rocket.chat/ui-composer';\nimport { useTranslation } from '@rocket.chat/ui-contexts';\nimport type { ReactElement } from 'react';\nimport React, { useEffect, useMemo, useState } from 'react';\n\nimport { AudioRecorder } from '../../../../app/ui/client/lib/recorderjs/AudioRecorder';\nimport type { ChatAPI } from '../../../lib/chats/ChatAPI';\nimport { useChat } from '../../room/contexts/ChatContext';\n\nconst audioRecorder = new AudioRecorder();\n\ntype AudioMessageRecorderProps = {\n\trid: IRoom['_id'];\n\tchatContext?: ChatAPI; // TODO: remove this when the composer is migrated to React\n\tisMicrophoneDenied?: boolean;\n};\n\nconst AudioMessageRecorder = ({ rid, chatContext, isMicrophoneDenied }: AudioMessageRecorderProps): ReactElement | null => {\n\tconst t = useTranslation();\n\n\tconst [state, setState] = useState<'loading' | 'recording'>('recording');\n\tconst [time, setTime] = useState('00:00');\n\tconst [recordingInterval, setRecordingInterval] = useState<ReturnType<typeof setInterval> | null>(null);\n\tconst [recordingRoomId, setRecordingRoomId] = useState<IRoom['_id'] | null>(null);\n\n\tconst stopRecording = useMutableCallback(async () => {\n\t\tif (recordingInterval) {\n\t\t\tclearInterval(recordingInterval);\n\t\t}\n\t\tsetRecordingInterval(null);\n\t\tsetRecordingRoomId(null);\n\n\t\tsetTime('00:00');\n\n\t\tchat?.action.stop('recording');\n\n\t\tchat?.composer?.setRecordingMode(false);\n\n\t\tconst blob = await new Promise<Blob>((resolve) => audioRecorder.stop(resolve));\n\n\t\treturn blob;\n\t});\n\n\tconst handleUnmount = useMutableCallback(async () => {\n\t\tif (state === 'recording') {\n\t\t\tawait stopRecording();\n\t\t}\n\t});\n\n\tconst handleRecord = useMutableCallback(async () => {\n\t\tif (recordingRoomId && recordingRoomId !== rid) {\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tawait audioRecorder.start();\n\t\t\tchat?.action.performContinuously('recording');\n\t\t\tconst startTime = new Date();\n\t\t\tsetRecordingInterval(\n\t\t\t\tsetInterval(() => {\n\t\t\t\t\tconst now = new Date();\n\t\t\t\t\tconst distance = (now.getTime() - startTime.getTime()) / 1000;\n\t\t\t\t\tconst minutes = Math.floor(distance / 60);\n\t\t\t\t\tconst seconds = Math.floor(distance % 60);\n\t\t\t\t\tsetTime(`${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);\n\t\t\t\t}, 1000),\n\t\t\t);\n\t\t\tsetRecordingRoomId(rid);\n\t\t} catch (error) {\n\t\t\tconsole.log(error);\n\t\t\tchat?.composer?.setRecordingMode(false);\n\t\t}\n\t});\n\n\tconst handleCancelButtonClick = useMutableCallback(async () => {\n\t\tawait stopRecording();\n\t});\n\n\tconst chat = useChat() ?? chatContext;\n\n\tconst handleDoneButtonClick = useMutableCallback(async () => {\n\t\tsetState('loading');\n\n\t\tconst blob = await stopRecording();\n\n\t\tconst fileName = `${t('Audio_record')}.mp3`;\n\t\tconst file = new File([blob], fileName, { type: 'audio/mpeg' });\n\n\t\tawait chat?.flows.uploadFiles([file]);\n\t});\n\n\tuseEffect(() => {\n\t\thandleRecord();\n\n\t\treturn () => {\n\t\t\thandleUnmount();\n\t\t};\n\t}, [handleUnmount, handleRecord]);\n\n\tconst stateClass = useMemo(() => {\n\t\tif (recordingRoomId && recordingRoomId !== rid) {\n\t\t\treturn 'rc-message-box__audio-message--busy';\n\t\t}\n\n\t\treturn state && `rc-message-box__audio-message--${state}`;\n\t}, [recordingRoomId, rid, state]);\n\n\tif (isMicrophoneDenied) {\n\t\treturn null;\n\t}\n\n\treturn (\n\t\t<Box position='absolute' pi={4} pb={12} className={`rc-message-box__audio-message ${stateClass}`}>\n\t\t\t{state === 'recording' && (\n\t\t\t\t<>\n\t\t\t\t\t<MessageComposerAction\n\t\t\t\t\t\ticon='circle-cross'\n\t\t\t\t\t\tclassName='rc-message-box__icon rc-message-box__audio-message-cancel'\n\t\t\t\t\t\tonClick={handleCancelButtonClick}\n\t\t\t\t\t/>\n\t\t\t\t\t<Box className='rc-message-box__audio-message-timer' color='default'>\n\t\t\t\t\t\t<span className='rc-message-box__audio-message-timer-dot'></span>\n\t\t\t\t\t\t<span className='rc-message-box__audio-message-timer-text'>{time}</span>\n\t\t\t\t\t</Box>\n\t\t\t\t\t<MessageComposerAction\n\t\t\t\t\t\ticon='circle-check'\n\t\t\t\t\t\tclassName='rc-message-box__icon rc-message-box__audio-message-done'\n\t\t\t\t\t\tonClick={handleDoneButtonClick}\n\t\t\t\t\t/>\n\t\t\t\t</>\n\t\t\t)}\n\t\t\t{state === 'loading' && (\n\t\t\t\t<div className='rc-message-box__icon'>\n\t\t\t\t\t<Throbber inheritColor size='x12' />\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</Box>\n\t);\n};\n\nexport default AudioMessageRecorder;\n",null],"names":["module","link","default","_regeneratorRuntime","_slicedToArray","Box","Throbber","useMutableCallback","MessageComposerAction","useTranslation","v","React","useEffect","useMemo","useState","AudioRecorder","useChat","audioRecorder","exportDefault","_ref","_useChat","rid","chatContext","isMicrophoneDenied","t","_useState2","state","setState","_useState4","time","setTime","_useState6","recordingInterval","setRecordingInterval","_useState8","recordingRoomId","setRecordingRoomId","stopRecording","_chat$composer","blob","async","_context","prev","next","clearInterval","chat","action","stop","composer","setRecordingMode","awrap","Promise","resolve","sent","abrupt","handleUnmount","_context2","handleRecord","startTime","_chat$composer2","_context3","start","performContinuously","Date","setInterval","distance","now","getTime","minutes","Math","floor","seconds","String","padStart","t0","console","log","handleCancelButtonClick","_context4","handleDoneButtonClick","fileName","file","_context5","File","type","flows","uploadFiles","stateClass","createElement","position","pi","pb","className","Fragment","icon","onClick","color","inheritColor","size"],"mappings":"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"}
)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/views/marketplace/hooks/useAppInstallationHandler.tsx","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { App } from '@rocket.chat/core-typings';\nimport { useEndpoint, useRouteParameter, useSetModal, useToastMessageDispatch } from '@rocket.chat/ui-contexts';\nimport React, { useCallback } from 'react';\n\nimport { AppClientOrchestratorInstance } from '../../../../ee/client/apps/orchestrator';\nimport { useExternalLink } from '../../../hooks/useExternalLink';\nimport { useCheckoutUrl } from '../../admin/subscription/hooks/useCheckoutUrl';\nimport IframeModal from '../IframeModal';\nimport AppInstallModal from '../components/AppInstallModal/AppInstallModal';\nimport type { Actions } from '../helpers';\nimport { handleAPIError } from '../helpers/handleAPIError';\nimport { isMarketplaceRouteContext, useAppsCountQuery } from './useAppsCountQuery';\nimport { useOpenAppPermissionsReviewModal } from './useOpenAppPermissionsReviewModal';\nimport { useOpenIncompatibleModal } from './useOpenIncompatibleModal';\n\nexport type AppInstallationHandlerParams = {\n\tapp: App;\n\taction: Actions;\n\tisAppPurchased: boolean;\n\tonDismiss: () => void;\n\tonSuccess: (action: Actions, appPermissions?: App['permissions']) => void;\n};\n\nexport function useAppInstallationHandler({ app, action, isAppPurchased, onDismiss, onSuccess }: AppInstallationHandlerParams) {\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\tconst setModal = useSetModal();\n\n\tconst routeContext = String(useRouteParameter('context'));\n\tconst context = isMarketplaceRouteContext(routeContext) ? routeContext : 'explore';\n\n\tconst appCountQuery = useAppsCountQuery(context);\n\n\tconst notifyAdmins = useEndpoint('POST', `/apps/notify-admins`);\n\n\tconst openIncompatibleModal = useOpenIncompatibleModal();\n\n\tconst openExternalLink = useExternalLink();\n\tconst manageSubscriptionUrl = useCheckoutUrl()({ target: 'user-page', action: 'buy_more' });\n\n\tconst closeModal = useCallback(() => {\n\t\tsetModal(null);\n\t\tonDismiss();\n\t}, [onDismiss, setModal]);\n\n\tconst success = useCallback(\n\t\t(appPermissions?: App['permissions']) => {\n\t\t\tsetModal(null);\n\t\t\tonSuccess(action, appPermissions);\n\t\t},\n\t\t[action, onSuccess, setModal],\n\t);\n\n\tconst openPermissionModal = useOpenAppPermissionsReviewModal({ app, onCancel: closeModal, onConfirm: success });\n\n\tconst acquireApp = useCallback(async () => {\n\t\tif (action === 'purchase' && !isAppPurchased) {\n\t\t\ttry {\n\t\t\t\tconst data = await AppClientOrchestratorInstance.buildExternalUrl(app.id, app.purchaseType, false);\n\t\t\t\tsetModal(<IframeModal url={data.url} cancel={onDismiss} confirm={openPermissionModal} />);\n\t\t\t} catch (error) {\n\t\t\t\thandleAPIError(error);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\topenPermissionModal();\n\t}, [action, isAppPurchased, openPermissionModal, app.id, app.purchaseType, setModal, onDismiss]);\n\n\treturn useCallback(async () => {\n\t\tif (app?.versionIncompatible) {\n\t\t\topenIncompatibleModal(app, action, closeModal);\n\t\t\treturn;\n\t\t}\n\n\t\tif (action === 'request') {\n\t\t\tconst requestConfirmAction = (postMessage: Record<string, unknown>) => {\n\t\t\t\tsetModal(null);\n\t\t\t\tdispatchToastMessage({ type: 'success', message: 'App request submitted' });\n\n\t\t\t\tnotifyAdmins({\n\t\t\t\t\tappId: app.id,\n\t\t\t\t\tappName: app.name,\n\t\t\t\t\tappVersion: app.marketplaceVersion,\n\t\t\t\t\tmessage: typeof postMessage.message === 'string' ? postMessage.message : '',\n\t\t\t\t});\n\n\t\t\t\tsuccess();\n\t\t\t};\n\n\t\t\ttry {\n\t\t\t\tconst data = await AppClientOrchestratorInstance.buildExternalAppRequest(app.id);\n\t\t\t\tsetModal(<IframeModal url={data.url} wrapperHeight='x460' cancel={onDismiss} confirm={requestConfirmAction} />);\n\t\t\t} catch (error) {\n\t\t\t\thandleAPIError(error);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tif (!appCountQuery.data) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (appCountQuery.data.hasUnlimitedApps) {\n\t\t\treturn acquireApp();\n\t\t}\n\n\t\tsetModal(\n\t\t\t<AppInstallModal\n\t\t\t\tcontext={context}\n\t\t\t\tenabled={appCountQuery.data.enabled}\n\t\t\t\tlimit={appCountQuery.data.limit}\n\t\t\t\tappName={app.name}\n\t\t\t\thandleClose={closeModal}\n\t\t\t\thandleConfirm={acquireApp}\n\t\t\t\thandleEnableUnlimitedApps={() => {\n\t\t\t\t\topenExternalLink(manageSubscriptionUrl);\n\t\t\t\t\tsetModal(null);\n\t\t\t\t}}\n\t\t\t/>,\n\t\t);\n\t}, [\n\t\tapp,\n\t\taction,\n\t\tappCountQuery.data,\n\t\tsetModal,\n\t\tcontext,\n\t\tcloseModal,\n\t\tacquireApp,\n\t\topenIncompatibleModal,\n\t\tdispatchToastMessage,\n\t\tnotifyAdmins,\n\t\tsuccess,\n\t\tonDismiss,\n\t\topenExternalLink,\n\t\tmanageSubscriptionUrl,\n\t]);\n}\n",null],"names":["_regeneratorRuntime","useEndpoint","useRouteParameter","useSetModal","useToastMessageDispatch","React","useCallback","AppClientOrchestratorInstance","useExternalLink","useCheckoutUrl","IframeModal","AppInstallModal","handleAPIError","isMarketplaceRouteContext","useAppsCountQuery","useOpenAppPermissionsReviewModal","useOpenIncompatibleModal","useAppInstallationHandler","_ref","app","action","isAppPurchased","onDismiss","onSuccess","dispatchToastMessage","setModal","routeContext","String","context","appCountQuery","notifyAdmins","openIncompatibleModal","openExternalLink","manageSubscriptionUrl","target","closeModal","success","appPermissions","openPermissionModal","onCancel","onConfirm","acquireApp","data","async","_context","prev","next","awrap","buildExternalUrl","id","purchaseType","sent","createElement","url","cancel","confirm","t0","abrupt","stop","Promise","requestConfirmAction","_context2","versionIncompatible","postMessage","type","message","appId","appName","name","appVersion","marketplaceVersion","buildExternalAppRequest","wrapperHeight","hasUnlimitedApps","enabled","limit","handleClose","handleConfirm","handleEnableUnlimitedApps","module","default","v","export"],"mappings":"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"}
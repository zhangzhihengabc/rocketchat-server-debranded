)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/views/room/providers/RoomProvider.tsx","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { IRoom } from '@rocket.chat/core-typings';\nimport { useRouter } from '@rocket.chat/ui-contexts';\nimport type { ReactNode, ContextType, ReactElement } from 'react';\nimport React, { useMemo, memo, useEffect, useCallback } from 'react';\n\nimport { ChatSubscription } from '../../../../app/models/client';\nimport { RoomHistoryManager } from '../../../../app/ui-utils/client';\nimport { UserAction } from '../../../../app/ui/client/lib/UserAction';\nimport { useReactiveQuery } from '../../../hooks/useReactiveQuery';\nimport { useReactiveValue } from '../../../hooks/useReactiveValue';\nimport { RoomManager } from '../../../lib/RoomManager';\nimport { roomCoordinator } from '../../../lib/rooms/roomCoordinator';\nimport RoomNotFound from '../RoomNotFound';\nimport RoomSkeleton from '../RoomSkeleton';\nimport { useRoomRolesManagement } from '../body/hooks/useRoomRolesManagement';\nimport { RoomContext } from '../contexts/RoomContext';\nimport ComposerPopupProvider from './ComposerPopupProvider';\nimport RoomToolboxProvider from './RoomToolboxProvider';\nimport { useRoomQuery } from './hooks/useRoomQuery';\n\ntype RoomProviderProps = {\n\tchildren: ReactNode;\n\trid: IRoom['_id'];\n};\n\nconst RoomProvider = ({ rid, children }: RoomProviderProps): ReactElement => {\n\tuseRoomRolesManagement(rid);\n\n\tconst { data: room, isSuccess } = useRoomQuery(rid);\n\n\t// TODO: the following effect is a workaround while we don't have a general and definitive solution for it\n\tconst router = useRouter();\n\tuseEffect(() => {\n\t\tif (isSuccess && !room) {\n\t\t\trouter.navigate('/home');\n\t\t}\n\t}, [isSuccess, room, router]);\n\n\tconst subscriptionQuery = useReactiveQuery(['subscriptions', { rid }], () => ChatSubscription.findOne({ rid }) ?? null);\n\n\tconst pseudoRoom = useMemo(() => {\n\t\tif (!room) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\t...subscriptionQuery.data,\n\t\t\t...room,\n\t\t\tname: roomCoordinator.getRoomName(room.t, room),\n\t\t\tfederationOriginalName: room.name,\n\t\t};\n\t}, [room, subscriptionQuery.data]);\n\n\tconst { hasMorePreviousMessages, hasMoreNextMessages, isLoadingMoreMessages } = useReactiveValue(\n\t\tuseCallback(() => {\n\t\t\tconst { hasMore, hasMoreNext, isLoading } = RoomHistoryManager.getRoom(rid);\n\n\t\t\treturn {\n\t\t\t\thasMorePreviousMessages: hasMore.get(),\n\t\t\t\thasMoreNextMessages: hasMoreNext.get(),\n\t\t\t\tisLoadingMoreMessages: isLoading.get(),\n\t\t\t};\n\t\t}, [rid]),\n\t);\n\n\tconst context = useMemo((): ContextType<typeof RoomContext> => {\n\t\tif (!pseudoRoom) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn {\n\t\t\trid,\n\t\t\troom: pseudoRoom,\n\t\t\tsubscription: subscriptionQuery.data ?? undefined,\n\t\t\thasMorePreviousMessages,\n\t\t\thasMoreNextMessages,\n\t\t\tisLoadingMoreMessages,\n\t\t};\n\t}, [hasMoreNextMessages, hasMorePreviousMessages, isLoadingMoreMessages, pseudoRoom, rid, subscriptionQuery.data]);\n\n\tuseEffect(() => {\n\t\tRoomManager.open(rid);\n\t\treturn (): void => {\n\t\t\tRoomManager.back(rid);\n\t\t};\n\t}, [rid]);\n\n\tconst subscribed = !!subscriptionQuery.data;\n\n\tuseEffect(() => {\n\t\tif (!subscribed) {\n\t\t\treturn;\n\t\t}\n\n\t\tUserAction.addStream(rid);\n\t\treturn (): void => {\n\t\t\ttry {\n\t\t\t\tUserAction.cancel(rid);\n\t\t\t} catch (error) {\n\t\t\t\t// Do nothing\n\t\t\t}\n\t\t};\n\t}, [rid, subscribed]);\n\n\tif (!pseudoRoom) {\n\t\treturn isSuccess && !room ? <RoomNotFound /> : <RoomSkeleton />;\n\t}\n\n\treturn (\n\t\t<RoomContext.Provider value={context}>\n\t\t\t<RoomToolboxProvider>\n\t\t\t\t<ComposerPopupProvider room={pseudoRoom}>{children}</ComposerPopupProvider>\n\t\t\t</RoomToolboxProvider>\n\t\t</RoomContext.Provider>\n\t);\n};\n\nexport default memo(RoomProvider);\n",null],"names":["_objectSpread","useRouter","React","useMemo","memo","useEffect","useCallback","ChatSubscription","RoomHistoryManager","UserAction","useReactiveQuery","useReactiveValue","RoomManager","roomCoordinator","RoomNotFound","RoomSkeleton","useRoomRolesManagement","RoomContext","ComposerPopupProvider","RoomToolboxProvider","useRoomQuery","module","link","default","v","exportDefault","_ref","rid","children","_useRoomQuery","room","data","isSuccess","router","navigate","subscriptionQuery","_ChatSubscription$fin","findOne","pseudoRoom","name","getRoomName","t","federationOriginalName","_useReactiveValue","_RoomHistoryManager$g","getRoom","hasMore","hasMoreNext","isLoading","hasMorePreviousMessages","get","hasMoreNextMessages","isLoadingMoreMessages","context","_subscriptionQuery$da","subscription","undefined","open","back","subscribed","addStream","cancel","error","createElement","Provider","value"],"mappings":"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"}
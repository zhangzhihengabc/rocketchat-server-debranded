)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/views/admin/viewLogs/ServerLogs.tsx","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { Serialized } from '@rocket.chat/core-typings';\nimport { Box, Icon, Scrollable } from '@rocket.chat/fuselage';\nimport { useToastMessageDispatch, useEndpoint, useStream, useTranslation } from '@rocket.chat/ui-contexts';\nimport type { ReactElement } from 'react';\nimport React, { useEffect, useRef, useState, useCallback } from 'react';\n\nimport { ansispan } from './ansispan';\n\ntype StdOutLogEntry = {\n\tid: string;\n\tstring: string;\n\tts: Date;\n};\n\nconst compareEntries = (a: StdOutLogEntry, b: StdOutLogEntry): number => a.ts.getTime() - b.ts.getTime();\n\nconst unserializeEntry = ({ ts, ...entry }: Serialized<StdOutLogEntry>): StdOutLogEntry => ({\n\tts: new Date(ts),\n\t...entry,\n});\n\nconst ServerLogs = (): ReactElement => {\n\tconst [entries, setEntries] = useState<StdOutLogEntry[]>([]);\n\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\n\tconst getStdoutQueue = useEndpoint('GET', '/v1/stdout.queue');\n\tconst subscribeToStdout = useStream('stdout');\n\n\tuseEffect(() => {\n\t\tconst fetchLines = async (): Promise<void> => {\n\t\t\ttry {\n\t\t\t\tconst { queue } = await getStdoutQueue(undefined);\n\t\t\t\tsetEntries(queue.map(unserializeEntry).sort(compareEntries));\n\t\t\t} catch (error: unknown) {\n\t\t\t\tdispatchToastMessage({ type: 'error', message: error });\n\t\t\t}\n\t\t};\n\n\t\tfetchLines();\n\t}, [dispatchToastMessage, getStdoutQueue]);\n\n\tuseEffect(\n\t\t() =>\n\t\t\tsubscribeToStdout('stdout', (entry: StdOutLogEntry) => {\n\t\t\t\tsetEntries((entries) => [...entries, entry]);\n\t\t\t}),\n\t\t[subscribeToStdout],\n\t);\n\n\tconst t = useTranslation();\n\n\tconst wrapperRef = useRef<HTMLElement>();\n\tconst atBottomRef = useRef<boolean>(false);\n\n\tconst [newLogsVisible, setNewLogsVisible] = useState(false);\n\n\tconst isAtBottom = useCallback((scrollThreshold = 0) => {\n\t\tconst wrapper = wrapperRef.current;\n\n\t\tif (!wrapper) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (wrapper.scrollTop + scrollThreshold >= wrapper.scrollHeight - wrapper.clientHeight) {\n\t\t\tsetNewLogsVisible(false);\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}, []);\n\n\tconst sendToBottom = useCallback(() => {\n\t\tconst wrapper = wrapperRef.current;\n\n\t\tif (!wrapper) {\n\t\t\treturn;\n\t\t}\n\n\t\twrapper.scrollTop = wrapper.scrollHeight - wrapper.clientHeight;\n\t\tsetNewLogsVisible(false);\n\t}, []);\n\n\tconst checkIfScrollIsAtBottom = useCallback(() => {\n\t\tatBottomRef.current = isAtBottom(100);\n\t}, [isAtBottom]);\n\n\tconst sendToBottomIfNecessary = useCallback(() => {\n\t\tif (atBottomRef.current === true && isAtBottom() !== true) {\n\t\t\tsendToBottom();\n\t\t} else if (atBottomRef.current === false) {\n\t\t\tsetNewLogsVisible(true);\n\t\t}\n\t}, [isAtBottom, sendToBottom]);\n\n\tuseEffect(() => {\n\t\tconst wrapper = wrapperRef.current;\n\n\t\tif (!wrapper) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (window.MutationObserver) {\n\t\t\tconst observer = new MutationObserver((mutations) => {\n\t\t\t\tmutations.forEach(() => {\n\t\t\t\t\tsendToBottomIfNecessary();\n\t\t\t\t});\n\t\t\t});\n\t\t\tobserver.observe(wrapper, { childList: true });\n\n\t\t\treturn (): void => {\n\t\t\t\tobserver.disconnect();\n\t\t\t};\n\t\t}\n\n\t\tconst handleSubtreeModified = (): void => {\n\t\t\tsendToBottomIfNecessary();\n\t\t};\n\t\twrapper.addEventListener('DOMSubtreeModified', handleSubtreeModified);\n\n\t\treturn (): void => {\n\t\t\twrapper.removeEventListener('DOMSubtreeModified', handleSubtreeModified);\n\t\t};\n\t}, [sendToBottomIfNecessary]);\n\n\tuseEffect(() => {\n\t\tconst handleWindowResize = (): void => {\n\t\t\tsetTimeout(() => {\n\t\t\t\tsendToBottomIfNecessary();\n\t\t\t}, 100);\n\t\t};\n\n\t\twindow.addEventListener('resize', handleWindowResize);\n\n\t\treturn (): void => {\n\t\t\twindow.removeEventListener('resize', handleWindowResize);\n\t\t};\n\t}, [sendToBottomIfNecessary]);\n\n\tconst handleWheel = useCallback(() => {\n\t\tatBottomRef.current = false;\n\t\tsetTimeout(() => {\n\t\t\tcheckIfScrollIsAtBottom();\n\t\t}, 100);\n\t}, [checkIfScrollIsAtBottom]);\n\n\tconst handleTouchStart = (): void => {\n\t\tatBottomRef.current = false;\n\t};\n\n\tconst handleTouchEnd = useCallback(() => {\n\t\tsetTimeout(() => {\n\t\t\tcheckIfScrollIsAtBottom();\n\t\t}, 100);\n\t}, [checkIfScrollIsAtBottom]);\n\n\tconst handleScroll = useCallback(() => {\n\t\tatBottomRef.current = false;\n\t\tsetTimeout(() => {\n\t\t\tcheckIfScrollIsAtBottom();\n\t\t}, 100);\n\t}, [checkIfScrollIsAtBottom]);\n\n\tconst handleClick = useCallback(() => {\n\t\tatBottomRef.current = true;\n\t\tsendToBottomIfNecessary();\n\t}, [sendToBottomIfNecessary]);\n\n\treturn (\n\t\t<Box width='full' height='full' overflow='hidden' position='relative' display='flex' mbe={8}>\n\t\t\t<Scrollable vertical>\n\t\t\t\t<Box\n\t\t\t\t\tref={wrapperRef}\n\t\t\t\t\tdisplay='flex'\n\t\t\t\t\tflexDirection='column'\n\t\t\t\t\tpadding={8}\n\t\t\t\t\tflexGrow={1}\n\t\t\t\t\tfontFamily='mono'\n\t\t\t\t\tcolor='default'\n\t\t\t\t\tbg='neutral'\n\t\t\t\t\tstyle={{ wordBreak: 'break-all' }}\n\t\t\t\t\tonWheel={handleWheel}\n\t\t\t\t\tonTouchStart={handleTouchStart}\n\t\t\t\t\tonTouchEnd={handleTouchEnd}\n\t\t\t\t\tonScroll={handleScroll}\n\t\t\t\t\tborderRadius='x4'\n\t\t\t\t>\n\t\t\t\t\t{entries.sort(compareEntries).map(({ string }, i) => (\n\t\t\t\t\t\t<span key={i} dangerouslySetInnerHTML={{ __html: ansispan(string) }} />\n\t\t\t\t\t))}\n\t\t\t\t</Box>\n\t\t\t</Scrollable>\n\t\t\t<Box\n\t\t\t\trole='button'\n\t\t\t\tposition='absolute'\n\t\t\t\tdisplay='flex'\n\t\t\t\tjustifyContent='center'\n\t\t\t\tinsetBlockEnd={8}\n\t\t\t\tinsetInlineStart='50%'\n\t\t\t\twidth='x132'\n\t\t\t\theight='x32'\n\t\t\t\tmarginInline='neg-x64'\n\t\t\t\tpaddingBlock={8}\n\t\t\t\tfontScale='c2'\n\t\t\t\tborderRadius='full'\n\t\t\t\televation='1'\n\t\t\t\tcolor='default'\n\t\t\t\tbg='light'\n\t\t\t\tonClick={handleClick}\n\t\t\t\ttextAlign='center'\n\t\t\t\tstyle={{\n\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\ttransition: 'transform 0.3s ease-out',\n\t\t\t\t\ttransform: newLogsVisible ? 'translateY(0)' : 'translateY(150%)',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<Icon name='jump' size='x16' /> {t('New_logs')}\n\t\t\t</Box>\n\t\t</Box>\n\t);\n};\n\nexport default ServerLogs;\n",null],"names":["_regeneratorRuntime","_toConsumableArray","_slicedToArray","_objectSpread","_objectWithoutProperties","Box","Icon","Scrollable","useToastMessageDispatch","useEndpoint","useStream","useTranslation","React","useEffect","useRef","useState","useCallback","ansispan","module","link","default","v","compareEntries","a","b","ts","getTime","unserializeEntry","_ref","entry","_excluded","Date","exportDefault","_useState2","entries","setEntries","dispatchToastMessage","getStdoutQueue","subscribeToStdout","async","_context","prev","next","awrap","undefined","queue","_await$getStdoutQueue","sent","map","sort","t0","type","message","stop","Promise","concat","t","wrapperRef","atBottomRef","_useState4","newLogsVisible","setNewLogsVisible","isAtBottom","scrollThreshold","arguments","length","wrapper","current","scrollTop","scrollHeight","clientHeight","sendToBottom","checkIfScrollIsAtBottom","sendToBottomIfNecessary","window","MutationObserver","observer","mutations","forEach","observe","childList","disconnect","handleSubtreeModified","addEventListener","removeEventListener","handleWindowResize","setTimeout","handleWheel","handleTouchEnd","handleScroll","handleClick","createElement","width","height","overflow","position","display","mbe","vertical","ref","flexDirection","padding","flexGrow","fontFamily","color","bg","style","wordBreak","onWheel","onTouchStart","onTouchEnd","onScroll","borderRadius","_ref2","i","string","key","dangerouslySetInnerHTML","__html","role","justifyContent","insetBlockEnd","insetInlineStart","marginInline","paddingBlock","fontScale","elevation","onClick","textAlign","cursor","transition","transform","name","size"],"mappings":"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"}
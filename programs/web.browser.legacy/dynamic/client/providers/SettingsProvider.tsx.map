)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/providers/SettingsProvider.tsx","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { ISetting } from '@rocket.chat/core-typings';\nimport type { SettingsContextValue } from '@rocket.chat/ui-contexts';\nimport { SettingsContext, useAtLeastOnePermission, useMethod } from '@rocket.chat/ui-contexts';\nimport { Tracker } from 'meteor/tracker';\nimport type { FunctionComponent } from 'react';\nimport React, { useCallback, useEffect, useMemo, useState } from 'react';\n\nimport { createReactiveSubscriptionFactory } from '../lib/createReactiveSubscriptionFactory';\nimport { queryClient } from '../lib/queryClient';\nimport { PrivateSettingsCachedCollection } from '../lib/settings/PrivateSettingsCachedCollection';\nimport { PublicSettingsCachedCollection } from '../lib/settings/PublicSettingsCachedCollection';\n\ntype SettingsProviderProps = {\n\treadonly privileged?: boolean;\n};\n\nconst SettingsProvider: FunctionComponent<SettingsProviderProps> = ({ children, privileged = false }) => {\n\tconst hasPrivilegedPermission = useAtLeastOnePermission(\n\t\tuseMemo(() => ['view-privileged-setting', 'edit-privileged-setting', 'manage-selected-settings'], []),\n\t);\n\n\tconst hasPrivateAccess = privileged && hasPrivilegedPermission;\n\n\tconst cachedCollection = useMemo(\n\t\t() => (hasPrivateAccess ? PrivateSettingsCachedCollection : PublicSettingsCachedCollection),\n\t\t[hasPrivateAccess],\n\t);\n\n\tconst [isLoading, setLoading] = useState(() => Tracker.nonreactive(() => !cachedCollection.ready.get()));\n\n\tuseEffect(() => {\n\t\tlet mounted = true;\n\n\t\tconst initialize = async (): Promise<void> => {\n\t\t\tif (!Tracker.nonreactive(() => cachedCollection.ready.get())) {\n\t\t\t\tawait cachedCollection.init();\n\t\t\t}\n\n\t\t\tif (!mounted) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tsetLoading(false);\n\t\t};\n\n\t\tinitialize();\n\n\t\treturn (): void => {\n\t\t\tmounted = false;\n\t\t};\n\t}, [cachedCollection]);\n\n\tconst querySetting = useMemo(\n\t\t() =>\n\t\t\tcreateReactiveSubscriptionFactory((_id): ISetting | undefined => {\n\t\t\t\tconst subscription = cachedCollection.collection.findOne(_id);\n\t\t\t\treturn subscription ? { ...subscription } : undefined;\n\t\t\t}),\n\t\t[cachedCollection],\n\t);\n\n\tconst querySettings = useMemo(\n\t\t() =>\n\t\t\tcreateReactiveSubscriptionFactory((query = {}) =>\n\t\t\t\tcachedCollection.collection\n\t\t\t\t\t.find(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t...('_id' in query && Array.isArray(query._id) && { _id: { $in: query._id } }),\n\t\t\t\t\t\t\t...('_id' in query && !Array.isArray(query._id) && { _id: query._id }),\n\t\t\t\t\t\t\t...('group' in query && { group: query.group }),\n\t\t\t\t\t\t\t...('section' in query &&\n\t\t\t\t\t\t\t\t(query.section\n\t\t\t\t\t\t\t\t\t? { section: query.section }\n\t\t\t\t\t\t\t\t\t: {\n\t\t\t\t\t\t\t\t\t\t\t$or: [{ section: { $exists: false } }, { section: undefined }],\n\t\t\t\t\t\t\t\t\t  })),\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tsort: {\n\t\t\t\t\t\t\t\tsection: 1,\n\t\t\t\t\t\t\t\tsorter: 1,\n\t\t\t\t\t\t\t\ti18nLabel: 1,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t)\n\t\t\t\t\t.fetch(),\n\t\t\t),\n\t\t[cachedCollection],\n\t);\n\n\tconst settingsChangeCallback = (changes: { _id: string }[]): void => {\n\t\tchanges.forEach((val) => {\n\t\t\tswitch (val._id) {\n\t\t\t\tcase 'Enterprise_License':\n\t\t\t\t\tqueryClient.invalidateQueries(['licenses']);\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t});\n\t};\n\n\tconst saveSettings = useMethod('saveSettings');\n\tconst dispatch = useCallback(\n\t\tasync (changes) => {\n\t\t\tsettingsChangeCallback(changes);\n\t\t\tawait saveSettings(changes);\n\t\t},\n\t\t[saveSettings],\n\t);\n\n\tconst contextValue = useMemo<SettingsContextValue>(\n\t\t() => ({\n\t\t\thasPrivateAccess,\n\t\t\tisLoading,\n\t\t\tquerySetting,\n\t\t\tquerySettings,\n\t\t\tdispatch,\n\t\t}),\n\t\t[hasPrivateAccess, isLoading, querySetting, querySettings, dispatch],\n\t);\n\n\treturn <SettingsContext.Provider children={children} value={contextValue} />;\n};\n\nexport default SettingsProvider;\n\n// '[subscribe: (onStoreChange: () => void) => () => void, getSnapshot: () => {}]'\n// '[subscribe: (onStoreChange: () => void) => () => void, getSnapshot: () => ISetting | undefined]'\n",null],"names":["_regeneratorRuntime","_objectSpread","_slicedToArray","SettingsContext","useAtLeastOnePermission","useMethod","Tracker","React","useCallback","useEffect","useMemo","useState","createReactiveSubscriptionFactory","queryClient","PrivateSettingsCachedCollection","PublicSettingsCachedCollection","module","link","default","v","exportDefault","_ref","children","_ref$privileged","privileged","hasPrivilegedPermission","hasPrivateAccess","cachedCollection","_useState2","nonreactive","ready","get","isLoading","setLoading","mounted","async","_context","prev","next","awrap","init","abrupt","stop","Promise","querySetting","_id","subscription","collection","findOne","undefined","querySettings","query","arguments","length","find","Array","isArray","$in","group","section","$or","$exists","sort","sorter","i18nLabel","fetch","settingsChangeCallback","changes","forEach","val","invalidateQueries","saveSettings","dispatch","_context2","contextValue","createElement","Provider","value"],"mappings":"uBAgBA,IAdAA,EAA+FC,EAAAC,EAA/FC,EAASC,EAAiBC,EAAqEC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAvEC,EAAEC,IAAA,CAAA,6BAAoC,CAAAC,QAAM,SAAAC,CAAA,EAAAnB,EAA2BmB,CAAA,CAAA,EAAA,GAAAH,EAAAA,IAAAA,CAAAA,uCAAAA,CAAAE,QAAAA,SAAAA,CAAAA,EAAAjB,EAAAA,CAAA,CAAA,EAAA,GAAAe,EAAAA,IAAAA,CAAAA,uCAAAA,CAAAE,QAAAA,SAAAA,CAAAA,EAAAhB,EAAAA,CAAA,CAAA,EAAA,GAA5Cc,EAASC,IAAE,CAAA,2BAAM,CAA0Bd,gBAAC,SAAAgB,CAAA,EAAAhB,EAAAA,CAAA,EAAAC,wBAAAA,SAAAA,CAAAA,EAAAA,EAAAA,CAAA,EAAAC,UAAAA,SAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAW,EAAAA,IAAAA,CAAAA,iBAAAA,CAAAV,QAAAA,SAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAU,EAAAA,IAAAA,CAAAA,QAAAA,CAAA,QAAA,SAAAG,CAAA,EAAAZ,EAAAA,CAAA,EAAAC,YAAAA,SAAAA,CAAAA,EAAAA,EAAAA,CAAA,EAAAC,UAAAA,SAAAA,CAAAA,EAAAA,EAAAA,CAAA,EAAAC,QAAAA,SAAAA,CAAAA,EAAAA,EAAAA,CAAA,EAAAC,SAAAA,SAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAK,EAAAA,IAAAA,CAAAA,2CAAAA,CAAAJ,kCAAAA,SAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAI,EAAAA,IAAAA,CAAAA,qBAAAA,CAAAH,YAAAA,SAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAG,EAAAA,IAAAA,CAAAA,kDAAAA,CAAAF,gCAAAA,SAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAE,EAAAA,IAAAA,CAAAA,iDAAAA,CAAAD,+BAAAA,SAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAA/FC,EAAOI,aAAE,CAc0D,SAAAC,CAAA,EAAqC,IAAlCC,EAAQD,EAARC,QAAQ,CAAAC,EAAAF,EAAEG,UAAU,CACnFC,EAA0BrB,EAC/BM,EAAQ,WAAA,MAAM,CAAC,0BAA2B,0BAA2B,2BAA2B,EAAE,EAAE,GAG/FgB,EAAmBF,AALgE,KAAA,IAAAD,GAAQA,GAK1DE,EAEjCE,EAAmBjB,EACxB,WAAA,OAAOgB,EAAmBZ,EAAkCC,CAA8B,EAC1F,CAACW,EAAiB,EAGqFE,EAAA1B,EAAxES,EAAS,WAAA,OAAML,EAAQuB,WAAW,CAAC,WAAA,MAAM,CAACF,EAAiBG,KAAK,CAACC,GAAG,EAAE,EAAC,GAAC,GAAjGC,EAASJ,CAAA,CAAA,EAAA,CAAEK,EAAUL,CAAA,CAAA,EAAA,CAE5BnB,EAAU,WACT,IAAIyB,EAAU,CAAA,EAgBd,OAdmBlC,EAAAmC,KAAA,CAAA,SAAAC,CAAA,EAAA,OAAA,OAAAA,EAAAC,IAAA,CAAAD,EAAAE,IAAA,EAAA,KAAA,EAAA,GACbhC,EAAQuB,WAAW,CAAC,WAAA,OAAMF,EAAiBG,KAAK,CAACC,GAAG,EAAE,GAAC,CAAAK,EAAAE,IAAA,CAAA,EAAA,KAAA,CAAA,OAAAF,EAAAE,IAAA,CAAA,EAAAtC,EAAAuC,KAAA,CACrDZ,EAAiBa,IAAI,GAAE,MAAA,EAAA,GAGzBN,EAAO,CAAAE,EAAAE,IAAA,CAAA,EAAA,KAAA,CAAA,OAAAF,EAAAK,MAAA,CAAA,SAAA,MAAA,EAIZR,EAAW,CAAA,EAAO,MAAA,EAAA,IAAA,MAAA,OAAAG,EAAAM,IAAA,EAAA,CAAA,EAAA,KAAA,KAAA,KAAAC,SAKZ,WACNT,EAAU,CAAA,CACX,CACD,EAAG,CAACP,EAAiB,EAErB,IAAMiB,EAAelC,EACpB,WAAA,OACCE,EAAkC,SAACiC,CAAG,EACrC,IAAMC,EAAenB,EAAiBoB,UAAU,CAACC,OAAO,CAACH,GACzD,OAAOC,EAAY7C,EAAA,CAAA,EAAQ6C,GAAiBG,KAAAA,CAC7C,EAAE,EACH,CAACtB,EAAiB,EAGbuB,EAAgBxC,EACrB,WAAA,OACCE,EAAkC,WAAA,IAACuC,EAAKC,UAAAC,MAAA,CAAA,GAAAD,AAAAH,KAAAA,IAAAG,SAAA,CAAA,EAAA,CAAAA,SAAA,CAAA,EAAA,CAAG,CAAA,EAAE,OAC5CzB,EAAiBoB,UAAU,CACzBO,IAAI,CAAArD,EAAAA,EAAAA,EAAAA,EAAA,CAAA,EAEC,QAASkD,GAASI,MAAMC,OAAO,CAACL,EAAMN,GAAG,GAAK,CAAEA,IAAK,CAAEY,IAAKN,EAAMN,GAAAA,AAAG,CAAE,GACvE,QAASM,GAAS,CAACI,MAAMC,OAAO,CAACL,EAAMN,GAAG,GAAK,CAAEA,IAAKM,EAAMN,GAAAA,AAAG,GAC/D,UAAWM,GAAS,CAAEO,MAAOP,EAAMO,KAAAA,AAAK,GACxC,YAAaP,GACfA,CAAAA,EAAMQ,OAAO,CACX,CAAEA,QAASR,EAAMQ,OAAAA,AAAO,EACxB,CACAC,IAAK,CAAC,CAAED,QAAS,CAAEE,QAAS,CAAA,CAAK,CAAE,EAAI,CAAEF,QAASV,KAAAA,CAAS,EAAE,IAGlE,CACCa,KAAM,CACLH,QAAS,EACTI,OAAQ,EACRC,UAAW,KAIbC,KAAK,EAAE,EACT,EACF,CAACtC,EAAiB,EAGbuC,EAAyB,SAACC,CAA0B,EACzDA,EAAQC,OAAO,CAAC,SAACC,CAAG,EAEb,uBADEA,EAAIxB,GAAG,EAEbhC,EAAYyD,iBAAiB,CAAC,CAAC,WAAW,CAM7C,EACD,EAEMC,EAAelE,EAAU,gBACzBmE,EAAWhE,EAChB,SAAO2D,CAAO,EAAA,OAAAnE,EAAAmC,KAAA,CAAA,SAAAsC,CAAA,EAAA,OAAA,OAAAA,EAAApC,IAAA,CAAAoC,EAAAnC,IAAA,EAAA,KAAA,EACmB,OAAhC4B,EAAuBC,GAASM,EAAAnC,IAAA,CAAA,EAAAtC,EAAAuC,KAAA,CAC1BgC,EAAaJ,GAAQ,MAAA,EAAA,IAAA,MAAA,OAAAM,EAAA/B,IAAA,EAAA,CAAA,EAAA,KAAA,KAAA,KAAAC,QAAA,EAE5B,CAAC4B,EAAa,EAGTG,EAAehE,EACpB,WAAA,MAAO,CACNgB,iBAAAA,EACAM,UAAAA,EACAY,aAAAA,EACAM,cAAAA,EACAsB,SAAAA,EACA,EACD,CAAC9C,EAAkBM,EAAWY,EAAcM,EAAesB,EAAS,EAGrE,OAAOjE,EAAAoE,aAAA,CAACxE,EAAgByE,QAAQ,CAAA,CAACtD,SAAUA,EAAUuD,MAAOH,CAAa,EAC1E"}
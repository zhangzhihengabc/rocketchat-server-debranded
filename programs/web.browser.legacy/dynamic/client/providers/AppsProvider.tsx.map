)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/providers/AppsProvider.tsx","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import { useDebouncedCallback } from '@rocket.chat/fuselage-hooks';\nimport { usePermission, useSingleStream } from '@rocket.chat/ui-contexts';\nimport { useQuery, useQueryClient } from '@tanstack/react-query';\nimport type { FC } from 'react';\nimport React, { useEffect } from 'react';\n\nimport { AppClientOrchestratorInstance } from '../../ee/client/apps/orchestrator';\nimport { AppsContext } from '../contexts/AppsContext';\nimport { useIsEnterprise } from '../hooks/useIsEnterprise';\nimport { useInvalidateLicense } from '../hooks/useLicense';\nimport { AsyncStatePhase } from '../lib/asyncState';\nimport { useInvalidateAppsCountQueryCallback } from '../views/marketplace/hooks/useAppsCountQuery';\nimport type { App } from '../views/marketplace/types';\n\nconst sortByName = (apps: App[]): App[] => apps.sort((a, b) => (a.name.toLowerCase() > b.name.toLowerCase() ? 1 : -1));\n\nconst AppsProvider: FC = ({ children }) => {\n\tconst isAdminUser = usePermission('manage-apps');\n\n\tconst queryClient = useQueryClient();\n\n\tconst { data } = useIsEnterprise();\n\tconst isEnterprise = !!data?.isEnterprise;\n\n\tconst invalidateAppsCountQuery = useInvalidateAppsCountQueryCallback();\n\tconst invalidateLicenseQuery = useInvalidateLicense();\n\n\tconst stream = useSingleStream('apps');\n\n\tconst invalidate = useDebouncedCallback(\n\t\t() => {\n\t\t\tqueryClient.invalidateQueries(['marketplace', 'apps-instance']);\n\t\t\tinvalidateAppsCountQuery();\n\t\t},\n\t\t100,\n\t\t[],\n\t);\n\n\tuseEffect(() => {\n\t\treturn stream('apps', ([key]) => {\n\t\t\tif (['app/added', 'app/removed', 'app/updated', 'app/statusUpdate', 'app/settingUpdated'].includes(key)) {\n\t\t\t\tinvalidate();\n\t\t\t}\n\t\t\tif (['app/added', 'app/removed'].includes(key) && !isEnterprise) {\n\t\t\t\tinvalidateLicenseQuery();\n\t\t\t}\n\t\t});\n\t}, [invalidate, invalidateLicenseQuery, isEnterprise, stream]);\n\n\tconst marketplace = useQuery(\n\t\t['marketplace', 'apps-marketplace', isAdminUser],\n\t\t() => {\n\t\t\tconst result = AppClientOrchestratorInstance.getAppsFromMarketplace(isAdminUser);\n\t\t\tqueryClient.invalidateQueries(['marketplace', 'apps-stored']);\n\t\t\treturn result;\n\t\t},\n\t\t{\n\t\t\tstaleTime: Infinity,\n\t\t\tkeepPreviousData: true,\n\t\t\tonSettled: () => queryClient.invalidateQueries(['marketplace', 'apps-stored']),\n\t\t},\n\t);\n\n\tconst instance = useQuery(\n\t\t['marketplace', 'apps-instance', isAdminUser],\n\t\tasync () => {\n\t\t\tconst result = await AppClientOrchestratorInstance.getInstalledApps().then((result: App[]) =>\n\t\t\t\tresult.map((current: App) => ({\n\t\t\t\t\t...current,\n\t\t\t\t\tinstalled: true,\n\t\t\t\t})),\n\t\t\t);\n\t\t\treturn result;\n\t\t},\n\t\t{\n\t\t\tstaleTime: Infinity,\n\t\t\tonSettled: () => queryClient.invalidateQueries(['marketplace', 'apps-stored']),\n\t\t},\n\t);\n\n\tconst store = useQuery(\n\t\t['marketplace', 'apps-stored', instance.data, marketplace.data],\n\t\t() => {\n\t\t\tif (!marketplace.isFetched && !instance.isFetched) {\n\t\t\t\tthrow new Error('Apps not loaded');\n\t\t\t}\n\n\t\t\tconst marketplaceApps: App[] = [];\n\t\t\tconst installedApps: App[] = [];\n\t\t\tconst privateApps: App[] = [];\n\t\t\tconst clonedData = [...(instance.data || [])];\n\n\t\t\tsortByName(marketplace.data || []).forEach((app) => {\n\t\t\t\tconst appIndex = clonedData.findIndex(({ id }) => id === app.id);\n\t\t\t\tconst [installedApp] = appIndex > -1 ? clonedData.splice(appIndex, 1) : [];\n\n\t\t\t\tconst record = {\n\t\t\t\t\t...app,\n\t\t\t\t\t...(installedApp && {\n\t\t\t\t\t\tprivate: installedApp.private,\n\t\t\t\t\t\tinstalled: true,\n\t\t\t\t\t\tstatus: installedApp.status,\n\t\t\t\t\t\tversion: installedApp.version,\n\t\t\t\t\t\tlicenseValidation: installedApp.licenseValidation,\n\t\t\t\t\t\tmigrated: installedApp.migrated,\n\t\t\t\t\t}),\n\t\t\t\t\tbundledIn: app.bundledIn,\n\t\t\t\t\tmarketplaceVersion: app.version,\n\t\t\t\t};\n\n\t\t\t\tif (installedApp) {\n\t\t\t\t\tinstalledApps.push(record);\n\t\t\t\t}\n\n\t\t\t\tmarketplaceApps.push(record);\n\t\t\t});\n\n\t\t\tsortByName(clonedData).forEach((app) => {\n\t\t\t\tif (app.private) {\n\t\t\t\t\tprivateApps.push(app);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn [marketplaceApps, installedApps, privateApps];\n\t\t},\n\t\t{\n\t\t\tenabled: marketplace.isFetched && instance.isFetched,\n\t\t\tkeepPreviousData: true,\n\t\t},\n\t);\n\n\treturn (\n\t\t<AppsContext.Provider\n\t\t\tchildren={children}\n\t\t\tvalue={{\n\t\t\t\tinstalledApps: { phase: AsyncStatePhase.RESOLVED, value: { apps: store.data?.[1] || [] } },\n\t\t\t\tmarketplaceApps: { phase: AsyncStatePhase.RESOLVED, value: { apps: store.data?.[0] || [] } },\n\t\t\t\tprivateApps: { phase: AsyncStatePhase.RESOLVED, value: { apps: store.data?.[2] || [] } },\n\t\t\t\treload: async () => {\n\t\t\t\t\tawait Promise.all([queryClient.invalidateQueries(['marketplace'])]);\n\t\t\t\t},\n\t\t\t}}\n\t\t/>\n\t);\n};\nexport default AppsProvider;\n",null],"names":["module","link","default","v","_regeneratorRuntime","_toConsumableArray","_objectSpread","_slicedToArray","useDebouncedCallback","usePermission","useSingleStream","useQuery","useQueryClient","React","useEffect","AppClientOrchestratorInstance","AppsContext","useIsEnterprise","useInvalidateLicense","AsyncStatePhase","useInvalidateAppsCountQueryCallback","sortByName","apps","sort","a","b","name","toLowerCase","exportDefault","_ref","_store$data","_store$data2","_store$data3","children","isAdminUser","queryClient","data","_useIsEnterprise","isEnterprise","invalidateAppsCountQuery","invalidateLicenseQuery","stream","invalidate","invalidateQueries","_ref2","key","_ref3","includes","marketplace","result","getAppsFromMarketplace","staleTime","Infinity","keepPreviousData","onSettled","instance","async","_context","prev","next","awrap","getInstalledApps","then","map","current","installed","sent","abrupt","stop","Promise","store","isFetched","Error","marketplaceApps","installedApps","privateApps","clonedData","forEach","app","appIndex","findIndex","_ref4","id","installedApp","_ref6","splice","record","private","status","version","licenseValidation","migrated","bundledIn","marketplaceVersion","push","enabled","createElement","Provider","value","phase","RESOLVED","reload","_context2","all"],"mappings":"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"}
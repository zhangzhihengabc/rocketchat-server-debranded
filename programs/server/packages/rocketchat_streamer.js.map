{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:streamer/lib/ev.js","meteor://ðŸ’»app/packages/rocketchat:streamer/server/server.js"],"names":["EV","constructor","handlers","emit","event","args","forEach","handler","apply","emitWithScope","scope","listenerCount","length","on","callback","push","once","self","onetimeCallback","removeListener","arguments","index","indexOf","splice","removeAllListeners","undefined","DDPCommon","module","link","v","StreamerCentral","instances","Meteor","changedPayload","collection","id","fields","_","isEmpty","stringifyDDP","msg","send","socket","Streamer","name","retransmit","retransmitToSelf","console","warn","subscriptions","subscriptionsByEventName","transformers","iniPublication","initMethod","_allowRead","_allowEmit","_allowWrite","allowRead","allowEmit","allowWrite","_name","check","String","subscriptionName","_retransmit","Boolean","_retransmitToSelf","eventName","fn","error","userId","isReadAllowed","call","isEmitAllowed","isWriteAllowed","addSubscription","subscription","removeSubscription","transform","applyTransformers","methodScope","tranformed","Array","isArray","_publish","publication","options","Match","OneOf","useCollection","stop","Error","onStop","_session","sendAdded","ready","stream","publish","method","unblock","connection","originalParams","_emit","methods","e","origin","broadcast","__emit","emitWithoutBroadcast"],"mappings":"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","file":"/packages/rocketchat_streamer.js","sourcesContent":["/* globals EV:true */\n/* exported EV */\n\nEV = class EV {\n\tconstructor() {\n\t\tthis.handlers = {};\n\t}\n\n\temit(event, ...args) {\n\t\treturn this.handlers[event] && this.handlers[event].forEach(handler => handler.apply(this, args));\n\t}\n\n\temitWithScope(event, scope, ...args) {\n\t\treturn this.handlers[event] && this.handlers[event].forEach(handler => handler.apply(scope, args));\n\t}\n\n\tlistenerCount(event) {\n\t\treturn (this.handlers[event] && this.handlers[event].length) || 0;\n\t}\n\n\ton(event, callback) {\n\t\tif (!this.handlers[event]) {\n\t\t\tthis.handlers[event] = [];\n\t\t}\n\t\tthis.handlers[event].push(callback);\n\t}\n\n\tonce(event, callback) {\n\t\tconst self = this;\n\t\tthis.on(event, function onetimeCallback() {\n\t\t\tself.removeListener(event, onetimeCallback);\n\t\t\tcallback.apply(this, arguments);\n\t\t});\n\t}\n\n\tremoveListener(event, callback) {\n\t\tif (!this.handlers[event]) {\n\t\t\treturn;\n\t\t}\n\t\tconst index = this.handlers[event].indexOf(callback);\n\t\tif (index > -1) {\n\t\t\tthis.handlers[event].splice(index, 1);\n\t\t}\n\t}\n\n\tremoveAllListeners(event) {\n\t\tthis.handlers[event] = undefined;\n\t}\n};\n","/* globals EV */\n/* eslint new-cap: false */\nimport { DDPCommon } from 'meteor/ddp-common';\n\nclass StreamerCentral extends EV {\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.instances = {};\n\t}\n}\n\nMeteor.StreamerCentral = new StreamerCentral;\n\nconst changedPayload = function (collection, id, fields) {\n\tif (_.isEmpty(fields)) {\n\t\treturn;\n\t}\n\treturn DDPCommon.stringifyDDP({\n\t\tmsg: 'changed',\n\t\tcollection,\n\t\tid,\n\t\tfields\n\t});\n};\n\nconst send = function (self, msg) {\n\tif (!self.socket) {\n\t\treturn;\n\t}\n\tself.socket.send(msg);\n};\n\n\nMeteor.Streamer = class Streamer extends EV {\n\tconstructor(name, {retransmit = true, retransmitToSelf = false} = {}) {\n\t\tif (Meteor.StreamerCentral.instances[name]) {\n\t\t\tconsole.warn('Streamer instance already exists:', name);\n\t\t\treturn Meteor.StreamerCentral.instances[name];\n\t\t}\n\n\t\tsuper();\n\n\t\tMeteor.StreamerCentral.instances[name] = this;\n\n\t\tthis.name = name;\n\t\tthis.retransmit = retransmit;\n\t\tthis.retransmitToSelf = retransmitToSelf;\n\n\t\tthis.subscriptions = [];\n\t\tthis.subscriptionsByEventName = {};\n\t\tthis.transformers = {};\n\n\t\tthis.iniPublication();\n\t\tthis.initMethod();\n\n\t\tthis._allowRead = {};\n\t\tthis._allowEmit = {};\n\t\tthis._allowWrite = {};\n\n\t\tthis.allowRead('none');\n\t\tthis.allowEmit('all');\n\t\tthis.allowWrite('none');\n\t}\n\n\tget name() {\n\t\treturn this._name;\n\t}\n\n\tset name(name) {\n\t\tcheck(name, String);\n\t\tthis._name = name;\n\t}\n\n\tget subscriptionName() {\n\t\treturn `stream-${this.name}`;\n\t}\n\n\tget retransmit() {\n\t\treturn this._retransmit;\n\t}\n\n\tset retransmit(retransmit) {\n\t\tcheck(retransmit, Boolean);\n\t\tthis._retransmit = retransmit;\n\t}\n\n\tget retransmitToSelf() {\n\t\treturn this._retransmitToSelf;\n\t}\n\n\tset retransmitToSelf(retransmitToSelf) {\n\t\tcheck(retransmitToSelf, Boolean);\n\t\tthis._retransmitToSelf = retransmitToSelf;\n\t}\n\n\tallowRead(eventName, fn) {\n\t\tif (fn === undefined) {\n\t\t\tfn = eventName;\n\t\t\teventName = '__all__';\n\t\t}\n\n\t\tif (typeof fn === 'function') {\n\t\t\treturn this._allowRead[eventName] = fn;\n\t\t}\n\n\t\tif (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n\t\t\tconsole.error(`allowRead shortcut '${fn}' is invalid`);\n\t\t}\n\n\t\tif (fn === 'all' || fn === true) {\n\t\t\treturn this._allowRead[eventName] = function() {\n\t\t\t\treturn true;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'none' || fn === false) {\n\t\t\treturn this._allowRead[eventName] = function() {\n\t\t\t\treturn false;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'logged') {\n\t\t\treturn this._allowRead[eventName] = function() {\n\t\t\t\treturn Boolean(this.userId);\n\t\t\t};\n\t\t}\n\t}\n\n\tallowEmit(eventName, fn) {\n\t\tif (fn === undefined) {\n\t\t\tfn = eventName;\n\t\t\teventName = '__all__';\n\t\t}\n\n\t\tif (typeof fn === 'function') {\n\t\t\treturn this._allowEmit[eventName] = fn;\n\t\t}\n\n\t\tif (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n\t\t\tconsole.error(`allowRead shortcut '${fn}' is invalid`);\n\t\t}\n\n\t\tif (fn === 'all' || fn === true) {\n\t\t\treturn this._allowEmit[eventName] = function() {\n\t\t\t\treturn true;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'none' || fn === false) {\n\t\t\treturn this._allowEmit[eventName] = function() {\n\t\t\t\treturn false;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'logged') {\n\t\t\treturn this._allowEmit[eventName] = function() {\n\t\t\t\treturn Boolean(this.userId);\n\t\t\t};\n\t\t}\n\t}\n\n\tallowWrite(eventName, fn) {\n\t\tif (fn === undefined) {\n\t\t\tfn = eventName;\n\t\t\teventName = '__all__';\n\t\t}\n\n\t\tif (typeof fn === 'function') {\n\t\t\treturn this._allowWrite[eventName] = fn;\n\t\t}\n\n\t\tif (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n\t\t\tconsole.error(`allowWrite shortcut '${fn}' is invalid`);\n\t\t}\n\n\t\tif (fn === 'all' || fn === true) {\n\t\t\treturn this._allowWrite[eventName] = function() {\n\t\t\t\treturn true;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'none' || fn === false) {\n\t\t\treturn this._allowWrite[eventName] = function() {\n\t\t\t\treturn false;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'logged') {\n\t\t\treturn this._allowWrite[eventName] = function() {\n\t\t\t\treturn Boolean(this.userId);\n\t\t\t};\n\t\t}\n\t}\n\n\tisReadAllowed(scope, eventName, args) {\n\t\tif (this._allowRead[eventName]) {\n\t\t\treturn this._allowRead[eventName].call(scope, eventName, ...args);\n\t\t}\n\n\t\treturn this._allowRead['__all__'].call(scope, eventName, ...args);\n\t}\n\n\tisEmitAllowed(scope, eventName, ...args) {\n\t\tif (this._allowEmit[eventName]) {\n\t\t\treturn this._allowEmit[eventName].call(scope, eventName, ...args);\n\t\t}\n\n\t\treturn this._allowEmit['__all__'].call(scope, eventName, ...args);\n\t}\n\n\tisWriteAllowed(scope, eventName, args) {\n\t\tif (this._allowWrite[eventName]) {\n\t\t\treturn this._allowWrite[eventName].call(scope, eventName, ...args);\n\t\t}\n\n\t\treturn this._allowWrite['__all__'].call(scope, eventName, ...args);\n\t}\n\n\taddSubscription(subscription, eventName) {\n\t\tthis.subscriptions.push(subscription);\n\n\t\tif (!this.subscriptionsByEventName[eventName]) {\n\t\t\tthis.subscriptionsByEventName[eventName] = [];\n\t\t}\n\n\t\tthis.subscriptionsByEventName[eventName].push(subscription);\n\t}\n\n\tremoveSubscription(subscription, eventName) {\n\t\tconst index = this.subscriptions.indexOf(subscription);\n\t\tif (index > -1) {\n\t\t\tthis.subscriptions.splice(index, 1);\n\t\t}\n\n\t\tif (this.subscriptionsByEventName[eventName]) {\n\t\t\tconst index = this.subscriptionsByEventName[eventName].indexOf(subscription);\n\t\t\tif (index > -1) {\n\t\t\t\tthis.subscriptionsByEventName[eventName].splice(index, 1);\n\t\t\t}\n\t\t}\n\t}\n\n\ttransform(eventName, fn) {\n\t\tif (typeof eventName === 'function') {\n\t\t\tfn = eventName;\n\t\t\teventName = '__all__';\n\t\t}\n\n\t\tif (!this.transformers[eventName]) {\n\t\t\tthis.transformers[eventName] = [];\n\t\t}\n\n\t\tthis.transformers[eventName].push(fn);\n\t}\n\n\tapplyTransformers(methodScope, eventName, args) {\n\t\tif (this.transformers['__all__']) {\n\t\t\tthis.transformers['__all__'].forEach((transform) => {\n\t\t\t\targs = transform.call(methodScope, eventName, args);\n\t\t\t\tmethodScope.tranformed = true;\n\t\t\t\tif (!Array.isArray(args)) {\n\t\t\t\t\targs = [args];\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (this.transformers[eventName]) {\n\t\t\tthis.transformers[eventName].forEach((transform) => {\n\t\t\t\targs = transform.call(methodScope, ...args);\n\t\t\t\tmethodScope.tranformed = true;\n\t\t\t\tif (!Array.isArray(args)) {\n\t\t\t\t\targs = [args];\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn args;\n\t}\n\n\n\t_publish(publication, eventName, options) {\n\t\tcheck(eventName, String);\n\t\tcheck(options, Match.OneOf(Boolean, {\n\t\t\tuseCollection: Boolean,\n\t\t\targs: Array,\n\t\t}));\n\n\t\tlet useCollection, args = [];\n\n\t\tif (typeof options === 'boolean') {\n\t\t\tuseCollection = options;\n\t\t} else {\n\t\t\tif (options.useCollection) {\n\t\t\t\tuseCollection = options.useCollection;\n\t\t\t}\n\n\t\t\tif (options.args) {\n\t\t\t\targs = options.args;\n\t\t\t}\n\t\t}\n\n\t\tif (eventName.length === 0) {\n\t\t\tpublication.stop();\n\t\t\tthrow new Meteor.Error('invalid-event-name');\n\t\t}\n\n\t\tif (this.isReadAllowed(publication, eventName, args) !== true) {\n\t\t\tpublication.stop();\n\t\t\tthrow new Meteor.Error('not-allowed');\n\t\t}\n\n\t\tconst subscription = {\n\t\t\tsubscription: publication,\n\t\t\teventName: eventName\n\t\t};\n\n\t\tthis.addSubscription(subscription, eventName);\n\n\t\tpublication.onStop(() => {\n\t\t\tthis.removeSubscription(subscription, eventName);\n\t\t});\n\n\t\tif (useCollection === true) {\n\t\t\t// Collection compatibility\n\t\t\tpublication._session.sendAdded(this.subscriptionName, 'id', {\n\t\t\t\teventName: eventName\n\t\t\t});\n\t\t}\n\n\t\tpublication.ready();\n\t}\n\n\tiniPublication() {\n\t\tconst stream = this;\n\t\tMeteor.publish(this.subscriptionName, function (...args) { return stream._publish.apply(stream, [this, ...args]); });\n\t}\n\n\tinitMethod() {\n\t\tconst stream = this;\n\t\tconst method = {};\n\n\t\tmethod[this.subscriptionName] = function(eventName, ...args) {\n\t\t\tcheck(eventName, String);\n\t\t\tcheck(args, Array);\n\n\t\t\tthis.unblock();\n\n\t\t\tif (stream.isWriteAllowed(this, eventName, args) !== true) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst methodScope = {\n\t\t\t\tuserId: this.userId,\n\t\t\t\tconnection: this.connection,\n\t\t\t\toriginalParams: args,\n\t\t\t\ttranformed: false\n\t\t\t};\n\n\t\t\targs = stream.applyTransformers(methodScope, eventName, args);\n\n\t\t\tstream.emitWithScope(eventName, methodScope, ...args);\n\n\t\t\tif (stream.retransmit === true) {\n\t\t\t\tstream._emit(eventName, args, this.connection, true);\n\t\t\t}\n\t\t};\n\n\t\ttry {\n\t\t\tMeteor.methods(method);\n\t\t} catch (e) {\n\t\t\tconsole.error(e);\n\t\t}\n\t}\n\n\t_emit(eventName, args, origin, broadcast) {\n\t\tif (broadcast === true) {\n\t\t\tMeteor.StreamerCentral.emit('broadcast', this.name, eventName, args);\n\t\t}\n\n\t\tconst subscriptions = this.subscriptionsByEventName[eventName];\n\t\tif (!Array.isArray(subscriptions)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst msg = changedPayload(this.subscriptionName, 'id', {\n\t\t\teventName,\n\t\t\targs\n\t\t});\n\n\t\tif(!msg) {\n\t\t\treturn;\n\t\t}\n\n\t\tsubscriptions.forEach((subscription) => {\n\t\t\tif (this.retransmitToSelf === false && origin && origin === subscription.subscription.connection) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (this.isEmitAllowed(subscription.subscription, eventName, ...args)) {\n\t\t\t\tsend(subscription.subscription._session, msg);\n\t\t\t}\n\t\t});\n\t}\n\n\temit(eventName, ...args) {\n\t\tthis._emit(eventName, args, undefined, true);\n\t}\n\n\t__emit(...args) {\n\t\treturn super.emit(...args);\n\t}\n\n\temitWithoutBroadcast(eventName, ...args) {\n\t\tthis._emit(eventName, args, undefined, false);\n\t}\n};\n"]}
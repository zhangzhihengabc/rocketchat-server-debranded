function module(e,t,s){let r,a,i,n;s.export({UserAgentClient:()=>o}),s.link("../messages",{C(e){r=e},IncomingResponseMessage(e){a=e}},0),s.link("../transactions",{NonInviteClientTransaction(e){i=e},TransactionState(e){n=e}},1);class o{constructor(e,t,s,r){this.transactionConstructor=e,this.core=t,this.message=s,this.delegate=r,this.challenged=!1,this.stale=!1,this.logger=this.loggerFactory.getLogger("sip.user-agent-client"),this.init()}dispose(){this.transaction.dispose()}get loggerFactory(){return this.core.loggerFactory}get transaction(){if(!this._transaction)throw Error("Transaction undefined.");return this._transaction}cancel(e,t={}){if(!this.transaction)throw Error("Transaction undefined.");if(!this.message.to)throw Error("To undefined.");if(!this.message.from)throw Error("From undefined.");let s=this.core.makeOutgoingRequestMessage(r.CANCEL,this.message.ruri,this.message.from.uri,this.message.to.uri,{toTag:this.message.toTag,fromTag:this.message.fromTag,callId:this.message.callId,cseq:this.message.cseq},t.extraHeaders);return s.branch=this.message.branch,this.message.headers.Route&&(s.headers.Route=this.message.headers.Route),e&&s.setHeader("Reason",e),this.transaction.state===n.Proceeding?new o(i,this.core,s):this.transaction.addStateChangeListener(()=>{this.transaction&&this.transaction.state===n.Proceeding&&new o(i,this.core,s)},{once:!0}),s}authenticationGuard(e,t){let s,r;let a=e.statusCode;if(!a)throw Error("Response status code undefined.");if(401!==a&&407!==a)return!0;if(401===a?(s=e.parseHeader("www-authenticate"),r="authorization"):(s=e.parseHeader("proxy-authenticate"),r="proxy-authorization"),!s)return this.logger.warn(a+" with wrong or missing challenge, cannot authenticate"),!0;if(this.challenged&&(this.stale||!0!==s.stale))return this.logger.warn(a+" apparently in authentication loop, cannot authenticate"),!0;if(!this.credentials&&(this.credentials=this.core.configuration.authenticationFactory(),!this.credentials))return this.logger.warn("Unable to obtain credentials, cannot authenticate"),!0;if(!this.credentials.authenticate(this.message,s))return!0;this.challenged=!0,s.stale&&(this.stale=!0);let i=this.message.cseq+=1;return t&&t.localSequenceNumber&&(t.incrementLocalSequenceNumber(),i=this.message.cseq=t.localSequenceNumber),this.message.setHeader("cseq",i+" "+this.message.method),this.message.setHeader(r,this.credentials.toString()),this.init(),!1}onRequestTimeout(){this.logger.warn("User agent client request timed out. Generating internal 408 Request Timeout.");let e=new a;e.statusCode=408,e.reasonPhrase="Request Timeout",this.receiveResponse(e)}onTransportError(e){this.logger.error(e.message),this.logger.error("User agent client request transport error. Generating internal 503 Service Unavailable.");let t=new a;t.statusCode=503,t.reasonPhrase="Service Unavailable",this.receiveResponse(t)}receiveResponse(e){if(!this.authenticationGuard(e))return;let t=e.statusCode?e.statusCode.toString():"";if(!t)throw Error("Response status code undefined.");switch(!0){case/^100$/.test(t):this.delegate&&this.delegate.onTrying&&this.delegate.onTrying({message:e});break;case/^1[0-9]{2}$/.test(t):this.delegate&&this.delegate.onProgress&&this.delegate.onProgress({message:e});break;case/^2[0-9]{2}$/.test(t):this.delegate&&this.delegate.onAccept&&this.delegate.onAccept({message:e});break;case/^3[0-9]{2}$/.test(t):this.delegate&&this.delegate.onRedirect&&this.delegate.onRedirect({message:e});break;case/^[4-6][0-9]{2}$/.test(t):this.delegate&&this.delegate.onReject&&this.delegate.onReject({message:e});break;default:throw Error(`Invalid status code ${t}`)}}init(){let e={loggerFactory:this.loggerFactory,onRequestTimeout:()=>this.onRequestTimeout(),onStateChange:e=>{e===n.Terminated&&(this.core.userAgentClients.delete(s),t===this._transaction&&this.dispose())},onTransportError:e=>this.onTransportError(e),receiveResponse:e=>this.receiveResponse(e)},t=new this.transactionConstructor(this.message,this.core.transport,e);this._transaction=t;let s=t.id+t.request.method;this.core.userAgentClients.set(s,this)}}}
//# sourceMappingURL=/dynamic/node_modules/sip.js/lib/core/user-agents/091fe76607faa013e91d72458cddcee573ed03ff.map

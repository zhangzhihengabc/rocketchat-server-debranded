)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/methods/updateMessage.ts","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { IEditedMessage } from '@rocket.chat/core-typings';\nimport type { ServerMethods } from '@rocket.chat/ui-contexts';\nimport { Meteor } from 'meteor/meteor';\nimport { Tracker } from 'meteor/tracker';\nimport moment from 'moment';\n\nimport { hasAtLeastOnePermission, hasPermission } from '../../app/authorization/client';\nimport { ChatMessage } from '../../app/models/client';\nimport { settings } from '../../app/settings/client';\nimport { t } from '../../app/utils/lib/i18n';\nimport { callbacks } from '../../lib/callbacks';\nimport { dispatchToastMessage } from '../lib/toast';\n\nMeteor.methods<ServerMethods>({\n\tupdateMessage(message) {\n\t\tconst uid = Meteor.userId();\n\t\tif (!uid) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst originalMessage = ChatMessage.findOne(message._id);\n\n\t\tif (!originalMessage) {\n\t\t\treturn;\n\t\t}\n\t\tconst canEditMessage = hasAtLeastOnePermission('edit-message', message.rid);\n\t\tconst editAllowed = settings.get('Message_AllowEditing');\n\t\tlet editOwn = false;\n\n\t\tconst msgText = originalMessage?.attachments?.[0]?.description ?? originalMessage.msg;\n\n\t\tif (msgText === message.msg) {\n\t\t\treturn;\n\t\t}\n\t\tif (originalMessage?.u?._id) {\n\t\t\teditOwn = originalMessage.u._id === uid;\n\t\t}\n\n\t\tconst me = Meteor.users.findOne(uid);\n\n\t\tif (!me) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!(canEditMessage || (editAllowed && editOwn))) {\n\t\t\tdispatchToastMessage({\n\t\t\t\ttype: 'error',\n\t\t\t\tmessage: t('error-action-not-allowed', { action: t('Message_editing') }),\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\n\t\tconst blockEditInMinutes = Number(settings.get('Message_AllowEditing_BlockEditInMinutes') as number | undefined);\n\t\tconst bypassBlockTimeLimit = hasPermission('bypass-time-limit-edit-and-delete');\n\n\t\tif (!bypassBlockTimeLimit && blockEditInMinutes !== 0) {\n\t\t\tif (originalMessage.ts) {\n\t\t\t\tconst msgTs = moment(originalMessage.ts);\n\t\t\t\tif (msgTs) {\n\t\t\t\t\tconst currentTsDiff = moment().diff(msgTs, 'minutes');\n\t\t\t\t\tif (currentTsDiff > blockEditInMinutes) {\n\t\t\t\t\t\tdispatchToastMessage({ type: 'error', message: t('error-message-editing-blocked') });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tTracker.nonreactive(async () => {\n\t\t\tmessage.editedAt = new Date(Date.now());\n\n\t\t\tmessage.editedBy = {\n\t\t\t\t_id: uid,\n\t\t\t\tusername: me.username,\n\t\t\t};\n\n\t\t\tmessage = (await callbacks.run('beforeSaveMessage', message)) as IEditedMessage;\n\t\t\tconst messageObject: Partial<IEditedMessage> = {\n\t\t\t\teditedAt: message.editedAt,\n\t\t\t\teditedBy: message.editedBy,\n\t\t\t\tmsg: message.msg,\n\t\t\t};\n\n\t\t\tif (originalMessage.attachments?.length) {\n\t\t\t\tif (originalMessage.attachments[0].description !== undefined) {\n\t\t\t\t\tdelete messageObject.msg;\n\t\t\t\t\toriginalMessage.attachments[0].description = message.msg;\n\t\t\t\t}\n\t\t\t}\n\t\t\tChatMessage.update(\n\t\t\t\t{\n\t\t\t\t\t'_id': message._id,\n\t\t\t\t\t'u._id': uid,\n\t\t\t\t},\n\t\t\t\t{ $set: messageObject },\n\t\t\t);\n\t\t});\n\t},\n});\n",null],"names":["Meteor","Tracker","moment","hasAtLeastOnePermission","hasPermission","ChatMessage","settings","t","callbacks","dispatchToastMessage","module","link","default","methods","updateMessage","message","_originalMessage$atta","_originalMessage$atta2","_originalMessage$atta3","_originalMessage$u","uid","userId","originalMessage","findOne","_id","canEditMessage","rid","editAllowed","get","editOwn","msgText","attachments","description","msg","u","me","users","type","action","blockEditInMinutes","Number","bypassBlockTimeLimit","ts","msgTs","currentTsDiff","diff","nonreactive","_originalMessage$atta4","editedAt","Date","now","editedBy","username","run","messageObject","length","undefined","update","$set"],"mappings":"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"}
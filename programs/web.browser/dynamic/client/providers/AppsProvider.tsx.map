)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/providers/AppsProvider.tsx","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import { useDebouncedCallback } from '@rocket.chat/fuselage-hooks';\nimport { usePermission, useSingleStream } from '@rocket.chat/ui-contexts';\nimport { useQuery, useQueryClient } from '@tanstack/react-query';\nimport type { FC } from 'react';\nimport React, { useEffect } from 'react';\n\nimport { AppClientOrchestratorInstance } from '../../ee/client/apps/orchestrator';\nimport { AppsContext } from '../contexts/AppsContext';\nimport { useIsEnterprise } from '../hooks/useIsEnterprise';\nimport { useInvalidateLicense } from '../hooks/useLicense';\nimport { AsyncStatePhase } from '../lib/asyncState';\nimport { useInvalidateAppsCountQueryCallback } from '../views/marketplace/hooks/useAppsCountQuery';\nimport type { App } from '../views/marketplace/types';\n\nconst sortByName = (apps: App[]): App[] => apps.sort((a, b) => (a.name.toLowerCase() > b.name.toLowerCase() ? 1 : -1));\n\nconst AppsProvider: FC = ({ children }) => {\n\tconst isAdminUser = usePermission('manage-apps');\n\n\tconst queryClient = useQueryClient();\n\n\tconst { data } = useIsEnterprise();\n\tconst isEnterprise = !!data?.isEnterprise;\n\n\tconst invalidateAppsCountQuery = useInvalidateAppsCountQueryCallback();\n\tconst invalidateLicenseQuery = useInvalidateLicense();\n\n\tconst stream = useSingleStream('apps');\n\n\tconst invalidate = useDebouncedCallback(\n\t\t() => {\n\t\t\tqueryClient.invalidateQueries(['marketplace', 'apps-instance']);\n\t\t\tinvalidateAppsCountQuery();\n\t\t},\n\t\t100,\n\t\t[],\n\t);\n\n\tuseEffect(() => {\n\t\treturn stream('apps', ([key]) => {\n\t\t\tif (['app/added', 'app/removed', 'app/updated', 'app/statusUpdate', 'app/settingUpdated'].includes(key)) {\n\t\t\t\tinvalidate();\n\t\t\t}\n\t\t\tif (['app/added', 'app/removed'].includes(key) && !isEnterprise) {\n\t\t\t\tinvalidateLicenseQuery();\n\t\t\t}\n\t\t});\n\t}, [invalidate, invalidateLicenseQuery, isEnterprise, stream]);\n\n\tconst marketplace = useQuery(\n\t\t['marketplace', 'apps-marketplace', isAdminUser],\n\t\t() => {\n\t\t\tconst result = AppClientOrchestratorInstance.getAppsFromMarketplace(isAdminUser);\n\t\t\tqueryClient.invalidateQueries(['marketplace', 'apps-stored']);\n\t\t\treturn result;\n\t\t},\n\t\t{\n\t\t\tstaleTime: Infinity,\n\t\t\tkeepPreviousData: true,\n\t\t\tonSettled: () => queryClient.invalidateQueries(['marketplace', 'apps-stored']),\n\t\t},\n\t);\n\n\tconst instance = useQuery(\n\t\t['marketplace', 'apps-instance', isAdminUser],\n\t\tasync () => {\n\t\t\tconst result = await AppClientOrchestratorInstance.getInstalledApps().then((result: App[]) =>\n\t\t\t\tresult.map((current: App) => ({\n\t\t\t\t\t...current,\n\t\t\t\t\tinstalled: true,\n\t\t\t\t})),\n\t\t\t);\n\t\t\treturn result;\n\t\t},\n\t\t{\n\t\t\tstaleTime: Infinity,\n\t\t\tonSettled: () => queryClient.invalidateQueries(['marketplace', 'apps-stored']),\n\t\t},\n\t);\n\n\tconst store = useQuery(\n\t\t['marketplace', 'apps-stored', instance.data, marketplace.data],\n\t\t() => {\n\t\t\tif (!marketplace.isFetched && !instance.isFetched) {\n\t\t\t\tthrow new Error('Apps not loaded');\n\t\t\t}\n\n\t\t\tconst marketplaceApps: App[] = [];\n\t\t\tconst installedApps: App[] = [];\n\t\t\tconst privateApps: App[] = [];\n\t\t\tconst clonedData = [...(instance.data || [])];\n\n\t\t\tsortByName(marketplace.data || []).forEach((app) => {\n\t\t\t\tconst appIndex = clonedData.findIndex(({ id }) => id === app.id);\n\t\t\t\tconst [installedApp] = appIndex > -1 ? clonedData.splice(appIndex, 1) : [];\n\n\t\t\t\tconst record = {\n\t\t\t\t\t...app,\n\t\t\t\t\t...(installedApp && {\n\t\t\t\t\t\tprivate: installedApp.private,\n\t\t\t\t\t\tinstalled: true,\n\t\t\t\t\t\tstatus: installedApp.status,\n\t\t\t\t\t\tversion: installedApp.version,\n\t\t\t\t\t\tlicenseValidation: installedApp.licenseValidation,\n\t\t\t\t\t\tmigrated: installedApp.migrated,\n\t\t\t\t\t}),\n\t\t\t\t\tbundledIn: app.bundledIn,\n\t\t\t\t\tmarketplaceVersion: app.version,\n\t\t\t\t};\n\n\t\t\t\tif (installedApp) {\n\t\t\t\t\tinstalledApps.push(record);\n\t\t\t\t}\n\n\t\t\t\tmarketplaceApps.push(record);\n\t\t\t});\n\n\t\t\tsortByName(clonedData).forEach((app) => {\n\t\t\t\tif (app.private) {\n\t\t\t\t\tprivateApps.push(app);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn [marketplaceApps, installedApps, privateApps];\n\t\t},\n\t\t{\n\t\t\tenabled: marketplace.isFetched && instance.isFetched,\n\t\t\tkeepPreviousData: true,\n\t\t},\n\t);\n\n\treturn (\n\t\t<AppsContext.Provider\n\t\t\tchildren={children}\n\t\t\tvalue={{\n\t\t\t\tinstalledApps: { phase: AsyncStatePhase.RESOLVED, value: { apps: store.data?.[1] || [] } },\n\t\t\t\tmarketplaceApps: { phase: AsyncStatePhase.RESOLVED, value: { apps: store.data?.[0] || [] } },\n\t\t\t\tprivateApps: { phase: AsyncStatePhase.RESOLVED, value: { apps: store.data?.[2] || [] } },\n\t\t\t\treload: async () => {\n\t\t\t\t\tawait Promise.all([queryClient.invalidateQueries(['marketplace'])]);\n\t\t\t\t},\n\t\t\t}}\n\t\t/>\n\t);\n};\nexport default AppsProvider;\n",null],"names":["_objectSpread","useDebouncedCallback","usePermission","useSingleStream","useQuery","useQueryClient","React","useEffect","AppClientOrchestratorInstance","AppsContext","useIsEnterprise","useInvalidateLicense","AsyncStatePhase","useInvalidateAppsCountQueryCallback","module","default","link","sortByName","apps","sort","a","b","name","toLowerCase","exportDefault","_ref","_store$data","_store$data2","_store$data3","children","isAdminUser","queryClient","data","isEnterprise","invalidateAppsCountQuery","invalidateLicenseQuery","stream","invalidate","invalidateQueries","_ref2","key","includes","marketplace","result","getAppsFromMarketplace","staleTime","Infinity","keepPreviousData","onSettled","instance","getInstalledApps","then","map","current","installed","store","isFetched","Error","marketplaceApps","installedApps","privateApps","clonedData","forEach","app","appIndex","findIndex","_ref3","id","installedApp","splice","record","private","status","version","licenseValidation","migrated","bundledIn","marketplaceVersion","push","enabled","createElement","Provider","value","phase","RESOLVED","reload","Promise","all"],"mappings":"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"}
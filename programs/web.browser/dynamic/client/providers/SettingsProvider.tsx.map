)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/providers/SettingsProvider.tsx","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { ISetting } from '@rocket.chat/core-typings';\nimport type { SettingsContextValue } from '@rocket.chat/ui-contexts';\nimport { SettingsContext, useAtLeastOnePermission, useMethod } from '@rocket.chat/ui-contexts';\nimport { Tracker } from 'meteor/tracker';\nimport type { FunctionComponent } from 'react';\nimport React, { useCallback, useEffect, useMemo, useState } from 'react';\n\nimport { createReactiveSubscriptionFactory } from '../lib/createReactiveSubscriptionFactory';\nimport { queryClient } from '../lib/queryClient';\nimport { PrivateSettingsCachedCollection } from '../lib/settings/PrivateSettingsCachedCollection';\nimport { PublicSettingsCachedCollection } from '../lib/settings/PublicSettingsCachedCollection';\n\ntype SettingsProviderProps = {\n\treadonly privileged?: boolean;\n};\n\nconst SettingsProvider: FunctionComponent<SettingsProviderProps> = ({ children, privileged = false }) => {\n\tconst hasPrivilegedPermission = useAtLeastOnePermission(\n\t\tuseMemo(() => ['view-privileged-setting', 'edit-privileged-setting', 'manage-selected-settings'], []),\n\t);\n\n\tconst hasPrivateAccess = privileged && hasPrivilegedPermission;\n\n\tconst cachedCollection = useMemo(\n\t\t() => (hasPrivateAccess ? PrivateSettingsCachedCollection : PublicSettingsCachedCollection),\n\t\t[hasPrivateAccess],\n\t);\n\n\tconst [isLoading, setLoading] = useState(() => Tracker.nonreactive(() => !cachedCollection.ready.get()));\n\n\tuseEffect(() => {\n\t\tlet mounted = true;\n\n\t\tconst initialize = async (): Promise<void> => {\n\t\t\tif (!Tracker.nonreactive(() => cachedCollection.ready.get())) {\n\t\t\t\tawait cachedCollection.init();\n\t\t\t}\n\n\t\t\tif (!mounted) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tsetLoading(false);\n\t\t};\n\n\t\tinitialize();\n\n\t\treturn (): void => {\n\t\t\tmounted = false;\n\t\t};\n\t}, [cachedCollection]);\n\n\tconst querySetting = useMemo(\n\t\t() =>\n\t\t\tcreateReactiveSubscriptionFactory((_id): ISetting | undefined => {\n\t\t\t\tconst subscription = cachedCollection.collection.findOne(_id);\n\t\t\t\treturn subscription ? { ...subscription } : undefined;\n\t\t\t}),\n\t\t[cachedCollection],\n\t);\n\n\tconst querySettings = useMemo(\n\t\t() =>\n\t\t\tcreateReactiveSubscriptionFactory((query = {}) =>\n\t\t\t\tcachedCollection.collection\n\t\t\t\t\t.find(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t...('_id' in query && Array.isArray(query._id) && { _id: { $in: query._id } }),\n\t\t\t\t\t\t\t...('_id' in query && !Array.isArray(query._id) && { _id: query._id }),\n\t\t\t\t\t\t\t...('group' in query && { group: query.group }),\n\t\t\t\t\t\t\t...('section' in query &&\n\t\t\t\t\t\t\t\t(query.section\n\t\t\t\t\t\t\t\t\t? { section: query.section }\n\t\t\t\t\t\t\t\t\t: {\n\t\t\t\t\t\t\t\t\t\t\t$or: [{ section: { $exists: false } }, { section: undefined }],\n\t\t\t\t\t\t\t\t\t  })),\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tsort: {\n\t\t\t\t\t\t\t\tsection: 1,\n\t\t\t\t\t\t\t\tsorter: 1,\n\t\t\t\t\t\t\t\ti18nLabel: 1,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t)\n\t\t\t\t\t.fetch(),\n\t\t\t),\n\t\t[cachedCollection],\n\t);\n\n\tconst settingsChangeCallback = (changes: { _id: string }[]): void => {\n\t\tchanges.forEach((val) => {\n\t\t\tswitch (val._id) {\n\t\t\t\tcase 'Enterprise_License':\n\t\t\t\t\tqueryClient.invalidateQueries(['licenses']);\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t});\n\t};\n\n\tconst saveSettings = useMethod('saveSettings');\n\tconst dispatch = useCallback(\n\t\tasync (changes) => {\n\t\t\tsettingsChangeCallback(changes);\n\t\t\tawait saveSettings(changes);\n\t\t},\n\t\t[saveSettings],\n\t);\n\n\tconst contextValue = useMemo<SettingsContextValue>(\n\t\t() => ({\n\t\t\thasPrivateAccess,\n\t\t\tisLoading,\n\t\t\tquerySetting,\n\t\t\tquerySettings,\n\t\t\tdispatch,\n\t\t}),\n\t\t[hasPrivateAccess, isLoading, querySetting, querySettings, dispatch],\n\t);\n\n\treturn <SettingsContext.Provider children={children} value={contextValue} />;\n};\n\nexport default SettingsProvider;\n\n// '[subscribe: (onStoreChange: () => void) => () => void, getSnapshot: () => {}]'\n// '[subscribe: (onStoreChange: () => void) => () => void, getSnapshot: () => ISetting | undefined]'\n",null],"names":["_objectSpread","SettingsContext","useAtLeastOnePermission","useMethod","Tracker","React","useCallback","useEffect","useMemo","useState","createReactiveSubscriptionFactory","queryClient","PrivateSettingsCachedCollection","PublicSettingsCachedCollection","module","link","default","v","exportDefault","_ref","children","privileged","hasPrivilegedPermission","hasPrivateAccess","cachedCollection","isLoading","setLoading","nonreactive","ready","get","mounted","initialize","init","querySetting","_id","subscription","collection","findOne","undefined","querySettings","query","arguments","length","find","Array","isArray","$in","group","section","$or","$exists","sort","sorter","i18nLabel","fetch","settingsChangeCallback","changes","forEach","val","invalidateQueries","saveSettings","dispatch","contextValue","createElement","Provider","value"],"mappings":"2BAEAA,EAAAC,EAASC,EAAiBC,EAAqEC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAtFC,EAAeC,IAAE,CAAA,uCAA0C,CAAAC,QAAAA,CAAAA,EAAAhB,EAA2BiB,CAAA,CAAA,EAAA,GAA5CH,EAASC,IAAE,CAAA,2BAAM,CAA0Bd,gBAACgB,CAAA,EAAAhB,EAAAA,CAAA,EAAAC,wBAAAA,CAAAA,EAAAA,EAAAA,CAAA,EAAAC,UAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAW,EAAAA,IAAAA,CAAAA,iBAAAA,CAAAV,QAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAU,EAAAA,IAAAA,CAAAA,QAAAA,CAAAE,QAAAA,CAAAA,EAAAX,EAAAA,CAAA,EAAAC,YAAAA,CAAAA,EAAAA,EAAAA,CAAA,EAAAC,UAAAA,CAAAA,EAAAA,EAAAA,CAAA,EAAAC,QAAAA,CAAAA,EAAAA,EAAAA,CAAA,EAAAC,SAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAK,EAAAA,IAAAA,CAAAA,2CAAAA,CAAAJ,kCAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAI,EAAAA,IAAAA,CAAAA,qBAAAA,CAAAH,YAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAG,EAAAA,IAAAA,CAAAA,kDAAAA,CAAAF,gCAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAE,EAAAA,IAAAA,CAAAA,iDAAAA,CAAAD,+BAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAA/FC,EAAOI,aAAE,CAc0DC,IAAqC,GAApC,CAAEC,SAAAA,CAAQ,CAAEC,WAAAA,EAAa,CAAA,CAAA,CAAO,CAAAF,EAC7FG,EAA0BpB,EAC/BM,EAAQ,IAAM,CAAC,0BAA2B,0BAA2B,2BAA2B,CAAE,EAAE,GAG/Fe,EAAmBF,GAAcC,EAEjCE,EAAmBhB,EACxB,IAAOe,EAAmBX,EAAkCC,EAC5D,CAACU,EAAiB,EAGb,CAACE,EAAWC,EAAW,CAAGjB,EAAS,IAAML,EAAQuB,WAAW,CAAC,IAAM,CAACH,EAAiBI,KAAK,CAACC,GAAG,KAEpGtB,EAAU,KACT,IAAIuB,EAAU,CAAA,EAERC,EAAa,UACb3B,EAAQuB,WAAW,CAAC,IAAMH,EAAiBI,KAAK,CAACC,GAAG,KACxD,MAAML,EAAiBQ,IAAI,GAGvBF,GAILJ,EAAW,CAAA,EACZ,EAIA,OAFAK,IAEO,KACND,EAAU,CAAA,CACX,CACD,EAAG,CAACN,EAAiB,EAErB,IAAMS,EAAezB,EACpB,IACCE,EAAmCwB,IAClC,IAAMC,EAAeX,EAAiBY,UAAU,CAACC,OAAO,CAACH,GACzD,OAAOC,EAAYnC,EAAA,CAAA,EAAQmC,GAAiBG,KAAAA,CAC7C,GACD,CAACd,EAAiB,EAGbe,EAAgB/B,EACrB,IACCE,EAAkC,WAAA,IAAC8B,EAAKC,UAAAC,MAAA,CAAA,GAAAD,AAAAH,KAAAA,IAAAG,SAAA,CAAA,EAAA,CAAAA,SAAA,CAAA,EAAA,CAAG,CAAA,EAAE,OAC5CjB,EAAiBY,UAAU,CACzBO,IAAI,CAAA3C,EAAAA,EAAAA,EAAAA,EAAA,CAAA,EAEC,QAASwC,GAASI,MAAMC,OAAO,CAACL,EAAMN,GAAG,GAAK,CAAEA,IAAK,CAAEY,IAAKN,EAAMN,GAAAA,AAAG,CAAE,GACvE,QAASM,GAAS,CAACI,MAAMC,OAAO,CAACL,EAAMN,GAAG,GAAK,CAAEA,IAAKM,EAAMN,GAAAA,AAAG,GAC/D,UAAWM,GAAS,CAAEO,MAAOP,EAAMO,KAAAA,AAAK,GACxC,YAAaP,GACfA,CAAAA,EAAMQ,OAAO,CACX,CAAEA,QAASR,EAAMQ,OAAAA,AAAO,EACxB,CACAC,IAAK,CAAC,CAAED,QAAS,CAAEE,QAAS,CAAA,CAAK,CAAE,EAAI,CAAEF,QAASV,KAAAA,CAAS,EAAE,IAGlE,CACCa,KAAM,CACLH,QAAS,EACTI,OAAQ,EACRC,UAAW,KAIbC,KAAK,EAAE,GAEX,CAAC9B,EAAiB,EAGb+B,EAA0BC,IAC/BA,EAAQC,OAAO,CAAEC,IAEV,uBADEA,EAAIxB,GAAG,EAEbvB,EAAYgD,iBAAiB,CAAC,CAAC,WAAW,CAM7C,EACD,EAEMC,EAAezD,EAAU,gBACzB0D,EAAWvD,EAChB,MAAOkD,IACND,EAAuBC,GACvB,MAAMI,EAAaJ,EACpB,EACA,CAACI,EAAa,EAGTE,EAAetD,EACpB,IAAO,CAAA,CACNe,iBAAAA,EACAE,UAAAA,EACAQ,aAAAA,EACAM,cAAAA,EACAsB,SAAAA,IAED,CAACtC,EAAkBE,EAAWQ,EAAcM,EAAesB,EAAS,EAGrE,OAAOxD,EAAA0D,aAAA,CAAC9D,EAAgB+D,QAAQ,CAAA,CAAC5C,SAAUA,EAAU6C,MAAOH,CAAa,EAC1E"}
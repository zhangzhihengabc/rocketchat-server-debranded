)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/hooks/useAppActionButtons.ts","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { IUIActionButton, UIActionButtonContext } from '@rocket.chat/apps-engine/definition/ui';\nimport { useDebouncedCallback } from '@rocket.chat/fuselage-hooks';\nimport { useEndpoint, useSingleStream, useToastMessageDispatch, useUserId } from '@rocket.chat/ui-contexts';\nimport type { UseQueryResult } from '@tanstack/react-query';\nimport { useQuery, useQueryClient } from '@tanstack/react-query';\nimport { useEffect, useMemo } from 'react';\nimport { useTranslation } from 'react-i18next';\n\nimport { UiKitTriggerTimeoutError } from '../../app/ui-message/client/UiKitTriggerTimeoutError';\nimport type { MessageActionConfig, MessageActionContext } from '../../app/ui-utils/client/lib/MessageAction';\nimport type { MessageBoxAction } from '../../app/ui-utils/client/lib/messageBox';\nimport { Utilities } from '../../ee/lib/misc/Utilities';\nimport type { GenericMenuItemProps } from '../components/GenericMenu/GenericMenuItem';\nimport { useUiKitActionManager } from '../uikit/hooks/useUiKitActionManager';\nimport { useApplyButtonFilters, useApplyButtonAuthFilter } from './useApplyButtonFilters';\n\nconst getIdForActionButton = ({ appId, actionId }: IUIActionButton): string => `${appId}/${actionId}`;\n\nexport const useAppActionButtons = <TContext extends `${UIActionButtonContext}`>(context?: TContext) => {\n\tconst queryClient = useQueryClient();\n\n\tconst apps = useSingleStream('apps');\n\tconst uid = useUserId();\n\n\tconst getActionButtons = useEndpoint('GET', '/apps/actionButtons');\n\n\tconst result = useQuery(['apps', 'actionButtons'], () => getActionButtons(), {\n\t\t...(context && {\n\t\t\tselect: (data) =>\n\t\t\t\tdata.filter(\n\t\t\t\t\t(\n\t\t\t\t\t\tbutton,\n\t\t\t\t\t): button is IUIActionButton & {\n\t\t\t\t\t\tcontext: UIActionButtonContext extends infer X ? (X extends TContext ? X : never) : never;\n\t\t\t\t\t} => button.context === context,\n\t\t\t\t),\n\t\t}),\n\t\tstaleTime: Infinity,\n\t});\n\n\tconst invalidate = useDebouncedCallback(\n\t\t() => {\n\t\t\tqueryClient.invalidateQueries(['apps', 'actionButtons']);\n\t\t},\n\t\t100,\n\t\t[],\n\t);\n\n\tuseEffect(() => {\n\t\tif (!uid) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn apps('apps', ([key]) => {\n\t\t\tif (['actions/changed'].includes(key)) {\n\t\t\t\tinvalidate();\n\t\t\t}\n\t\t});\n\t}, [uid, apps, invalidate]);\n\n\treturn result;\n};\n\nexport const useMessageboxAppsActionButtons = () => {\n\tconst result = useAppActionButtons('messageBoxAction');\n\tconst actionManager = useUiKitActionManager();\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\tconst { t } = useTranslation();\n\n\tconst applyButtonFilters = useApplyButtonFilters();\n\n\tconst data = useMemo(\n\t\t() =>\n\t\t\tresult.data\n\t\t\t\t?.filter((action) => {\n\t\t\t\t\treturn applyButtonFilters(action);\n\t\t\t\t})\n\t\t\t\t.map((action) => {\n\t\t\t\t\tconst item: MessageBoxAction = {\n\t\t\t\t\t\tid: getIdForActionButton(action),\n\t\t\t\t\t\tlabel: Utilities.getI18nKeyForApp(action.labelI18n, action.appId),\n\t\t\t\t\t\taction: (params) => {\n\t\t\t\t\t\t\tvoid actionManager\n\t\t\t\t\t\t\t\t.emitInteraction(action.appId, {\n\t\t\t\t\t\t\t\t\ttype: 'actionButton',\n\t\t\t\t\t\t\t\t\trid: params.rid,\n\t\t\t\t\t\t\t\t\ttmid: params.tmid,\n\t\t\t\t\t\t\t\t\tactionId: action.actionId,\n\t\t\t\t\t\t\t\t\tpayload: { context: action.context, message: params.chat.composer?.text ?? '' },\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.catch(async (reason) => {\n\t\t\t\t\t\t\t\t\tif (reason instanceof UiKitTriggerTimeoutError) {\n\t\t\t\t\t\t\t\t\t\tdispatchToastMessage({\n\t\t\t\t\t\t\t\t\t\t\ttype: 'error',\n\t\t\t\t\t\t\t\t\t\t\tmessage: t('UIKit_Interaction_Timeout'),\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\treturn reason;\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\n\t\t\t\t\treturn item;\n\t\t\t\t}),\n\t\t[actionManager, applyButtonFilters, dispatchToastMessage, result.data, t],\n\t);\n\treturn {\n\t\t...result,\n\t\tdata,\n\t} as UseQueryResult<MessageBoxAction[]>;\n};\n\nexport const useUserDropdownAppsActionButtons = () => {\n\tconst result = useAppActionButtons('userDropdownAction');\n\tconst actionManager = useUiKitActionManager();\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\tconst { t } = useTranslation();\n\n\tconst applyButtonFilters = useApplyButtonAuthFilter();\n\n\tconst data = useMemo(\n\t\t() =>\n\t\t\tresult.data\n\t\t\t\t?.filter((action) => {\n\t\t\t\t\treturn applyButtonFilters(action);\n\t\t\t\t})\n\t\t\t\t.map((action) => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tid: `${action.appId}_${action.actionId}`,\n\t\t\t\t\t\t// icon: action.icon as GenericMenuItemProps['icon'],\n\t\t\t\t\t\tcontent: action.labelI18n,\n\t\t\t\t\t\tonClick: () => {\n\t\t\t\t\t\t\tvoid actionManager\n\t\t\t\t\t\t\t\t.emitInteraction(action.appId, {\n\t\t\t\t\t\t\t\t\ttype: 'actionButton',\n\t\t\t\t\t\t\t\t\tactionId: action.actionId,\n\t\t\t\t\t\t\t\t\tpayload: { context: action.context },\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.catch(async (reason) => {\n\t\t\t\t\t\t\t\t\tif (reason instanceof UiKitTriggerTimeoutError) {\n\t\t\t\t\t\t\t\t\t\tdispatchToastMessage({\n\t\t\t\t\t\t\t\t\t\t\ttype: 'error',\n\t\t\t\t\t\t\t\t\t\t\tmessage: t('UIKit_Interaction_Timeout'),\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\treturn reason;\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t}),\n\t\t[actionManager, applyButtonFilters, dispatchToastMessage, result.data, t],\n\t);\n\treturn {\n\t\t...result,\n\t\tdata,\n\t} as UseQueryResult<GenericMenuItemProps[]>;\n};\n\nexport const useMessageActionAppsActionButtons = (context?: MessageActionContext) => {\n\tconst result = useAppActionButtons('messageAction');\n\tconst actionManager = useUiKitActionManager();\n\tconst applyButtonFilters = useApplyButtonFilters();\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\tconst { t } = useTranslation();\n\tconst data = useMemo(\n\t\t() =>\n\t\t\tresult.data\n\t\t\t\t?.filter((action) => {\n\t\t\t\t\tif (\n\t\t\t\t\t\tcontext &&\n\t\t\t\t\t\t!(action.when?.messageActionContext || ['message', 'message-mobile', 'threads', 'starred']).includes(context as any)\n\t\t\t\t\t) {\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t\treturn applyButtonFilters(action);\n\t\t\t\t})\n\t\t\t\t.map((action) => {\n\t\t\t\t\tconst item: MessageActionConfig = {\n\t\t\t\t\t\ticon: undefined as any,\n\t\t\t\t\t\tid: getIdForActionButton(action),\n\t\t\t\t\t\tlabel: Utilities.getI18nKeyForApp(action.labelI18n, action.appId),\n\t\t\t\t\t\torder: 7,\n\t\t\t\t\t\ttype: 'apps',\n\t\t\t\t\t\tvariant: action.variant,\n\t\t\t\t\t\taction: (_, params) => {\n\t\t\t\t\t\t\tvoid actionManager\n\t\t\t\t\t\t\t\t.emitInteraction(action.appId, {\n\t\t\t\t\t\t\t\t\ttype: 'actionButton',\n\t\t\t\t\t\t\t\t\trid: params.message.rid,\n\t\t\t\t\t\t\t\t\ttmid: params.message.tmid,\n\t\t\t\t\t\t\t\t\tmid: params.message._id,\n\t\t\t\t\t\t\t\t\tactionId: action.actionId,\n\t\t\t\t\t\t\t\t\tpayload: { context: action.context },\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.catch(async (reason) => {\n\t\t\t\t\t\t\t\t\tif (reason instanceof UiKitTriggerTimeoutError) {\n\t\t\t\t\t\t\t\t\t\tdispatchToastMessage({\n\t\t\t\t\t\t\t\t\t\t\ttype: 'error',\n\t\t\t\t\t\t\t\t\t\t\tmessage: t('UIKit_Interaction_Timeout'),\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\treturn reason;\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\n\t\t\t\t\treturn item;\n\t\t\t\t}),\n\t\t[actionManager, applyButtonFilters, context, dispatchToastMessage, result.data, t],\n\t);\n\treturn {\n\t\t...result,\n\t\tdata,\n\t} as UseQueryResult<MessageActionConfig[]>;\n};\n",null],"names":["_objectSpread","useDebouncedCallback","useEndpoint","useSingleStream","useToastMessageDispatch","useUserId","useQuery","useQueryClient","useEffect","useMemo","useTranslation","UiKitTriggerTimeoutError","Utilities","useUiKitActionManager","useApplyButtonFilters","useApplyButtonAuthFilter","module","default","export","useAppActionButtons","useMessageboxAppsActionButtons","useUserDropdownAppsActionButtons","useMessageActionAppsActionButtons","getIdForActionButton","_ref","appId","actionId","concat","context","queryClient","apps","uid","getActionButtons","result","select","data","filter","button","staleTime","Infinity","invalidate","invalidateQueries","_ref2","key","includes","actionManager","dispatchToastMessage","t","applyButtonFilters","_result$data","action","map","item","id","label","getI18nKeyForApp","labelI18n","params","_params$chat$composer","_params$chat$composer2","emitInteraction","type","rid","tmid","payload","message","chat","composer","text","catch","reason","_result$data2","content","onClick","_result$data3","_action$when","when","messageActionContext","icon","undefined","order","variant","_","mid","_id"],"mappings":"2BACAA,EAAmEC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAA1DC,EAAAA,IAAoB,CAAA,uCAAsC,CAAAC,QAAAA,CAAAA,EAAAjB,EAAAA,CAAA,CAAA,EAAA,GAAnEgB,EAAOE,MAAE,CAAA,CAAAC,oBAAsB,IAAMA,EAAAC,+BAA8B,IAAAA,EAAAC,iCAAAA,IAAAA,EAAAC,kCAAAA,IAAAA,CAAA,GAAAN,EAAAA,IAAAA,CAAAA,8BAAAA,CAAAf,qBAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAe,EAAAA,IAAAA,CAAAA,2BAAAA,CAAAd,YAAAA,CAAAA,EAAAA,EAAAA,CAAA,EAAAC,gBAAAA,CAAAA,EAAAA,EAAAA,CAAA,EAAAC,wBAAAA,CAAAA,EAAAA,EAAAA,CAAA,EAAAC,UAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAW,EAAAA,IAAAA,CAAAA,wBAAAA,CAAAV,SAAAA,CAAAA,EAAAA,EAAAA,CAAA,EAAAC,eAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAS,EAAAA,IAAAA,CAAAA,QAAAA,CAAAR,UAAAA,CAAAA,EAAAA,EAAAA,CAAA,EAAAC,QAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAO,EAAAA,IAAAA,CAAAA,gBAAAA,CAAAN,eAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAM,EAAAA,IAAAA,CAAAA,uDAAAA,CAAAL,yBAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAK,EAAAA,IAAAA,CAAAA,8BAAAA,CAAAJ,UAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAI,EAAAA,IAAAA,CAAAA,uCAAAA,CAAAH,sBAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAG,EAAAA,IAAAA,CAAAA,0BAAAA,CAAAF,sBAAAA,CAAAA,EAAAA,EAAAA,CAAA,EAAAC,yBAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAenE,IAAMQ,EAAuBC,IAAA,GAAC,CAAEC,MAAAA,CAAK,CAAEC,SAAAA,CAAAA,CAA2B,CAAAF,EAAA,MAAA,GAAAG,MAAA,CAAgBF,EAAK,KAAAE,MAAA,CAAID,EAAQ,EAEtFP,EAAoES,IAChF,IAAMC,EAActB,IAEduB,EAAO3B,EAAgB,QACvB4B,EAAM1B,IAEN2B,EAAmB9B,EAAY,MAAO,uBAEtC+B,EAAS3B,EAAS,CAAC,OAAQ,gBAAgB,CAAE,IAAM0B,IAAkBhC,EAAAA,EAAA,CAAA,EACtE4B,GAAW,CACdM,OAASC,GACRA,EAAKC,MAAM,CAETC,GAGIA,EAAOT,OAAO,GAAKA,KAE1B,CAAA,EAAA,CACDU,UAAWC,GAAQ,IAGdC,EAAavC,EAClB,KACC4B,EAAYY,iBAAiB,CAAC,CAAC,OAAQ,gBAAgB,CACxD,EACA,IACA,EAAE,EAeH,OAZAjC,EAAU,KACT,GAAKuB,EAIL,OAAOD,EAAK,OAAQY,IAAU,GAAT,CAACC,EAAI,CAAAD,EACrB,CAAC,kBAAkB,CAACE,QAAQ,CAACD,IAChCH,GAEF,EACD,EAAG,CAACT,EAAKD,EAAMU,EAAW,EAEnBP,CACR,EAEab,EAAiC,KAC7C,IAAMa,EAASd,EAAoB,oBAC7B0B,EAAgBhC,IAChBiC,EAAuB1C,IACvB,CAAE2C,EAAAA,CAAAA,CAAG,CAAGrC,IAERsC,EAAqBlC,IAErBqB,EAAO1B,EACZ,KAAA,IAAAwC,EAAA,OAAA,AACY,OADZA,CAAAA,EACChB,EAAOE,IAAI,AAAJA,GAAIc,AAAA,KAAA,IAAAA,EAAA,KAAA,EAAXA,EACGb,MAAM,CAAEc,GACFF,EAAmBE,IAE1BC,GAAG,CAAED,IACL,IAAME,EAAyB,CAC9BC,GAAI9B,EAAqB2B,GACzBI,MAAO1C,EAAU2C,gBAAgB,CAACL,EAAOM,SAAS,CAAEN,EAAOzB,KAAK,EAChEyB,OAASO,IAAU,IAAAC,EAAAC,EACbd,EACHe,eAAe,CAACV,EAAOzB,KAAK,CAAE,CAC9BoC,KAAM,eACNC,IAAKL,EAAOK,GAAG,CACfC,KAAMN,EAAOM,IAAI,CACjBrC,SAAUwB,EAAOxB,QAAQ,CACzBsC,QAAS,CAAEpC,QAASsB,EAAOtB,OAAO,CAAEqC,QAAO,AAA4B,OAA5BP,CAAAA,EAAA,AAAsB,OAAtBC,CAAAA,EAAEF,EAAOS,IAAI,CAACC,QAAQ,AAARA,GAAQR,AAAA,KAAA,IAAAA,EAAA,KAAA,EAApBA,EAAsBS,IAAI,AAAJA,GAAIV,AAAA,KAAA,IAAAA,EAAAA,EAAI,EAAE,IAE7EW,KAAK,CAAC,MAAOC,IACb,GAAIA,aAAkB3D,EAA0B,CAC/CmC,EAAqB,CACpBe,KAAM,QACNI,QAASlB,EAAE,+BAEZ,OAGD,OAAOuB,CACR,EACF,GAGD,OAAOlB,CACR,EAAE,EACJ,CAACP,EAAeG,EAAoBF,EAAsBb,EAAOE,IAAI,CAAEY,EAAE,EAE1E,OAAA/C,EAAAA,EAAA,CAAA,EACIiC,GAAM,CAAA,EAAA,CACTE,KAAAA,CAAI,EAEN,EAEad,EAAmC,KAC/C,IAAMY,EAASd,EAAoB,sBAC7B0B,EAAgBhC,IAChBiC,EAAuB1C,IACvB,CAAE2C,EAAAA,CAAAA,CAAG,CAAGrC,IAERsC,EAAqBjC,IAErBoB,EAAO1B,EACZ,KAAA,IAAA8D,EAAA,OAAA,AACY,OADZA,CAAAA,EACCtC,EAAOE,IAAI,AAAJA,GAAIoC,AAAA,KAAA,IAAAA,EAAA,KAAA,EAAXA,EACGnC,MAAM,CAAEc,GACFF,EAAmBE,IAE1BC,GAAG,CAAED,GACE,CAAA,CACNG,GAAE,GAAA1B,MAAA,CAAKuB,EAAOzB,KAAK,CAAA,KAAAE,MAAA,CAAIuB,EAAOxB,QAAQ,EAEtC8C,QAAStB,EAAOM,SAAS,CACzBiB,QAAS,KACH5B,EACHe,eAAe,CAACV,EAAOzB,KAAK,CAAE,CAC9BoC,KAAM,eACNnC,SAAUwB,EAAOxB,QAAQ,CACzBsC,QAAS,CAAEpC,QAASsB,EAAOtB,OAAAA,AAAO,IAElCyC,KAAK,CAAC,MAAOC,IACb,GAAIA,aAAkB3D,EAA0B,CAC/CmC,EAAqB,CACpBe,KAAM,QACNI,QAASlB,EAAE,+BAEZ,OAGD,OAAOuB,CACR,EACF,IAEA,EACJ,CAACzB,EAAeG,EAAoBF,EAAsBb,EAAOE,IAAI,CAAEY,EAAE,EAE1E,OAAA/C,EAAAA,EAAA,CAAA,EACIiC,GAAM,CAAA,EAAA,CACTE,KAAAA,CAAI,EAEN,EAEab,EAAqCM,IACjD,IAAMK,EAASd,EAAoB,iBAC7B0B,EAAgBhC,IAChBmC,EAAqBlC,IACrBgC,EAAuB1C,IACvB,CAAE2C,EAAAA,CAAAA,CAAG,CAAGrC,IACRyB,EAAO1B,EACZ,KAAA,IAAAiE,EAAA,OAAA,AACY,OADZA,CAAAA,EACCzC,EAAOE,IAAI,AAAJA,GAAIuC,AAAA,KAAA,IAAAA,EAAA,KAAA,EAAXA,EACGtC,MAAM,CAAEc,IAAU,IAAAyB,QACnB,AACC/C,CAAAA,CAAAA,IACA,CAAC,AAAC,CAAA,CAAA,AAAW,OAAX+C,CAAAA,EAAAzB,EAAO0B,IAAI,AAAJA,GAAID,AAAA,KAAA,IAAAA,EAAA,KAAA,EAAXA,EAAaE,oBAAoB,AAApBA,GAAwB,CAAC,UAAW,iBAAkB,UAAW,UAAU,AAAD,EAAGjC,QAAQ,CAAChB,EAAc,GAI7GoB,EAAmBE,EAC3B,GACCC,GAAG,CAAED,IACL,IAAME,EAA4B,CACjC0B,KAAMC,KAAAA,EACN1B,GAAI9B,EAAqB2B,GACzBI,MAAO1C,EAAU2C,gBAAgB,CAACL,EAAOM,SAAS,CAAEN,EAAOzB,KAAK,EAChEuD,MAAO,EACPnB,KAAM,OACNoB,QAAS/B,EAAO+B,OAAO,CACvB/B,OAAQ,CAACgC,EAAGzB,KACNZ,EACHe,eAAe,CAACV,EAAOzB,KAAK,CAAE,CAC9BoC,KAAM,eACNC,IAAKL,EAAOQ,OAAO,CAACH,GAAG,CACvBC,KAAMN,EAAOQ,OAAO,CAACF,IAAI,CACzBoB,IAAK1B,EAAOQ,OAAO,CAACmB,GAAG,CACvB1D,SAAUwB,EAAOxB,QAAQ,CACzBsC,QAAS,CAAEpC,QAASsB,EAAOtB,OAAAA,AAAO,IAElCyC,KAAK,CAAC,MAAOC,IACb,GAAIA,aAAkB3D,EAA0B,CAC/CmC,EAAqB,CACpBe,KAAM,QACNI,QAASlB,EAAE,+BAEZ,OAGD,OAAOuB,CACR,EACF,GAGD,OAAOlB,CACR,EAAE,EACJ,CAACP,EAAeG,EAAoBpB,EAASkB,EAAsBb,EAAOE,IAAI,CAAEY,EAAE,EAEnF,OAAA/C,EAAAA,EAAA,CAAA,EACIiC,GAAM,CAAA,EAAA,CACTE,KAAAA,CAAI,EAEN"}
)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/views/room/body/hooks/useRoomRolesManagement.ts","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { IRoom, IUser } from '@rocket.chat/core-typings';\nimport { useMethod, useStream } from '@rocket.chat/ui-contexts';\nimport { useEffect } from 'react';\n\nimport { RoomRoles, ChatMessage } from '../../../../../app/models/client';\n\n// const roomRoles = RoomRoles as Mongo.Collection<Pick<ISubscription, 'rid' | 'u' | 'roles'>>;\n\nexport const useRoomRolesManagement = (rid: IRoom['_id']): void => {\n\tconst getRoomRoles = useMethod('getRoomRoles');\n\n\tuseEffect(() => {\n\t\tgetRoomRoles(rid).then((results) => {\n\t\t\tArray.from(results).forEach(({ _id, ...data }) => {\n\t\t\t\tconst {\n\t\t\t\t\trid,\n\t\t\t\t\tu: { _id: uid },\n\t\t\t\t} = data;\n\t\t\t\tRoomRoles.upsert({ rid, 'u._id': uid }, { $set: data });\n\t\t\t});\n\t\t});\n\t}, [getRoomRoles, rid]);\n\n\tuseEffect(() => {\n\t\tconst rolesObserve = RoomRoles.find({ rid }).observe({\n\t\t\tadded: (role) => {\n\t\t\t\tif (!role.u?._id) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tChatMessage.update({ rid, 'u._id': role.u._id }, { $addToSet: { roles: role._id } }, { multi: true });\n\t\t\t},\n\t\t\tchanged: (role) => {\n\t\t\t\tif (!role.u?._id) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tChatMessage.update({ rid, 'u._id': role.u._id }, { $inc: { rerender: 1 } }, { multi: true });\n\t\t\t},\n\t\t\tremoved: (role) => {\n\t\t\t\tif (!role.u?._id) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tChatMessage.update({ rid, 'u._id': role.u._id }, { $pull: { roles: role._id } }, { multi: true });\n\t\t\t},\n\t\t});\n\n\t\treturn (): void => {\n\t\t\trolesObserve.stop();\n\t\t};\n\t}, [getRoomRoles, rid]);\n\n\tconst subscribeToNotifyLoggedIn = useStream('notify-logged');\n\n\tuseEffect(\n\t\t() =>\n\t\t\tsubscribeToNotifyLoggedIn('roles-change', ({ type, ...role }) => {\n\t\t\t\tif (!role.scope) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!role.u?._id) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tswitch (type) {\n\t\t\t\t\tcase 'added':\n\t\t\t\t\t\tRoomRoles.upsert({ 'rid': role.scope, 'u._id': role.u._id }, { $setOnInsert: { u: role.u }, $addToSet: { roles: role._id } });\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'removed':\n\t\t\t\t\t\tRoomRoles.update({ 'rid': role.scope, 'u._id': role.u._id }, { $pull: { roles: role._id } });\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}),\n\t\t[subscribeToNotifyLoggedIn],\n\t);\n\n\tuseEffect(\n\t\t() =>\n\t\t\tsubscribeToNotifyLoggedIn('Users:NameChanged', ({ _id: uid, name }: Partial<IUser>) => {\n\t\t\t\tRoomRoles.update(\n\t\t\t\t\t{\n\t\t\t\t\t\t'u._id': uid,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t$set: {\n\t\t\t\t\t\t\t'u.name': name,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tmulti: true,\n\t\t\t\t\t},\n\t\t\t\t);\n\t\t\t}),\n\t\t[subscribeToNotifyLoggedIn],\n\t);\n};\n",null],"names":["_objectWithoutProperties","useMethod","useStream","useEffect","RoomRoles","ChatMessage","module","link","default","export","useRoomRolesManagement","rid","getRoomRoles","then","results","Array","from","forEach","_ref","_id","data","_excluded","u","uid","upsert","$set","rolesObserve","find","observe","added","role","_role$u","update","$addToSet","roles","multi","changed","_role$u2","$inc","rerender","removed","_role$u3","$pull","stop","subscribeToNotifyLoggedIn","_ref2","_role$u4","type","_excluded2","scope","$setOnInsert","_ref3","name"],"mappings":"2BACAA,EAAgEC,EAAAC,EAAAC,EAAAC,EAAAC,2BAAnCC,EAAEC,IAAM,CAAA,iDAA2B,CAAAC,QAAAA,CAAAA,EAAAR,EAAAA,CAAA,CAAA,EAAA,GAAhEM,EAAOG,MAAE,CAAA,CAAAC,uBAA4B,IAAAA,CAA2B,GAAAJ,EAAAA,IAAAA,CAAAA,2BAAAA,CAAAL,UAAAA,CAAAA,EAAAA,EAAAA,CAAA,EAAAC,UAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAI,EAAAA,IAAAA,CAAAA,QAAAA,CAAAH,UAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAG,EAAAA,IAAAA,CAAAA,mCAAAA,CAAAF,UAAAA,CAAAA,EAAAA,EAAAA,CAAA,EAAAC,YAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAOzD,IAAMK,EAA0BC,IACtC,IAAMC,EAAeX,EAAU,gBAE/BE,EAAU,KACTS,EAAaD,GAAKE,IAAI,CAAEC,IACvBC,MAAMC,IAAI,CAACF,GAASG,OAAO,CAACC,IAAqB,GAApB,CAAEC,IAAAA,CAAAA,CAAc,CAAAD,EAANE,EAAIpB,EAAAkB,EAAAG,GACpC,CACLV,IAAAA,CAAG,CACHW,EAAG,CAAEH,IAAKI,CAAAA,CAAG,CACb,CAAGH,EACJhB,EAAUoB,MAAM,CAAC,CAAEb,IAAAA,EAAK,QAASY,CAAG,EAAI,CAAEE,KAAML,CAAI,EACrD,EACD,EACD,EAAG,CAACR,EAAcD,EAAI,EAEtBR,EAAU,KACT,IAAMuB,EAAetB,EAAUuB,IAAI,CAAC,CAAEhB,IAAAA,CAAG,GAAIiB,OAAO,CAAC,CACpDC,MAAQC,IAAQ,IAAAC,CACJ,QAAPA,CAAAA,EAACD,EAAKR,CAAC,AAADA,GAACS,AAAA,KAAA,IAAAA,GAANA,EAAQZ,GAAG,EAGhBd,EAAY2B,MAAM,CAAC,CAAErB,IAAAA,EAAK,QAASmB,EAAKR,CAAC,CAACH,GAAAA,AAAG,EAAI,CAAEc,UAAW,CAAEC,MAAOJ,EAAKX,GAAAA,AAAG,CAAE,EAAI,CAAEgB,MAAO,CAAA,CAAI,EACnG,EACAC,QAAUN,IAAQ,IAAAO,CACN,QAAPA,CAAAA,EAACP,EAAKR,CAAC,AAADA,GAACe,AAAA,KAAA,IAAAA,GAANA,EAAQlB,GAAG,EAGhBd,EAAY2B,MAAM,CAAC,CAAErB,IAAAA,EAAK,QAASmB,EAAKR,CAAC,CAACH,GAAAA,AAAG,EAAI,CAAEmB,KAAM,CAAEC,SAAU,CAAC,CAAE,EAAI,CAAEJ,MAAO,CAAA,CAAI,EAC1F,EACAK,QAAUV,IAAQ,IAAAW,CACN,QAAPA,CAAAA,EAACX,EAAKR,CAAC,AAADA,GAACmB,AAAA,KAAA,IAAAA,GAANA,EAAQtB,GAAG,EAGhBd,EAAY2B,MAAM,CAAC,CAAErB,IAAAA,EAAK,QAASmB,EAAKR,CAAC,CAACH,GAAAA,AAAG,EAAI,CAAEuB,MAAO,CAAER,MAAOJ,EAAKX,GAAAA,AAAG,CAAE,EAAI,CAAEgB,MAAO,CAAA,CAAI,EAC/F,IAGD,MAAO,KACNT,EAAaiB,IAAI,EAClB,CACD,EAAG,CAAC/B,EAAcD,EAAI,EAEtB,IAAMiC,EAA4B1C,EAAU,iBAE5CC,EACC,IACCyC,EAA0B,eAAgBC,IAAsB,IAAAC,EAAA,GAArB,CAAEC,KAAAA,CAAAA,CAAe,CAAAF,EAANf,EAAI9B,EAAA6C,EAAAG,GACzD,GAAKlB,EAAKmB,KAAK,EAIX,AAAO,OAAPH,CAAAA,EAAChB,EAAKR,CAAC,AAADA,GAACwB,AAAA,KAAA,IAAAA,GAANA,EAAQ3B,GAAG,CAIhB,OAAQ4B,GACP,IAAK,QACJ3C,EAAUoB,MAAM,CAAC,CAAE,IAAOM,EAAKmB,KAAK,CAAE,QAASnB,EAAKR,CAAC,CAACH,GAAAA,AAAG,EAAI,CAAE+B,aAAc,CAAE5B,EAAGQ,EAAKR,CAAAA,AAAC,EAAIW,UAAW,CAAEC,MAAOJ,EAAKX,GAAAA,AAAG,CAAE,GAC1H,KAED,KAAK,UACJf,EAAU4B,MAAM,CAAC,CAAE,IAAOF,EAAKmB,KAAK,CAAE,QAASnB,EAAKR,CAAC,CAACH,GAAAA,AAAG,EAAI,CAAEuB,MAAO,CAAER,MAAOJ,EAAKX,GAAAA,AAAG,CAAE,EACnF,CAET,GACD,CAACyB,EAA0B,EAG5BzC,EACC,IACCyC,EAA0B,oBAAqBO,IAAuC,GAAtC,CAAEhC,IAAKI,CAAG,CAAE6B,KAAAA,CAAAA,CAAsB,CAAAD,EACjF/C,EAAU4B,MAAM,CACf,CACC,QAAST,GAEV,CACCE,KAAM,CACL,SAAU2B,IAGZ,CACCjB,MAAO,CAAA,GAGV,GACD,CAACS,EAA0B,CAE7B"}
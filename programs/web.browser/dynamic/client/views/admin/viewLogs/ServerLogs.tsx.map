)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/views/admin/viewLogs/ServerLogs.tsx","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { Serialized } from '@rocket.chat/core-typings';\nimport { Box, Icon, Scrollable } from '@rocket.chat/fuselage';\nimport { useToastMessageDispatch, useEndpoint, useStream, useTranslation } from '@rocket.chat/ui-contexts';\nimport type { ReactElement } from 'react';\nimport React, { useEffect, useRef, useState, useCallback } from 'react';\n\nimport { ansispan } from './ansispan';\n\ntype StdOutLogEntry = {\n\tid: string;\n\tstring: string;\n\tts: Date;\n};\n\nconst compareEntries = (a: StdOutLogEntry, b: StdOutLogEntry): number => a.ts.getTime() - b.ts.getTime();\n\nconst unserializeEntry = ({ ts, ...entry }: Serialized<StdOutLogEntry>): StdOutLogEntry => ({\n\tts: new Date(ts),\n\t...entry,\n});\n\nconst ServerLogs = (): ReactElement => {\n\tconst [entries, setEntries] = useState<StdOutLogEntry[]>([]);\n\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\n\tconst getStdoutQueue = useEndpoint('GET', '/v1/stdout.queue');\n\tconst subscribeToStdout = useStream('stdout');\n\n\tuseEffect(() => {\n\t\tconst fetchLines = async (): Promise<void> => {\n\t\t\ttry {\n\t\t\t\tconst { queue } = await getStdoutQueue(undefined);\n\t\t\t\tsetEntries(queue.map(unserializeEntry).sort(compareEntries));\n\t\t\t} catch (error: unknown) {\n\t\t\t\tdispatchToastMessage({ type: 'error', message: error });\n\t\t\t}\n\t\t};\n\n\t\tfetchLines();\n\t}, [dispatchToastMessage, getStdoutQueue]);\n\n\tuseEffect(\n\t\t() =>\n\t\t\tsubscribeToStdout('stdout', (entry: StdOutLogEntry) => {\n\t\t\t\tsetEntries((entries) => [...entries, entry]);\n\t\t\t}),\n\t\t[subscribeToStdout],\n\t);\n\n\tconst t = useTranslation();\n\n\tconst wrapperRef = useRef<HTMLElement>();\n\tconst atBottomRef = useRef<boolean>(false);\n\n\tconst [newLogsVisible, setNewLogsVisible] = useState(false);\n\n\tconst isAtBottom = useCallback((scrollThreshold = 0) => {\n\t\tconst wrapper = wrapperRef.current;\n\n\t\tif (!wrapper) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (wrapper.scrollTop + scrollThreshold >= wrapper.scrollHeight - wrapper.clientHeight) {\n\t\t\tsetNewLogsVisible(false);\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}, []);\n\n\tconst sendToBottom = useCallback(() => {\n\t\tconst wrapper = wrapperRef.current;\n\n\t\tif (!wrapper) {\n\t\t\treturn;\n\t\t}\n\n\t\twrapper.scrollTop = wrapper.scrollHeight - wrapper.clientHeight;\n\t\tsetNewLogsVisible(false);\n\t}, []);\n\n\tconst checkIfScrollIsAtBottom = useCallback(() => {\n\t\tatBottomRef.current = isAtBottom(100);\n\t}, [isAtBottom]);\n\n\tconst sendToBottomIfNecessary = useCallback(() => {\n\t\tif (atBottomRef.current === true && isAtBottom() !== true) {\n\t\t\tsendToBottom();\n\t\t} else if (atBottomRef.current === false) {\n\t\t\tsetNewLogsVisible(true);\n\t\t}\n\t}, [isAtBottom, sendToBottom]);\n\n\tuseEffect(() => {\n\t\tconst wrapper = wrapperRef.current;\n\n\t\tif (!wrapper) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (window.MutationObserver) {\n\t\t\tconst observer = new MutationObserver((mutations) => {\n\t\t\t\tmutations.forEach(() => {\n\t\t\t\t\tsendToBottomIfNecessary();\n\t\t\t\t});\n\t\t\t});\n\t\t\tobserver.observe(wrapper, { childList: true });\n\n\t\t\treturn (): void => {\n\t\t\t\tobserver.disconnect();\n\t\t\t};\n\t\t}\n\n\t\tconst handleSubtreeModified = (): void => {\n\t\t\tsendToBottomIfNecessary();\n\t\t};\n\t\twrapper.addEventListener('DOMSubtreeModified', handleSubtreeModified);\n\n\t\treturn (): void => {\n\t\t\twrapper.removeEventListener('DOMSubtreeModified', handleSubtreeModified);\n\t\t};\n\t}, [sendToBottomIfNecessary]);\n\n\tuseEffect(() => {\n\t\tconst handleWindowResize = (): void => {\n\t\t\tsetTimeout(() => {\n\t\t\t\tsendToBottomIfNecessary();\n\t\t\t}, 100);\n\t\t};\n\n\t\twindow.addEventListener('resize', handleWindowResize);\n\n\t\treturn (): void => {\n\t\t\twindow.removeEventListener('resize', handleWindowResize);\n\t\t};\n\t}, [sendToBottomIfNecessary]);\n\n\tconst handleWheel = useCallback(() => {\n\t\tatBottomRef.current = false;\n\t\tsetTimeout(() => {\n\t\t\tcheckIfScrollIsAtBottom();\n\t\t}, 100);\n\t}, [checkIfScrollIsAtBottom]);\n\n\tconst handleTouchStart = (): void => {\n\t\tatBottomRef.current = false;\n\t};\n\n\tconst handleTouchEnd = useCallback(() => {\n\t\tsetTimeout(() => {\n\t\t\tcheckIfScrollIsAtBottom();\n\t\t}, 100);\n\t}, [checkIfScrollIsAtBottom]);\n\n\tconst handleScroll = useCallback(() => {\n\t\tatBottomRef.current = false;\n\t\tsetTimeout(() => {\n\t\t\tcheckIfScrollIsAtBottom();\n\t\t}, 100);\n\t}, [checkIfScrollIsAtBottom]);\n\n\tconst handleClick = useCallback(() => {\n\t\tatBottomRef.current = true;\n\t\tsendToBottomIfNecessary();\n\t}, [sendToBottomIfNecessary]);\n\n\treturn (\n\t\t<Box width='full' height='full' overflow='hidden' position='relative' display='flex' mbe={8}>\n\t\t\t<Scrollable vertical>\n\t\t\t\t<Box\n\t\t\t\t\tref={wrapperRef}\n\t\t\t\t\tdisplay='flex'\n\t\t\t\t\tflexDirection='column'\n\t\t\t\t\tpadding={8}\n\t\t\t\t\tflexGrow={1}\n\t\t\t\t\tfontFamily='mono'\n\t\t\t\t\tcolor='default'\n\t\t\t\t\tbg='neutral'\n\t\t\t\t\tstyle={{ wordBreak: 'break-all' }}\n\t\t\t\t\tonWheel={handleWheel}\n\t\t\t\t\tonTouchStart={handleTouchStart}\n\t\t\t\t\tonTouchEnd={handleTouchEnd}\n\t\t\t\t\tonScroll={handleScroll}\n\t\t\t\t\tborderRadius='x4'\n\t\t\t\t>\n\t\t\t\t\t{entries.sort(compareEntries).map(({ string }, i) => (\n\t\t\t\t\t\t<span key={i} dangerouslySetInnerHTML={{ __html: ansispan(string) }} />\n\t\t\t\t\t))}\n\t\t\t\t</Box>\n\t\t\t</Scrollable>\n\t\t\t<Box\n\t\t\t\trole='button'\n\t\t\t\tposition='absolute'\n\t\t\t\tdisplay='flex'\n\t\t\t\tjustifyContent='center'\n\t\t\t\tinsetBlockEnd={8}\n\t\t\t\tinsetInlineStart='50%'\n\t\t\t\twidth='x132'\n\t\t\t\theight='x32'\n\t\t\t\tmarginInline='neg-x64'\n\t\t\t\tpaddingBlock={8}\n\t\t\t\tfontScale='c2'\n\t\t\t\tborderRadius='full'\n\t\t\t\televation='1'\n\t\t\t\tcolor='default'\n\t\t\t\tbg='light'\n\t\t\t\tonClick={handleClick}\n\t\t\t\ttextAlign='center'\n\t\t\t\tstyle={{\n\t\t\t\t\tcursor: 'pointer',\n\t\t\t\t\ttransition: 'transform 0.3s ease-out',\n\t\t\t\t\ttransform: newLogsVisible ? 'translateY(0)' : 'translateY(150%)',\n\t\t\t\t}}\n\t\t\t>\n\t\t\t\t<Icon name='jump' size='x16' /> {t('New_logs')}\n\t\t\t</Box>\n\t\t</Box>\n\t);\n};\n\nexport default ServerLogs;\n",null],"names":["_objectSpread","_objectWithoutProperties","Box","Icon","Scrollable","useToastMessageDispatch","useEndpoint","useStream","useTranslation","React","useEffect","useRef","useState","useCallback","ansispan","module","link","default","v","compareEntries","a","b","ts","getTime","unserializeEntry","_ref","entry","_excluded","Date","exportDefault","entries","setEntries","dispatchToastMessage","getStdoutQueue","subscribeToStdout","fetchLines","queue","undefined","map","sort","error","type","message","t","wrapperRef","atBottomRef","newLogsVisible","setNewLogsVisible","isAtBottom","scrollThreshold","arguments","length","wrapper","current","scrollTop","scrollHeight","clientHeight","sendToBottom","checkIfScrollIsAtBottom","sendToBottomIfNecessary","window","MutationObserver","observer","mutations","forEach","observe","childList","disconnect","handleSubtreeModified","addEventListener","removeEventListener","handleWindowResize","setTimeout","handleWheel","handleTouchEnd","handleScroll","handleClick","createElement","width","height","overflow","position","display","mbe","vertical","ref","flexDirection","padding","flexGrow","fontFamily","color","bg","style","wordBreak","onWheel","onTouchStart","onTouchEnd","onScroll","borderRadius","_ref2","i","string","key","dangerouslySetInnerHTML","__html","role","justifyContent","insetBlockEnd","insetInlineStart","marginInline","paddingBlock","fontScale","elevation","onClick","textAlign","cursor","transition","transform","name","size"],"mappings":"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"}
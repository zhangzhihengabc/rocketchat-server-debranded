)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/views/marketplace/hooks/useAppInstallationHandler.tsx","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { App } from '@rocket.chat/core-typings';\nimport { useEndpoint, useRouteParameter, useSetModal, useToastMessageDispatch } from '@rocket.chat/ui-contexts';\nimport React, { useCallback } from 'react';\n\nimport { AppClientOrchestratorInstance } from '../../../../ee/client/apps/orchestrator';\nimport { useExternalLink } from '../../../hooks/useExternalLink';\nimport { useCheckoutUrl } from '../../admin/subscription/hooks/useCheckoutUrl';\nimport IframeModal from '../IframeModal';\nimport AppInstallModal from '../components/AppInstallModal/AppInstallModal';\nimport type { Actions } from '../helpers';\nimport { handleAPIError } from '../helpers/handleAPIError';\nimport { isMarketplaceRouteContext, useAppsCountQuery } from './useAppsCountQuery';\nimport { useOpenAppPermissionsReviewModal } from './useOpenAppPermissionsReviewModal';\nimport { useOpenIncompatibleModal } from './useOpenIncompatibleModal';\n\nexport type AppInstallationHandlerParams = {\n\tapp: App;\n\taction: Actions;\n\tisAppPurchased: boolean;\n\tonDismiss: () => void;\n\tonSuccess: (action: Actions, appPermissions?: App['permissions']) => void;\n};\n\nexport function useAppInstallationHandler({ app, action, isAppPurchased, onDismiss, onSuccess }: AppInstallationHandlerParams) {\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\tconst setModal = useSetModal();\n\n\tconst routeContext = String(useRouteParameter('context'));\n\tconst context = isMarketplaceRouteContext(routeContext) ? routeContext : 'explore';\n\n\tconst appCountQuery = useAppsCountQuery(context);\n\n\tconst notifyAdmins = useEndpoint('POST', `/apps/notify-admins`);\n\n\tconst openIncompatibleModal = useOpenIncompatibleModal();\n\n\tconst openExternalLink = useExternalLink();\n\tconst manageSubscriptionUrl = useCheckoutUrl()({ target: 'user-page', action: 'buy_more' });\n\n\tconst closeModal = useCallback(() => {\n\t\tsetModal(null);\n\t\tonDismiss();\n\t}, [onDismiss, setModal]);\n\n\tconst success = useCallback(\n\t\t(appPermissions?: App['permissions']) => {\n\t\t\tsetModal(null);\n\t\t\tonSuccess(action, appPermissions);\n\t\t},\n\t\t[action, onSuccess, setModal],\n\t);\n\n\tconst openPermissionModal = useOpenAppPermissionsReviewModal({ app, onCancel: closeModal, onConfirm: success });\n\n\tconst acquireApp = useCallback(async () => {\n\t\tif (action === 'purchase' && !isAppPurchased) {\n\t\t\ttry {\n\t\t\t\tconst data = await AppClientOrchestratorInstance.buildExternalUrl(app.id, app.purchaseType, false);\n\t\t\t\tsetModal(<IframeModal url={data.url} cancel={onDismiss} confirm={openPermissionModal} />);\n\t\t\t} catch (error) {\n\t\t\t\thandleAPIError(error);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\topenPermissionModal();\n\t}, [action, isAppPurchased, openPermissionModal, app.id, app.purchaseType, setModal, onDismiss]);\n\n\treturn useCallback(async () => {\n\t\tif (app?.versionIncompatible) {\n\t\t\topenIncompatibleModal(app, action, closeModal);\n\t\t\treturn;\n\t\t}\n\n\t\tif (action === 'request') {\n\t\t\tconst requestConfirmAction = (postMessage: Record<string, unknown>) => {\n\t\t\t\tsetModal(null);\n\t\t\t\tdispatchToastMessage({ type: 'success', message: 'App request submitted' });\n\n\t\t\t\tnotifyAdmins({\n\t\t\t\t\tappId: app.id,\n\t\t\t\t\tappName: app.name,\n\t\t\t\t\tappVersion: app.marketplaceVersion,\n\t\t\t\t\tmessage: typeof postMessage.message === 'string' ? postMessage.message : '',\n\t\t\t\t});\n\n\t\t\t\tsuccess();\n\t\t\t};\n\n\t\t\ttry {\n\t\t\t\tconst data = await AppClientOrchestratorInstance.buildExternalAppRequest(app.id);\n\t\t\t\tsetModal(<IframeModal url={data.url} wrapperHeight='x460' cancel={onDismiss} confirm={requestConfirmAction} />);\n\t\t\t} catch (error) {\n\t\t\t\thandleAPIError(error);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tif (!appCountQuery.data) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (appCountQuery.data.hasUnlimitedApps) {\n\t\t\treturn acquireApp();\n\t\t}\n\n\t\tsetModal(\n\t\t\t<AppInstallModal\n\t\t\t\tcontext={context}\n\t\t\t\tenabled={appCountQuery.data.enabled}\n\t\t\t\tlimit={appCountQuery.data.limit}\n\t\t\t\tappName={app.name}\n\t\t\t\thandleClose={closeModal}\n\t\t\t\thandleConfirm={acquireApp}\n\t\t\t\thandleEnableUnlimitedApps={() => {\n\t\t\t\t\topenExternalLink(manageSubscriptionUrl);\n\t\t\t\t\tsetModal(null);\n\t\t\t\t}}\n\t\t\t/>,\n\t\t);\n\t}, [\n\t\tapp,\n\t\taction,\n\t\tappCountQuery.data,\n\t\tsetModal,\n\t\tcontext,\n\t\tcloseModal,\n\t\tacquireApp,\n\t\topenIncompatibleModal,\n\t\tdispatchToastMessage,\n\t\tnotifyAdmins,\n\t\tsuccess,\n\t\tonDismiss,\n\t\topenExternalLink,\n\t\tmanageSubscriptionUrl,\n\t]);\n}\n",null],"names":["useEndpoint","useRouteParameter","useSetModal","useToastMessageDispatch","React","useCallback","AppClientOrchestratorInstance","useExternalLink","useCheckoutUrl","IframeModal","AppInstallModal","handleAPIError","isMarketplaceRouteContext","useAppsCountQuery","useOpenAppPermissionsReviewModal","useOpenIncompatibleModal","useAppInstallationHandler","_ref","app","action","isAppPurchased","onDismiss","onSuccess","dispatchToastMessage","setModal","routeContext","String","context","appCountQuery","notifyAdmins","openIncompatibleModal","openExternalLink","manageSubscriptionUrl","target","closeModal","success","appPermissions","openPermissionModal","onCancel","onConfirm","acquireApp","data","buildExternalUrl","id","purchaseType","createElement","url","cancel","confirm","error","versionIncompatible","buildExternalAppRequest","wrapperHeight","postMessage","type","message","appId","appName","name","appVersion","marketplaceVersion","hasUnlimitedApps","enabled","limit","handleClose","handleConfirm","handleEnableUnlimitedApps","module","export","default"],"mappings":"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"}
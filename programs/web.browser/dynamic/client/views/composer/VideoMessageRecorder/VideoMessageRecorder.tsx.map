)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/views/composer/VideoMessageRecorder/VideoMessageRecorder.tsx","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { IMessage, IRoom } from '@rocket.chat/core-typings';\nimport { css } from '@rocket.chat/css-in-js';\nimport { Box, ButtonGroup, Button, Icon, PositionAnimated } from '@rocket.chat/fuselage';\nimport { useMutableCallback } from '@rocket.chat/fuselage-hooks';\nimport { useTranslation, useToastMessageDispatch } from '@rocket.chat/ui-contexts';\nimport type { AllHTMLAttributes, RefObject } from 'react';\nimport React, { useRef, useEffect, useState } from 'react';\n\nimport { UserAction, USER_ACTIVITIES } from '../../../../app/ui/client/lib/UserAction';\nimport { VideoRecorder } from '../../../../app/ui/client/lib/recorderjs/videoRecorder';\nimport type { ChatAPI } from '../../../lib/chats/ChatAPI';\nimport { useChat } from '../../room/contexts/ChatContext';\n\ntype VideoMessageRecorderProps = {\n\trid: IRoom['_id'];\n\ttmid?: IMessage['_id'];\n\tchatContext?: ChatAPI; // TODO: remove this when the composer is migrated to React\n\treference: RefObject<HTMLElement>;\n} & Omit<AllHTMLAttributes<HTMLDivElement>, 'is'>;\n\nconst videoContainerClass = css`\n\ttransform: scaleX(-1);\n\tfilter: FlipH;\n\n\t@media (max-width: 500px) {\n\t\t& > video {\n\t\t\twidth: 100%;\n\t\t\theight: 100%;\n\t\t}\n\t}\n`;\n\nconst getVideoRecordingExtension = () => {\n\tconst supported = VideoRecorder.getSupportedMimeTypes();\n\tif (supported.match(/video\\/webm/)) {\n\t\treturn 'webm';\n\t}\n\treturn 'mp4';\n};\n\nconst VideoMessageRecorder = ({ rid, tmid, chatContext, reference }: VideoMessageRecorderProps) => {\n\tconst t = useTranslation();\n\tconst videoRef = useRef<HTMLVideoElement>(null);\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\n\tconst [time, setTime] = useState<string | undefined>();\n\tconst [recordingState, setRecordingState] = useState<'idle' | 'loading' | 'recording'>('idle');\n\tconst [recordingInterval, setRecordingInterval] = useState<ReturnType<typeof setInterval> | null>(null);\n\tconst isRecording = recordingState === 'recording';\n\tconst sendButtonDisabled = !(VideoRecorder.cameraStarted.get() && !(recordingState === 'recording'));\n\n\tconst chat = useChat() ?? chatContext;\n\n\tconst stopVideoRecording = async (rid: IRoom['_id'], tmid?: IMessage['_id']) => {\n\t\tif (recordingInterval) {\n\t\t\tclearInterval(recordingInterval);\n\t\t}\n\t\tsetRecordingInterval(null);\n\t\tVideoRecorder.stopRecording();\n\t\tUserAction.stop(rid, USER_ACTIVITIES.USER_RECORDING, { tmid });\n\t\tsetRecordingState('idle');\n\t};\n\n\tconst handleRecord = async () => {\n\t\tif (recordingState === 'recording') {\n\t\t\tstopVideoRecording(rid, tmid);\n\t\t} else {\n\t\t\tVideoRecorder.record();\n\t\t\tsetRecordingState('recording');\n\t\t\tUserAction.performContinuously(rid, USER_ACTIVITIES.USER_RECORDING, { tmid });\n\t\t\tsetTime('00:00');\n\t\t\tconst startTime = new Date();\n\t\t\tsetRecordingInterval(\n\t\t\t\tsetInterval(() => {\n\t\t\t\t\tconst now = new Date();\n\t\t\t\t\tconst distance = (now.getTime() - startTime.getTime()) / 1000;\n\t\t\t\t\tconst minutes = Math.floor(distance / 60);\n\t\t\t\t\tconst seconds = Math.floor(distance % 60);\n\t\t\t\t\tsetTime(`${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);\n\t\t\t\t}, 1000),\n\t\t\t);\n\t\t}\n\t};\n\n\tconst handleSendRecord = async () => {\n\t\tconst cb = async (blob: Blob) => {\n\t\t\tconst fileName = `${t('Video_record')}.${getVideoRecordingExtension()}`;\n\t\t\tconst file = new File([blob], fileName, { type: VideoRecorder.getSupportedMimeTypes().split(';')[0] });\n\t\t\tawait chat?.flows.uploadFiles([file]);\n\t\t\tchat?.composer?.setRecordingVideo(false);\n\t\t};\n\n\t\tVideoRecorder.stop(cb);\n\t\tsetTime(undefined);\n\t\tstopVideoRecording(rid, tmid);\n\t};\n\n\tconst handleCancel = useMutableCallback(() => {\n\t\tVideoRecorder.stop();\n\t\tchat?.composer?.setRecordingVideo(false);\n\t\tsetTime(undefined);\n\t\tstopVideoRecording(rid, tmid);\n\t});\n\n\tuseEffect(() => {\n\t\tif (!VideoRecorder.getSupportedMimeTypes()) {\n\t\t\treturn dispatchToastMessage({ type: 'error', message: t('Browser_does_not_support_recording_video') });\n\t\t}\n\n\t\tVideoRecorder.start(videoRef.current ?? undefined, (success) => (!success ? handleCancel() : undefined));\n\n\t\treturn () => {\n\t\t\tVideoRecorder.stop();\n\t\t};\n\t}, [dispatchToastMessage, handleCancel, t]);\n\n\treturn (\n\t\t<PositionAnimated visible='visible' anchor={reference} placement='top-end'>\n\t\t\t<Box bg='light' padding={4} borderRadius={4} elevation='2'>\n\t\t\t\t<Box className={videoContainerClass} overflow='hidden' height={240} borderRadius={4}>\n\t\t\t\t\t<video muted autoPlay playsInline ref={videoRef} width={320} height={240} />\n\t\t\t\t</Box>\n\t\t\t\t<Box mbs={4} display='flex' justifyContent='space-between'>\n\t\t\t\t\t<Button small onClick={handleRecord}>\n\t\t\t\t\t\t<Box is='span' display='flex' alignItems='center'>\n\t\t\t\t\t\t\t<Icon size='x16' mie={time ? 4 : undefined} name={isRecording ? 'stop-unfilled' : 'rec'} />\n\t\t\t\t\t\t\t{time && <span>{time}</span>}\n\t\t\t\t\t\t</Box>\n\t\t\t\t\t</Button>\n\t\t\t\t\t<ButtonGroup>\n\t\t\t\t\t\t<Button small onClick={handleCancel}>\n\t\t\t\t\t\t\t{t('Cancel')}\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t<Button primary small disabled={sendButtonDisabled} onClick={handleSendRecord}>\n\t\t\t\t\t\t\t{t('Send')}\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</ButtonGroup>\n\t\t\t\t</Box>\n\t\t\t</Box>\n\t\t</PositionAnimated>\n\t);\n};\n\nexport default VideoMessageRecorder;\n",null],"names":["_taggedTemplateLiteral","css","Box","ButtonGroup","Button","Icon","PositionAnimated","useMutableCallback","useTranslation","useToastMessageDispatch","React","useRef","useEffect","useState","UserAction","USER_ACTIVITIES","VideoRecorder","useChat","module","default","link","videoContainerClass","_templateObject","getVideoRecordingExtension","supported","getSupportedMimeTypes","match","exportDefault","_ref","_useChat","rid","tmid","chatContext","reference","t","videoRef","dispatchToastMessage","time","setTime","recordingState","setRecordingState","recordingInterval","setRecordingInterval","sendButtonDisabled","cameraStarted","get","chat","stopVideoRecording","clearInterval","stopRecording","stop","USER_RECORDING","handleRecord","record","performContinuously","startTime","Date","setInterval","now","distance","getTime","concat","String","Math","floor","padStart","handleSendRecord","cb","blob","_chat$composer","fileName","file","File","type","split","flows","uploadFiles","composer","setRecordingVideo","undefined","handleCancel","_chat$composer2","_videoRef$current","start","current","success","message","createElement","visible","anchor","placement","bg","padding","borderRadius","elevation","className","overflow","height","muted","autoPlay","playsInline","ref","width","mbs","display","justifyContent","small","onClick","is","alignItems","size","mie","name","isRecording","primary","disabled"],"mappings":"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"}
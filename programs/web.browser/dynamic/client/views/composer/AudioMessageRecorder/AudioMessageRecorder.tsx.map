)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/views/composer/AudioMessageRecorder/AudioMessageRecorder.tsx","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { IRoom } from '@rocket.chat/core-typings';\nimport { Box, Throbber } from '@rocket.chat/fuselage';\nimport { useMutableCallback } from '@rocket.chat/fuselage-hooks';\nimport { MessageComposerAction } from '@rocket.chat/ui-composer';\nimport { useTranslation } from '@rocket.chat/ui-contexts';\nimport type { ReactElement } from 'react';\nimport React, { useEffect, useMemo, useState } from 'react';\n\nimport { AudioRecorder } from '../../../../app/ui/client/lib/recorderjs/AudioRecorder';\nimport type { ChatAPI } from '../../../lib/chats/ChatAPI';\nimport { useChat } from '../../room/contexts/ChatContext';\n\nconst audioRecorder = new AudioRecorder();\n\ntype AudioMessageRecorderProps = {\n\trid: IRoom['_id'];\n\tchatContext?: ChatAPI; // TODO: remove this when the composer is migrated to React\n\tisMicrophoneDenied?: boolean;\n};\n\nconst AudioMessageRecorder = ({ rid, chatContext, isMicrophoneDenied }: AudioMessageRecorderProps): ReactElement | null => {\n\tconst t = useTranslation();\n\n\tconst [state, setState] = useState<'loading' | 'recording'>('recording');\n\tconst [time, setTime] = useState('00:00');\n\tconst [recordingInterval, setRecordingInterval] = useState<ReturnType<typeof setInterval> | null>(null);\n\tconst [recordingRoomId, setRecordingRoomId] = useState<IRoom['_id'] | null>(null);\n\n\tconst stopRecording = useMutableCallback(async () => {\n\t\tif (recordingInterval) {\n\t\t\tclearInterval(recordingInterval);\n\t\t}\n\t\tsetRecordingInterval(null);\n\t\tsetRecordingRoomId(null);\n\n\t\tsetTime('00:00');\n\n\t\tchat?.action.stop('recording');\n\n\t\tchat?.composer?.setRecordingMode(false);\n\n\t\tconst blob = await new Promise<Blob>((resolve) => audioRecorder.stop(resolve));\n\n\t\treturn blob;\n\t});\n\n\tconst handleUnmount = useMutableCallback(async () => {\n\t\tif (state === 'recording') {\n\t\t\tawait stopRecording();\n\t\t}\n\t});\n\n\tconst handleRecord = useMutableCallback(async () => {\n\t\tif (recordingRoomId && recordingRoomId !== rid) {\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tawait audioRecorder.start();\n\t\t\tchat?.action.performContinuously('recording');\n\t\t\tconst startTime = new Date();\n\t\t\tsetRecordingInterval(\n\t\t\t\tsetInterval(() => {\n\t\t\t\t\tconst now = new Date();\n\t\t\t\t\tconst distance = (now.getTime() - startTime.getTime()) / 1000;\n\t\t\t\t\tconst minutes = Math.floor(distance / 60);\n\t\t\t\t\tconst seconds = Math.floor(distance % 60);\n\t\t\t\t\tsetTime(`${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);\n\t\t\t\t}, 1000),\n\t\t\t);\n\t\t\tsetRecordingRoomId(rid);\n\t\t} catch (error) {\n\t\t\tconsole.log(error);\n\t\t\tchat?.composer?.setRecordingMode(false);\n\t\t}\n\t});\n\n\tconst handleCancelButtonClick = useMutableCallback(async () => {\n\t\tawait stopRecording();\n\t});\n\n\tconst chat = useChat() ?? chatContext;\n\n\tconst handleDoneButtonClick = useMutableCallback(async () => {\n\t\tsetState('loading');\n\n\t\tconst blob = await stopRecording();\n\n\t\tconst fileName = `${t('Audio_record')}.mp3`;\n\t\tconst file = new File([blob], fileName, { type: 'audio/mpeg' });\n\n\t\tawait chat?.flows.uploadFiles([file]);\n\t});\n\n\tuseEffect(() => {\n\t\thandleRecord();\n\n\t\treturn () => {\n\t\t\thandleUnmount();\n\t\t};\n\t}, [handleUnmount, handleRecord]);\n\n\tconst stateClass = useMemo(() => {\n\t\tif (recordingRoomId && recordingRoomId !== rid) {\n\t\t\treturn 'rc-message-box__audio-message--busy';\n\t\t}\n\n\t\treturn state && `rc-message-box__audio-message--${state}`;\n\t}, [recordingRoomId, rid, state]);\n\n\tif (isMicrophoneDenied) {\n\t\treturn null;\n\t}\n\n\treturn (\n\t\t<Box position='absolute' pi={4} pb={12} className={`rc-message-box__audio-message ${stateClass}`}>\n\t\t\t{state === 'recording' && (\n\t\t\t\t<>\n\t\t\t\t\t<MessageComposerAction\n\t\t\t\t\t\ticon='circle-cross'\n\t\t\t\t\t\tclassName='rc-message-box__icon rc-message-box__audio-message-cancel'\n\t\t\t\t\t\tonClick={handleCancelButtonClick}\n\t\t\t\t\t/>\n\t\t\t\t\t<Box className='rc-message-box__audio-message-timer' color='default'>\n\t\t\t\t\t\t<span className='rc-message-box__audio-message-timer-dot'></span>\n\t\t\t\t\t\t<span className='rc-message-box__audio-message-timer-text'>{time}</span>\n\t\t\t\t\t</Box>\n\t\t\t\t\t<MessageComposerAction\n\t\t\t\t\t\ticon='circle-check'\n\t\t\t\t\t\tclassName='rc-message-box__icon rc-message-box__audio-message-done'\n\t\t\t\t\t\tonClick={handleDoneButtonClick}\n\t\t\t\t\t/>\n\t\t\t\t</>\n\t\t\t)}\n\t\t\t{state === 'loading' && (\n\t\t\t\t<div className='rc-message-box__icon'>\n\t\t\t\t\t<Throbber inheritColor size='x12' />\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</Box>\n\t);\n};\n\nexport default AudioMessageRecorder;\n",null],"names":["Box","Throbber","useMutableCallback","MessageComposerAction","useTranslation","React","useEffect","useMemo","useState","AudioRecorder","useChat","module","link","default","audioRecorder","exportDefault","_ref","_useChat","rid","chatContext","isMicrophoneDenied","t","state","setState","time","setTime","recordingInterval","setRecordingInterval","recordingRoomId","setRecordingRoomId","stopRecording","_chat$composer","clearInterval","chat","action","stop","composer","setRecordingMode","blob","Promise","resolve","handleUnmount","handleRecord","start","performContinuously","startTime","Date","setInterval","now","distance","getTime","concat","String","Math","floor","padStart","error","_chat$composer2","console","log","handleCancelButtonClick","handleDoneButtonClick","fileName","file","File","type","flows","uploadFiles","stateClass","createElement","position","pi","pb","className","Fragment","icon","onClick","color","inheritColor","size"],"mappings":"2BACAA,EAAOC,EAA+CC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAxCC,EAAUC,IAAAA,CAAAA,wBAA6B,CAACZ,IAAAA,CAAAA,EAAAA,EAAAA,CAAA,EAAAC,SAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAU,EAAAA,IAAAA,CAAAA,8BAAAA,CAAAT,mBAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAS,EAAAA,IAAAA,CAAAA,2BAAAA,CAAAR,sBAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAQ,EAAAA,IAAAA,CAAAA,2BAAAA,CAAAP,eAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAO,EAAAA,IAAAA,CAAAA,QAAAA,CAAAE,QAAAA,CAAAA,EAAAR,EAAAA,CAAA,EAAAC,UAAAA,CAAAA,EAAAA,EAAAA,CAAA,EAAAC,QAAAA,CAAAA,EAAAA,EAAAA,CAAA,EAAAC,SAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAG,EAAAA,IAAAA,CAAAA,yDAAAA,CAAAF,cAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAE,EAAAA,IAAAA,CAAAA,kCAAAA,CAAAD,QAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAWtD,IAAMI,EAAgB,IAAIL,EAX1BE,EAAOI,aAAO,CAmBeC,IAA6F,IAAAC,EAAA,GAA5F,CAAEC,IAAAA,CAAG,CAAEC,YAAAA,CAAW,CAAEC,mBAAAA,CAAAA,CAA+C,CAAAJ,EAC1FK,EAAIjB,IAEJ,CAACkB,EAAOC,EAAS,CAAGf,EAAkC,aACtD,CAACgB,EAAMC,EAAQ,CAAGjB,EAAS,SAC3B,CAACkB,EAAmBC,EAAqB,CAAGnB,EAAgD,MAC5F,CAACoB,EAAiBC,EAAmB,CAAGrB,EAA8B,MAEtEsB,EAAgB5B,EAAmB,UAAW,IAAA6B,EAC/CL,GACHM,cAAcN,GAEfC,EAAqB,MACrBE,EAAmB,MAEnBJ,EAAQ,SAERQ,MAAAA,GAAAA,EAAMC,MAAM,CAACC,IAAI,CAAC,aAElBF,MAAAA,GAAI,AAAU,OAAVF,CAAAA,EAAJE,EAAMG,QAAQ,AAARA,GAAQL,AAAA,KAAA,IAAAA,GAAdA,EAAgBM,gBAAgB,CAAC,CAAA,GAEjC,IAAMC,EAAO,MAAM,IAAIC,QAAeC,GAAY1B,EAAcqB,IAAI,CAACK,IAErE,OAAOF,CACR,GAEMG,EAAgBvC,EAAmB,UAC1B,cAAVoB,GACH,MAAMQ,GAER,GAEMY,EAAexC,EAAmB,UACvC,GAAI0B,CAAAA,GAAmBA,IAAoBV,EAI3C,GAAI,CACH,MAAMJ,EAAc6B,KAAK,GACzBV,MAAAA,GAAAA,EAAMC,MAAM,CAACU,mBAAmB,CAAC,aACjC,IAAMC,EAAY,IAAIC,KACtBnB,EACCoB,YAAY,KACX,IAAMC,EAAM,IAAIF,KACVG,EAAW,AAACD,CAAAA,EAAIE,OAAO,GAAKL,EAAUK,OAAO,EAAA,EAAM,IAGzDzB,EAAO,GAAA0B,MAAA,CAAIC,OAFKC,KAAKC,KAAK,CAACL,EAAW,KAEXM,QAAQ,CAAC,EAAG,KAAI,KAAAJ,MAAA,CAAIC,OAD/BC,KAAKC,KAAK,CAACL,EAAW,KACyBM,QAAQ,CAAC,EAAG,MAC5E,EAAG,MAEJ1B,EAAmBX,GAClB,MAAOsC,EAAO,CAAA,IAAAC,EACfC,QAAQC,GAAG,CAACH,GACZvB,MAAAA,GAAI,AAAU,OAAVwB,CAAAA,EAAJxB,EAAMG,QAAQ,AAARA,GAAQqB,AAAA,KAAA,IAAAA,GAAdA,EAAgBpB,gBAAgB,CAAC,CAAA,GAEnC,GAEMuB,EAA0B1D,EAAmB,UAClD,MAAM4B,GACP,GAEMG,EAAI,AAAY,OAAZhB,CAAAA,EAAGP,GAAO,GAAEO,AAAA,KAAA,IAAAA,EAAAA,EAAIE,EAEpB0C,EAAwB3D,EAAmB,UAChDqB,EAAS,WAET,IAAMe,EAAO,MAAMR,IAEbgC,EAAQ,GAAAX,MAAA,CAAM9B,EAAE,gBAAe,QAC/B0C,EAAO,IAAIC,KAAK,CAAC1B,EAAK,CAAEwB,EAAU,CAAEG,KAAM,YAAY,EAE5D,OAAMhC,CAAAA,MAAAA,EAAI,KAAA,EAAJA,EAAMiC,KAAK,CAACC,WAAW,CAAC,CAACJ,EAAK,CAAA,CACrC,GAEAzD,EAAU,KACToC,IAEO,KACND,GACD,GACE,CAACA,EAAeC,EAAa,EAEhC,IAAM0B,EAAa7D,EAAQ,IAC1B,AAAIqB,GAAmBA,IAAoBV,EACnC,sCAGDI,GAAK,kCAAA6B,MAAA,CAAsC7B,GAChD,CAACM,EAAiBV,EAAKI,EAAM,SAEhC,AAAIF,EACI,KAIPf,EAAAgE,aAAA,CAACrE,EAAG,CAACsE,SAAS,WAAWC,GAAI,EAAGC,GAAI,GAAIC,UAAS,iCAAAtB,MAAA,CAAmCiB,EAAa,EAC/F9C,AAAU,cAAVA,GACAjB,EAAAgE,aAAA,CAAAhE,EAAAqE,QAAA,CAAA,KACCrE,EAAAgE,aAAA,CAAClE,EAAqB,CACrBwE,KAAK,eACLF,UAAU,4DACVG,QAAShB,CAAwB,GAElCvD,EAAAgE,aAAA,CAACrE,EAAG,CAACyE,UAAU,sCAAsCI,MAAM,SAAS,EACnExE,EAAAgE,aAAA,CAAA,OAAA,CAAMI,UAAU,yCAAyC,GACzDpE,EAAAgE,aAAA,CAAA,OAAA,CAAMI,UAAU,0CAA0C,EAAEjD,IAE7DnB,EAAAgE,aAAA,CAAClE,EAAqB,CACrBwE,KAAK,eACLF,UAAU,0DACVG,QAASf,CAAsB,IAIjCvC,AAAU,YAAVA,GACAjB,EAAAgE,aAAA,CAAA,MAAA,CAAKI,UAAU,sBAAsB,EACpCpE,EAAAgE,aAAA,CAACpE,EAAQ,CAAC6E,aAAY,CAAA,EAACC,KAAK,KAAK,IAKtC"}
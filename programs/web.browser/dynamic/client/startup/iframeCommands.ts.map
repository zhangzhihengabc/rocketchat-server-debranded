)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/startup/iframeCommands.ts","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { UserStatus, IUser } from '@rocket.chat/core-typings';\nimport { escapeRegExp } from '@rocket.chat/string-helpers';\nimport type { LocationPathname } from '@rocket.chat/ui-contexts';\nimport { Meteor } from 'meteor/meteor';\nimport { ServiceConfiguration } from 'meteor/service-configuration';\n\nimport { settings } from '../../app/settings/client';\nimport { AccountBox } from '../../app/ui-utils/client/lib/AccountBox';\nimport { sdk } from '../../app/utils/client/lib/SDKClient';\nimport { afterLogoutCleanUpCallback } from '../../lib/callbacks/afterLogoutCleanUpCallback';\nimport { capitalize, ltrim, rtrim } from '../../lib/utils/stringUtils';\nimport { baseURI } from '../lib/baseURI';\nimport { router } from '../providers/RouterProvider';\n\nconst commands = {\n\t'go'(data: { path: string }) {\n\t\tif (typeof data.path !== 'string' || data.path.trim().length === 0) {\n\t\t\treturn console.error('`path` not defined');\n\t\t}\n\t\tconst newUrl = new URL(`${rtrim(baseURI, '/')}/${ltrim(data.path, '/')}`);\n\n\t\tconst newParams = Array.from(newUrl.searchParams.entries()).reduce((ret, [key, value]) => {\n\t\t\tret[key] = value;\n\t\t\treturn ret;\n\t\t}, {} as Record<string, string>);\n\n\t\tconst newPath = newUrl.pathname.replace(\n\t\t\tnew RegExp(`^${escapeRegExp(__meteor_runtime_config__.ROOT_URL_PATH_PREFIX)}`),\n\t\t\t'',\n\t\t) as LocationPathname;\n\t\trouter.navigate({\n\t\t\tpathname: newPath,\n\t\t\tsearch: { ...router.getSearchParameters(), ...newParams },\n\t\t});\n\t},\n\n\t'set-user-status'(data: { status: UserStatus }) {\n\t\tAccountBox.setStatus(data.status);\n\t},\n\n\t'call-custom-oauth-login'(data: { service: string; redirectUrl?: string | null }, event: MessageEvent) {\n\t\tconst customOAuthCallback = (response: unknown) => {\n\t\t\tevent.source?.postMessage(\n\t\t\t\t{\n\t\t\t\t\tevent: 'custom-oauth-callback',\n\t\t\t\t\tresponse,\n\t\t\t\t},\n\t\t\t\t{ targetOrigin: event.origin },\n\t\t\t);\n\t\t};\n\n\t\tconst siteUrl = `${Meteor.settings.Site_Url}/`;\n\t\tif (typeof data.redirectUrl !== 'string' || !data.redirectUrl.startsWith(siteUrl)) {\n\t\t\tdata.redirectUrl = null;\n\t\t}\n\n\t\tif (typeof data.service === 'string' && window.ServiceConfiguration) {\n\t\t\tconst customOauth = ServiceConfiguration.configurations.findOne({ service: data.service });\n\n\t\t\tif (customOauth) {\n\t\t\t\tconst customLoginWith = (Meteor as any)[`loginWith${capitalize(customOauth.service, true)}`];\n\t\t\t\tconst customRedirectUri = data.redirectUrl || siteUrl;\n\t\t\t\tcustomLoginWith.call(Meteor, { redirectUrl: customRedirectUri }, customOAuthCallback);\n\t\t\t}\n\t\t}\n\t},\n\n\t'login-with-token'(data: { token: string }) {\n\t\tif (typeof data.token === 'string') {\n\t\t\tMeteor.loginWithToken(data.token, () => {\n\t\t\t\tconsole.log('Iframe command [login-with-token]: result', data);\n\t\t\t});\n\t\t}\n\t},\n\n\tasync 'logout'() {\n\t\tconst user = Meteor.user();\n\t\tMeteor.logout(() => {\n\t\t\tif (!user) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvoid afterLogoutCleanUpCallback.run(user);\n\t\t\tsdk.call('logoutCleanUp', user as unknown as IUser);\n\t\t\treturn router.navigate('/home');\n\t\t});\n\t},\n} as const;\n\ntype CommandMessage<TCommandName extends keyof typeof commands = keyof typeof commands> = {\n\texternalCommand: TCommandName;\n} & Parameters<(typeof commands)[TCommandName]>[0];\n\nwindow.addEventListener('message', <TCommandMessage extends CommandMessage>(e: MessageEvent<TCommandMessage>) => {\n\tif (!settings.get<boolean>('Iframe_Integration_receive_enable')) {\n\t\treturn;\n\t}\n\n\tif (typeof e.data !== 'object' || typeof e.data.externalCommand !== 'string') {\n\t\treturn;\n\t}\n\n\tconst origins = settings.get<string>('Iframe_Integration_receive_origin');\n\n\tif (origins !== '*' && origins.split(',').indexOf(e.origin) === -1) {\n\t\tconsole.error('Origin not allowed', e.origin);\n\t\treturn;\n\t}\n\n\tif (!(e.data.externalCommand in commands)) {\n\t\tconsole.error('Command not allowed', e.data.externalCommand);\n\t\treturn;\n\t}\n\n\tconst command: (data: any, event: MessageEvent) => void = commands[e.data.externalCommand];\n\tcommand(e.data, e);\n});\n",null],"names":["_objectSpread","escapeRegExp","Meteor","ServiceConfiguration","settings","AccountBox","sdk","afterLogoutCleanUpCallback","capitalize","ltrim","rtrim","baseURI","router","module","link","default","commands","data","path","trim","length","console","error","newUrl","URL","concat","newParams","Array","from","searchParams","entries","reduce","ret","_ref","key","value","newPath","pathname","replace","RegExp","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","navigate","search","getSearchParameters","setStatus","status","event","siteUrl","Site_Url","redirectUrl","startsWith","service","window","customOauth","configurations","findOne","customLoginWith","customRedirectUri","call","response","_event$source","source","postMessage","targetOrigin","origin","token","loginWithToken","log","user","logout","run","addEventListener","e","get","externalCommand","origins","split","indexOf","command"],"mappings":"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"}
)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/startup/notifications/konchatNotifications.ts","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { AtLeast, ISubscription, IUser, ICalendarNotification } from '@rocket.chat/core-typings';\nimport { Meteor } from 'meteor/meteor';\nimport { Tracker } from 'meteor/tracker';\nimport { lazy } from 'react';\n\nimport { CachedChatSubscription } from '../../../app/models/client';\nimport { Notifications } from '../../../app/notifications/client';\nimport { settings } from '../../../app/settings/client';\nimport { KonchatNotification } from '../../../app/ui/client/lib/KonchatNotification';\nimport { getUserPreference } from '../../../app/utils/client';\nimport { RoomManager } from '../../lib/RoomManager';\nimport { imperativeModal } from '../../lib/imperativeModal';\nimport { fireGlobalEvent } from '../../lib/utils/fireGlobalEvent';\nimport { isLayoutEmbedded } from '../../lib/utils/isLayoutEmbedded';\nimport { router } from '../../providers/RouterProvider';\n\nconst OutlookCalendarEventModal = lazy(() => import('../../views/outlookCalendar/OutlookCalendarEventModal'));\n\nconst notifyNewRoom = async (sub: AtLeast<ISubscription, 'rid'>): Promise<void> => {\n\tconst user = Meteor.user() as IUser | null;\n\tif (!user || user.status === 'busy') {\n\t\treturn;\n\t}\n\n\tif ((!router.getRouteParameters().name || router.getRouteParameters().name !== sub.name) && !sub.ls && sub.alert === true) {\n\t\tKonchatNotification.newRoom(sub.rid);\n\t}\n};\n\nfunction notifyNewMessageAudio(rid?: string): void {\n\t// This logic is duplicated in /client/startup/unread.coffee.\n\tconst hasFocus = document.hasFocus();\n\tconst messageIsInOpenedRoom = RoomManager.opened === rid;\n\tconst muteFocusedConversations = getUserPreference(Meteor.userId(), 'muteFocusedConversations');\n\n\tif (isLayoutEmbedded()) {\n\t\tif (!hasFocus && messageIsInOpenedRoom) {\n\t\t\t// Play a notification sound\n\t\t\tvoid KonchatNotification.newMessage(rid);\n\t\t}\n\t} else if (!hasFocus || !messageIsInOpenedRoom || !muteFocusedConversations) {\n\t\t// Play a notification sound\n\t\tvoid KonchatNotification.newMessage(rid);\n\t}\n}\n\nMeteor.startup(() => {\n\tconst notifyUserCalendar = async function (notification: ICalendarNotification): Promise<void> {\n\t\tconst user = Meteor.user() as IUser | null;\n\t\tif (!user || user.status === 'busy') {\n\t\t\treturn;\n\t\t}\n\n\t\tconst requireInteraction = getUserPreference<boolean>(Meteor.userId(), 'desktopNotificationRequireInteraction');\n\n\t\tconst n = new Notification(notification.title, {\n\t\t\tbody: notification.text,\n\t\t\ttag: notification.payload._id,\n\t\t\tsilent: true,\n\t\t\trequireInteraction,\n\t\t} as NotificationOptions);\n\n\t\tn.onclick = function () {\n\t\t\tthis.close();\n\t\t\twindow.focus();\n\t\t\timperativeModal.open({\n\t\t\t\tcomponent: OutlookCalendarEventModal,\n\t\t\t\tprops: { id: notification.payload._id, onClose: imperativeModal.close, onCancel: imperativeModal.close },\n\t\t\t});\n\t\t};\n\t};\n\tTracker.autorun(() => {\n\t\tif (!Meteor.userId() || !settings.get('Outlook_Calendar_Enabled')) {\n\t\t\treturn Notifications.unUser('calendar');\n\t\t}\n\n\t\tNotifications.onUser('calendar', notifyUserCalendar);\n\t});\n\n\tTracker.autorun(() => {\n\t\tif (!Meteor.userId()) {\n\t\t\treturn;\n\t\t}\n\t\tNotifications.onUser('notification', (notification) => {\n\t\t\tconst openedRoomId = ['channel', 'group', 'direct'].includes(router.getRouteName()!) ? RoomManager.opened : undefined;\n\n\t\t\t// This logic is duplicated in /client/startup/unread.coffee.\n\t\t\tconst hasFocus = document.hasFocus();\n\t\t\tconst messageIsInOpenedRoom = openedRoomId === notification.payload.rid;\n\n\t\t\tfireGlobalEvent('notification', {\n\t\t\t\tnotification,\n\t\t\t\tfromOpenedRoom: messageIsInOpenedRoom,\n\t\t\t\thasFocus,\n\t\t\t});\n\n\t\t\tif (isLayoutEmbedded()) {\n\t\t\t\tif (!hasFocus && messageIsInOpenedRoom) {\n\t\t\t\t\t// Show a notification.\n\t\t\t\t\tKonchatNotification.showDesktop(notification);\n\t\t\t\t}\n\t\t\t} else if (!hasFocus || !messageIsInOpenedRoom) {\n\t\t\t\t// Show a notification.\n\t\t\t\tKonchatNotification.showDesktop(notification);\n\t\t\t}\n\n\t\t\tnotifyNewMessageAudio(notification.payload.rid);\n\t\t});\n\n\t\tCachedChatSubscription.on('changed', (sub): void => {\n\t\t\tvoid notifyNewRoom(sub);\n\t\t});\n\n\t\tNotifications.onUser('subscriptions-changed', (action, sub) => {\n\t\t\tif (action === 'removed') {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvoid notifyNewRoom(sub);\n\t\t});\n\t});\n});\n",null],"names":["Meteor","Tracker","lazy","CachedChatSubscription","Notifications","settings","KonchatNotification","getUserPreference","RoomManager","imperativeModal","fireGlobalEvent","isLayoutEmbedded","router","module","link","OutlookCalendarEventModal","dynamicImport","notifyNewRoom","sub","user","status","getRouteParameters","name","ls","alert","newRoom","rid","startup","notifyUserCalendar","notification","requireInteraction","userId","n","Notification","title","body","text","tag","payload","_id","silent","onclick","close","window","focus","open","component","props","id","onClose","onCancel","autorun","get","unUser","onUser","openedRoomId","includes","getRouteName","opened","undefined","hasFocus","document","messageIsInOpenedRoom","fromOpenedRoom","showDesktop","notifyNewMessageAudio","muteFocusedConversations","newMessage","on","action"],"mappings":"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"}
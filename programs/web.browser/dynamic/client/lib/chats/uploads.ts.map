)]}'
{"version":3,"sources":["meteor://ðŸ’»app/client/lib/chats/uploads.ts","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { IMessage, IRoom } from '@rocket.chat/core-typings';\nimport { Emitter } from '@rocket.chat/emitter';\nimport { Random } from '@rocket.chat/random';\n\nimport { UserAction, USER_ACTIVITIES } from '../../../app/ui/client/lib/UserAction';\nimport { sdk } from '../../../app/utils/client/lib/SDKClient';\nimport { getErrorMessage } from '../errorHandling';\nimport type { UploadsAPI } from './ChatAPI';\nimport type { Upload } from './Upload';\n\nlet uploads: readonly Upload[] = [];\n\nconst emitter = new Emitter<{ update: void; [x: `cancelling-${Upload['id']}`]: void }>();\n\nconst updateUploads = (update: (uploads: readonly Upload[]) => readonly Upload[]): void => {\n\tuploads = update(uploads);\n\temitter.emit('update');\n};\n\nconst get = (): readonly Upload[] => uploads;\n\nconst subscribe = (callback: () => void): (() => void) => emitter.on('update', callback);\n\nconst cancel = (id: Upload['id']): void => {\n\temitter.emit(`cancelling-${id}`);\n};\n\nconst wipeFailedOnes = (): void => {\n\tupdateUploads((uploads) => uploads.filter((upload) => !upload.error));\n};\n\nconst send = async (\n\tfile: File,\n\t{\n\t\tdescription,\n\t\tmsg,\n\t\trid,\n\t\ttmid,\n\t}: {\n\t\tdescription?: string;\n\t\tmsg?: string;\n\t\trid: string;\n\t\ttmid?: string;\n\t},\n): Promise<void> => {\n\tconst id = Random.id();\n\n\tupdateUploads((uploads) => [\n\t\t...uploads,\n\t\t{\n\t\t\tid,\n\t\t\tname: file.name,\n\t\t\tpercentage: 0,\n\t\t},\n\t]);\n\n\ttry {\n\t\tawait new Promise((resolve, reject) => {\n\t\t\tconst xhr = sdk.rest.upload(\n\t\t\t\t`/v1/rooms.upload/${rid}`,\n\t\t\t\t{\n\t\t\t\t\tmsg,\n\t\t\t\t\ttmid,\n\t\t\t\t\tfile,\n\t\t\t\t\tdescription,\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tload: (event) => {\n\t\t\t\t\t\tresolve(event);\n\t\t\t\t\t},\n\t\t\t\t\tprogress: (event) => {\n\t\t\t\t\t\tif (!event.lengthComputable) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst progress = (event.loaded / event.total) * 100;\n\t\t\t\t\t\tif (progress === 100) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tupdateUploads((uploads) =>\n\t\t\t\t\t\t\tuploads.map((upload) => {\n\t\t\t\t\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\t\t\t\t\treturn upload;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t...upload,\n\t\t\t\t\t\t\t\t\tpercentage: Math.round(progress) || 0,\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t);\n\t\t\t\t\t},\n\t\t\t\t\terror: (event) => {\n\t\t\t\t\t\tupdateUploads((uploads) =>\n\t\t\t\t\t\t\tuploads.map((upload) => {\n\t\t\t\t\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\t\t\t\t\treturn upload;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t...upload,\n\t\t\t\t\t\t\t\t\tpercentage: 0,\n\t\t\t\t\t\t\t\t\terror: new Error(xhr.responseText),\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t);\n\t\t\t\t\t\treject(event);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t);\n\n\t\t\tif (uploads.length) {\n\t\t\t\tUserAction.performContinuously(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t\t\t}\n\n\t\t\temitter.once(`cancelling-${id}`, () => {\n\t\t\t\txhr.abort();\n\t\t\t\tupdateUploads((uploads) => uploads.filter((upload) => upload.id !== id));\n\t\t\t});\n\t\t});\n\n\t\tupdateUploads((uploads) => uploads.filter((upload) => upload.id !== id));\n\t} catch (error: unknown) {\n\t\tupdateUploads((uploads) =>\n\t\t\tuploads.map((upload) => {\n\t\t\t\tif (upload.id !== id) {\n\t\t\t\t\treturn upload;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\t...upload,\n\t\t\t\t\tpercentage: 0,\n\t\t\t\t\terror: new Error(getErrorMessage(error)),\n\t\t\t\t};\n\t\t\t}),\n\t\t);\n\t} finally {\n\t\tif (!uploads.length) {\n\t\t\tUserAction.stop(rid, USER_ACTIVITIES.USER_UPLOADING, { tmid });\n\t\t}\n\t}\n};\n\nexport const createUploadsAPI = ({ rid, tmid }: { rid: IRoom['_id']; tmid?: IMessage['_id'] }): UploadsAPI => ({\n\tget,\n\tsubscribe,\n\twipeFailedOnes,\n\tcancel,\n\tsend: (file: File, { description, msg }: { description?: string; msg?: string }): Promise<void> =>\n\t\tsend(file, { description, msg, rid, tmid }),\n});\n",null],"names":["_objectSpread","Emitter","Random","UserAction","USER_ACTIVITIES","sdk","getErrorMessage","module","link","default","export","createUploadsAPI","uploads","emitter","updateUploads","update","emit","get","subscribe","callback","on","cancel","id","concat","wipeFailedOnes","filter","upload","error","send","file","_ref","description","msg","rid","tmid","name","percentage","Promise","resolve","reject","xhr","rest","load","event","progress","lengthComputable","loaded","total","map","Math","round","Error","responseText","length","performContinuously","USER_UPLOADING","once","abort","stop","_ref2","_ref3"],"mappings":"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"}
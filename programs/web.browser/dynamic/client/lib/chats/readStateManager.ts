function module(e,t,i){let r,s,d,n,a,o,u;i.export({ReadStateManager:()=>c}),i.link("@rocket.chat/emitter",{Emitter(e){r=e}},0),i.link("meteor/meteor",{Meteor(e){s=e}},1),i.link("../../../app/models/client",{ChatMessage(e){d=e}},2),i.link("../../../app/ui-utils/client/lib/LegacyRoomManager",{LegacyRoomManager(e){n=e}},3),i.link("../../../app/ui-utils/client/lib/RoomHistoryManager",{RoomHistoryManager(e){a=e}},4),i.link("../../../app/utils/client/lib/SDKClient",{sdk(e){o=e}},5),i.link("../../../lib/utils/highOrderFunctions",{withDebouncing(e){u=e}},6);class c extends r{constructor(e){super(),this.rid=void 0,this.firstUnreadRecordId=void 0,this.subscription=void 0,this.onUnreadStateChange=e=>this.on("unread-state-change",e),this.getFirstUnreadRecordId=()=>this.firstUnreadRecordId,this.handleWindowEvents=()=>{let e=()=>{this.attemptMarkAsRead()},t=e=>{"Escape"===e.key&&(this.markAsRead(),this.updateFirstUnreadRecordId())};return window.addEventListener("focus",e),window.addEventListener("keyup",t),()=>{window.removeEventListener("focus",e),window.removeEventListener("keyup",t)}},this.debouncedMarkAsRead=u({wait:1e3})(()=>{try{return this.markAsRead()}catch(e){console.error(e)}}),this.rid=e}getRid(){return this.rid}get unreadMark(){return document.querySelector(".rcx-message-divider--unread")}updateSubscription(e){var t;if(!e)return;let i=!this.subscription;this.subscription=e,null===(t=n.getOpenedRoomByRid(this.rid))||void 0===t||t.unreadSince.set(this.subscription.ls);let{unread:r,alert:s}=this.subscription;if(r||s){if(i){this.updateFirstUnreadRecordId();return}document.hasFocus()&&this.firstUnreadRecordId||this.updateFirstUnreadRecordId()}}updateFirstUnreadRecordId(){var e,t;if(!(null!==(e=this.subscription)&&void 0!==e&&e.ls))return;let i=d.findOne({rid:this.subscription.rid,ts:{$gt:this.subscription.ls},"u._id":{$ne:null!==(t=s.userId())&&void 0!==t?t:void 0}},{sort:{ts:1}});this.setFirstUnreadRecordId(null==i?void 0:i._id),a.once("loaded-messages",()=>this.updateFirstUnreadRecordId())}setFirstUnreadRecordId(e){this.firstUnreadRecordId=e,this.emit("unread-state-change",this.firstUnreadRecordId)}clearUnreadMark(){this.setFirstUnreadRecordId(void 0)}isUnreadMarkVisible(){var e;return!!this.unreadMark&&this.unreadMark.offsetTop>((null===(e=this.unreadMark.offsetParent)||void 0===e?void 0:e.scrollTop)||0)}attemptMarkAsRead(){let{alert:e,unread:t}=this.subscription||{};if(!(!e&&0===t||!document.hasFocus()||this.unreadMark&&!this.isUnreadMarkVisible()||a.getRoom(this.rid).unreadNotLoaded.get()>0))return this.markAsRead()}async markAsRead(){if(this.rid)return o.rest.post("/v1/subscriptions.read",{rid:this.rid}).then(()=>{a.getRoom(this.rid).unreadNotLoaded.set(0)})}}}
//# sourceMappingURL=/dynamic/client/lib/chats/60d2cb5d379bc5db0602e216eeb53d1e1c37d807.map

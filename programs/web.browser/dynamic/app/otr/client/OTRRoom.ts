function module(e,t,i){let r,s,o,a,n,c,l,h,d,y,u,p,m,_,S,E,w,I,T,g,R,k,b,f;i.export({OTRRoom:()=>K}),i.link("@rocket.chat/random",{Random(e){r=e}},0),i.link("ejson",{default(e){s=e}},1),i.link("meteor/meteor",{Meteor(e){o=e}},2),i.link("meteor/reactive-var",{ReactiveVar(e){a=e}},3),i.link("meteor/tracker",{Tracker(e){n=e}},4),i.link("../../../client/components/GenericModal",{default(e){c=e}},5),i.link("../../../client/lib/imperativeModal",{imperativeModal(e){l=e}},6),i.link("../../../client/lib/presence",{Presence(e){h=e}},7),i.link("../../../client/lib/toast",{dispatchToastMessage(e){d=e}},8),i.link("../../../client/lib/utils/getUidDirectMessage",{getUidDirectMessage(e){y=e}},9),i.link("../../../client/lib/utils/goToRoomById",{goToRoomById(e){u=e}},10),i.link("../../utils/client/lib/SDKClient",{sdk(e){p=e}},11),i.link("../../utils/lib/i18n",{t(e){m=e}},12),i.link("../lib/OtrRoomState",{OtrRoomState(e){_=e}},13),i.link("../lib/constants",{otrSystemMessages(e){S=e}},14),i.link("../lib/functions",{decryptAES(e){E=e},deriveBits(e){w=e},digest(e){I=e},encryptAES(e){T=e},exportKey(e){g=e},generateKeyPair(e){R=e},importKey(e){k=e},importKeyRaw(e){b=e},joinEncryptedData(e){f=e}},15);class K{constructor(e,t,i){this._userId=void 0,this._roomId=void 0,this._keyPair=void 0,this._exportedPublicKey=void 0,this._sessionKey=void 0,this._userOnlineComputation=void 0,this.peerId=void 0,this.state=new a(_.NOT_STARTED),this.isFirstOTR=void 0,this._userId=e,this._roomId=t,this._keyPair=null,this._sessionKey=null,this.peerId=i,this.isFirstOTR=!0}static create(e,t){let i=y(t);if(i)return new K(e,t,i)}getPeerId(){return this.peerId}getState(){return this.state.get()}setState(e){this.getState()!==e&&this.state.set(e)}async handshake(e){if(this.setState(_.ESTABLISHING),await this.generateKeyPair(),p.publish("notify-user",["".concat(this.peerId,"/otr"),"handshake",{roomId:this._roomId,userId:this._userId,publicKey:s.stringify(this._exportedPublicKey),refresh:e}]),e){let e=o.user();e&&(await p.call("sendSystemMessages",this._roomId,e.username,S.USER_REQUESTED_OTR_KEY_REFRESH),this.isFirstOTR=!1)}}acknowledge(){p.rest.post("/v1/statistics.telemetry",{params:[{eventName:"otrStats",timestamp:Date.now(),rid:this._roomId}]}),p.publish("notify-user",["".concat(this.peerId,"/otr"),"acknowledge",{roomId:this._roomId,userId:this._userId,publicKey:s.stringify(this._exportedPublicKey)}])}deny(){this.reset(),this.setState(_.DECLINED),p.publish("notify-user",["".concat(this.peerId,"/otr"),"deny",{roomId:this._roomId,userId:this._userId}])}end(){this.isFirstOTR=!0,this.reset(),this.setState(_.NOT_STARTED),p.publish("notify-user",["".concat(this.peerId,"/otr"),"end",{roomId:this._roomId,userId:this._userId}])}reset(){this._keyPair=null,this._exportedPublicKey={},this._sessionKey=null,p.call("deleteOldOTRMessages",this._roomId)}async generateKeyPair(){this._userOnlineComputation&&this._userOnlineComputation.stop(),this._userOnlineComputation=n.autorun(()=>{let e=document.querySelector("#chat-window-".concat(this._roomId)),t=null==e?void 0:e.querySelector(".rc-header__title");if(this.getState()===_.ESTABLISHED)e&&t&&!t.querySelector(".otr-icon")&&t.prepend("<i class='otr-icon icon-key'></i>");else if(t){var i;null===(i=t.querySelector(".otr-icon"))||void 0===i||i.remove()}});try{if(this._keyPair=await R(),!this._keyPair.publicKey)throw Error("Public key is not generated");this._exportedPublicKey=await g(this._keyPair.publicKey),p.call("deleteOldOTRMessages",this._roomId)}catch(e){throw this.setState(_.ERROR),e}}async importPublicKey(e){try{if(!this._keyPair)throw Error("No key pair");let t=s.parse(e),i=await k(t),r=await w({ecdhObj:{name:"ECDH",namedCurve:"P-256",public:i},_keyPair:this._keyPair}),o=await I(r),a=new Uint8Array(o).slice(0,16);this._sessionKey=await b(a)}catch(e){throw this.setState(_.ERROR),e}}async encryptText(e){"string"==typeof e&&(e=new TextEncoder().encode(s.stringify({text:e,ack:r.id((r.fraction()+1)*20)})));try{if(!this._sessionKey)throw Error("Session Key not available");let t=crypto.getRandomValues(new Uint8Array(12)),i=await T({iv:t,_sessionKey:this._sessionKey,data:e}),r=f({encryptedData:i,iv:t});return s.stringify(r)}catch(e){throw this.setState(_.ERROR),new o.Error("encryption-error","Encryption error.")}}async encrypt(e){try{let t=new TextEncoder().encode(s.stringify({_id:e._id,text:e.msg,userId:this._userId,ack:r.id((r.fraction()+1)*20),ts:new Date})),i=await this.encryptText(t);return i}catch(e){throw new o.Error("encryption-error","Encryption error.")}}async decrypt(e){try{if(!this._sessionKey)throw Error("Session Key not available.");let t=s.parse(e),i=await E(t,this._sessionKey),r=s.parse(new TextDecoder("UTF-8").decode(new Uint8Array(i)));if(r&&"object"==typeof r)return r;return e}catch(t){return d({type:"error",message:t}),this.setState(_.ERROR),e}}async onUserStream(e,t){switch(e){case"handshake":let i;let r=async()=>{this.setState(_.ESTABLISHING),clearTimeout(i);try{if(!t.publicKey)throw Error("Public key is not generated");await this.generateKeyPair(),await this.importPublicKey(t.publicKey),await u(t.roomId),setTimeout(async()=>{this.setState(_.ESTABLISHED),this.acknowledge(),t.refresh&&await p.rest.post("/v1/chat.otr",{roomId:this._roomId,type:S.USER_KEY_REFRESHED_SUCCESSFULLY})},0)}catch(e){throw d({type:"error",message:e}),new o.Error("establish-connection-error","Establish connection error.")}},s=()=>{clearTimeout(i),this.deny(),l.close()};try{let e=await h.get(t.userId);if(!(null!=e&&e.username))throw new o.Error("user-not-defined","User not defined.");if(t.refresh&&this.getState()===_.ESTABLISHED)this.reset(),await r();else{if(this.getState()===_.REQUESTED)return;this.getState()===_.ESTABLISHED&&this.reset(),this.setState(_.REQUESTED),l.open({component:c,props:{variant:"warning",title:m("OTR"),children:m("Username_wants_to_start_otr_Do_you_want_to_accept",{username:e.username}),confirmText:m("Yes"),cancelText:m("No"),onClose:()=>s(),onCancel:()=>s(),onConfirm:async()=>{await r(),l.close()}}}),i=setTimeout(()=>{this.setState(_.TIMEOUT),l.close()},1e4)}}catch(e){d({type:"error",message:e})}break;case"acknowledge":try{if(!t.publicKey)throw Error("Public key is not generated");await this.importPublicKey(t.publicKey),this.setState(_.ESTABLISHED),this.isFirstOTR&&await p.rest.post("/v1/chat.otr",{roomId:this._roomId,type:S.USER_JOINED_OTR}),this.isFirstOTR=!1}catch(e){d({type:"error",message:e})}break;case"deny":this.getState()===_.ESTABLISHING&&(this.reset(),this.setState(_.DECLINED));break;case"end":try{let e=await h.get(this.peerId);if(!(null!=e&&e.username))throw new o.Error("user-not-defined","User not defined.");this.getState()===_.ESTABLISHED&&(this.reset(),this.setState(_.NOT_STARTED),l.open({component:c,props:{variant:"warning",title:m("OTR"),children:m("Username_ended_the_OTR_session",{username:e.username}),confirmText:m("Ok"),onClose:l.close,onConfirm:l.close}}))}catch(e){d({type:"error",message:e})}}}}}
//# sourceMappingURL=/dynamic/app/otr/client/e8f43114ab927afd8ae21e7b4d651fc381a416c1.map

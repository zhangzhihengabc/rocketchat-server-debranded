)]}'
{"version":3,"sources":["meteor://ðŸ’»app/app/analytics/client/loadScript.ts","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { useEffect } from 'react';\n\nimport { useReactiveValue } from '../../../client/hooks/useReactiveValue';\nimport { settings } from '../../settings/client';\n\ndeclare global {\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\tinterface Window {\n\t\t_paq?: [string, ...unknown[]][];\n\t\tGoogleAnalyticsObject: unknown;\n\t\tga?: qa;\n\t}\n\n\ttype qa = {\n\t\t(...args: unknown[]): void;\n\t\tl?: number;\n\t\tq?: unknown[];\n\t};\n}\n\nexport const useAnalytics = (): void => {\n\tconst uid = useReactiveValue(() => Meteor.userId());\n\n\tconst googleId = useReactiveValue(() => settings.get('GoogleAnalytics_enabled') && settings.get('GoogleAnalytics_ID'));\n\tconst piwikUrl = useReactiveValue(() => settings.get('PiwikAnalytics_enabled') && settings.get('PiwikAnalytics_url'));\n\n\tuseEffect(() => {\n\t\tif (uid) {\n\t\t\twindow._paq = window._paq || [];\n\t\t\twindow._paq.push(['setUserId', uid]);\n\t\t}\n\t});\n\n\tuseEffect(() => {\n\t\tif (!googleId) {\n\t\t\treturn;\n\t\t}\n\t\tif (googleId.startsWith('G-')) {\n\t\t\t// Google Analytics 4\n\t\t\tconst f = document.getElementsByTagName('script')[0];\n\t\t\tconst j = document.createElement('script');\n\t\t\tj.async = true;\n\t\t\tj.src = `//www.googletagmanager.com/gtag/js?id=${googleId}`;\n\t\t\tf.parentNode?.insertBefore(j, f);\n\n\t\t\t// injecting the dataLayer into the windows global object\n\t\t\tconst w: Window & { dataLayer?: any } = window;\n\t\t\tconst dataLayer = w.dataLayer || [];\n\t\t\tconst gtag = (key: string, value: any) => {\n\t\t\t\tdataLayer.push(key, value);\n\t\t\t};\n\t\t\tgtag('js', new Date());\n\t\t\tgtag('config', googleId);\n\t\t} else {\n\t\t\t// Google Analytics 3\n\t\t\t(function (i, s, o, g, r: 'ga', a?: any, m?: any) {\n\t\t\t\ti.GoogleAnalyticsObject = r;\n\t\t\t\t(i[r] =\n\t\t\t\t\ti[r] ||\n\t\t\t\t\tfunction (...args) {\n\t\t\t\t\t\t((i[r] as any).q = (i[r] as any).q || []).push(args);\n\t\t\t\t\t\t// eslint-disable-next-line no-sequences\n\t\t\t\t\t}),\n\t\t\t\t\t((i[r] as any).l = new Date().getTime());\n\t\t\t\t// eslint-disable-next-line no-sequences\n\t\t\t\t(a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);\n\t\t\t\ta.async = 1;\n\t\t\t\ta.src = g;\n\t\t\t\tm.parentNode.insertBefore(a, m);\n\t\t\t})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');\n\n\t\t\twindow.ga?.('create', googleId, 'auto');\n\t\t\twindow.ga?.('send', 'pageview');\n\t\t}\n\t}, [googleId, uid]);\n\n\tuseEffect(() => {\n\t\tif (!piwikUrl) {\n\t\t\tdocument.getElementById('piwik-analytics')?.remove();\n\t\t\twindow._paq = [];\n\t\t\treturn;\n\t\t}\n\n\t\tconst piwikSiteId = piwikUrl && settings.get('PiwikAnalytics_siteId');\n\t\tconst piwikPrependDomain = piwikUrl && settings.get('PiwikAnalytics_prependDomain');\n\t\tconst piwikCookieDomain = piwikUrl && settings.get('PiwikAnalytics_cookieDomain');\n\t\tconst piwikDomains = piwikUrl && settings.get('PiwikAnalytics_domains');\n\t\tconst piwikAdditionalTracker = piwikUrl && settings.get('PiwikAdditionalTrackers');\n\t\twindow._paq = window._paq || [];\n\n\t\twindow._paq.push(['trackPageView']);\n\t\twindow._paq.push(['enableLinkTracking']);\n\t\tif (piwikPrependDomain) {\n\t\t\twindow._paq.push(['setDocumentTitle', `${window.location.hostname}/${document.title}`]);\n\t\t}\n\t\tconst upperLevelDomain = `*.${window.location.hostname.split('.').slice(1).join('.')}`;\n\t\tif (piwikCookieDomain) {\n\t\t\twindow._paq.push(['setCookieDomain', upperLevelDomain]);\n\t\t}\n\t\tif (piwikDomains) {\n\t\t\t// array\n\t\t\tconst domainsArray = piwikDomains.split(/\\n/);\n\t\t\tconst domains = [];\n\t\t\tfor (let i = 0; i < domainsArray.length; i++) {\n\t\t\t\t// only push domain if it contains a non whitespace character.\n\t\t\t\tif (/\\S/.test(domainsArray[i])) {\n\t\t\t\t\tdomains.push(`*.${domainsArray[i].trim()}`);\n\t\t\t\t}\n\t\t\t}\n\t\t\twindow._paq.push(['setDomains', domains]);\n\t\t}\n\t\t(() => {\n\t\t\ttry {\n\t\t\t\tif (/\\S/.test(piwikAdditionalTracker)) {\n\t\t\t\t\t// piwikAdditionalTracker is not empty or whitespace only\n\t\t\t\t\tconst addTrackers = JSON.parse(piwikAdditionalTracker);\n\t\t\t\t\tfor (let i = 0; i < addTrackers.length; i++) {\n\t\t\t\t\t\tconst tracker = addTrackers[i];\n\t\t\t\t\t\twindow._paq.push(['addTracker', `${tracker.trackerURL}js/`, tracker.siteId]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\t// parsing JSON faild\n\t\t\t\tconsole.log('Error while parsing JSON value of \"piwikAdditionalTracker\": ', e);\n\t\t\t}\n\t\t\twindow._paq.push(['setTrackerUrl', `${piwikUrl}js/`]);\n\t\t\twindow._paq.push(['setSiteId', Number.parseInt(piwikSiteId)]);\n\t\t\tconst d = document;\n\t\t\tconst g = d.createElement('script');\n\t\t\tg.setAttribute('id', 'piwik-analytics');\n\t\t\tconst s = d.getElementsByTagName('script')[0];\n\t\t\tg.type = 'text/javascript';\n\t\t\tg.async = true;\n\t\t\tg.defer = true;\n\t\t\tg.src = `${piwikUrl}js/`;\n\t\t\ts.parentNode?.insertBefore(g, s);\n\t\t})();\n\t}, [piwikUrl]);\n};\n",null],"names":["Meteor","useEffect","useReactiveValue","settings","module","export","useAnalytics","uid","userId","googleId","get","piwikUrl","window","_paq","push","_f$parentNode","_window$ga","_window","_window$ga2","_window2","i","s","o","a","m","startsWith","f","document","getElementsByTagName","j","createElement","async","src","concat","parentNode","insertBefore","w","dataLayer","gtag","key","value","Date","GoogleAnalyticsObject","_len","arguments","length","args","Array","_key","q","l","getTime","ga","call","_document$getElementB","getElementById","remove","piwikSiteId","piwikPrependDomain","piwikCookieDomain","piwikDomains","piwikAdditionalTracker","location","hostname","title","upperLevelDomain","split","slice","join","domainsArray","domains","test","trim","_s$parentNode","addTrackers","JSON","parse","tracker","trackerURL","siteId","e","console","log","Number","parseInt","d","g","setAttribute","type","defer"],"mappings":"2BAAuCA,EAAAC,EAAAC,EAAAC,EAAvCC,EAAOC,MAAE,CAAA,CAAMC,aAAQ,IAAAA,CAAgB,GAAAF,EAAAA,IAAAA,CAAAA,gBAAAA,CAAAJ,OAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAI,EAAAA,IAAAA,CAAAA,QAAAA,CAAAH,UAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAG,EAAAA,IAAAA,CAAAA,yCAAAA,CAAAF,iBAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAAAE,EAAAA,IAAAA,CAAAA,wBAAAA,CAAAD,SAAAA,CAAAA,EAAAA,EAAAA,CAAA,CAAA,EAAA,GAqBhC,IAAMG,EAAe,KAC3B,IAAMC,EAAML,EAAiB,IAAMF,EAAOQ,MAAM,IAE1CC,EAAWP,EAAiB,IAAMC,EAASO,GAAG,CAAC,4BAA8BP,EAASO,GAAG,CAAC,uBAC1FC,EAAWT,EAAiB,IAAMC,EAASO,GAAG,CAAC,2BAA6BP,EAASO,GAAG,CAAC,uBAE/FT,EAAU,KACLM,IACHK,OAAOC,IAAI,CAAGD,OAAOC,IAAI,EAAI,EAAE,CAC/BD,OAAOC,IAAI,CAACC,IAAI,CAAC,CAAC,YAAaP,EAAI,EAErC,GAEAN,EAAU,SAIsBc,EAgBxBC,EAAAC,EAAAC,EAAAC,EAEKC,EAAGC,EAAGC,EAAeC,EAASC,EArB1C,GAAKf,GAGL,GAAIA,EAASgB,UAAU,CAAC,MAAO,CAE9B,IAAMC,EAAIC,SAASC,oBAAoB,CAAC,SAAS,CAAC,EAAE,CAC9CC,EAAIF,SAASG,aAAa,CAAC,SACjCD,CAAAA,EAAEE,KAAK,CAAG,CAAA,EACVF,EAAEG,GAAG,CAAA,yCAAAC,MAAA,CAA4CxB,GACjD,AAAY,OAAZM,CAAAA,EAAAW,EAAEQ,UAAU,AAAVA,GAAUnB,AAAA,KAAA,IAAAA,GAAZA,EAAcoB,YAAY,CAACN,EAAGH,GAG9B,IAAMU,EAAkCxB,OAClCyB,EAAYD,EAAEC,SAAS,EAAI,EAAE,CAC7BC,EAAO,CAACC,EAAaC,KAC1BH,EAAUvB,IAAI,CAACyB,EAAKC,EACrB,EACAF,EAAK,KAAM,IAAIG,MACfH,EAAK,SAAU7B,QAGJW,EAcRR,OAdWS,EAcHM,SAdML,EAcI,SAbpBF,EAAEsB,qBAAqB,CAawD,KAZ9EtB,EAY8E,EAZ1E,CACJA,EAW8E,EAX1E,EACJ,WAAiB,IAAA,IAAAuB,EAAAC,UAAAC,MAAA,CAAJC,EAAI,AAAAC,MAAAJ,GAAAK,EAAA,EAAAA,EAAAL,EAAAK,IAAJF,CAAI,CAAAE,EAAA,CAAAJ,SAAA,CAAAI,EAAA,CAChB,AAAE5B,CAAAA,EAS2E,EAT/D,CAAC6B,CAAC,CAAI7B,EASyD,EAT7C,CAAC6B,CAAC,EAAI,EAAE,AAAF,EAAInC,IAAI,CAACgC,EAEhD,EACE1B,EAM4E,EANhE,CAAC8B,CAAC,CAAG,IAAIT,OAAOU,OAAO,GAErC5B,EAAIF,EAAES,aAAa,CAACR,GAAME,EAAIH,EAAEO,oBAAoB,CAACN,EAAE,CAAC,EAAG,CAC5DC,EAAEQ,KAAK,CAAG,EACVR,EAAES,GAAG,CAEyB,gDAD9BR,EAAEU,UAAU,CAACC,YAAY,CAACZ,EAAGC,GAG9B,AAAS,OAATR,CAAAA,EAAA,AAAAC,CAAAA,EAAAL,MAAA,EAAOwC,EAAE,AAAFA,GAAEpC,AAAA,KAAA,IAAAA,GAATA,EAAAqC,IAAA,CAAApC,EAAY,SAAUR,EAAU,QAChC,AAAS,OAATS,CAAAA,EAAA,AAAAC,CAAAA,EAAAP,MAAA,EAAOwC,EAAE,AAAFA,GAAElC,AAAA,KAAA,IAAAA,GAATA,EAAAmC,IAAA,CAAAlC,EAAY,OAAQ,YAEtB,EAAG,CAACV,EAAUF,EAAI,EAElBN,EAAU,KACT,GAAI,CAACU,EAAU,CAAA,IAAA2C,CACd,AAA0C,QAA1CA,CAAAA,EAAA3B,SAAS4B,cAAc,CAAC,kBAAiB,GAACD,AAAA,KAAA,IAAAA,GAA1CA,EAA4CE,MAAM,GAClD5C,OAAOC,IAAI,CAAG,EAAE,CAChB,OAGD,IAAM4C,EAAc9C,GAAYR,EAASO,GAAG,CAAC,yBACvCgD,EAAqB/C,GAAYR,EAASO,GAAG,CAAC,gCAC9CiD,EAAoBhD,GAAYR,EAASO,GAAG,CAAC,+BAC7CkD,EAAejD,GAAYR,EAASO,GAAG,CAAC,0BACxCmD,EAAyBlD,GAAYR,EAASO,GAAG,CAAC,0BACxDE,CAAAA,OAAOC,IAAI,CAAGD,OAAOC,IAAI,EAAI,EAAE,CAE/BD,OAAOC,IAAI,CAACC,IAAI,CAAC,CAAC,gBAAgB,EAClCF,OAAOC,IAAI,CAACC,IAAI,CAAC,CAAC,qBAAqB,EACnC4C,GACH9C,OAAOC,IAAI,CAACC,IAAI,CAAC,CAAC,mBAAkB,GAAAmB,MAAA,CAAKrB,OAAOkD,QAAQ,CAACC,QAAQ,CAAA,KAAA9B,MAAA,CAAIN,SAASqC,KAAK,EAAG,EAEvF,IAAMC,EAAgB,KAAAhC,MAAA,CAAQrB,OAAOkD,QAAQ,CAACC,QAAQ,CAACG,KAAK,CAAC,KAAKC,KAAK,CAAC,GAAGC,IAAI,CAAC,MAIhF,GAHIT,GACH/C,OAAOC,IAAI,CAACC,IAAI,CAAC,CAAC,kBAAmBmD,EAAiB,EAEnDL,EAAc,CAEjB,IAAMS,EAAeT,EAAaM,KAAK,CAAC,MAClCI,EAAU,EAAE,CAClB,IAAK,IAAIlD,EAAI,EAAGA,EAAIiD,EAAaxB,MAAM,CAAEzB,IAEpC,KAAKmD,IAAI,CAACF,CAAY,CAACjD,EAAE,GAC5BkD,EAAQxD,IAAI,CAAA,KAAAmB,MAAA,CAAMoC,CAAY,CAACjD,EAAE,CAACoD,IAAI,KAGxC5D,OAAOC,IAAI,CAACC,IAAI,CAAC,CAAC,aAAcwD,EAAQ,EAEzC,AAAC,CAAA,KAAK,IAAAG,EACL,GAAI,CACH,GAAI,KAAKF,IAAI,CAACV,GAAyB,CAEtC,IAAMa,EAAcC,KAAKC,KAAK,CAACf,GAC/B,IAAK,IAAIzC,EAAI,EAAGA,EAAIsD,EAAY7B,MAAM,CAAEzB,IAAK,CAC5C,IAAMyD,EAAUH,CAAW,CAACtD,EAAE,CAC9BR,OAAOC,IAAI,CAACC,IAAI,CAAC,CAAC,aAAY,GAAAmB,MAAA,CAAK4C,EAAQC,UAAU,CAAA,OAAOD,EAAQE,MAAM,CAAC,IAG5E,MAAOC,EAAG,CAEXC,QAAQC,GAAG,CAAC,+DAAgEF,GAE7EpE,OAAOC,IAAI,CAACC,IAAI,CAAC,CAAC,gBAAe,GAAAmB,MAAA,CAAKtB,EAAQ,OAAM,EACpDC,OAAOC,IAAI,CAACC,IAAI,CAAC,CAAC,YAAaqE,OAAOC,QAAQ,CAAC3B,GAAa,EAC5D,IAAM4B,EAAI1D,SACJ2D,EAAID,EAAEvD,aAAa,CAAC,UAC1BwD,EAAEC,YAAY,CAAC,KAAM,mBACrB,IAAMlE,EAAIgE,EAAEzD,oBAAoB,CAAC,SAAS,CAAC,EAAE,AAC7C0D,CAAAA,EAAEE,IAAI,CAAG,kBACTF,EAAEvD,KAAK,CAAG,CAAA,EACVuD,EAAEG,KAAK,CAAG,CAAA,EACVH,EAAEtD,GAAG,CAAA,GAAAC,MAAA,CAAMtB,EAAQ,OACnB,AAAY,OAAZ8D,CAAAA,EAAApD,EAAEa,UAAU,AAAVA,GAAUuC,AAAA,KAAA,IAAAA,GAAZA,EAActC,YAAY,CAACmD,EAAGjE,EAC/B,CAAA,GACD,EAAG,CAACV,EAAS,CACd"}
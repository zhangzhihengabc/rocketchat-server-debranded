)]}'
{"version":3,"sources":["meteor://ðŸ’»app/app/reactions/client/methods/setReaction.ts","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { IMessage, IRoom } from '@rocket.chat/core-typings';\nimport type { ServerMethods } from '@rocket.chat/ui-contexts';\nimport { Meteor } from 'meteor/meteor';\n\nimport { roomCoordinator } from '../../../../client/lib/rooms/roomCoordinator';\nimport { callbacks } from '../../../../lib/callbacks';\nimport { emoji } from '../../../emoji/client';\nimport { Messages, ChatRoom, Subscriptions } from '../../../models/client';\n\nMeteor.methods<ServerMethods>({\n\tasync setReaction(reaction, messageId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error(203, 'User_logged_out');\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif (!user?.username) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst message: IMessage | undefined = Messages.findOne({ _id: messageId });\n\t\tif (!message) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst room: IRoom | undefined = ChatRoom.findOne({ _id: message.rid });\n\t\tif (!room) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (message.private) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!emoji.list[reaction]) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (roomCoordinator.readOnly(room._id, user)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!Subscriptions.findOne({ rid: message.rid })) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (message.reactions?.[reaction] && message.reactions[reaction].usernames.indexOf(user.username) !== -1) {\n\t\t\tmessage.reactions[reaction].usernames.splice(message.reactions[reaction].usernames.indexOf(user.username), 1);\n\n\t\t\tif (message.reactions[reaction].usernames.length === 0) {\n\t\t\t\tdelete message.reactions[reaction];\n\t\t\t}\n\n\t\t\tif (!message.reactions || typeof message.reactions !== 'object' || Object.keys(message.reactions).length === 0) {\n\t\t\t\tdelete message.reactions;\n\t\t\t\tMessages.update({ _id: messageId }, { $unset: { reactions: 1 } });\n\t\t\t\tawait callbacks.run('unsetReaction', messageId, reaction);\n\t\t\t} else {\n\t\t\t\tMessages.update({ _id: messageId }, { $set: { reactions: message.reactions } });\n\t\t\t\tawait callbacks.run('setReaction', messageId, reaction);\n\t\t\t}\n\t\t} else {\n\t\t\tif (!message.reactions) {\n\t\t\t\tmessage.reactions = {};\n\t\t\t}\n\t\t\tif (!message.reactions[reaction]) {\n\t\t\t\tmessage.reactions[reaction] = {\n\t\t\t\t\tusernames: [],\n\t\t\t\t};\n\t\t\t}\n\t\t\tmessage.reactions[reaction].usernames.push(user.username);\n\n\t\t\tMessages.update({ _id: messageId }, { $set: { reactions: message.reactions } });\n\t\t\tawait callbacks.run('setReaction', messageId, reaction);\n\t\t}\n\t},\n});\n",null],"names":["Meteor","roomCoordinator","callbacks","emoji","Messages","ChatRoom","Subscriptions","module","link","methods","setReaction","reaction","messageId","_message$reactions","userId","Error","user","username","message","findOne","_id","room","rid","private","list","readOnly","reactions","usernames","indexOf","splice","length","Object","keys","update","$set","run","$unset","push"],"mappings":"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"}
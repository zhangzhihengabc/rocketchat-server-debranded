)]}'
{"version":3,"sources":["meteor://ðŸ’»app/app/autotranslate/client/lib/autotranslate.ts","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type {\n\tIRoom,\n\tISubscription,\n\tISupportedLanguage,\n\tITranslatedMessage,\n\tIUser,\n\tMessageAttachmentDefault,\n} from '@rocket.chat/core-typings';\nimport { isTranslatedMessageAttachment } from '@rocket.chat/core-typings';\nimport mem from 'mem';\nimport { Meteor } from 'meteor/meteor';\nimport { Tracker } from 'meteor/tracker';\n\nimport {\n\thasTranslationLanguageInAttachments,\n\thasTranslationLanguageInMessage,\n} from '../../../../client/views/room/MessageList/lib/autoTranslate';\nimport { hasPermission } from '../../../authorization/client';\nimport { Subscriptions, Messages } from '../../../models/client';\nimport { sdk } from '../../../utils/client/lib/SDKClient';\n\nlet userLanguage = 'en';\nlet username = '';\n\nMeteor.startup(() => {\n\tTracker.autorun(() => {\n\t\tconst user: Pick<IUser, 'language' | 'username'> | null = Meteor.user();\n\t\tif (!user) {\n\t\t\treturn;\n\t\t}\n\t\tuserLanguage = user.language || 'en';\n\t\tusername = user.username || '';\n\t});\n});\n\nexport const AutoTranslate = {\n\tinitialized: false,\n\tprovidersMetadata: {} as { [providerNamer: string]: { name: string; displayName: string } },\n\tmessageIdsToWait: {} as { [messageId: string]: string },\n\tsupportedLanguages: [] as ISupportedLanguage[] | undefined,\n\n\tfindSubscriptionByRid: mem((rid) => Subscriptions.findOne({ rid })),\n\n\tgetLanguage(rid: IRoom['_id']): string {\n\t\tlet subscription: ISubscription | undefined;\n\t\tif (rid) {\n\t\t\tsubscription = this.findSubscriptionByRid(rid);\n\t\t}\n\t\tconst language = (subscription?.autoTranslateLanguage || userLanguage || window.defaultUserLanguage?.()) as string;\n\t\tif (language.indexOf('-') !== -1) {\n\t\t\tif (!(this.supportedLanguages || []).some((supportedLanguage) => supportedLanguage.language === language)) {\n\t\t\t\treturn language.slice(0, 2);\n\t\t\t}\n\t\t}\n\t\treturn language;\n\t},\n\n\ttranslateAttachments(\n\t\tattachments: MessageAttachmentDefault[],\n\t\tlanguage: string,\n\t\tautoTranslateShowInverse: boolean,\n\t): MessageAttachmentDefault[] {\n\t\tif (!isTranslatedMessageAttachment(attachments)) {\n\t\t\treturn attachments;\n\t\t}\n\t\tfor (const attachment of attachments) {\n\t\t\tif (attachment.author_name !== username) {\n\t\t\t\tif (attachment.text && attachment.translations && attachment.translations[language]) {\n\t\t\t\t\tattachment.translations.original = attachment.text;\n\n\t\t\t\t\tif (autoTranslateShowInverse) {\n\t\t\t\t\t\tattachment.text = attachment.translations.original;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tattachment.text = attachment.translations[language];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (attachment.description && attachment.translations && attachment.translations[language]) {\n\t\t\t\t\tattachment.translations.original = attachment.description;\n\n\t\t\t\t\tif (autoTranslateShowInverse) {\n\t\t\t\t\t\tattachment.description = attachment.translations.original;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tattachment.description = attachment.translations[language];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// @ts-expect-error - not sure what to do with this\n\t\t\t\tif (attachment.attachments && attachment.attachments.length > 0) {\n\t\t\t\t\t// @ts-expect-error - not sure what to do with this\n\t\t\t\t\tattachment.attachments = this.translateAttachments(attachment.attachments, language);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn attachments;\n\t},\n\n\tinit(): void {\n\t\tif (this.initialized) {\n\t\t\treturn;\n\t\t}\n\n\t\tTracker.autorun(async (c) => {\n\t\t\tconst uid = Meteor.userId();\n\t\t\tif (!uid || !hasPermission('auto-translate')) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tc.stop();\n\n\t\t\ttry {\n\t\t\t\t[this.providersMetadata, this.supportedLanguages] = await Promise.all([\n\t\t\t\t\tsdk.call('autoTranslate.getProviderUiMetadata'),\n\t\t\t\t\tsdk.call('autoTranslate.getSupportedLanguages', 'en'),\n\t\t\t\t]);\n\t\t\t} catch (e: unknown) {\n\t\t\t\t// Avoid unwanted error message on UI when autotranslate is disabled while fetching data\n\t\t\t\tconsole.error((e as Error).message);\n\t\t\t}\n\t\t});\n\n\t\tSubscriptions.find().observeChanges({\n\t\t\tchanged: (_id: string, fields: ISubscription) => {\n\t\t\t\tif (fields.hasOwnProperty('autoTranslate') || fields.hasOwnProperty('autoTranslateLanguage')) {\n\t\t\t\t\tmem.clear(this.findSubscriptionByRid);\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\n\t\tthis.initialized = true;\n\t},\n};\n\nexport const createAutoTranslateMessageStreamHandler = (): ((message: ITranslatedMessage) => void) => {\n\tAutoTranslate.init();\n\n\treturn (message: ITranslatedMessage): void => {\n\t\tif (message.u && message.u._id !== Meteor.userId()) {\n\t\t\tconst subscription = AutoTranslate.findSubscriptionByRid(message.rid);\n\t\t\tconst language = AutoTranslate.getLanguage(message.rid);\n\t\t\tif (\n\t\t\t\tsubscription &&\n\t\t\t\tsubscription.autoTranslate === true &&\n\t\t\t\tmessage.msg &&\n\t\t\t\t(!message.translations ||\n\t\t\t\t\t(!hasTranslationLanguageInMessage(message, language) && !hasTranslationLanguageInAttachments(message.attachments, language)))\n\t\t\t) {\n\t\t\t\t// || (message.attachments && !_.find(message.attachments, attachment => { return attachment.translations && attachment.translations[language]; }))\n\t\t\t\tMessages.update({ _id: message._id }, { $set: { autoTranslateFetching: true } });\n\t\t\t} else if (AutoTranslate.messageIdsToWait[message._id] !== undefined && subscription && subscription.autoTranslate !== true) {\n\t\t\t\tMessages.update({ _id: message._id }, { $set: { autoTranslateShowInverse: true }, $unset: { autoTranslateFetching: true } });\n\t\t\t\tdelete AutoTranslate.messageIdsToWait[message._id];\n\t\t\t} else if (message.autoTranslateFetching === true) {\n\t\t\t\tMessages.update({ _id: message._id }, { $unset: { autoTranslateFetching: true } });\n\t\t\t}\n\t\t}\n\t};\n};\n",null],"names":["isTranslatedMessageAttachment","mem","Meteor","Tracker","hasTranslationLanguageInAttachments","hasTranslationLanguageInMessage","hasPermission","Subscriptions","Messages","sdk","module","export","AutoTranslate","createAutoTranslateMessageStreamHandler","default","userLanguage","username","startup","autorun","user","language","initialized","providersMetadata","messageIdsToWait","supportedLanguages","findSubscriptionByRid","rid","findOne","getLanguage","_subscription","_window$defaultUserLa","_window","subscription","autoTranslateLanguage","window","defaultUserLanguage","call","indexOf","some","supportedLanguage","slice","translateAttachments","attachments","autoTranslateShowInverse","attachment","author_name","text","translations","original","description","length","init","c","uid","userId","stop","Promise","all","e","console","error","message","find","observeChanges","changed","_id","fields","hasOwnProperty","clear","u","autoTranslate","msg","undefined","update","$set","$unset","autoTranslateFetching"],"mappings":"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"}
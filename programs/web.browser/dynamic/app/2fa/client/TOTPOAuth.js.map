)]}'
{"version":3,"sources":["meteor://ðŸ’»app/app/2fa/client/TOTPOAuth.js","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import { capitalize } from '@rocket.chat/string-helpers';\nimport { Accounts } from 'meteor/accounts-base';\nimport { Facebook } from 'meteor/facebook-oauth';\nimport { Github } from 'meteor/github-oauth';\nimport { Meteor } from 'meteor/meteor';\nimport { MeteorDeveloperAccounts } from 'meteor/meteor-developer-oauth';\nimport { OAuth } from 'meteor/oauth';\nimport { Linkedin } from 'meteor/pauli:linkedin-oauth';\nimport { Twitter } from 'meteor/twitter-oauth';\n\nimport { overrideLoginMethod } from '../../../client/lib/2fa/overrideLoginMethod';\nimport { process2faReturn } from '../../../client/lib/2fa/process2faReturn';\nimport { convertError } from '../../../client/lib/2fa/utils';\nimport { CustomOAuth } from '../../custom-oauth/client/custom_oauth_client';\n\nlet lastCredentialToken = null;\nlet lastCredentialSecret = null;\n\nAccounts.oauth.tryLoginAfterPopupClosed = function (credentialToken, callback, totpCode, credentialSecret = null) {\n\tcredentialSecret = credentialSecret || OAuth._retrieveCredentialSecret(credentialToken) || null;\n\tconst methodArgument = {\n\t\toauth: {\n\t\t\tcredentialToken,\n\t\t\tcredentialSecret,\n\t\t},\n\t};\n\n\tlastCredentialToken = credentialToken;\n\tlastCredentialSecret = credentialSecret;\n\n\tif (totpCode && typeof totpCode === 'string') {\n\t\tmethodArgument.totp = {\n\t\t\tcode: totpCode,\n\t\t};\n\t}\n\n\tAccounts.callLoginMethod({\n\t\tmethodArguments: [methodArgument],\n\t\tuserCallback:\n\t\t\tcallback &&\n\t\t\tfunction (err) {\n\t\t\t\tcallback(convertError(err));\n\t\t\t},\n\t});\n};\n\nAccounts.oauth.credentialRequestCompleteHandler = function (callback, totpCode) {\n\treturn function (credentialTokenOrError) {\n\t\tif (credentialTokenOrError && credentialTokenOrError instanceof Error) {\n\t\t\tcallback && callback(credentialTokenOrError);\n\t\t} else {\n\t\t\tAccounts.oauth.tryLoginAfterPopupClosed(credentialTokenOrError, callback, totpCode);\n\t\t}\n\t};\n};\n\nconst createOAuthTotpLoginMethod = (credentialProvider) => (options, code, callback) => {\n\t// support a callback without options\n\tif (!callback && typeof options === 'function') {\n\t\tcallback = options;\n\t\toptions = null;\n\t}\n\n\tif (lastCredentialToken && lastCredentialSecret) {\n\t\tAccounts.oauth.tryLoginAfterPopupClosed(lastCredentialToken, callback, code, lastCredentialSecret);\n\t} else {\n\t\tconst provider = (credentialProvider && credentialProvider()) || this;\n\t\tconst credentialRequestCompleteCallback = Accounts.oauth.credentialRequestCompleteHandler(callback, code);\n\t\tprovider.requestCredential(options, credentialRequestCompleteCallback);\n\t}\n\n\tlastCredentialToken = null;\n\tlastCredentialSecret = null;\n};\n\nconst loginWithOAuthTokenAndTOTP = createOAuthTotpLoginMethod();\n\nconst loginWithFacebookAndTOTP = createOAuthTotpLoginMethod(() => Facebook);\nconst { loginWithFacebook } = Meteor;\nMeteor.loginWithFacebook = function (options, cb) {\n\toverrideLoginMethod(loginWithFacebook, [options], cb, loginWithFacebookAndTOTP);\n};\n\nconst loginWithGithubAndTOTP = createOAuthTotpLoginMethod(() => Github);\nconst { loginWithGithub } = Meteor;\nMeteor.loginWithGithub = function (options, cb) {\n\toverrideLoginMethod(loginWithGithub, [options], cb, loginWithGithubAndTOTP);\n};\n\nconst loginWithMeteorDeveloperAccountAndTOTP = createOAuthTotpLoginMethod(() => MeteorDeveloperAccounts);\nconst { loginWithMeteorDeveloperAccount } = Meteor;\nMeteor.loginWithMeteorDeveloperAccount = function (options, cb) {\n\toverrideLoginMethod(loginWithMeteorDeveloperAccount, [options], cb, loginWithMeteorDeveloperAccountAndTOTP);\n};\n\nconst loginWithTwitterAndTOTP = createOAuthTotpLoginMethod(() => Twitter);\nconst { loginWithTwitter } = Meteor;\nMeteor.loginWithTwitter = function (options, cb) {\n\toverrideLoginMethod(loginWithTwitter, [options], cb, loginWithTwitterAndTOTP);\n};\n\nconst loginWithLinkedinAndTOTP = createOAuthTotpLoginMethod(() => Linkedin);\nconst { loginWithLinkedin } = Meteor;\nMeteor.loginWithLinkedin = function (options, cb) {\n\toverrideLoginMethod(loginWithLinkedin, [options], cb, loginWithLinkedinAndTOTP);\n};\n\nAccounts.onPageLoadLogin(async (loginAttempt) => {\n\tif (loginAttempt?.error?.error !== 'totp-required') {\n\t\treturn;\n\t}\n\n\tconst { methodArguments } = loginAttempt;\n\tif (!methodArguments?.length) {\n\t\treturn;\n\t}\n\n\tconst oAuthArgs = methodArguments.find((arg) => arg.oauth);\n\tconst { credentialToken, credentialSecret } = oAuthArgs.oauth;\n\tconst cb = loginAttempt.userCallback;\n\n\tawait process2faReturn({\n\t\terror: loginAttempt.error,\n\t\toriginalCallback: cb,\n\t\tonCode: (code) => {\n\t\t\tAccounts.oauth.tryLoginAfterPopupClosed(credentialToken, cb, code, credentialSecret);\n\t\t},\n\t});\n});\n\nconst oldConfigureLogin = CustomOAuth.prototype.configureLogin;\nCustomOAuth.prototype.configureLogin = function (...args) {\n\tconst loginWithService = `loginWith${capitalize(String(this.name || ''))}`;\n\n\toldConfigureLogin.apply(this, args);\n\n\tconst oldMethod = Meteor[loginWithService];\n\n\tMeteor[loginWithService] = function (options, cb) {\n\t\toverrideLoginMethod(oldMethod, [options], cb, loginWithOAuthTokenAndTOTP);\n\t};\n};\n",null],"names":["capitalize","Accounts","Facebook","Github","Meteor","MeteorDeveloperAccounts","OAuth","Linkedin","Twitter","overrideLoginMethod","process2faReturn","convertError","CustomOAuth","module","link","v","lastCredentialToken","lastCredentialSecret","oauth","tryLoginAfterPopupClosed","credentialToken","callback","totpCode","credentialSecret","arguments","length","undefined","_retrieveCredentialSecret","methodArgument","totp","code","callLoginMethod","methodArguments","userCallback","err","credentialRequestCompleteHandler","credentialTokenOrError","Error","createOAuthTotpLoginMethod","credentialProvider","options","provider","credentialRequestCompleteCallback","requestCredential","loginWithOAuthTokenAndTOTP","loginWithFacebookAndTOTP","loginWithFacebook","cb","loginWithGithubAndTOTP","loginWithGithub","loginWithMeteorDeveloperAccountAndTOTP","loginWithMeteorDeveloperAccount","loginWithTwitterAndTOTP","loginWithTwitter","loginWithLinkedinAndTOTP","loginWithLinkedin","onPageLoadLogin","loginAttempt","_loginAttempt$error","error","oAuthArgs","find","arg","originalCallback","onCode","oldConfigureLogin","prototype","configureLogin","loginWithService","concat","String","name","_len","args","Array","_key","apply","oldMethod"],"mappings":"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"}
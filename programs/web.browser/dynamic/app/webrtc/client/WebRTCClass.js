function module(e,t,o){let i,n,s,r,a,l,c,d,h,m,g,u,f;o.export({WebRTC:()=>b}),o.link("@rocket.chat/emitter",{Emitter(e){i=e}},0),o.link("meteor/meteor",{Meteor(e){n=e}},1),o.link("meteor/reactive-var",{ReactiveVar(e){s=e}},2),o.link("meteor/tracker",{Tracker(e){r=e}},3),o.link("../../../client/components/GenericModal",{default(e){a=e}},4),o.link("../../../client/lib/imperativeModal",{imperativeModal(e){l=e}},5),o.link("../../../client/lib/utils/goToRoomById",{goToRoomById(e){c=e}},6),o.link("../../models/client",{ChatSubscription(e){d=e}},7),o.link("../../notifications/client",{Notifications(e){h=e}},8),o.link("../../settings/client",{settings(e){m=e}},9),o.link("../../utils/lib/i18n",{t(e){g=e}},10),o.link("../lib/constants",{WEB_RTC_EVENTS(e){u=e}},11),o.link("./screenShare",{ChromeScreenShare(e){f=e}},12);class p extends i{constructor(e){super(),this.debug=!1,this.webrtcInstance=e,h.onRoom(this.webrtcInstance.room,u.WEB_RTC,(e,t)=>{this.log("WebRTCTransportClass - onRoom",e,t),this.emit(e,t)})}log(){!0===this.debug&&console.log(...arguments)}onUserStream(e,t){t.room===this.webrtcInstance.room&&(this.log("WebRTCTransportClass - onUser",e,t),this.emit(e,t))}startCall(e){this.log("WebRTCTransportClass - startCall",this.webrtcInstance.room,this.webrtcInstance.selfId),h.notifyUsersOfRoom(this.webrtcInstance.room,u.WEB_RTC,u.CALL,{from:this.webrtcInstance.selfId,room:this.webrtcInstance.room,media:e.media,monitor:e.monitor})}joinCall(e){this.log("WebRTCTransportClass - joinCall",this.webrtcInstance.room,this.webrtcInstance.selfId),!0===e.monitor?h.notifyUser(e.to,u.WEB_RTC,u.JOIN,{from:this.webrtcInstance.selfId,room:this.webrtcInstance.room,media:e.media,monitor:e.monitor}):h.notifyUsersOfRoom(this.webrtcInstance.room,u.WEB_RTC,u.JOIN,{from:this.webrtcInstance.selfId,room:this.webrtcInstance.room,media:e.media,monitor:e.monitor})}sendCandidate(e){e.from=this.webrtcInstance.selfId,e.room=this.webrtcInstance.room,this.log("WebRTCTransportClass - sendCandidate",e),h.notifyUser(e.to,u.WEB_RTC,u.CANDIDATE,e)}sendDescription(e){e.from=this.webrtcInstance.selfId,e.room=this.webrtcInstance.room,this.log("WebRTCTransportClass - sendDescription",e),h.notifyUser(e.to,u.WEB_RTC,u.DESCRIPTION,e)}sendStatus(e){this.log("WebRTCTransportClass - sendStatus",e,this.webrtcInstance.room),e.from=this.webrtcInstance.selfId,h.notifyRoom(this.webrtcInstance.room,u.WEB_RTC,u.STATUS,e)}onRemoteCall(e){return this.on(u.CALL,e)}onRemoteJoin(e){return this.on(u.JOIN,e)}onRemoteCandidate(e){return this.on(u.CANDIDATE,e)}onRemoteDescription(e){return this.on(u.DESCRIPTION,e)}onRemoteStatus(e){return this.on(u.STATUS,e)}}class C{constructor(e,t){let o=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.resetCallInProgress=()=>{this.callInProgress.set(!1)},this.stopPeerConnection=e=>{let t=this.peerConnections[e];null!=t&&(delete this.peerConnections[e],t.close(),this.updateRemoteItems())},this.config={iceServers:[]},this.debug=!1,this.TransportClass=p,this.selfId=e,this.room=t;let i=m.get("WebRTC_Servers");i&&""!==i.trim()&&(i=(i=i.replace(/\s/g,"")).split(",")).forEach(e=>{e=e.split("@");let t={urls:e.pop()};1===e.length&&(e=e[0].split(":"),t.username=decodeURIComponent(e[0]),t.credential=decodeURIComponent(e[1])),this.config.iceServers.push(t)}),this.peerConnections={},this.remoteItems=new s([]),this.remoteItemsById=new s({}),this.callInProgress=new s(!1),this.audioEnabled=new s(!1),this.videoEnabled=new s(!1),this.overlayEnabled=new s(!1),this.screenShareEnabled=new s(!1),this.localUrl=new s,this.active=!1,this.remoteMonitoring=!1,this.monitor=!1,this.autoAccept=o,this.navigator=void 0;let n=navigator.userAgent.toLocaleLowerCase();-1!==n.indexOf("electron")?this.navigator="electron":-1!==n.indexOf("chrome")?this.navigator="chrome":-1!==n.indexOf("firefox")?this.navigator="firefox":-1!==n.indexOf("safari")&&(this.navigator="safari"),this.screenShareAvailable=["chrome","firefox","electron"].includes(this.navigator),this.media={video:!0,audio:!0},this.transport=new this.TransportClass(this),this.transport.onRemoteCall(this.onRemoteCall.bind(this)),this.transport.onRemoteJoin(this.onRemoteJoin.bind(this)),this.transport.onRemoteCandidate(this.onRemoteCandidate.bind(this)),this.transport.onRemoteDescription(this.onRemoteDescription.bind(this)),this.transport.onRemoteStatus(this.onRemoteStatus.bind(this)),setInterval(this.checkPeerConnections.bind(this),1e3)}onUserStream(){return this.transport.onUserStream(...arguments)}log(){if(!0===this.debug){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];console.log.apply(console,t)}}onError(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];console.error.apply(console,t)}checkPeerConnections(){let{peerConnections:e}=this,t=Date.now();Object.entries(e).some(e=>{let[o,i]=e;return!["connected","completed"].includes(i.iceConnectionState)&&i.createdAt+5e3<t&&(this.stopPeerConnection(o),!0)})}updateRemoteItems(){let e=[],t={},{peerConnections:o}=this;Object.entries(o).forEach(o=>{let[i,n]=o;n.getRemoteStreams().forEach(o=>{let s={id:i,url:o,state:n.iceConnectionState};switch(n.iceConnectionState){case"checking":s.stateText="Connecting...";break;case"connected":case"completed":s.stateText="Connected",s.connected=!0;break;case"disconnected":s.stateText="Disconnected";break;case"failed":s.stateText="Failed";break;case"closed":s.stateText="Closed"}e.push(s),t[i]=s})}),this.remoteItems.set(e),this.remoteItemsById.set(t)}broadcastStatus(){if(!0!==this.active||!0===this.monitor||!0===this.remoteMonitoring)return;let e=[],{peerConnections:t}=this;Object.keys(t).entries(t=>{let[o,{remoteMedia:i}]=t;e.push({id:o,media:i})}),this.transport.sendStatus({media:this.media,remoteConnections:e})}onRemoteStatus(e){if(this.callInProgress.set(!0),clearTimeout(this.callInProgressTimeout),this.callInProgressTimeout=setTimeout(this.resetCallInProgress,2e3),!0!==this.active)return;let t=[{id:e.from,media:e.media},...e.remoteConnections];t.forEach(e=>{e.id!==this.selfId&&null==this.peerConnections[e.id]&&(this.log("reconnecting with",e.id),this.onRemoteJoin({from:e.id,media:e.media}))})}getPeerConnection(e){if(null!=this.peerConnections[e])return this.peerConnections[e];let t=new RTCPeerConnection(this.config);return t.createdAt=Date.now(),t.remoteMedia={},this.peerConnections[e]=t,["icecandidate","addstream","removestream","iceconnectionstatechange","datachannel","identityresult","idpassertionerror","idpvalidationerror","negotiationneeded","peeridentity","signalingstatechange"].forEach(o=>{t.addEventListener(o,t=>{this.log(e,t.type,t)})}),t.addEventListener("icecandidate",t=>{null!=t.candidate&&this.transport.sendCandidate({to:e,candidate:{candidate:t.candidate.candidate,sdpMLineIndex:t.candidate.sdpMLineIndex,sdpMid:t.candidate.sdpMid}})}),t.addEventListener("addstream",()=>{this.updateRemoteItems()}),t.addEventListener("removestream",()=>{this.updateRemoteItems()}),t.addEventListener("iceconnectionstatechange",()=>{("disconnected"===t.iceConnectionState||"closed"===t.iceConnectionState)&&t===this.peerConnections[e]&&(this.stopPeerConnection(e),setTimeout(()=>{0===Object.keys(this.peerConnections).length&&this.stop()},3e3)),this.updateRemoteItems()}),t}_getUserMedia(e,t,o){let i=e=>{if(AudioContext&&e.getAudioTracks().length>0){let t=new AudioContext,o=t.createMediaStreamSource(e),i=t.createGain();o.connect(i);let n=t.createMediaStreamDestination();i.connect(n),i.gain.value=.6,e.removeTrack(e.getAudioTracks()[0]),e.addTrack(n.stream.getAudioTracks()[0]),e.volume=i,this.audioContext=t}t(e)};if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)return navigator.mediaDevices.getUserMedia(e).then(i).catch(o);navigator.getUserMedia(e,i,o)}getUserMedia(e,t){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.onError;if(!0!==e.desktop){this._getUserMedia(e,t,o);return}if(!0!==this.screenShareAvailable){console.log("Screen share is not avaliable");return}let i=i=>{let n=function(){l.open({component:a,props:{variant:"warning",title:g("Refresh_your_page_after_install_to_enable_screen_sharing")}})},s="chrome"===this.navigator&&f.installed,r="firefox"===this.navigator&&null!=window.rocketchatscreenshare;if(!s&&!r)return l.open({component:a,props:{title:g("Screen_Share"),variant:"warning",confirmText:g("Install_Extension"),cancelText:g("Cancel"),children:g("You_need_install_an_extension_to_allow_screen_sharing"),onConfirm:()=>{if("chrome"===this.navigator){let e="https://chrome.google.com/webstore/detail/rocketchat-screen-share/nocfbnnmjnndkbipkabodnheejiegccf";try{chrome.webstore.install(e,n,()=>{window.open(e),n()})}catch(t){console.log(t),window.open(e),n()}}else"firefox"===this.navigator&&(window.open("https://addons.mozilla.org/en-GB/firefox/addon/rocketchat-screen-share/"),n())}}}),o(!1);let c=e=>{null!=i&&e.addTrack(i.getAudioTracks()[0]),t(e)};"firefox"===this.navigator?(e={audio:e.audio,video:{mozMediaSource:"window",mediaSource:"window"}},this._getUserMedia(e,c,o)):f.getSourceId(this.navigator,t=>{e={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxWidth:1280,maxHeight:720}}},this._getUserMedia(e,c,o)})};"firefox"===this.navigator||null==e.audio||!1===e.audio?i():this._getUserMedia({audio:e.audio},e=>{i(e)},()=>{i()})}getLocalUserMedia(e){for(var t=arguments.length,o=Array(t>1?t-1:0),i=1;i<t;i++)o[i-1]=arguments[i];if(this.log("getLocalUserMedia",[e,...o]),null!=this.localStream)return e(null,this.localStream);this.getUserMedia(this.media,t=>{this.localStream=t,this.audioEnabled.get()||this.disableAudio(),this.videoEnabled.get()||this.disableVideo(),this.localUrl.set(t);let{peerConnections:o}=this;Object.entries(o).forEach(e=>{let[,o]=e;return o.addStream(t)}),document.querySelector("video#localVideo").srcObject=t,e(null,this.localStream)},t=>{e(!1),this.onError(t)})}stopAllPeerConnections(){let{peerConnections:e}=this;Object.keys(e).forEach(this.stopPeerConnection),window.audioContext&&window.audioContext.close()}setAudioEnabled(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];null!=this.localStream&&(this.localStream.getAudioTracks().forEach(t=>{t.enabled=e}),this.audioEnabled.set(e))}disableAudio(){this.setAudioEnabled(!1)}enableAudio(){this.setAudioEnabled(!0)}toggleAudio(){return this.audioEnabled.get()?this.disableAudio():this.enableAudio()}setVideoEnabled(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];null!=this.localStream&&(this.localStream.getVideoTracks().forEach(t=>{t.enabled=e}),this.videoEnabled.set(e))}disableScreenShare(){this.setScreenShareEnabled(!1)}enableScreenShare(){this.setScreenShareEnabled(!0)}setScreenShareEnabled(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];null!=this.localStream&&(this.media.desktop=e,delete this.localStream,this.getLocalUserMedia(t=>{null==t&&(this.screenShareEnabled.set(e),this.stopAllPeerConnections(),this.joinCall())}))}disableVideo(){this.setVideoEnabled(!1)}enableVideo(){this.setVideoEnabled(!0)}toggleVideo(){return this.videoEnabled.get()?this.disableVideo():this.enableVideo()}stop(){this.active=!1,this.monitor=!1,this.remoteMonitoring=!1,null!=this.localStream&&void 0!==this.localStream&&this.localStream.getTracks().forEach(e=>e.stop()),this.localUrl.set(void 0),delete this.localStream,this.stopAllPeerConnections()}startCall(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};for(var t=arguments.length,o=Array(t>1?t-1:0),i=1;i<t;i++)o[i-1]=arguments[i];this.log("startCall",[e,...o]),this.media=e,this.getLocalUserMedia(()=>{this.active=!0,this.transport.startCall({media:this.media})})}startCallAsMonitor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};for(var t=arguments.length,o=Array(t>1?t-1:0),i=1;i<t;i++)o[i-1]=arguments[i];this.log("startCallAsMonitor",[e,...o]),this.media=e,this.active=!0,this.monitor=!0,this.transport.startCall({media:this.media,monitor:!0})}onRemoteCall(e){let t,o,i;if(!0===this.autoAccept){setTimeout(()=>{this.joinCall({to:e.from,monitor:e.monitor,media:e.media})},0);return}let s=n.users.findOne(e.from);s&&s.username&&(i=s.username);let r=d.findOne({rid:e.room});!0===e.monitor?(t="eye",o=g("WebRTC_monitor_call_from_%s",i)):r&&"d"===r.t?e.media&&e.media.video?(t="videocam",o=g("WebRTC_direct_video_call_from_%s",i)):(t="phone",o=g("WebRTC_direct_audio_call_from_%s",i)):e.media&&e.media.video?(t="videocam",o=g("WebRTC_group_video_call_from_%s",r.name)):(t="phone",o=g("WebRTC_group_audio_call_from_%s",r.name)),l.open({component:a,props:{title:o,icon:t,confirmText:g("Yes"),cancelText:g("No"),children:g("Do_you_want_to_accept"),onConfirm:()=>(c(e.room),this.joinCall({to:e.from,monitor:e.monitor,media:e.media})),onCancel:()=>this.stop(),onClose:()=>this.stop()}})}joinCall(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e.media=this.media;for(var t=arguments.length,o=Array(t>1?t-1:0),i=1;i<t;i++)o[i-1]=arguments[i];this.log("joinCall",[e,...o]),this.getLocalUserMedia(()=>{this.remoteMonitoring=e.monitor,this.active=!0,this.transport.joinCall(e)})}onRemoteJoin(e){if(!0!==this.active)return;for(var t=arguments.length,o=Array(t>1?t-1:0),i=1;i<t;i++)o[i-1]=arguments[i];this.log("onRemoteJoin",[e,...o]);let n=this.getPeerConnection(e.from);if("checking"!==n.signalingState&&(this.stopPeerConnection(e.from),n=this.getPeerConnection(e.from)),"new"!==n.iceConnectionState)return;n.remoteMedia=e.media,this.localStream&&n.addStream(this.localStream);let s=t=>{n.setLocalDescription(new RTCSessionDescription(t),()=>{this.transport.sendDescription({to:e.from,type:"offer",ts:n.createdAt,media:this.media,description:{sdp:t.sdp,type:t.type}})},this.onError)};!0===e.monitor?n.createOffer(s,this.onError,{mandatory:{OfferToReceiveAudio:e.media.audio,OfferToReceiveVideo:e.media.video}}):n.createOffer(s,this.onError)}onRemoteOffer(e){if(!0!==this.active)return;for(var t=arguments.length,o=Array(t>1?t-1:0),i=1;i<t;i++)o[i-1]=arguments[i];this.log("onRemoteOffer",[e,...o]);let n=this.getPeerConnection(e.from);if(["have-local-offer","stable"].includes(n.signalingState)&&n.createdAt<e.ts&&(this.stopPeerConnection(e.from),n=this.getPeerConnection(e.from)),"new"===n.iceConnectionState){n.setRemoteDescription(new RTCSessionDescription(e.description));try{this.localStream&&n.addStream(this.localStream)}catch(e){console.log(e)}n.createAnswer(t=>{n.setLocalDescription(new RTCSessionDescription(t),()=>{this.transport.sendDescription({to:e.from,type:"answer",ts:n.createdAt,description:{sdp:t.sdp,type:t.type}})},this.onError)},this.onError)}}onRemoteCandidate(e){var t;if(!0!==this.active||e.to!==this.selfId)return;for(var o=arguments.length,i=Array(o>1?o-1:0),n=1;n<o;n++)i[n-1]=arguments[n];this.log("onRemoteCandidate",[e,...i]);let s=this.getPeerConnection(e.from);"closed"!==s.iceConnectionState&&"failed"!==s.iceConnectionState&&"disconnected"!==s.iceConnectionState&&"completed"!==s.iceConnectionState&&s.addIceCandidate(new RTCIceCandidate(e.candidate)),document.querySelector("video#remoteVideo").srcObject=null===(t=this.remoteItems.get()[0])||void 0===t?void 0:t.url}onRemoteDescription(e){if(!0!==this.active||e.to!==this.selfId)return;for(var t=arguments.length,o=Array(t>1?t-1:0),i=1;i<t;i++)o[i-1]=arguments[i];this.log("onRemoteDescription",[e,...o]);let n=this.getPeerConnection(e.from);"offer"===e.type?(n.remoteMedia=e.media,this.onRemoteOffer({from:e.from,ts:e.ts,description:e.description})):n.setRemoteDescription(new RTCSessionDescription(e.description))}}let b=new class{constructor(){this.instancesByRoomId={}}getInstanceByRoomId(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=!1;if(t)o="WebRTC"===m.get("Omnichannel_call_provider");else{let t=d.findOne({rid:e});if(!t)return;switch(t.t){case"d":o=m.get("WebRTC_Enable_Direct");break;case"p":o=m.get("WebRTC_Enable_Private");break;case"c":o=m.get("WebRTC_Enable_Channel");break;case"l":o="WebRTC"===m.get("Omnichannel_call_provider")}}if(!1!==(o=o&&m.get("WebRTC_Enabled"))){if(null==this.instancesByRoomId[e]){let o=n.userId(),i=!1;t&&(o=t,i=!0),this.instancesByRoomId[e]=new C(o,e,i)}return this.instancesByRoomId[e]}}};n.startup(()=>{r.autorun(()=>{n.userId()&&h.onUser(u.WEB_RTC,(e,t)=>{if(null==t.room)return;let o=b.getInstanceByRoomId(t.room);o.onUserStream(e,t)})})})}
//# sourceMappingURL=/dynamic/app/webrtc/client/28dcad5da464ca5c86154e6ad9f2fcc72db11329.map

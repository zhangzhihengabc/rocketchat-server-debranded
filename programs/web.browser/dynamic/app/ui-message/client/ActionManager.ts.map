)]}'
{"version":3,"sources":["meteor://ðŸ’»app/app/ui-message/client/ActionManager.ts","meteor://ðŸ’»app/<anon>"],"sourcesContent":["import type { DistributiveOmit, UiKit } from '@rocket.chat/core-typings';\nimport { Emitter } from '@rocket.chat/emitter';\nimport { Random } from '@rocket.chat/random';\nimport type { RouterContext, IActionManager } from '@rocket.chat/ui-contexts';\nimport type { ContextType } from 'react';\nimport { lazy } from 'react';\n\nimport * as banners from '../../../client/lib/banners';\nimport { imperativeModal } from '../../../client/lib/imperativeModal';\nimport { sdk } from '../../utils/client/lib/SDKClient';\nimport { UiKitTriggerTimeoutError } from './UiKitTriggerTimeoutError';\n\nconst UiKitModal = lazy(() => import('../../../client/views/modal/uikit/UiKitModal'));\n\nexport class ActionManager implements IActionManager {\n\tprotected static TRIGGER_TIMEOUT = 5000;\n\n\tprotected static TRIGGER_TIMEOUT_ERROR = 'TRIGGER_TIMEOUT_ERROR';\n\n\tprotected events = new Emitter<{ busy: { busy: boolean }; [viewId: string]: any }>();\n\n\tprotected triggersId = new Map<string, string | undefined>();\n\n\tprotected viewInstances = new Map<\n\t\tstring,\n\t\t{\n\t\t\tpayload?: {\n\t\t\t\tview: UiKit.ContextualBarView;\n\t\t\t};\n\t\t\tclose: () => void;\n\t\t}\n\t>();\n\n\tpublic constructor(protected router: ContextType<typeof RouterContext>) {}\n\n\tprotected invalidateTriggerId(id: string) {\n\t\tconst appId = this.triggersId.get(id);\n\t\tthis.triggersId.delete(id);\n\t\treturn appId;\n\t}\n\n\tpublic on(viewId: string, listener: (data: any) => void): void;\n\n\tpublic on(eventName: 'busy', listener: ({ busy }: { busy: boolean }) => void): void;\n\n\tpublic on(eventName: string, listener: (data: any) => void) {\n\t\treturn this.events.on(eventName, listener);\n\t}\n\n\tpublic off(viewId: string, listener: (data: any) => any): void;\n\n\tpublic off(eventName: 'busy', listener: ({ busy }: { busy: boolean }) => void): void;\n\n\tpublic off(eventName: string, listener: (data: any) => void) {\n\t\treturn this.events.off(eventName, listener);\n\t}\n\n\tpublic notifyBusy() {\n\t\tthis.events.emit('busy', { busy: true });\n\t}\n\n\tpublic notifyIdle() {\n\t\tthis.events.emit('busy', { busy: false });\n\t}\n\n\tpublic generateTriggerId(appId: string | undefined) {\n\t\tconst triggerId = Random.id();\n\t\tthis.triggersId.set(triggerId, appId);\n\t\tsetTimeout(() => this.invalidateTriggerId(triggerId), ActionManager.TRIGGER_TIMEOUT);\n\t\treturn triggerId;\n\t}\n\n\tpublic async emitInteraction(appId: string, userInteraction: DistributiveOmit<UiKit.UserInteraction, 'triggerId'>) {\n\t\tthis.notifyBusy();\n\n\t\tconst triggerId = this.generateTriggerId(appId);\n\n\t\tlet timeout: ReturnType<typeof setTimeout> | undefined;\n\n\t\tawait Promise.race([\n\t\t\tnew Promise((_, reject) => {\n\t\t\t\ttimeout = setTimeout(() => reject(new UiKitTriggerTimeoutError('Timeout', { triggerId, appId })), ActionManager.TRIGGER_TIMEOUT);\n\t\t\t}),\n\t\t\tsdk.rest\n\t\t\t\t.post(`/apps/ui.interaction/${appId}`, {\n\t\t\t\t\t...userInteraction,\n\t\t\t\t\ttriggerId,\n\t\t\t\t})\n\t\t\t\t.then((interaction) => this.handleServerInteraction(interaction)),\n\t\t]).finally(() => {\n\t\t\tif (timeout) clearTimeout(timeout);\n\t\t\tthis.notifyIdle();\n\t\t});\n\t}\n\n\tpublic handleServerInteraction(interaction: UiKit.ServerInteraction) {\n\t\tconst { triggerId } = interaction;\n\n\t\tif (!this.triggersId.has(triggerId)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst appId = this.invalidateTriggerId(triggerId);\n\t\tif (!appId) {\n\t\t\treturn;\n\t\t}\n\n\t\tswitch (interaction.type) {\n\t\t\tcase 'errors': {\n\t\t\t\tconst { type, triggerId, viewId, appId, errors } = interaction;\n\t\t\t\tthis.events.emit(interaction.viewId, {\n\t\t\t\t\ttype,\n\t\t\t\t\ttriggerId,\n\t\t\t\t\tviewId,\n\t\t\t\t\tappId,\n\t\t\t\t\terrors,\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'modal.open': {\n\t\t\t\tconst { view } = interaction;\n\t\t\t\tthis.openModal(view);\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'modal.update':\n\t\t\tcase 'contextual_bar.update': {\n\t\t\t\tconst { type, triggerId, appId, view } = interaction;\n\t\t\t\tthis.events.emit(view.id, {\n\t\t\t\t\ttype,\n\t\t\t\t\ttriggerId,\n\t\t\t\t\tviewId: view.id,\n\t\t\t\t\tappId,\n\t\t\t\t\tview,\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'modal.close': {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'banner.open': {\n\t\t\t\tconst { type, triggerId, ...view } = interaction;\n\t\t\t\tthis.openBanner(view);\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'banner.update': {\n\t\t\t\tconst { type, triggerId, appId, view } = interaction;\n\t\t\t\tthis.events.emit(view.viewId, {\n\t\t\t\t\ttype,\n\t\t\t\t\ttriggerId,\n\t\t\t\t\tviewId: view.viewId,\n\t\t\t\t\tappId,\n\t\t\t\t\tview,\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'banner.close': {\n\t\t\t\tconst { viewId } = interaction;\n\t\t\t\tthis.viewInstances.get(viewId)?.close();\n\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'contextual_bar.open': {\n\t\t\t\tconst { view } = interaction;\n\t\t\t\tthis.openContextualBar(view);\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'contextual_bar.close': {\n\t\t\t\tconst { view } = interaction;\n\t\t\t\tthis.viewInstances.get(view.id)?.close();\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\treturn interaction.type;\n\t}\n\n\tpublic getInteractionPayloadByViewId(viewId: UiKit.ContextualBarView['id']) {\n\t\tif (!viewId) {\n\t\t\tthrow new Error('No viewId provided when checking for `user interaction payload`');\n\t\t}\n\n\t\treturn this.viewInstances.get(viewId)?.payload;\n\t}\n\n\tpublic openView(surface: 'modal', view: UiKit.ModalView): void;\n\n\tpublic openView(surface: 'banner', view: UiKit.BannerView): void;\n\n\tpublic openView(surface: 'contextual_bar', view: UiKit.ContextualBarView): void;\n\n\tpublic openView(surface: string, view: UiKit.View) {\n\t\tswitch (surface) {\n\t\t\tcase 'modal':\n\t\t\t\tthis.openModal(view as UiKit.ModalView);\n\t\t\t\tbreak;\n\n\t\t\tcase 'banner':\n\t\t\t\tthis.openBanner(view as UiKit.BannerView);\n\t\t\t\tbreak;\n\n\t\t\tcase 'contextual_bar':\n\t\t\t\tthis.openContextualBar(view as UiKit.ContextualBarView);\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tprivate openModal(view: UiKit.ModalView) {\n\t\tconst instance = imperativeModal.open({\n\t\t\tcomponent: UiKitModal,\n\t\t\tprops: {\n\t\t\t\tkey: view.id,\n\t\t\t\tinitialView: view,\n\t\t\t},\n\t\t});\n\n\t\tthis.viewInstances.set(view.id, {\n\t\t\tclose: () => {\n\t\t\t\tinstance.close();\n\t\t\t\tthis.viewInstances.delete(view.id);\n\t\t\t},\n\t\t});\n\t}\n\n\tprivate openBanner(view: UiKit.BannerView) {\n\t\tbanners.open(view);\n\t\tthis.viewInstances.set(view.viewId, {\n\t\t\tclose: () => {\n\t\t\t\tbanners.closeById(view.viewId);\n\t\t\t},\n\t\t});\n\t}\n\n\tprivate openContextualBar(view: UiKit.ContextualBarView) {\n\t\tthis.viewInstances.set(view.id, {\n\t\t\tpayload: {\n\t\t\t\tview,\n\t\t\t},\n\t\t\tclose: () => {\n\t\t\t\tthis.viewInstances.delete(view.id);\n\t\t\t},\n\t\t});\n\n\t\tconst routeName = this.router.getRouteName();\n\t\tconst routeParams = this.router.getRouteParameters();\n\n\t\tif (!routeName) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.router.navigate({\n\t\t\tname: routeName,\n\t\t\tparams: {\n\t\t\t\t...routeParams,\n\t\t\t\ttab: 'app',\n\t\t\t\tcontext: view.id,\n\t\t\t},\n\t\t});\n\t}\n\n\tpublic disposeView(viewId: UiKit.ModalView['id'] | UiKit.BannerView['viewId'] | UiKit.ContextualBarView['id']) {\n\t\tconst instance = this.viewInstances.get(viewId);\n\t\tinstance?.close?.();\n\t\tthis.viewInstances.delete(viewId);\n\t}\n}\n",null],"names":["_objectWithoutProperties","_objectSpread","Emitter","Random","lazy","banners","imperativeModal","sdk","UiKitTriggerTimeoutError","module","default","export","ActionManager","v","UiKitModal","dynamicImport","constructor","router","events","triggersId","Map","viewInstances","invalidateTriggerId","id","appId","get","delete","on","eventName","listener","off","notifyBusy","emit","busy","notifyIdle","generateTriggerId","triggerId","set","setTimeout","TRIGGER_TIMEOUT","emitInteraction","userInteraction","timeout","Promise","race","_","reject","rest","post","concat","then","interaction","handleServerInteraction","finally","clearTimeout","_this$viewInstances$g","_this$viewInstances$g2","has","type","viewId","errors","view","openModal","_excluded","openBanner","close","openContextualBar","getInteractionPayloadByViewId","_this$viewInstances$g3","Error","payload","openView","surface","instance","open","component","props","key","initialView","closeById","routeName","getRouteName","routeParams","getRouteParameters","navigate","name","params","tab","context","disposeView","_instance$close","call","TRIGGER_TIMEOUT_ERROR"],"mappings":"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"}